-- Add Next.js 14â†’15 Migration Guide entries
-- Source: https://nextjs.org/docs/app/building-your-application/upgrading/version-15
-- Extracted: 2025-11-24
-- Category: migration-guide (Next.js version upgrade)

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Next.js 15 upgrade: How to migrate from Next.js 14 to 15',
    'migration-guide',
    'VERY_HIGH',
    '[
        {"solution": "Run automated codemod to handle most breaking changes", "percentage": 92, "note": "Handles async request APIs, imports, and common patterns", "command": "npx @next/codemod@canary upgrade latest"},
        {"solution": "Manually update packages with force flag for React 19 peer deps", "percentage": 90, "note": "React 19 may trigger peer dependency warnings until stable", "command": "npm i next@latest react@latest react-dom@latest eslint-config-next@latest --force"},
        {"solution": "Use legacy-peer-deps if force flag causes issues in monorepos", "percentage": 85, "note": "Alternative approach for complex dependency trees", "command": "npm i next@latest react@latest react-dom@latest eslint-config-next@latest --legacy-peer-deps"},
        {"solution": "Review codemod-generated @next-codemod-error comments and fix manually", "percentage": 88, "note": "Codemod cannot handle all edge cases - search for error comments in your codebase"}
    ]'::jsonb,
    'Next.js 14 project, Node.js 18.18+, npm or yarn package manager, Git for tracking changes',
    'Packages install without errors, next dev runs successfully, Build completes with next build, All tests pass after upgrade',
    'React 19 is still in RC - expect peer dependency warnings. Do not skip testing after automated migration. Check all dynamic imports and Suspense boundaries. Verify TypeScript types for @types/react and @types/react-dom match React 19.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-15'
),
(
    'Next.js 15 breaking change: cookies(), headers(), draftMode() are now async',
    'migration-guide',
    'VERY_HIGH',
    '[
        {"solution": "Add await before cookies(), headers(), and draftMode() calls in Server Components", "percentage": 95, "note": "These APIs now return Promises that must be awaited", "command": "const cookieStore = await cookies();\nconst headersList = await headers();\nconst { isEnabled } = await draftMode();"},
        {"solution": "Use React.use() to unwrap Promise in Client Components", "percentage": 88, "note": "Client components cannot use await - use React.use() instead", "command": "import { use } from ''react'';\nconst cookieStore = use(cookies());"},
        {"solution": "Temporarily cast to UnsafeUnwrappedCookies to keep sync usage (dev warnings)", "percentage": 70, "note": "Deprecated workaround - produces warnings in development", "command": "import { cookies, type UnsafeUnwrappedCookies } from ''next/headers'';\nconst cookieStore = cookies() as unknown as UnsafeUnwrappedCookies;"},
        {"solution": "Run codemod to automatically convert sync to async usage", "percentage": 90, "command": "npx @next/codemod@latest next-async-request-api ."}
    ]'::jsonb,
    'Next.js 15+, React 19+, Server Components or Client Components using these APIs',
    'No TypeScript errors on cookies/headers calls, No deprecation warnings in console, Functions return expected values, Build succeeds without async warnings',
    'In Next.js 14 these were synchronous - this is the biggest breaking change in v15. Codemod cannot handle all cases, especially complex nested usage. Do not wrap in try/catch without re-throwing. Third-party libraries using these APIs will need updates.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-15#async-request-apis-breaking-change'
),
(
    'Next.js 15 breaking change: params and searchParams are now async in layouts and pages',
    'migration-guide',
    'VERY_HIGH',
    '[
        {"solution": "Await params in Server Component layouts, pages, and metadata functions", "percentage": 95, "note": "params is now Promise in all route handlers", "command": "export async function generateMetadata({ params }: { params: Promise<{ slug: string }> }) {\n  const { slug } = await params;\n  return { title: slug };\n}"},
        {"solution": "Use React.use() for params in synchronous Client Components", "percentage": 90, "note": "Client components must unwrap Promise with use()", "command": "import { use } from ''react'';\nfunction Page({ params }: { params: Promise<{ id: string }> }) {\n  const { id } = use(params);\n}"},
        {"solution": "Update TypeScript types to Promise<T> for params and searchParams", "percentage": 92, "note": "TypeScript will error without Promise wrapper", "command": "type Params = Promise<{ slug: string }>;\ntype SearchParams = Promise<{ query?: string }>;"},
        {"solution": "Await searchParams in pages that use search query parameters", "percentage": 93, "command": "export default async function Page({ searchParams }: { searchParams: Promise<{ q?: string }> }) {\n  const { q } = await searchParams;\n}"}
    ]'::jsonb,
    'Next.js 15+, App Router architecture, TypeScript for type safety',
    'Params resolve correctly in components, SearchParams work in pages, No TypeScript errors on params/searchParams, Metadata generation succeeds',
    'This change affects layouts, pages, route handlers, generateMetadata, and generateStaticParams. In nested routes, each level must await its own params. Do not destructure params in function signature - await first, then destructure. Client Components using searchParams may need Suspense boundaries.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-15#async-request-apis-breaking-change'
),
(
    'Next.js 15 breaking change: fetch requests no longer cached by default',
    'migration-guide',
    'VERY_HIGH',
    '[
        {"solution": "Add cache: force-cache option to fetch calls that should be cached", "percentage": 95, "note": "Explicit caching replaces previous default behavior", "command": "fetch(''https://api.example.com/data'', { cache: ''force-cache'' })"},
        {"solution": "Use cache: no-store for dynamic data (already default in v15)", "percentage": 90, "note": "Explicitly document intent for dynamic fetches", "command": "fetch(''https://api.example.com/user'', { cache: ''no-store'' })"},
        {"solution": "Set export const fetchCache = force-cache at route level to restore v14 behavior", "percentage": 85, "note": "Applies caching to all fetches in the route segment", "command": "export const fetchCache = ''force-cache'';"},
        {"solution": "Review all fetch calls and add appropriate cache options based on data freshness needs", "percentage": 88, "note": "Migration opportunity to optimize caching strategy"}
    ]'::jsonb,
    'Next.js 15+, Application using fetch for data retrieval, Understanding of caching strategies',
    'Pages load with expected performance, Data freshness matches requirements, No unexpected stale data, Cache headers match intent',
    'This reverses Next.js 14 behavior where fetch was cached by default. Check all fetch calls - previously cached data may now refetch on every request. This can significantly impact performance and API costs. Consider using revalidate options for ISR patterns.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-15#fetch-requests-are-no-longer-cached-by-default'
),
(
    'Next.js 15 breaking change: Route handlers GET methods no longer cached by default',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Add export const dynamic = force-static to cache GET route handlers", "percentage": 93, "note": "Opt into static generation for route handlers", "command": "export const dynamic = ''force-static'';\nexport async function GET() {\n  return Response.json({ data: ''cached'' });\n}"},
        {"solution": "Keep default dynamic behavior for route handlers that need request-time data", "percentage": 90, "note": "No change needed if dynamic behavior is desired"},
        {"solution": "Use export const revalidate = 60 for ISR pattern with time-based revalidation", "percentage": 88, "note": "Combines static generation with periodic updates", "command": "export const revalidate = 60; // Revalidate every 60 seconds"},
        {"solution": "Review all GET route handlers and determine appropriate caching strategy", "percentage": 85, "note": "Audit existing handlers to avoid performance regression"}
    ]'::jsonb,
    'Next.js 15+, App Router with Route Handlers, API routes in app directory',
    'Route handlers return data correctly, Response times match expectations, Caching behavior matches intent, No unexpected dynamic renders',
    'In Next.js 14, GET route handlers were cached by default. This change makes them dynamic by default. If your GET handlers return static data, you may see performance degradation without force-static. POST/PUT/DELETE handlers remain dynamic.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-15#get-route-handlers-are-no-longer-cached-by-default'
),
(
    'Next.js 15 breaking change: Client-side router cache no longer caches page components by default',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Configure staleTimes in next.config.js to restore caching behavior", "percentage": 90, "note": "Controls how long page segments are cached in client router", "command": "// next.config.js\nexperimental: {\n  staleTimes: {\n    dynamic: 30,\n    static: 180\n  }\n}"},
        {"solution": "Set dynamic: 0 for fully dynamic pages with no client cache", "percentage": 85, "note": "Useful for pages with frequently changing data"},
        {"solution": "Use larger static values (300+) for mostly static marketing pages", "percentage": 82, "note": "Improves navigation performance for stable content"},
        {"solution": "Keep default behavior (no caching) if pages should always refetch on navigation", "percentage": 88, "note": "Ensures data freshness at cost of performance"}
    ]'::jsonb,
    'Next.js 15+, Client-side navigation with <Link> or useRouter, Understanding of client-side caching',
    'Navigation performance meets expectations, Data freshness is appropriate for use case, No stale data issues, Loading states work correctly',
    'Layouts and loading.js states still use client-side cache. Only page components are affected. Previously, pages were cached for 30 seconds (dynamic) or 5 minutes (static) by default. Users may notice slower navigation without staleTimes configuration.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-15#client-side-router-cache'
),
(
    'Next.js 15 React 19 support: Upgrade to React 19 RC',
    'migration-guide',
    'VERY_HIGH',
    '[
        {"solution": "Update @types/react and @types/react-dom to latest versions", "percentage": 95, "note": "Required for React 19 TypeScript support", "command": "npm i --save-dev @types/react@latest @types/react-dom@latest"},
        {"solution": "Replace useFormState with useActionState in Client Components", "percentage": 92, "note": "useFormState is deprecated in React 19", "command": "import { useActionState } from ''react'';\nconst [state, formAction, isPending] = useActionState(action, initialState);"},
        {"solution": "Update useFormStatus usage to access new properties (data, method, action)", "percentage": 85, "note": "New properties only available with React 19", "command": "const { pending, data, method, action } = useFormStatus();"},
        {"solution": "Install with --force flag to override peer dependency warnings until React 19 stable", "percentage": 88, "command": "npm i next@latest react@rc react-dom@rc --force"}
    ]'::jsonb,
    'Next.js 15+, TypeScript project, Forms using React hooks, Willingness to use React RC version',
    'React 19 installs successfully, TypeScript errors resolve, Forms work with new hooks, No runtime errors from hook changes',
    'React 19 is still in RC - production apps may want to wait for stable release. useFormState deprecation will show console warnings. Third-party libraries may not support React 19 yet - check compatibility. Peer dependency warnings are expected until React 19 stable.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-15#react-19'
),
(
    'Next.js 15 config changes: Stable configuration options promoted from experimental',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Replace experimental.bundlePagesExternals with bundlePagesRouterDependencies", "percentage": 95, "note": "Config option promoted to stable in Next.js 15", "command": "// next.config.js\nbundlePagesRouterDependencies: true"},
        {"solution": "Replace experimental.serverComponentsExternalPackages with serverExternalPackages", "percentage": 95, "note": "Renamed to stable config option", "command": "serverExternalPackages: [''package-name'']"},
        {"solution": "Change runtime: experimental-edge to runtime: edge in route handlers", "percentage": 90, "note": "experimental-edge is deprecated", "command": "export const runtime = ''edge'';"},
        {"solution": "Update font imports from @next/font to next/font if not already done", "percentage": 92, "note": "Old import path removed in Next.js 15", "command": "import { Inter } from ''next/font/google'';"}
    ]'::jsonb,
    'Next.js 15+, Project using experimental config options, next.config.js or next.config.ts file',
    'Build succeeds with new config names, No deprecation warnings about config options, Edge runtime works correctly, Fonts load properly',
    'Old experimental config names will cause errors in Next.js 15 - they must be updated. Font import change is required if still using @next/font from Next.js 12 era. Check for any custom config referencing experimental options.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-15#configuration-options'
),
(
    'Next.js 15 removed features: Speed Insights and geolocation APIs',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Install @vercel/speed-insights and manually instrument for Speed Insights", "percentage": 93, "note": "Replaces automatic instrumentation removed in v15", "command": "npm i @vercel/speed-insights\n// app/layout.tsx\nimport { SpeedInsights } from ''@vercel/speed-insights/next'';\nexport default function RootLayout({ children }) {\n  return <html><body>{children}<SpeedInsights /></body></html>;\n}"},
        {"solution": "Replace NextRequest.geo with @vercel/functions geolocation function", "percentage": 90, "note": "For Vercel deployments only", "command": "import { geolocation } from ''@vercel/functions'';\nconst { city, country } = geolocation(request);"},
        {"solution": "Replace NextRequest.ip with @vercel/functions ipAddress function", "percentage": 90, "note": "For Vercel deployments only", "command": "import { ipAddress } from ''@vercel/functions'';\nconst ip = ipAddress(request);"},
        {"solution": "Remove references to NextRequest.geo and .ip if not on Vercel", "percentage": 85, "note": "These properties are Vercel-specific and removed from Next.js core"}
    ]'::jsonb,
    'Next.js 15+, Vercel deployment (for geo/IP features), Speed Insights previously used',
    'Speed Insights dashboard shows data after manual setup, Geolocation works with new API, IP address detection functions correctly, No errors about missing properties',
    'Speed Insights was automatically injected in Next.js 14 on Vercel - now requires manual setup. NextRequest.geo and .ip were Vercel-specific features that should have been in @vercel/functions from the start. Non-Vercel deployments need alternative solutions for geolocation.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-15#removed-deprecated-features'
),
(
    'Next.js 15 TypeScript config: Update tsconfig.json for async APIs',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Update function signatures to accept Promise types for params", "percentage": 95, "note": "Required for type safety with async params", "command": "export async function generateMetadata(\n  { params }: { params: Promise<{ id: string }> }\n) {\n  const { id } = await params;\n}"},
        {"solution": "Enable strict mode in tsconfig.json for better async type checking", "percentage": 88, "note": "Catches missing await keywords at compile time", "command": "{\n  \"compilerOptions\": {\n    \"strict\": true\n  }\n}"},
        {"solution": "Update all route handler types to use Promise for params and searchParams", "percentage": 92, "command": "type RouteParams = Promise<{ slug: string }>;\ntype SearchParams = Promise<{ [key: string]: string | string[] | undefined }>;"},
        {"solution": "Install latest @types/react for useActionState and new hook types", "percentage": 90, "command": "npm i --save-dev @types/react@latest"}
    ]'::jsonb,
    'Next.js 15+, TypeScript project, tsconfig.json configured, Understanding of Promise types',
    'No TypeScript errors in route files, Async types resolve correctly, IDE autocomplete works for params/searchParams, Build succeeds without type errors',
    'TypeScript will not automatically infer Promise types for params - you must explicitly type them. Missing Promise wrapper will cause type errors. Generic route handler types need updating across entire codebase. Consider using type aliases for common param patterns.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-15#typescript-changes'
),
(
    'Next.js 15 migration best practices: Testing and rollback strategy',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Create new git branch before running codemod and upgrading packages", "percentage": 98, "note": "Enables easy rollback if migration fails", "command": "git checkout -b upgrade-nextjs-15\ngit add -A\ngit commit -m \"Pre-upgrade checkpoint\""},
        {"solution": "Run codemod first, review changes, then upgrade packages", "percentage": 92, "note": "Separates automated changes from dependency updates for easier debugging", "command": "npx @next/codemod@canary upgrade latest\ngit diff\nnpm i next@latest react@latest react-dom@latest"},
        {"solution": "Search codebase for @next-codemod-error comments after codemod", "percentage": 95, "note": "Identifies areas requiring manual intervention", "command": "grep -r \"@next-codemod-error\" ."},
        {"solution": "Test incrementally: dev server, then build, then production deployment", "percentage": 90, "note": "Catches issues early before production deployment"},
        {"solution": "Review all fetch calls, route handlers, and dynamic APIs manually", "percentage": 88, "note": "Caching changes are subtle and may not cause errors but impact performance"}
    ]'::jsonb,
    'Next.js 14 project ready to upgrade, Git version control, Test environment available, CI/CD pipeline for validation',
    'All automated tests pass, Manual testing covers key user flows, Build completes successfully, Performance metrics match expectations, No console errors or warnings',
    'Do not upgrade directly in production without testing. Codemod does not handle 100% of cases - manual review is essential. Pay special attention to authentication flows using cookies/headers. Test data fetching patterns thoroughly - caching changes may not throw errors but degrade performance. Have rollback plan ready.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-15'
);
