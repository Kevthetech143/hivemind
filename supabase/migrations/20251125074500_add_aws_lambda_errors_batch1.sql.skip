-- Add AWS Lambda common errors from official documentation
-- Source: https://docs.aws.amazon.com/lambda/latest/dg/
-- Batch: 1 (API errors and configuration)

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Lambda error: TooManyRequestsException (429) - request throughput limit exceeded',
    'aws-lambda',
    'HIGH',
    '[
        {"solution": "Implement exponential backoff retry logic starting at 1 second", "percentage": 90, "note": "Use retryAfterSeconds from response header to determine backoff"},
        {"solution": "Request concurrent execution quota increase via Service Quotas dashboard for soft limits", "percentage": 85, "note": "Default limit is 1,000 concurrent executions per account"},
        {"solution": "Batch multiple requests or optimize function logic to reduce invocation frequency", "percentage": 80, "note": "Consider asynchronous invocations instead of synchronous"}
    ]'::jsonb,
    'AWS account with Lambda functions, Valid API credentials',
    'Subsequent requests succeed after retry delay, retryAfterSeconds value respected',
    'Do not retry immediately without respecting retryAfterSeconds. Exponential backoff is required. Check Service Quotas for your actual limits.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html'
),
(
    'Lambda error: InvalidParameterValueException (400) - invalid function parameters',
    'aws-lambda',
    'HIGH',
    '[
        {"solution": "Validate MemorySize parameter: must be 128-10240 MB in 1 MB increments", "percentage": 92, "note": "Check you are using valid value like 128, 256, 512, 1024, etc."},
        {"solution": "Validate Timeout parameter: must be 1-900 seconds (15 minutes max)", "percentage": 90, "note": "Timeout applies per invocation"},
        {"solution": "Verify Handler parameter format is correct (e.g., index.handler) and contains no spaces", "percentage": 88, "note": "Handler required for .zip deployment packages"},
        {"solution": "Confirm Runtime parameter matches supported runtimes list", "percentage": 85, "command": "Check AWS docs for current supported runtimes"}
    ]'::jsonb,
    'Lambda function definition, Access to function configuration console or AWS CLI',
    'Function creates or updates successfully, API returns 201 or 200 status code',
    'Do not use fractional MB for memory (must be whole number). Timeout cannot exceed 900 seconds. Handler name is case-sensitive.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_CreateFunction.html'
),
(
    'Lambda error: ResourceNotFoundException (404) - function or resource does not exist',
    'aws-lambda',
    'HIGH',
    '[
        {"solution": "Verify function name exists in AWS account and correct region is selected", "percentage": 93, "note": "Check AWS Lambda console or use AWS CLI: aws lambda get-function --function-name MyFunction"},
        {"solution": "For role/execution permission errors, confirm IAM role ARN is correct and role exists", "percentage": 90, "note": "Role ARN format: arn:aws:iam::ACCOUNT:role/ROLE_NAME"},
        {"solution": "If referencing layers, verify all layer ARNs exist in the same region", "percentage": 88, "note": "Layers must be in the same AWS region as the function"},
        {"solution": "For VPC config errors, validate subnet IDs and security group IDs exist", "percentage": 85, "note": "Use VPC console to verify subnet and security group existence"}
    ]'::jsonb,
    'AWS credentials configured, Correct AWS region specified',
    'Function found and accessible, API returns 200 with function metadata, IAM role accessible',
    'Function must be in the same region as the API call. Case-sensitive function names. Resource ARNs must use correct format.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_CreateFunction.html'
),
(
    'Lambda error: RequestTooLargeException (413) - payload size exceeded',
    'aws-lambda',
    'MEDIUM',
    '[
        {"solution": "For synchronous invocations, keep payload under 6 MB limit", "percentage": 92, "note": "Total request body including JSON overhead must fit within 6 MB"},
        {"solution": "For asynchronous invocations, reduce payload to under 1 MB maximum", "percentage": 90, "note": "Async invocations have stricter 1 MB payload limit"},
        {"solution": "Compress payload data or use S3 for large data transfer instead", "percentage": 85, "note": "Pass S3 bucket reference in small payload instead of full data"},
        {"solution": "For streamed responses, keep payload under 200 MB limit", "percentage": 82, "note": "Stream response payloads have separate 200 MB limit"}
    ]'::jsonb,
    'Lambda function capable of handling payload data, Understanding of sync vs async invocations',
    'Invoke succeeds with 200 or 202 status code, Function processes payload correctly',
    'Asynchronous payloads are limited to 1 MB, not 6 MB like synchronous. Streamed responses have separate 200 MB limit.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html'
),
(
    'Lambda error: CodeVerificationFailedException (400) - code signature validation failed',
    'aws-lambda',
    'MEDIUM',
    '[
        {"solution": "Re-sign deployment package with valid code-signing profile before deployment", "percentage": 91, "note": "Signature must not be expired and must match trusted publisher"},
        {"solution": "Verify code signing configuration ARN is correct", "percentage": 88, "note": "ARN format: arn:aws:lambda:region:account:code-signing-config:csc-[a-z0-9]{17}"},
        {"solution": "Check that code signing policy is not set to ENFORCE, or re-sign with valid signature", "percentage": 85, "note": "ENFORCE policy blocks deployment on any signature validation failure"},
        {"solution": "Ensure signing certificate has not expired and matches configured publisher", "percentage": 82, "note": "AWS Signer service manages code signing certificates"}
    ]'::jsonb,
    'AWS Code Signing configuration set up, Valid signing certificate, Code signing policy defined',
    'Deployment succeeds with 201 status, Function state becomes Active, No signature validation errors in logs',
    'Code signatures must be valid even with WARN policy. Expired certificates will always fail. Signature format must match configuration.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_CreateFunction.html'
),
(
    'Lambda error: RecursiveInvocationException (400) - function recursively invoking itself',
    'aws-lambda',
    'MEDIUM',
    '[
        {"solution": "Add conditional logic to prevent function from invoking itself directly", "percentage": 93, "note": "Lambda detects recursive loops and stops invocation automatically"},
        {"solution": "Use environment variables or state to track invocation depth", "percentage": 88, "note": "Check MAX_RECURSION_DEPTH before invoking child function"},
        {"solution": "Implement queue-based processing instead of direct recursive invocation", "percentage": 85, "note": "Use SQS or SNS to decouple function invocations"},
        {"solution": "Review EventBridge or CloudWatch rules that may trigger recursive invocations", "percentage": 82, "note": "Event rules may trigger same function multiple times"}
    ]'::jsonb,
    'Lambda function with invoke permissions, Understanding of function flow logic',
    'Function executes without recursive invocation errors, Invocation count remains low in metrics',
    'Lambda blocks recursive invocations to prevent infinite loops. Check all event sources for circular triggers.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html'
),
(
    'Lambda error: InvalidZipFileException (502) - deployment package cannot be unzipped',
    'aws-lambda',
    'MEDIUM',
    '[
        {"solution": "Verify deployment package ZIP file is valid and not corrupted", "percentage": 92, "note": "Test locally: unzip -t myfunction.zip"},
        {"solution": "Ensure ZIP includes required handler file specified in Handler parameter", "percentage": 90, "note": "Handler path must reference file inside ZIP (e.g., index.js for index.handler)"},
        {"solution": "Check ZIP file does not exceed size limits: 50 MB zipped, 250 MB unzipped", "percentage": 88, "note": "Remove unnecessary files and dependencies to reduce size"},
        {"solution": "Recreate ZIP file from scratch, ensuring correct directory structure", "percentage": 85, "note": "Some ZIP tools may create invalid archives with wrong paths"}
    ]'::jsonb,
    'Deployment package source code, ZIP creation tools (zip command or equivalent)',
    'Function deployment succeeds, Function code loads without extraction errors, Handler executes correctly',
    'ZIP file must be created correctly with source code at root level. Do not include parent directory in ZIP paths.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html'
),
(
    'Lambda error: KMSAccessDeniedException (502) - insufficient KMS permissions for environment variable decryption',
    'aws-lambda',
    'MEDIUM',
    '[
        {"solution": "Add kms:Decrypt permission to Lambda execution role for the KMS key", "percentage": 93, "note": "IAM policy must include: arn:aws:kms:region:account:key/key-id"},
        {"solution": "Verify KMS key policy grants permission to the Lambda execution role", "percentage": 90, "note": "Key policy must list role ARN as a principal with Decrypt action"},
        {"solution": "Use AWS managed key (aws/lambda) instead of custom KMS key if possible", "percentage": 85, "note": "AWS managed keys have predefined permissions for Lambda"},
        {"solution": "Check that KMS key is in the same AWS region as the Lambda function", "percentage": 82, "note": "Cross-region KMS keys are not supported for Lambda environment variables"}
    ]'::jsonb,
    'Lambda function with encrypted environment variables, IAM role with permissions, KMS key in same region',
    'Function initialization succeeds, Environment variables decrypt and become available, No KMS permission errors in CloudWatch logs',
    'IAM policy Decrypt action must reference specific KMS key ARN, not wildcard. Cross-region KMS keys will not work.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html'
),
(
    'Lambda error: EFSMountFailureException (403) - cannot mount EFS file system due to permissions',
    'aws-lambda',
    'MEDIUM',
    '[
        {"solution": "Verify Lambda execution role has elasticfilesystem:ClientMount permission", "percentage": 92, "note": "IAM policy must include EFS mount action"},
        {"solution": "Check security group rules allow NFS port 2049 traffic from Lambda security group", "percentage": 91, "note": "Inbound rule: Protocol NFS, Port 2049, Source: Lambda security group"},
        {"solution": "Ensure EFS access point exists and is properly configured if using access points", "percentage": 88, "note": "Access point must be in accessible mount target"},
        {"solution": "Verify EFS mount targets exist in the same subnets as Lambda VPC configuration", "percentage": 85, "note": "Mount targets required in each subnet for high availability"}
    ]'::jsonb,
    'EFS file system created, Lambda function in VPC, Security groups configured, Execution role created',
    'EFS mounts successfully during function initialization, /mnt/efs directory accessible, Files can be read/written',
    'EFS must be in same VPC as Lambda. Security group must allow NFS (port 2049). Mount targets required in subnets.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html'
),
(
    'Lambda error: Environment variable configuration size exceeds 4 KB limit',
    'aws-lambda',
    'MEDIUM',
    '[
        {"solution": "Review all environment variables and remove unused or redundant ones", "percentage": 91, "note": "Total size of all variables combined cannot exceed 4 KB"},
        {"solution": "Use AWS Secrets Manager for sensitive data instead of environment variables", "percentage": 90, "note": "Secrets Manager does not count toward 4 KB limit and is more secure"},
        {"solution": "Compress environment variable values or store references to external configuration", "percentage": 85, "note": "Store config in S3 or Parameter Store and reference via small environment variable"},
        {"solution": "Implement feature flags or configuration service for dynamic settings", "percentage": 80, "note": "Fetch configuration at runtime instead of storing in environment"}
    ]'::jsonb,
    'Lambda function with multiple environment variables, Understanding of configuration management',
    'Function configuration succeeds, all environment variables load correctly, Function executes without size limit errors',
    'Total size includes all variable names and values. Sensitive data should use Secrets Manager. No workaround to increase 4 KB limit.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/lambda-environment-variables.html'
),
(
    'Lambda error: ENILimitReachedException (502) - VPC elastic network interface limit exceeded',
    'aws-lambda',
    'LOW',
    '[
        {"solution": "Verify AWS account has sufficient available ENI quota in the region", "percentage": 91, "note": "Request ENI quota increase via Service Quotas dashboard"},
        {"solution": "Check VPC subnets have available IP addresses for ENI attachment", "percentage": 89, "note": "Each ENI requires an available private IP in the subnet"},
        {"solution": "Review function concurrency and reduce if possible to lower ENI demand", "percentage": 85, "note": "Higher concurrency requires more ENIs for VPC connection"},
        {"solution": "Use provisioned concurrency to reserve ENI resources in advance", "percentage": 82, "note": "Provisioned concurrency helps avoid ENI exhaustion under load"}
    ]'::jsonb,
    'Lambda functions configured for VPC, AWS Service Quotas access, Subnet IP availability',
    'Function initializes successfully in VPC, ENI attaches without errors, CloudWatch shows no ENI limit errors',
    'ENI limits are per account and per region. Hyperplane ENIs support 65,000 connections. Monitor ENI usage in EC2 dashboard.',
    0.84,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html'
),
(
    'Lambda error: InvalidSubnetIDException (502) - VPC subnet configuration invalid',
    'aws-lambda',
    'LOW',
    '[
        {"solution": "Verify subnet IDs exist in the same AWS region as Lambda function", "percentage": 92, "note": "Cross-region VPC configuration will fail"},
        {"solution": "Confirm subnets are part of the specified VPC and have available IP addresses", "percentage": 90, "note": "Use VPC console to verify subnet status and CIDR blocks"},
        {"solution": "Check that subnet is not in a restricted availability zone", "percentage": 85, "note": "Some AZs may be restricted for certain instance types"},
        {"solution": "Ensure IAM permissions include ec2:DescribeSubnets and ec2:DescribeNetworkInterfaces", "percentage": 82, "note": "Lambda requires these permissions to access VPC resources"}
    ]'::jsonb,
    'VPC with subnets created, Lambda execution role with VPC permissions, Correct region selected',
    'Lambda VPC configuration succeeds, ENI attaches to subnet, Function can access VPC resources',
    'Subnet IDs are case-sensitive and region-specific. Cannot mix subnets from different VPCs. Verify subnet has available IPs.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html'
),
(
    'Lambda error: CodeStorageExceededException (400) - account code storage quota exceeded',
    'aws-lambda',
    'LOW',
    '[
        {"solution": "Review and delete unused or deprecated Lambda functions to free storage quota", "percentage": 93, "note": "Default quota is 75 GB total code storage per account per region"},
        {"solution": "Optimize deployment package size by removing dependencies and unused code", "percentage": 90, "note": "Use tree-shaking, minification, and bundling to reduce package size"},
        {"solution": "Request code storage quota increase via AWS Service Quotas dashboard", "percentage": 88, "note": "Quota can be increased to terabytes if needed"},
        {"solution": "Use container images instead of ZIP if approaching quota limits", "percentage": 85, "note": "Container images have separate 10 GB size limit per image"}
    ]'::jsonb,
    'AWS account with multiple Lambda functions, AWS Service Quotas access',
    'Function deployment succeeds, storage quota usage decreased, New functions can be created',
    'Code storage includes all Lambda functions and versions in the account. Deleted functions may take time to free quota.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://docs.aws.amazon.com/lambda/latest/dg/API_CreateFunction.html'
);
