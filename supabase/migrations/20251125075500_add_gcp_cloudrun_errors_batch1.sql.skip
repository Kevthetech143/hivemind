-- Add GCP Cloud Run common errors and solutions - Batch 1

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'GCP Cloud Run: Container failed to start on PORT environment variable',
    'gcp-cloudrun',
    'VERY_HIGH',
    '[
        {"solution": "Verify container listens on 0.0.0.0 instead of 127.0.0.1 for the PORT environment variable", "percentage": 95, "note": "Cloud Run requires binding to all interfaces"},
        {"solution": "Test container locally first to ensure it starts and listens correctly", "percentage": 90, "note": "Use ''docker run -p 8080:8080'' to verify locally"},
        {"solution": "For ARM machines, use Cloud Build to compile 64-bit Linux binary", "percentage": 85, "note": "Native ARM builds may not be compatible"},
        {"solution": "Check Cloud Logging for stdout/stderr error messages from startup", "percentage": 88, "command": "gcloud logging read resource.type=cloud_run_revision"}
    ]'::jsonb,
    'Docker image built, Cloud Run service created, PORT environment variable set',
    'Container starts without errors, Service responds to requests on specified port, Logs show successful startup',
    'Do not bind to 127.0.0.1 - Cloud Run cannot reach it. Always use 0.0.0.0. Make sure binary is 64-bit Linux compiled.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://cloud.google.com/run/docs/troubleshooting#container-failed-to-start'
),
(
    'GCP Cloud Run: HTTP 429 - No available instances',
    'gcp-cloudrun',
    'HIGH',
    '[
        {"solution": "Increase the maximum instances limit in Cloud Run service settings", "percentage": 90, "note": "Check current quota in API console"},
        {"solution": "Implement exponential backoff and retry logic in client code", "percentage": 85, "note": "Start with 1 second delay, increase exponentially up to 60 seconds"},
        {"solution": "Check Cloud Monitoring metrics to confirm instance count has been reached", "percentage": 88, "command": "Check Cloud Monitoring for instance count metrics"},
        {"solution": "Request quota increase from GCP quotas panel if hitting limits", "percentage": 75, "note": "May take 24-48 hours for approval"}
    ]'::jsonb,
    'Cloud Run service deployed, Monitoring API enabled, API quotas page accessible',
    'HTTP 429 errors stop occurring after scaling increase, Requests succeed with fewer retries, Monitoring shows higher instance count',
    'Quota limits vary by region. Check quotas page before requesting increase. Autoscaling takes 60-90 seconds to add instances.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://cloud.google.com/run/docs/troubleshooting#http-429-no-available-instances'
),
(
    'GCP Cloud Run: HTTP 500 - Instance failed to start due to secrets',
    'gcp-cloudrun',
    'HIGH',
    '[
        {"solution": "Verify service account has roles/secretmanager.secretAccessor permission on Secret Manager", "percentage": 92, "note": "Use IAM policy for Cloud Run service account"},
        {"solution": "Check secret name and version are correctly specified in code", "percentage": 90, "command": "gcloud secrets list && gcloud secrets versions list SECRET_NAME"},
        {"solution": "Allow egress to secretmanager.googleapis.com if using VPC connector", "percentage": 88, "note": "Add firewall rules for Secret Manager API endpoint"},
        {"solution": "Add startup logging to debug secret access failures", "percentage": 85, "note": "Log before and after secret.access_secret_version() calls"}
    ]'::jsonb,
    'Service account created, Secret Manager API enabled, VPC connector configured (if applicable)',
    'Container starts successfully, Secret values accessible in application, No permission denied errors in logs',
    'Service account must have exact permission: roles/secretmanager.secretAccessor. Logging in startup is critical for debugging.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://cloud.google.com/run/docs/troubleshooting#http-500-instance-failed-to-start'
),
(
    'GCP Cloud Run: HTTP 500/503 - Container exceeds memory limit',
    'gcp-cloudrun',
    'HIGH',
    '[
        {"solution": "Increase memory allocation in Cloud Run service revision settings", "percentage": 93, "note": "Start with 512MB, increase in 128MB increments"},
        {"solution": "Check for memory leaks in application code using profiling tools", "percentage": 85, "note": "Use language-specific memory profilers"},
        {"solution": "Monitor /var/log/system for OOMKilled or container termination messages", "percentage": 88, "command": "gcloud logging read resource.type=cloud_run_revision severity=ERROR"},
        {"solution": "Review local filesystem writes - they count toward memory limit", "percentage": 87, "note": "Avoid logging to /tmp or files outside /var/log"}
    ]'::jsonb,
    'Cloud Monitoring enabled, Application deployed to Cloud Run, Container image available',
    'Memory usage stays below limit, No OOMKilled errors in logs, Container runs for >1 minute without termination',
    'Local filesystem writes count toward memory. Avoid temp files. Default max is 2GB but can be configured up to 8GB.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://cloud.google.com/run/docs/troubleshooting#http-500-container-exceeds-memory'
),
(
    'GCP Cloud Run: HTTP 401 - Client not authenticated with ID tokens',
    'gcp-cloudrun',
    'MEDIUM',
    '[
        {"solution": "Set correct audience (aud) claim in JWT ID token to match service URL", "percentage": 92, "note": "Use ''https://service-name-hash.region.run.app'' as audience"},
        {"solution": "Include Authorization header with Bearer ID_TOKEN in requests", "percentage": 93, "command": "curl -H ''Authorization: Bearer ID_TOKEN'' https://service-url"},
        {"solution": "Verify JWT token validity at jwt.io decoder", "percentage": 85, "note": "Check expiration time and claims"},
        {"solution": "Configure HTTP proxy exceptions for metadata server (169.254.*, *.google.internal)", "percentage": 80, "note": "Required for mTLS and identity lookups"}
    ]'::jsonb,
    'Identity Platform or IAM configured, Service protected with Authorization policy, ID tokens generated',
    'Requests receive 200 status instead of 401, Claims verified successfully, Service logs show authorized access',
    'Audience claim must match service URL exactly. Check for trailing slashes. ID tokens expire - refresh regularly.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://cloud.google.com/run/docs/troubleshooting#http-401-client-not-authenticated'
),
(
    'GCP Cloud Run: HTTP 403 - Client not authorized to invoke service',
    'gcp-cloudrun',
    'HIGH',
    '[
        {"solution": "Grant roles/run.invoker role to user or service account via IAM", "percentage": 94, "note": "Use gcloud iam service-accounts add-iam-policy-binding"},
        {"solution": "Update ingress settings to allow public access for testing", "percentage": 88, "note": "Set ingress to ''all'' temporarily for troubleshooting"},
        {"solution": "Verify service account membership in Cloud IAM bindings", "percentage": 90, "command": "gcloud run services get-iam-policy SERVICE_NAME"},
        {"solution": "Use Cloud Run Admin or Cloud Run Invoker role for proper permissions", "percentage": 92, "note": "Invoker role sufficient for calling, Admin role needed for management"}
    ]'::jsonb,
    'Service account exists, Cloud Run service deployed, IAM policy page accessible',
    'Requests receive 200/successful response, No 403 errors in logs, IAM bindings show correct role assignments',
    'HTTP 403 means authentication succeeded but authorization failed. Check exact role name (run.invoker not run.admin for invoke access).',
    0.93,
    'sonnet-4',
    NOW(),
    'https://cloud.google.com/run/docs/troubleshooting#http-403-client-not-authorized'
),
(
    'GCP Cloud Run: Connection reset by peer with database connections',
    'gcp-cloudrun',
    'MEDIUM',
    '[
        {"solution": "Enable TCP keepalive in socket options to detect stale connections", "percentage": 89, "note": "Set SO_KEEPALIVE socket option"},
        {"solution": "Implement connection retry logic for asyncpg, psycopg, or gRPC clients", "percentage": 90, "note": "Retry with exponential backoff"},
        {"solution": "Use instance-based billing model for background work to avoid connection resets", "percentage": 85, "note": "Request-based services disconnect idle connections"},
        {"solution": "Validate and reconnect if using HTTP proxy after infrastructure updates", "percentage": 82, "note": "Cloud Run infrastructure may reset connections during updates"}
    ]'::jsonb,
    'Database service accessible, Application uses connection pooling, Network connectivity verified',
    'Connections established successfully, No ''Connection reset'' errors in application logs, Requests complete without premature termination',
    'Cloud Run has 24-hour outbound request timeout. Long-lived connections will fail. Use connection pooling with max idle timeout.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://cloud.google.com/run/docs/troubleshooting#connection-reset-by-peer'
),
(
    'GCP Cloud Run: HTTP 504 - Gateway timeout on long requests',
    'gcp-cloudrun',
    'MEDIUM',
    '[
        {"solution": "Increase request timeout in Cloud Run revision settings (max 3600 seconds)", "percentage": 91, "note": "Default is 300 seconds (5 minutes)"},
        {"solution": "Add distributed tracing/logging to identify slow operations", "percentage": 85, "note": "Use Cloud Trace to pinpoint bottlenecks"},
        {"solution": "Implement timeout handling for long-lived connections with reconnection logic", "percentage": 88, "note": "Gracefully handle timeouts and retry"},
        {"solution": "Enable HTTP/2 if handling >800 requests/second", "percentage": 82, "note": "Improves multiplexing and reduces latency"}
    ]'::jsonb,
    'Cloud Run revision deployed, Application handles timeouts gracefully, Cloud Trace enabled',
    'Requests complete within timeout window, No 504 errors in logs, Tracing shows request completion time <timeout',
    'Max timeout is 3600 seconds (1 hour). 504 means request exceeded timeout - must optimize or increase timeout. HTTP/2 helps at scale.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://cloud.google.com/run/docs/troubleshooting#http-504-gateway-timeout'
),
(
    'GCP Cloud Run: Container import error with non-UTF8 characters',
    'gcp-cloudrun',
    'LOW',
    '[
        {"solution": "Remove non-UTF8 characters from filesystem paths and filenames", "percentage": 92, "note": "Use ASCII-safe filenames only"},
        {"solution": "Avoid Windows Docker images with foreign layers on non-Windows systems", "percentage": 88, "note": "Use Linux base images instead"},
        {"solution": "Use --allow-nondistributable-artifacts flag if absolutely necessary", "percentage": 70, "note": "Not recommended - prefer fixing encoding issues"},
        {"solution": "Rebuild container image ensuring UTF-8 encoding in all files", "percentage": 90, "command": "docker build -t gcr.io/project/image:tag ."}
    ]'::jsonb,
    'Docker image source available, Git repository with files, Build environment configured',
    'Container imports successfully, No encoding errors in build logs, Image runs without I/O errors',
    'Non-UTF8 characters often hidden in filenames. Check all paths in Dockerfile and source files. Clean build recommended.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://cloud.google.com/run/docs/troubleshooting#container-import-error'
),
(
    'GCP Cloud Run: Python source deployment HTTP 500 - missing web server',
    'gcp-cloudrun',
    'HIGH',
    '[
        {"solution": "Add WSGI web server to requirements.txt (gunicorn, uvicorn, or waitress)", "percentage": 93, "note": "Example: echo ''gunicorn==20.1.0'' >> requirements.txt"},
        {"solution": "Specify entrypoint via --set-build-env-vars GOOGLE_ENTRYPOINT=app:app", "percentage": 90, "command": "gcloud run deploy --set-build-env-vars GOOGLE_ENTRYPOINT=main:app"},
        {"solution": "Use Procfile to define custom entrypoint if complex setup needed", "percentage": 85, "note": "Procfile: web: gunicorn main:app"},
        {"solution": "Verify app exports Flask/FastAPI application object correctly", "percentage": 88, "note": "Object must be named ''app'' or specified in GOOGLE_ENTRYPOINT"}
    ]'::jsonb,
    'Python application code ready, requirements.txt configured, Build configuration accessible',
    'HTTP requests return 200 status, Service starts without errors, Logs show successful application startup',
    'Cloud Run buildpacks require WSGI server. Do not rely on Flask/FastAPI dev server. Entrypoint must reference module:app_object.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://cloud.google.com/run/docs/troubleshooting#python-source-code-deployment'
),
(
    'GCP Cloud Run: Connection timeout with VPC Connector',
    'gcp-cloudrun',
    'MEDIUM',
    '[
        {"solution": "Define necessary firewall rules to allow outbound traffic through VPC connector", "percentage": 91, "note": "Allow Cloud Run to reach internal resources"},
        {"solution": "Verify network routes exist for hybrid connectivity destinations", "percentage": 89, "note": "Check VPC routing table for correct route configuration"},
        {"solution": "Ensure remote hosts are reachable via configured HTTP proxy rules", "percentage": 85, "note": "Use gcloud compute routes list to verify"},
        {"solution": "Implement retries and exponential backoff for transient network failures", "percentage": 87, "command": "Start with 1s delay, exponential backoff up to 60s"}
    ]'::jsonb,
    'VPC Connector created and configured, Firewall rules accessible, Remote service reachable',
    'Connections established to internal resources, No timeout errors in logs, Requests complete successfully',
    'VPC Connector has throughput limits. Check quotas. Firewall rules must explicitly allow egress. Metadata server needs exemptions (169.254.*).',
    0.88,
    'sonnet-4',
    NOW(),
    'https://cloud.google.com/run/docs/troubleshooting#connection-timeouts'
);
