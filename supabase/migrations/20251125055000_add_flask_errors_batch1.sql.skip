-- Add Flask framework common errors batch 1
-- Extracted from official Flask documentation: https://flask.palletsprojects.com/en/stable/

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Flask 404 error handler not triggered for invalid URL access',
    'flask',
    'HIGH',
    '[
        {"solution": "Define 404 error handler at application level, not blueprint level", "percentage": 95, "note": "Blueprints cannot intercept routing errors due to URL ownership limitations"},
        {"solution": "Use @app.errorhandler(404) instead of @blueprint.errorhandler(404) for application-wide handling", "percentage": 90, "command": "@app.errorhandler(404)"},
        {"solution": "Inspect request.path in handler to determine origin and route accordingly", "percentage": 85, "note": "Blueprint-specific routing errors must be handled at app level"}
    ]'::jsonb,
    'Flask application running, routes defined',
    'Invalid URLs return custom 404 page, error handler executes on unregistered routes',
    'Error handlers at blueprint level only work for view function errors, not URL routing errors. Always define 404/405 handlers at application level.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/blueprints/'
),
(
    'Flask development server used in production environment',
    'flask',
    'VERY_HIGH',
    '[
        {"solution": "Deploy with a production WSGI server like Gunicorn", "percentage": 95, "note": "Use: gunicorn -w 4 -b 0.0.0.0:5000 app:app", "command": "pip install gunicorn && gunicorn app:app"},
        {"solution": "Use alternative WSGI servers: Waitress, uWSGI, or mod_wsgi", "percentage": 90, "note": "Choose based on application requirements and hosting platform"},
        {"solution": "Place HTTP reverse proxy (nginx, Apache) in front of WSGI server", "percentage": 88, "note": "Improves security, efficiency, and capability"}
    ]'::jsonb,
    'Flask application code complete, deployment platform available',
    'Application runs on production WSGI server, reverse proxy handles HTTP requests, no security warnings',
    'The Flask development server is not designed to be secure, stable, or efficient. Never use app.run() or flask run in production. Always use a proper WSGI server.',
    0.98,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/deploying/'
),
(
    'Flask route returns 405 Method Not Allowed but developer expects GET to work',
    'flask',
    'HIGH',
    '[
        {"solution": "Explicitly declare HTTP methods in route decorator: @app.route(\"/path\", methods=[\"GET\", \"POST\"])", "percentage": 95, "note": "Default is GET-only; POST requires explicit declaration", "command": "@app.route(\"/path\", methods=[\"GET\", \"POST\"])"},
        {"solution": "Check form submissions include correct method attribute", "percentage": 85, "note": "HTML forms default to GET method"},
        {"solution": "For DELETE/PUT requests, verify client sends correct HTTP method header", "percentage": 80, "note": "Some JavaScript libraries require explicit method specification"}
    ]'::jsonb,
    'Flask application running, route defined',
    'Requests to route return 200 status, correct HTTP methods accepted',
    'Routes only accept GET requests by default. Always specify methods=[...] parameter for POST, PUT, DELETE, PATCH. Forgetting this is the most common cause of 405 errors.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/quickstart/'
),
(
    'Flask test client fails to access session data after request',
    'flask',
    'HIGH',
    '[
        {"solution": "Access session only within \"with client:\" context: \"with client: response = client.get(\\\"/\\\"); assert session[\\\"key\\\"]\"", "percentage": 95, "note": "Session is only accessible after request within context block", "command": "with client: response = client.get(\\\"/\\\")"},
        {"solution": "Use client.session_transaction() context manager for preset session values before request", "percentage": 90, "note": "Allows bypassing login workflows during testing"},
        {"solution": "Manually create request context with app.test_request_context() for non-request testing", "percentage": 85, "command": "with app.test_request_context(): ..."}
    ]'::jsonb,
    'Flask test client created, test route exists',
    'Session values accessible after request within context, test assertions pass on session data',
    'Session is only available after making a request within the \"with client:\" block. Accessing session outside this context will raise AttributeError. before_request functions are not called by test client.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/testing/'
),
(
    'Flask application logs missing or duplicate handlers added unexpectedly',
    'flask',
    'MEDIUM',
    '[
        {"solution": "Configure logging before accessing app.logger to avoid automatic default handler", "percentage": 95, "note": "Accessing app.logger first adds default handler; configure logging first", "command": "logging.basicConfig(...) before accessing app.logger"},
        {"solution": "Check for duplicate handlers: use logger.handlers to inspect current handlers", "percentage": 88, "note": "Multiple handlers cause duplicate log messages"},
        {"solution": "Set Python root log level explicitly: logging.getLogger().setLevel(logging.INFO)", "percentage": 85, "note": "Default log level is WARNING, missing INFO and DEBUG messages"}
    ]'::jsonb,
    'Flask application with logging configuration',
    'Log messages appear once without duplication, correct log level shows INFO and DEBUG messages',
    'Accessing app.logger before configuring logging automatically adds a default handler. Always configure logging before accessing app.logger to avoid duplicates. Default Python log level is WARNING.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/logging/'
),
(
    'Flask request context not available when accessing session or request object',
    'flask',
    'HIGH',
    '[
        {"solution": "Use app.test_request_context() context manager outside HTTP requests", "percentage": 95, "note": "Manually create request context for non-request code", "command": "with app.test_request_context(\\\"/path\\\"): ..."},
        {"solution": "Access request/session only inside view functions or within active context", "percentage": 90, "note": "These objects require active request context"},
        {"solution": "Use has_request_context() to check context before accessing request data", "percentage": 85, "note": "Prevents AttributeError in background tasks or logging"}
    ]'::jsonb,
    'Flask application with routes and context-dependent code',
    'Request context available when needed, no AttributeError on request/session access',
    'request and session objects are only available within an active request context. Accessing them outside will raise RuntimeError. Use app.test_request_context() or has_request_context() to work around this.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/templating/'
),
(
    'Flask form submission fails silently or returns 400 error without file upload',
    'flask',
    'HIGH',
    '[
        {"solution": "Add enctype=\"multipart/form-data\" to HTML form when uploading files", "percentage": 98, "note": "Without this attribute, file upload data is not sent to server", "command": "<form method=\"POST\" enctype=\"multipart/form-data\">"},
        {"solution": "Use request.files[\"filename\"] in Flask route to access uploaded files", "percentage": 95, "note": "Files are in request.files, not request.form"},
        {"solution": "Validate using werkzeug.utils.secure_filename() to prevent path traversal attacks", "percentage": 90, "note": "Never trust client-provided filenames"}
    ]'::jsonb,
    'Flask application with form handling routes, HTML form template',
    'File uploads succeed, files saved with secure names, no 400 errors',
    'Forms with file uploads fail silently if enctype=\"multipart/form-data\" is missing. Always include this in form HTML. Never use client-provided filenames directly; always pass through secure_filename().',
    0.95,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/quickstart/'
),
(
    'Flask KeyError when accessing missing form data or query parameters',
    'flask',
    'HIGH',
    '[
        {"solution": "Use request.form.get(\"key\", default_value) instead of request.form[\"key\"]", "percentage": 98, "note": "Direct dictionary access raises KeyError for missing keys", "command": "value = request.form.get(\"key\", \"default\")"},
        {"solution": "Same pattern for query parameters: request.args.get(\"key\", default)", "percentage": 95, "note": "Use .get() for all optional form/query data"},
        {"solution": "Validate required fields separately before accessing", "percentage": 85, "note": "Check presence first, then access"}
    ]'::jsonb,
    'Flask application with form or query parameter handling',
    'Form/query access returns default values, no KeyError exceptions, missing parameters handled gracefully',
    'Accessing request.form[\"key\"] or request.args[\"key\"] directly raises KeyError if key is missing. Always use .get() method with default value for optional data to prevent 400 errors.',
    0.97,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/quickstart/'
),
(
    'Flask blueprint routes not accessible - blueprint not registered',
    'flask',
    'HIGH',
    '[
        {"solution": "Register blueprint on app instance: app.register_blueprint(blueprint_name)", "percentage": 98, "note": "Blueprint routes are not active until explicitly registered", "command": "app.register_blueprint(auth_bp)"},
        {"solution": "Register with URL prefix: app.register_blueprint(blueprint_name, url_prefix=\"/auth\")", "percentage": 95, "note": "Add URL prefix to organize routes"},
        {"solution": "Verify blueprint object exists and is correct type", "percentage": 85, "note": "Typos in blueprint name cause silent failures"}
    ]'::jsonb,
    'Flask application with blueprint defined, blueprint object exists',
    'Blueprint routes accessible at expected URLs, requests return 200, routes registered in app',
    'Blueprints must be explicitly registered with app.register_blueprint(). Routes defined in unregistered blueprints are completely inaccessible and will return 404. Always register blueprints in application factory.',
    0.98,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/blueprints/'
),
(
    'Flask async view functions cancel background tasks before completion',
    'flask',
    'MEDIUM',
    '[
        {"solution": "Use Celery or RQ task queue instead of asyncio.create_task() for background work", "percentage": 95, "note": "Background tasks spawned in async views are cancelled when view completes"},
        {"solution": "For IO-bound operations, use async views; for CPU-bound, use sync views", "percentage": 88, "note": "Async views only improve performance for concurrent IO operations"},
        {"solution": "Consider Quart framework instead of Flask for primarily async codebases", "percentage": 80, "note": "Quart is Flask-compatible but built on ASGI for true async support"}
    ]'::jsonb,
    'Flask application with async view functions, Python 3.7+, asyncio imported',
    'Background tasks complete successfully, no cancellation errors, task queue functioning',
    'Flask WSGI architecture cancels spawned tasks when async function completes. asyncio.create_task() will not work for background jobs. Always use task queues for background work. Each async request still consumes one worker.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/async-await/'
),
(
    'Flask debugger exposed in production with security risk',
    'flask',
    'HIGH',
    '[
        {"solution": "Never enable debug mode (debug=True or --debug flag) in production", "percentage": 99, "note": "Debugger allows arbitrary Python code execution from browser"},
        {"solution": "Use logging and error tracking (Sentry) instead of interactive debugger in production", "percentage": 95, "note": "Sentry or similar service provides error tracking without security risk", "command": "pip install sentry-sdk && sentry_sdk.init()"},
        {"solution": "For external IDE debugging, disable Flask debugger with --no-debugger --no-reload flags", "percentage": 90, "note": "Prevents conflict between Flask and IDE debuggers"}
    ]'::jsonb,
    'Flask application configured for production, error tracking system available',
    'Debug mode disabled in production, error tracking functional, no access to interactive debugger',
    'The Flask debugger presents critical security vulnerability and allows executing arbitrary Python code from the browser. Never use in production. Even with PIN, it should not be deployed. Always use debug=False in production.',
    0.99,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/debugging/'
),
(
    'Flask template autoescaping not working or XSS vulnerability from unsafe output',
    'flask',
    'MEDIUM',
    '[
        {"solution": "Rely on default Jinja2 autoescaping for .html/.htm/.xml/.xhtml files", "percentage": 95, "note": "Autoescaping enabled by default for these extensions"},
        {"solution": "Use Markup class in Python instead of disabling autoescaping: from markupsafe import Markup", "percentage": 90, "note": "Wrap trusted HTML strings with Markup() rather than turning off autoescape"},
        {"solution": "Use |escape filter in templates for non-HTML files or to escape specific variables", "percentage": 85, "command": "{{ user_input|escape }}"},
        {"solution": "Avoid {% autoescape false %} blocks or |safe filter unless absolutely necessary", "percentage": 80, "note": "Only use for trusted content; creates XSS vulnerability otherwise"}
    ]'::jsonb,
    'Flask application with Jinja2 templates, user input in templates',
    'User input properly escaped in output, no XSS vulnerabilities in security scan, HTML renders correctly',
    'Autoescaping is enabled by default for .html files but disabled for other extensions. Never use |safe filter or {% autoescape false %} with user input. Always use Markup() in Python code for trusted HTML instead of disabling escaping.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://flask.palletsprojects.com/en/stable/templating/'
);
