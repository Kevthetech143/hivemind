-- Add Cargo (Rust package manager) common errors batch 1
-- Extracted from official Rust/Cargo documentation: https://doc.rust-lang.org/cargo/

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Cargo failed to select a version for dependency due to version conflict',
    'cargo',
    'HIGH',
    '[
        {"solution": "Check for duplicate links field values - only one package may specify the same links value. Run cargo tree to inspect dependencies.", "percentage": 85, "note": "links field is exclusive per dependency graph"},
        {"solution": "Modify version constraints to make them consistent across all dependencies. Use cargo check to validate resolution.", "percentage": 90, "command": "cargo check"},
        {"solution": "When using direct-minimal-versions, adjust direct dependency versions to meet SemVer requirements. Run cargo update --aggressive.", "percentage": 80, "command": "cargo update --aggressive"},
        {"solution": "Verify the dependent crate version supports your chosen features. Use cargo tree --edges features to check.", "percentage": 85, "command": "cargo tree --edges features"}
    ]'::jsonb,
    'Rust toolchain installed, Project with Cargo.toml, Conflicting dependencies present',
    'cargo check completes successfully, No version conflict error message, Lockfile resolves to compatible versions',
    'Duplicate links values silently cause failures. Default features may be automatically enabled when not desired. Feature unification issues occur with resolver v1.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/faq.html'
),
(
    'Cargo unexpectedly rebuilds code or dependencies when no changes were made',
    'cargo',
    'HIGH',
    '[
        {"solution": "Check build scripts for rerun-if-changed directives referencing non-existent files. Use CARGO_LOG=cargo::core::compiler::fingerprint=info to debug.", "percentage": 90, "command": "CARGO_LOG=cargo::core::compiler::fingerprint=info cargo build"},
        {"solution": "Verify feature flags remain consistent between builds. Feature variations trigger rebuilds. Use cargo tree -e features to inspect.", "percentage": 85, "command": "cargo tree -e features"},
        {"solution": "Check for unusual filesystem timestamp behavior or background processes modifying build artifacts. Use cargo clean to reset state.", "percentage": 75, "command": "cargo clean && cargo build"},
        {"solution": "Review rerun-if directives in build scripts - conservative rebuilds happen when directives are missing or overly broad.", "percentage": 80, "note": "env! and option_env! macros automatically trigger rebuilds in Rust 1.46+"}
    ]'::jsonb,
    'Cargo project with build.rs script, Completed at least one build',
    'Build completes without rebuilding unchanged code, Subsequent builds with no changes complete quickly, Timestamps match expected patterns',
    'Build scripts without rerun-if directives cause conservative rebuilds. Filesystem timestamp issues on some systems affect change detection. env! macro changes trigger rebuilds automatically.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/faq.html'
),
(
    'Cargo build script fails with unexpected_cfgs compiler warning',
    'cargo',
    'MEDIUM',
    '[
        {"solution": "Declare custom cfgs using cargo::rustc-check-cfg directive in build.rs. Example: println!(\"cargo::rustc-check-cfg=cfg(my_cfg)\");", "percentage": 95, "note": "Required for Rust 1.77+ or with MSRV restrictions"},
        {"solution": "Add unexpected_cfgs to RUSTFLAGS with allow attribute if not using build.rs. Use: RUSTFLAGS=\"--cap-lints warn\" cargo build", "percentage": 70, "command": "cargo::rustc-check-cfg=cfg(custom_config)"}
    ]'::jsonb,
    'Cargo project with build.rs using custom cfgs, Rust 1.77 or later',
    'No unexpected_cfgs warnings during compilation, Build completes successfully, Custom cfg is recognized by compiler',
    'Custom cfgs must be declared before use. Without declaration, all custom cfgs generate warnings. cargo::rustc-check-cfg is the correct solution, not just suppressing warnings.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/reference/build-scripts.html'
),
(
    'Cargo build script metadata not available in nested dependencies',
    'cargo',
    'MEDIUM',
    '[
        {"solution": "Metadata is only passed to immediate dependents, not transitive dependents. Ensure metadata is set directly in the build.rs of the immediate dependency.", "percentage": 90, "note": "This is by design to prevent implicit coupling"},
        {"solution": "If nested dependencies need metadata, add the dependency directly to your Cargo.toml instead of relying on transitive propagation.", "percentage": 85, "note": "Breaks transitive dependency clarity"}
    ]'::jsonb,
    'Multi-level dependency chain with build.rs metadata, Cargo project',
    'Build script receives metadata for direct dependencies, No metadata propagation to nested levels, Correct scope of metadata is respected',
    'Metadata only reaches immediate dependents. Transitive propagation does not occur. Developers often assume metadata cascades through dependency chains.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/reference/build-scripts.html'
),
(
    'Cargo fails to resolve dependencies with native library linking conflicts on links field',
    'cargo',
    'MEDIUM',
    '[
        {"solution": "Ensure only one package specifies each links value. If libgit2-sys 0.11 and 0.12 both specify links=libgit2, Cargo cannot unify them. Choose one version.", "percentage": 92, "command": "cargo tree --invert libgit2-sys"},
        {"solution": "Use cargo tree --workspace --target all --all-features --invert [package] to identify all dependent versions and conflicting links values.", "percentage": 88, "command": "cargo tree --workspace --target all --all-features --invert libgit2-sys"}
    ]'::jsonb,
    'Project with multiple versions of same native library dependency, Cargo project',
    'Dependencies resolve to single version, No native library linking conflict error, cargo tree shows unified version',
    'The links field constraint is strict - only one instance per dependency graph. Breaking patch releases in native library crates cause cascading failures. Pinning with --precise helps temporarily.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/reference/resolver.html'
),
(
    'Cargo.toml validation fails for crates.io publishing - missing or invalid metadata',
    'cargo',
    'HIGH',
    '[
        {"solution": "For crates.io publishing, set license field using valid SPDX 2.3 license expression, or license-file field pointing to LICENSE file. Both are required.", "percentage": 95, "command": "license = \"MIT\" or license-file = \"LICENSE\""},
        {"solution": "Add description field - crates.io requires this and displays it in package listing. Keep under 256 characters.", "percentage": 95, "command": "description = \"Brief description of package\""},
        {"solution": "Verify package name contains only alphanumeric chars, hyphens, underscores. Max 64 ASCII characters, not Windows reserved names. No uppercase.", "percentage": 90, "command": "cargo check"},
        {"solution": "Add at most 5 keywords (20 chars each) and 5 categories using exact strings from crates.io category_slugs list.", "percentage": 85, "command": "keywords = [\"web\", \"api\"] and categories = [\"web-programming\"]"}
    ]'::jsonb,
    'Package ready to publish, Valid SPDX license identifier list available, Crates.io account',
    'cargo publish succeeds, Package appears on crates.io, All metadata displays correctly',
    'Invalid SPDX license strings reject publication. Categories must use exact strings from crates.io. Windows reserved names are rejected. Keywords over 20 chars are rejected.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/reference/manifest.html'
),
(
    'Cargo workspace config files in subdirectories are ignored',
    'cargo',
    'MEDIUM',
    '[
        {"solution": "Place shared configuration at workspace root level in .cargo/config.toml. Individual crate configs in subdirectories are not read when Cargo runs from workspace root.", "percentage": 92, "note": "By design - only root config is loaded"},
        {"solution": "If crate-specific config is needed, use target-specific settings in root config or environment variables. Run from crate directory if necessary.", "percentage": 75, "note": "Changes working directory semantics"}
    ]'::jsonb,
    'Workspace with multiple crates, .cargo/config.toml files in crate subdirectories',
    'Configuration from workspace root is applied, No config from crate subdirectories loaded, cargo build respects root settings',
    'Individual crate .cargo/config.toml files are silently ignored when running from workspace root. Developers expect hierarchical config inheritance like other tools.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/reference/config.html'
),
(
    'Cargo config file not loaded due to wrong filename or extension',
    'cargo',
    'MEDIUM',
    '[
        {"solution": "Use .cargo/config.toml extension (preferred since v1.39). Cargo reads both .cargo/config (legacy) and .cargo/config.toml, but .toml version is recommended.", "percentage": 95, "note": "If both exist, non-extension version takes precedence"},
        {"solution": "If migrating from .cargo/config to .cargo/config.toml, delete the old file. Presence of both causes the legacy version to be used.", "percentage": 90, "command": "rm .cargo/config"}
    ]'::jsonb,
    'Cargo workspace, .cargo/ directory created',
    'Config file is loaded and settings applied, cargo build respects configuration values, No duplicate config files exist',
    'Legacy .cargo/config (no extension) takes precedence over .cargo/config.toml if both exist. Cargo silently prefers the wrong file. Extension handling differs from most tools.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/reference/config.html'
),
(
    'Cargo relative paths in config files resolve unexpectedly or fail',
    'cargo',
    'MEDIUM',
    '[
        {"solution": "Remember paths in config files are relative to parent directory of config file, not the config file itself or cwd. For /projects/foo/.cargo/config.toml, path = \"bar\" refers to /projects/foo/bar.", "percentage": 92, "note": "This differs from environment variables which are relative to cwd"},
        {"solution": "Use absolute paths when uncertain. Paths starting with / or using variables like $HOME are unambiguous.", "percentage": 88, "command": "path = \"/absolute/path/to/tool\""},
        {"solution": "For executables in PATH, use bare name. For non-executables, use absolute path or relative to config file parent.", "percentage": 85}
    ]'::jsonb,
    'Cargo project with .cargo/config.toml containing paths, Unix-like system',
    'Paths resolve to correct locations, Tools/binaries are found and executed, No file not found errors',
    'Relative path resolution differs from environment variables - developers commonly mix up the base directory. Relative paths are relative to config parent, not cwd or config file location.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/reference/config.html'
),
(
    'Cargo compilation fails due to conflicting feature flags across dependency tree',
    'cargo',
    'MEDIUM',
    '[
        {"solution": "Use resolver = \"2\" in Cargo.toml to avoid unifying features in platform-specific, build, and dev-dependencies. Resolver v1 unifies all uses.", "percentage": 90, "command": "resolver = \"2\" in [package] section"},
        {"solution": "Explicitly disable default features where needed: dependency = { version = \"1.0\", default-features = false }. Default features auto-enable.", "percentage": 95, "command": "default-features = false"},
        {"solution": "Use cargo tree -e features to visualize which packages enabled conflicting features on dependencies.", "percentage": 85, "command": "cargo tree -e features"}
    ]'::jsonb,
    'Multi-crate project with mixed feature requirements, Resolver v1 or v2 available',
    'Compilation succeeds with correct feature set, No feature conflict errors, cargo tree shows clean feature activation',
    'Default features are automatically enabled unless explicitly disabled. Resolver v1 unifies features across all uses including build-deps. Conflicting feature activation is hard to debug without cargo tree -e features.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/reference/features.html'
),
(
    'Cargo optimization level surprises - higher optimization levels unexpectedly slower',
    'cargo',
    'LOW',
    '[
        {"solution": "Experiment with different optimization levels. Level 3 can be slower than 2 due to code rearrangement and branch prediction impacts. Measure with realistic workloads.", "percentage": 80, "command": "cargo build --release"},
        {"solution": "Use opt-level = 2 as baseline for production. If performance critical, benchmark opt-level = 3 against 2. Link-time optimizations also impact speed.", "percentage": 85, "note": "Use cargo build -r or adjust [profile.release] opt-level"},
        {"solution": "For development, use opt-level = 1 to share monomorphized code between crates while maintaining fast compilation.", "percentage": 75, "command": "[profile.dev] opt-level = 1"}
    ]'::jsonb,
    'Release build configured with optimization, Performance profiling tools available, CPU with predictable branch patterns',
    'Binary performs well with chosen optimization level, Build time is acceptable, No significant slowdowns from aggressive optimization',
    'Higher optimization levels may reduce performance in some workloads. Optimization impacts vary by code structure. Debug info rearrangement makes debugger usage difficult. LTO increases linking time significantly.',
    0.82,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/reference/profiles.html'
),
(
    'Cargo build script output not visible during compilation',
    'cargo',
    'MEDIUM',
    '[
        {"solution": "Normal build script output is hidden by default. Use -vv (very verbose) flag to display output: cargo build -vv", "percentage": 95, "command": "cargo build -vv"},
        {"solution": "In build.rs, use println!() to stdout (lines prefixed with cargo:); use eprintln!() to stderr for debugging without cargo: prefix.", "percentage": 88, "note": "Only cargo: lines are processed as directives"},
        {"solution": "Use CARGO_LOG=cargo::core::compiler=debug to see detailed build system logs including when scripts execute.", "percentage": 80, "command": "CARGO_LOG=cargo::core::compiler=debug cargo build"}
    ]'::jsonb,
    'Cargo project with build.rs script, Verbose output flag enabled',
    'Build script output appears in terminal with -vv flag, Debug output is visible, Script execution order is clear',
    'Build script output is silently hidden by default - developers assume scripts are not running. Normal println!() output requires -vv to display. Only cargo: prefixed lines are processed as directives.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://doc.rust-lang.org/cargo/reference/build-scripts.html'
);
