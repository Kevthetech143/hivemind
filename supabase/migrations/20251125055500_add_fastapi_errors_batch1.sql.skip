-- Add FastAPI common errors and solutions batch 1
-- Extracted from official FastAPI documentation: https://fastapi.tiangolo.com/

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'FastAPI HTTPException not being raised properly or returns wrong status code',
    'fastapi',
    'HIGH',
    '[
        {"solution": "Raise HTTPException instead of returning it: raise HTTPException(status_code=404, detail=\"Item not found\")", "percentage": 95, "note": "HTTPException must be raised, not returned"},
        {"solution": "Verify status_code parameter is an integer between 100-599", "percentage": 90, "note": "Invalid status codes will cause errors"},
        {"solution": "Use dict or JSON-serializable objects in detail field, not just strings", "percentage": 85, "note": "FastAPI HTTPException accepts any JSON-serializable detail"}
    ]'::jsonb,
    'FastAPI application running, requests being made',
    'HTTP response returns correct status code, error detail message appears in response body',
    'Do not return HTTPException - always raise it. Ensure detail field contains JSON-serializable data. Remember HTTPException differs from Starlette version.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/handling-errors/'
),
(
    'FastAPI missing required query parameter returns 422 validation error',
    'fastapi',
    'VERY_HIGH',
    '[
        {"solution": "Add required parameter to function signature: def get_item(needy: str)", "percentage": 95, "note": "Parameters without defaults are required"},
        {"solution": "Make parameter optional by adding default: needy: str | None = None", "percentage": 92, "note": "None default makes parameter optional"},
        {"solution": "Check query string URL contains all required parameters", "percentage": 85, "note": "Validate client is sending expected parameters"}
    ]'::jsonb,
    'FastAPI endpoint defined, test client making requests',
    'Endpoint accepts requests with parameter provided, 422 error disappears when parameter added',
    'Required parameters need no default value. Optional parameters require = None. Remember that missing required query params trigger 422 validation errors.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/query-params/'
),
(
    'FastAPI path parameter validation fails for integer/enum types',
    'fastapi',
    'HIGH',
    '[
        {"solution": "Declare path parameter with correct type: def get_item(item_id: int)", "percentage": 95, "note": "Type conversion happens automatically"},
        {"solution": "For enums, create class inheriting from str and Enum: class ModelName(str, Enum)", "percentage": 90, "note": "Must inherit from both str and Enum for FastAPI validation"},
        {"solution": "Verify URL path matches declared parameter type - strings will fail if int is expected", "percentage": 88, "note": "Invalid types in path return 422 error"}
    ]'::jsonb,
    'FastAPI application with typed path parameters, test requests with different types',
    'Path parameter accepts valid values, returns 422 only for invalid type conversions',
    'Path parameters must match declared types exactly. FastAPI performs automatic type conversion. Invalid values like floats for integer paths trigger 422 errors.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/path-params/'
),
(
    'FastAPI Pydantic validation error on request body - Field required or type mismatch',
    'fastapi',
    'VERY_HIGH',
    '[
        {"solution": "Define Pydantic BaseModel with correct field types: class Item(BaseModel): name: str, price: float", "percentage": 95, "note": "All required fields must be provided"},
        {"solution": "Make fields optional using union types: description: str | None = None", "percentage": 93, "note": "Use None default for optional fields"},
        {"solution": "Ensure request JSON matches model structure exactly - nested objects require nested models", "percentage": 90, "note": "Type validation is strict"}
    ]'::jsonb,
    'Pydantic models defined, JSON request body being sent',
    'Request body validates successfully, 422 error contains detailed field-level error information',
    'All required model fields must be present in request. Type conversion is automatic but strict. Missing fields and type mismatches both return 422 validation errors.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/body/'
),
(
    'FastAPI CORS error - Browser blocks cross-origin request with Access-Control-Allow-Origin missing',
    'fastapi',
    'HIGH',
    '[
        {"solution": "Add CORSMiddleware to app: app.add_middleware(CORSMiddleware, allow_origins=[\"http://localhost:8080\"])", "percentage": 95, "note": "Must be added before other middleware"},
        {"solution": "Ensure frontend and backend origins match exactly (protocol, domain, port)", "percentage": 92, "note": "http://localhost:3000 differs from http://localhost:8080"},
        {"solution": "For credentials, explicitly list origins instead of using wildcard: allow_origins=[\"http://...\"]. Cannot mix credentials with allow_origins=[\"*\"]", "percentage": 90, "note": "Critical constraint for credentialed requests"}
    ]'::jsonb,
    'FastAPI app with middleware setup, frontend making cross-origin requests',
    'Browser no longer blocks requests, preflight OPTIONS requests return 200, Access-Control-Allow-Origin header present',
    'Wildcard allow_origins=["*"] blocks credential-based requests. Must explicitly list all origins for credentialed CORS. Middleware order matters - add CORS early.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/cors/'
),
(
    'FastAPI uvicorn.run() executes on module import without if __name__ == "__main__" guard',
    'fastapi',
    'HIGH',
    '[
        {"solution": "Wrap server startup in main guard: if __name__ == \"__main__\": uvicorn.run(...)", "percentage": 96, "note": "Prevents execution during imports"},
        {"solution": "Use fastapi dev command instead: fastapi dev main.py", "percentage": 93, "note": "Recommended over manual uvicorn.run()"},
        {"solution": "For debugging, call uvicorn.run() directly in debug guard with debugger attached", "percentage": 88, "note": "Enables breakpoint functionality"}
    ]'::jsonb,
    'FastAPI project with uvicorn setup, debugging enabled',
    'Server starts only when script runs directly, not when imported. Debugger can attach to uvicorn process.',
    'Without if __name__ guard, server starts unexpectedly during imports. Always use guard for module safety. IDE debuggers work best with direct uvicorn.run() calls.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/debugging/'
),
(
    'FastAPI custom exception handler not catching exceptions - using wrong decorator or not imported',
    'fastapi',
    'MEDIUM',
    '[
        {"solution": "Import exception handler from fastapi: from fastapi import Request, HTTPException", "percentage": 95, "note": "Correct imports are essential"},
        {"solution": "Use @app.exception_handler() decorator: @app.exception_handler(CustomException)", "percentage": 94, "note": "Must decorate handler function"},
        {"solution": "Handler receives Request and exception: async def handler(request: Request, exc: CustomException)", "percentage": 90, "note": "Signature must match expected format"},
        {"solution": "Return JSONResponse or RedirectResponse with status_code", "percentage": 85, "note": "Handler must return valid response object"}
    ]'::jsonb,
    'FastAPI app with custom exception classes, handlers defined',
    'Custom exceptions caught by handlers, response returns expected status code and content',
    'Exception handler decorator must target the specific exception class. Handler signature must accept Request and exception. Must return valid response object, not raise.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/handling-errors/'
),
(
    'FastAPI response model validation fails or sensitive fields leak in response',
    'fastapi',
    'MEDIUM',
    '[
        {"solution": "Define separate output model without sensitive fields: class UserOut(BaseModel): id: int, email: str (no password field)", "percentage": 96, "note": "Security best practice"},
        {"solution": "Use response_model parameter: @app.post(\"/users/\", response_model=UserOut)", "percentage": 95, "note": "Enforces response schema"},
        {"solution": "FastAPI automatically filters response to match model - fields not in model are excluded", "percentage": 93, "note": "Automatic filtering provides security"},
        {"solution": "Use response_model_exclude_unset=True to omit fields with default values", "percentage": 85, "note": "Reduces response size"}
    ]'::jsonb,
    'Pydantic models defined, endpoints returning database objects',
    'Response contains only declared fields, passwords or sensitive data not in response, validation passes',
    'Always create separate input (with passwords) and output (without) models. response_model parameter is security-critical. Fields not in response_model are automatically excluded.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/response-model/'
),
(
    'FastAPI PUT request with partial data overwrites existing fields with defaults',
    'fastapi',
    'MEDIUM',
    '[
        {"solution": "Use Pydantic exclude_unset=True to extract only provided fields: update_data = item.dict(exclude_unset=True)", "percentage": 95, "note": "Preserves unset fields"},
        {"solution": "Update existing object: stored_item.copy(update=update_data)", "percentage": 94, "note": "Merges updates with stored data"},
        {"solution": "Use PATCH for partial updates instead of PUT", "percentage": 85, "note": "More semantically correct for partial changes"},
        {"solution": "Define update models with all fields optional: class ItemUpdate(BaseModel): name: str | None = None", "percentage": 90, "note": "All update fields must have defaults"}
    ]'::jsonb,
    'Update models defined with Pydantic, PUT endpoints implemented',
    'PUT requests preserve existing data, only updated fields change, no unintended overwrites',
    'PUT overwrites omitted fields with defaults if not careful. Use exclude_unset=True. Keep separate create vs update models. PATCH is safer for partial updates.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/body-updates/'
),
(
    'FastAPI header parameter case sensitivity or underscore conversion issues',
    'fastapi',
    'MEDIUM',
    '[
        {"solution": "FastAPI auto-converts underscores to hyphens: user_agent becomes User-Agent header", "percentage": 95, "note": "Default behavior matches HTTP standard"},
        {"solution": "Declare headers with snake_case: def get_header(user_agent: str = Header(...))", "percentage": 93, "note": "FastAPI handles conversion automatically"},
        {"solution": "To disable conversion, use Header(convert_underscores=False)", "percentage": 85, "note": "Some proxies block underscores in headers"},
        {"solution": "For duplicate headers, use list type: x_token: list[str] | None = Header(None)", "percentage": 82, "note": "Collects all header values"}
    ]'::jsonb,
    'FastAPI endpoints with header parameters, requests with headers',
    'Headers properly recognized regardless of case, underscore/hyphen conversions work correctly',
    'HTTP headers are case-insensitive but FastAPI converts underscores to hyphens. Some proxies block underscores. Use Header() function for explicit declarations.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/header-params/'
),
(
    'FastAPI middleware order incorrect - error handlers not working or CORS not applied',
    'fastapi',
    'MEDIUM',
    '[
        {"solution": "Use app.add_middleware() instead of direct instantiation", "percentage": 96, "note": "Maintains internal middleware handler ordering"},
        {"solution": "Add middleware in reverse order of execution: app.add_middleware() calls execute bottom-up", "percentage": 93, "note": "Last add_middleware() executes first"},
        {"solution": "Add critical middleware (CORS, error handling) early in setup", "percentage": 90, "note": "Ensures proper error handling"},
        {"solution": "Verify middleware is ASGI-compliant - incompatible ASGI middleware breaks FastAPI", "percentage": 85, "note": "Check Starlette/ASGI compatibility"}
    ]'::jsonb,
    'FastAPI app with multiple middleware, error handlers defined',
    'Error handlers catch exceptions, CORS works properly, middleware processes in correct order',
    'Direct middleware instantiation breaks internal handler ordering. Use app.add_middleware(). Order matters - added last executes first. Verify ASGI compliance.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/advanced/middleware/'
),
(
    'FastAPI dependency injection circular dependency or missing Depends() wrapper',
    'fastapi',
    'MEDIUM',
    '[
        {"solution": "Use Depends() wrapper: def get_items(db = Depends(get_database))", "percentage": 96, "note": "Depends() signals dependency injection"},
        {"solution": "Do not call dependency directly - do not add parentheses: Depends(get_database) not Depends(get_database())", "percentage": 95, "note": "Critical distinction"},
        {"solution": "For complex dependencies, use Annotated for cleaner syntax: from typing import Annotated", "percentage": 85, "note": "Modern approach reduces boilerplate"},
        {"solution": "Avoid circular dependencies - if A depends on B and B depends on A, restructure", "percentage": 88, "note": "Design pattern issue, not Framework issue"}
    ]'::jsonb,
    'FastAPI application with dependency injection defined, routes using dependencies',
    'Dependencies inject correctly, parameters receive dependency values, no circular dependency errors',
    'Dependencies must be wrapped in Depends(). Do not call the dependency function directly. Avoid circular dependency chains. Use Annotated for cleaner code.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/dependencies/'
),
(
    'FastAPI FastAPI() import fails or app instance not created before routes',
    'fastapi',
    'HIGH',
    '[
        {"solution": "Import FastAPI: from fastapi import FastAPI", "percentage": 98, "note": "Basic import required"},
        {"solution": "Create app instance before defining routes: app = FastAPI()", "percentage": 97, "note": "Must occur before @app.get() decorators"},
        {"solution": "Use fastapi dev command to run: fastapi dev main.py", "percentage": 93, "note": "Recommended over manual uvicorn calls"},
        {"solution": "Ensure Python file structure has correct module imports in __init__.py", "percentage": 85, "note": "Required for CLI discovery"}
    ]'::jsonb,
    'Python environment with FastAPI installed (pip install fastapi)',
    'FastAPI imports without error, app starts successfully, routes are registered',
    'FastAPI import must occur before usage. app = FastAPI() must come before any @app.route() decorators. Use fastapi dev for modern startup.',
    0.96,
    'sonnet-4',
    NOW(),
    'https://fastapi.tiangolo.com/tutorial/first-steps/'
);
