-- Add Stack Overflow Vitest Q&A batch 1
-- 12 highest-voted questions with accepted answers

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Vitest defineConfig: "test" does not exist in type "UserConfigExport"',
    'stackoverflow-vitest',
    'HIGH',
    '[
        {"solution": "Import defineConfig from ''vitest/config'' instead of ''vite''", "percentage": 95, "note": "Vitest exports extended types with test property"},
        {"solution": "Add triple-slash reference directive at top of vite.config.ts: /// <reference types=\"vitest/config\" />", "percentage": 90, "note": "Alternative approach without changing imports"},
        {"solution": "Use mergeConfig with separate defineViteConfig and defineVitestConfig", "percentage": 75, "note": "Most elegant solution but requires more setup"},
        {"solution": "Create separate vitest.config.ts file instead of combining with vite.config.ts", "percentage": 70, "note": "Works but less convenient than single config"}
    ]'::jsonb,
    'Vite project with TypeScript, compatible vite and vitest versions',
    'vite.config.ts or vitest.config.ts compiles without TypeScript errors, test property is recognized',
    'Version incompatibility between vite and vitest (always update both together). Using ''as'' to cast bypasses type-checking. Official docs may not reflect all working approaches.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/72146352/vitest-defineconfig-test-does-not-exist-in-type-userconfigexport'
),
(
    'Vitest: @ src folder alias not resolved in test files',
    'stackoverflow-vitest',
    'HIGH',
    '[
        {"solution": "Create tsconfig.vitest.json that includes test files and extends main tsconfig", "percentage": 93, "note": "Ensure vitest is referenced in tsconfig.json"},
        {"solution": "Create dedicated vitest.config.ts with explicit resolve.alias configuration", "percentage": 90, "note": "Use path.resolve(__dirname, ''./src'') for alias mapping"},
        {"solution": "Use vite-tsconfig-paths plugin to automatically resolve TypeScript path mappings", "percentage": 85, "note": "Requires installing vite-tsconfig-paths package"},
        {"solution": "Create jsconfig.json in tests folder extending main tsconfig", "percentage": 70, "note": "Alternative for JavaScript projects"}
    ]'::jsonb,
    'Vue 3 project with TypeScript, Vite build tool, Vitest framework, path aliases configured in tsconfig.json',
    'Test files can import modules using @ alias without "cannot find module" errors, TypeScript compilation succeeds',
    'Excluding test directories from TypeScript ''include'' patterns prevents alias resolution. Only defining aliases in vite.config.ts without ensuring test runner configuration. Forgetting to create dedicated vitest.config.ts when needed.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/72468249/vitest-src-folder-alias-not-resolved-in-test-files'
),
(
    'How do I access my .env variables from a Vitest test?',
    'stackoverflow-vitest',
    'HIGH',
    '[
        {"solution": "Add setupFiles with dotenv/config to vitest.config.ts: setupFiles: [''dotenv/config'']", "percentage": 95, "note": "Loads environment variables before tests run"},
        {"solution": "Use Vite''s loadEnv function in vitest.config.ts with env option (Node v20.6.0+)", "percentage": 85, "note": "Modern approach: import { loadEnv } from ''vite'' and set test.env: loadEnv(mode, process.cwd(), '''')"},
        {"solution": "Manually import and call dotenv.config() in vitest.config.ts", "percentage": 80, "note": "Set test.env: env.parsed after calling config()"},
        {"solution": "Use process.env directly if VITE_ prefix variables", "percentage": 70, "note": "Vite automatically loads VITE_* variables from .env files"}
    ]'::jsonb,
    'dotenv package installed (if using that approach), properly configured vitest.config.ts, .env file in project root',
    'process.env.VARIABLE_NAME returns expected values in test code, tests pass without "undefined" variable errors',
    'Variables without VITE_ prefix do not expose to process.env by default. Vite loads .env but doesn''t always make variables accessible to tests. Using .env.testing instead of .env.test. Node.js v20+ requires --env-file flag when running via node directly.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/72924177/how-do-i-access-my-env-variables-from-a-vitest-test'
),
(
    'Vitest: How to exclude specific files and folders?',
    'stackoverflow-vitest',
    'MEDIUM',
    '[
        {"solution": "Import configDefaults and spread it into exclude: [''...configDefaults.exclude'', ''shared/*'']", "percentage": 93, "note": "Preserves default exclusions like node_modules"},
        {"solution": "Use mergeConfig to properly combine vite.config with vitest settings", "percentage": 85, "note": "Ensures test configuration properly overrides base config"},
        {"solution": "Apply glob patterns for excluding test directories: [''...configDefaults.exclude'', ''**/test/**'']", "percentage": 80, "note": "Flexible for various project structures"},
        {"solution": "Use async await with vi.importActual() to avoid TypeScript strictness issues", "percentage": 75, "note": "Resolves module mocking errors that can mask configuration issues"}
    ]'::jsonb,
    'Vitest imported with configDefaults available, vitest.config.ts file exists',
    'Files in excluded patterns do not run during test execution, coverage reports exclude specified paths, no errors thrown from excluded directories',
    'Omitting configDefaults.exclude causes node_modules to be scanned. Module mocking errors may mask configuration issues. TypeScript strictness can block vi.importActual() without await keyword.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/74088103/vitest-how-to-exclude-specific-files-and-folders'
),
(
    'How to write a unit test in vitest that expects an error',
    'stackoverflow-vitest',
    'MEDIUM',
    '[
        {"solution": "For async errors, use .rejects.toThrow() or .rejects.toThrowError()", "percentage": 94, "note": "Example: await expect(asyncFunc()).rejects.toThrow()"},
        {"solution": "For synchronous errors, wrap function call in arrow function: expect(() => func()).toThrowError()", "percentage": 92, "note": "Pass function reference, do not execute it before expect()"},
        {"solution": "Use toThrowError with error message regex for precise matching", "percentage": 85, "note": "Example: expect(() => func()).toThrowError(/error message/)"},
        {"solution": "Test both error type and message with Jest-style matchers", "percentage": 80, "note": "Compatible with Vitest from Jest migration"}
    ]'::jsonb,
    'Vitest test file setup, function that throws errors, expect library available',
    'Test passes when error is thrown, test fails when error is not thrown or wrong error type thrown',
    'Calling await on function then using .toThrow() executes function outside expect block, throwing error before assertion. Forgetting that async errors require .rejects modifier. Executing function directly instead of passing function reference.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/74487468/how-to-write-a-unit-test-in-vitest-that-expects-an-error'
),
(
    'Vitest: Failed to resolve import ''@/...'' error',
    'stackoverflow-vitest',
    'MEDIUM',
    '[
        {"solution": "Create vitest.config.ts with explicit alias using array format: [{find: ''@'', replacement: resolve(__dirname, ''./src'')}]", "percentage": 94, "note": "Import resolve from ''node:path'', use array syntax not object"},
        {"solution": "Use vite-tsconfig-paths package to automatically read tsconfig.json aliases", "percentage": 85, "note": "Requires npm install vite-tsconfig-paths then import in config"},
        {"solution": "Ensure both vite.config.ts and vitest.config.ts define the same aliases", "percentage": 80, "note": "Vitest does not automatically inherit Vite alias settings"},
        {"solution": "Use fileURLToPath with import.meta.url for path resolution", "percentage": 75, "note": "Alternative approach for complex path handling"}
    ]'::jsonb,
    'Path aliases defined in tsconfig.json or vite.config.ts, Node path module available, Vitest configured',
    'Imports using @ alias resolve successfully, no "Failed to resolve import" errors during test execution',
    'Forgetting to import resolve from ''node:path''. Using object syntax instead of array syntax in alias configuration. Not creating separate vitest.config.ts (Vitest may not inherit Vite settings). Different alias configurations between vite and vitest.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/75798479/how-can-i-solve-the-issue-of-failed-to-resolve-import-in-vitest'
),
(
    'Vitest: "describe is not defined" error',
    'stackoverflow-vitest',
    'MEDIUM',
    '[
        {"solution": "Enable globals in vitest.config.ts: test: { globals: true }", "percentage": 93, "note": "Makes describe, test, expect available globally"},
        {"solution": "Add vitest/globals to tsconfig.json types array for TypeScript support", "percentage": 90, "note": "Enable IDE hints and type checking: compilerOptions.types: [''vitest/globals'']"},
        {"solution": "Import test utilities in each file: import { describe, test, expect } from ''vitest''", "percentage": 85, "note": "Works without globals config but requires imports in every file"},
        {"solution": "Restart TypeScript server after configuration changes", "percentage": 70, "note": "VSCode: F1 > TypeScript: Restart TS Server"}
    ]'::jsonb,
    'Vitest installed, vitest.config.ts file exists, React or other framework project',
    'Test files compile without ReferenceError, IDE recognizes describe/test/expect functions, tests run successfully',
    'Installing multiple test frameworks (Jest + Vitest) creates confusion about which configuration applies. Vitest doesn''t globally define test functions by default, unlike Jest. TypeScript users need vitest/globals type definition.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/75971024/describe-is-not-defined-in-vitest'
),
(
    'Vitest: How to clear/reset mocks between tests',
    'stackoverflow-vitest',
    'MEDIUM',
    '[
        {"solution": "Call vi.mock() once at module level, then use vi.clearAllMocks() in afterEach hook", "percentage": 94, "note": "Do NOT call vi.mock() multiple times or within tests - it is hoisted"},
        {"solution": "Use vi.mocked() wrapper for type-safe mock access and proper reset", "percentage": 90, "note": "Syntax: vi.mocked(moduleFunction).mockReturnValue({...})"},
        {"solution": "Call vi.clearAllMocks() in afterEach() to reset call history between tests", "percentage": 88, "note": "Clears call counts while preserving mock definitions"},
        {"solution": "Use vi.resetAllMocks() to reset implementation and call history", "percentage": 80, "note": "Stronger reset than clearAllMocks if needed"}
    ]'::jsonb,
    'Vitest test framework, modules mocked with vi.mock(), afterEach hook available',
    'Different tests can have different mock return values without cross-contamination, call counts reset between tests, vi.clearAllMocks() executes without errors',
    'Calling vi.mock() multiple times within tests (hoisting issue). Not using afterEach() to reset mocks between tests. Not wrapping mocks with vi.mocked() for type safety.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/73620826/how-to-clear-reset-mocks-in-vitest'
),
(
    'Vitest: How to mock/stub vue-i18n',
    'stackoverflow-vitest',
    'MEDIUM',
    '[
        {"solution": "Use vi.mock(''vue-i18n'') with useI18n hook returning {t, d} functions", "percentage": 92, "note": "Best for Composition API: t returns key, d returns value"},
        {"solution": "Create global i18n instance with createI18n and add to vitest.setup.ts config.global.plugins", "percentage": 88, "note": "Set legacy: false and allowComposition: true for Vue 3"},
        {"solution": "Mount component with i18n plugin in setup: mount(Component, {global: {plugins: [i18n]}})", "percentage": 85, "note": "Per-test approach for component-specific i18n setup"},
        {"solution": "Configure ESLint globals and TypeScript types for i18n", "percentage": 70, "note": "Ensures IDE recognizes $t and useI18n()"}
    ]'::jsonb,
    'Vue 3 project with Vitest, vue-i18n library installed, Composition API setup',
    'Components render without "t is not defined" errors, useI18n() hook returns mock translation functions, tests pass for i18n-dependent components',
    'Mixing global mocks with Composition API creates "$setup.t is not a function" errors. Forgetting legacy: false and allowComposition: true flags. Mixing setupFiles config with vi.mock() approach (they conflict).',
    0.89,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/72260793/how-to-mock-stub-vue-i18n'
),
(
    'Vitest: VSCode does not recognize globals (describe, test, expect)',
    'stackoverflow-vitest',
    'MEDIUM',
    '[
        {"solution": "Add vitest/globals to tsconfig.json compilerOptions.types array", "percentage": 92, "note": "Enables type checking for global test functions"},
        {"solution": "Restart TypeScript server in VSCode: F1 > TypeScript: Restart TS Server", "percentage": 90, "note": "Required after any tsconfig.json changes"},
        {"solution": "Ensure test files are included in tsconfig.json include array", "percentage": 88, "note": "Exclude patterns preventing test file recognition"},
        {"solution": "Configure ESLint globals for test environment if using ESLint", "percentage": 75, "note": "Add globals: {...globals.jest, ...globals.mocha} to ESLint config"}
    ]'::jsonb,
    'VSCode editor, Vitest installed with globals: true, tsconfig.json file exists',
    'No red squiggly lines under describe/test/expect, IntelliSense shows function suggestions, TypeScript compilation succeeds',
    'Not restarting VSCode/TS Server after config changes. Test files excluded from tsconfig.json include array. Configuration in tsconfig.test.json instead of root tsconfig.json. ESLint globals not configured for test environments.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/75678812/how-to-get-vscode-to-recognise-vitest-globals'
),
(
    'Vitest: ReferenceError: document is not defined',
    'stackoverflow-vitest',
    'MEDIUM',
    '[
        {"solution": "Configure jsdom environment in vitest.config.ts: test: { environment: ''jsdom'' }", "percentage": 95, "note": "Provides browser DOM implementation for testing-library"},
        {"solution": "Install jsdom as dev dependency: npm install --save-dev jsdom", "percentage": 94, "note": "Required peer for jsdom environment configuration"},
        {"solution": "Set globals: true in vitest config for global test functions", "percentage": 85, "note": "Additional recommended configuration"},
        {"solution": "Add setupFiles configuration for additional test matchers", "percentage": 75, "note": "Optional: setupFiles: [''./vitest.setup.ts''] for toBeInTheDocument etc"}
    ]'::jsonb,
    'Vitest configured, React project or testing-library usage, jsdom package installable',
    'render() from @testing-library/react works without errors, document object accessible in tests, DOM queries succeed',
    'Forgetting to configure environment: "jsdom". Not installing jsdom as dev dependency. Confusing jsdom with happy-dom (different implementations). Not understanding Vitest defaults to Node.js environment without browser APIs.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/77713195/referenceerror-document-is-not-defined-testing-with-vitest'
),
(
    'Vitest: How do I assert that console.log() happened',
    'stackoverflow-vitest',
    'MEDIUM',
    '[
        {"solution": "Use vi.spyOn(console, ''log'').mockImplementation(() => undefined) to track calls", "percentage": 93, "note": "Spy and mock in one step, suppress actual output"},
        {"solution": "Assert with toHaveBeenCalledOnce() to verify single call", "percentage": 90, "note": "One-time assertion for single log calls"},
        {"solution": "Use toHaveBeenLastCalledWith() to verify logged arguments", "percentage": 90, "note": "Check exact message: expect(spy).toHaveBeenLastCalledWith(''message'')"},
        {"solution": "Use vi.spyOn(console, ''log'') without mockImplementation to preserve output", "percentage": 80, "note": "Still tracks calls while showing logs in test output"}
    ]'::jsonb,
    'Vitest test environment, function that calls console.log(), vi spyOn available',
    'Spy tracks console.log calls correctly, toHaveBeenCalledOnce() and toHaveBeenLastCalledWith() assertions pass',
    'Using afterAll() instead of beforeEach/afterEach to reset spy (call counts persist across tests). Assuming mockImplementation() preserves console output (it suppresses). Forgetting to call mockReset() to clean up spies after test completion.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/76042978/in-vitest-how-do-i-assert-that-a-console-log-happened'
);
