-- Add Kubernetes CVE documentation batch 1
-- Source: Official Kubernetes CVE Feed (https://kubernetes.io/docs/reference/issues-security/official-cve-feed/)
-- Coverage: API server vulnerabilities, RBAC bypasses, kubelet exploits
-- Last updated: November 25, 2025

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'CVE-2022-3162: Unauthorized read of Custom Resources in Kubernetes API server',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade to Kubernetes v1.25.1, v1.24.5, v1.23.11, or v1.22.14 which contain the fix", "percentage": 95, "note": "Official patch for CVE-2022-3162"},
        {"solution": "Review and restrict RBAC permissions for Custom Resource Definitions (CRDs) to prevent unauthorized access", "percentage": 90, "note": "Implement least privilege access controls"},
        {"solution": "Audit existing CustomResourceDefinitions for excessive read permissions", "percentage": 85, "command": "kubectl get crd -o yaml | grep -A 10 rbac"},
        {"solution": "Enable audit logging to detect unauthorized Custom Resource access attempts", "percentage": 80, "note": "Monitor for suspicious API server activity"}
    ]'::jsonb,
    'Kubernetes cluster running vulnerable version, Admin access to upgrade cluster',
    'Cluster upgraded to patched version, kubectl version shows fixed release, No unauthorized CRD access in audit logs',
    'Affects versions prior to v1.25.1, v1.24.5, v1.23.11, and v1.22.14. Custom Resources may be readable by users without proper authorization. RBAC policies must be reviewed post-upgrade. Audit logs essential for detecting exploitation.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://kubernetes.io/docs/reference/issues-security/official-cve-feed/'
),
(
    'CVE-2024-3177: ServiceAccount admission bypass allows mounting arbitrary secrets',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade to patched Kubernetes version containing fix for CVE-2024-3177", "percentage": 95, "note": "Critical security patch for ServiceAccount admission plugin"},
        {"solution": "Review all ServiceAccount configurations and remove automountServiceAccountToken where not needed", "percentage": 90, "command": "kubectl patch serviceaccount default -p ''automountServiceAccountToken: false''"},
        {"solution": "Implement PodSecurityPolicy or Pod Security Standards to restrict secret mounting", "percentage": 85, "note": "Enforce security policies cluster-wide"},
        {"solution": "Audit existing pods for unauthorized secret mounts", "percentage": 80, "command": "kubectl get pods --all-namespaces -o json | jq ''.items[].spec.volumes[] | select(.secret)''"}
    ]'::jsonb,
    'Kubernetes cluster with ServiceAccount admission plugin enabled, Admin access to patch cluster',
    'Cluster upgraded to patched version, ServiceAccount policies enforced correctly, No unauthorized secret mounts detected',
    'ServiceAccount admission plugin can be bypassed to mount secrets outside allowed policy. Default ServiceAccounts auto-mount tokens unless explicitly disabled. PodSecurityPolicy deprecated in v1.25 - use Pod Security Standards. Review GitHub issue #124336 for full details.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://kubernetes.io/docs/reference/issues-security/official-cve-feed/'
),
(
    'CVE-2023-2728: ImagePolicyWebhook bypass allows unauthorized images',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade to Kubernetes version with CVE-2023-2728 patch applied", "percentage": 95, "note": "Official fix for ImagePolicyWebhook bypass"},
        {"solution": "Implement OPA Gatekeeper or Kyverno for image validation as defense-in-depth", "percentage": 90, "note": "Additional policy enforcement layer"},
        {"solution": "Configure admission controllers to validate image signatures and registries", "percentage": 85, "note": "Use ValidatingAdmissionWebhook for custom image policies"},
        {"solution": "Restrict image pull policies and enforce trusted registry allowlists", "percentage": 80, "command": "kubectl create podsecuritypolicy restrict-registries --image=trusted-registry.io/*"}
    ]'::jsonb,
    'Kubernetes cluster using ImagePolicyWebhook, Admin access to upgrade and configure admission controllers',
    'Cluster patched to fixed version, Image policies enforced correctly, Only approved images deployed',
    'ImagePolicyWebhook can be bypassed under specific conditions allowing unauthorized container images. Admission webhooks must be properly configured and reachable. Policy enforcement requires multiple layers of defense. See GitHub issue #118640 for exploitation details.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://kubernetes.io/docs/reference/issues-security/official-cve-feed/'
),
(
    'CVE-2021-25735: Validating Admission Webhook oversight allows policy bypass',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade to Kubernetes v1.21.1, v1.20.7, v1.19.11, or v1.18.19 containing the fix", "percentage": 95, "note": "Patch for validating admission webhook bypass"},
        {"solution": "Review all ValidatingWebhookConfiguration resources for incomplete field coverage", "percentage": 90, "command": "kubectl get validatingwebhookconfigurations -o yaml"},
        {"solution": "Ensure webhooks validate all relevant object fields including previously ignored fields", "percentage": 85, "note": "Update webhook logic to cover all security-sensitive fields"},
        {"solution": "Enable audit logging for admission controller decisions to detect bypass attempts", "percentage": 80, "note": "Monitor webhook validation outcomes"}
    ]'::jsonb,
    'Kubernetes cluster with ValidatingAdmissionWebhooks configured, Webhook endpoints accessible',
    'Cluster upgraded to patched version, Webhooks validate all relevant fields, Audit logs show proper validation',
    'Validating webhooks may not observe some fields allowing policy bypass. Webhook configuration must explicitly list all fields to validate. Network issues to webhook endpoints cause admission failures. GitHub issue #100096 has full technical details.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://kubernetes.io/docs/reference/issues-security/official-cve-feed/'
),
(
    'CVE-2020-8561: kube-apiserver webhook redirect vulnerability',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade to Kubernetes v1.18.19, v1.19.11, v1.20.7, or v1.21.1 with CVE-2020-8561 fix", "percentage": 95, "note": "Official patch for webhook redirect vulnerability"},
        {"solution": "Restrict network access to kube-apiserver using network policies and firewalls", "percentage": 90, "note": "Limit exposure of API server to trusted networks only"},
        {"solution": "Review and validate all webhook configurations for suspicious redirect endpoints", "percentage": 85, "command": "kubectl get validatingwebhookconfigurations,mutatingwebhookconfigurations -A -o yaml | grep url"},
        {"solution": "Enable API server audit logging to track webhook invocations and redirects", "percentage": 80, "note": "Monitor for unexpected webhook behavior"}
    ]'::jsonb,
    'Kubernetes cluster with webhooks configured, Admin access to audit and upgrade cluster',
    'Cluster upgraded to patched version, No unauthorized redirects in audit logs, Webhook configurations validated',
    'Webhook redirect vulnerability allows attackers to redirect API server requests. Only exploitable with specific webhook configurations. API server must be network-isolated. GitHub issue #104720 contains exploit details. CVSS score indicates high severity.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://kubernetes.io/docs/reference/issues-security/official-cve-feed/'
),
(
    'CVE-2021-25740: Endpoint and EndpointSlice permissions allow cross-namespace forwarding',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade to Kubernetes v1.22.0, v1.21.3, v1.20.9, or v1.19.13 with CVE-2021-25740 patch", "percentage": 95, "note": "Fix for cross-namespace forwarding vulnerability"},
        {"solution": "Review RBAC permissions for Endpoint and EndpointSlice resources and restrict to namespace scope", "percentage": 90, "command": "kubectl get clusterroles,roles -A -o yaml | grep -A 5 endpoints"},
        {"solution": "Implement NetworkPolicy to prevent unauthorized cross-namespace traffic", "percentage": 85, "note": "Enforce network segmentation between namespaces"},
        {"solution": "Audit existing Endpoint and EndpointSlice objects for cross-namespace references", "percentage": 80, "command": "kubectl get endpoints,endpointslices --all-namespaces -o json | jq ''.items[] | select(.subsets[].addresses[].targetRef.namespace != .metadata.namespace)''"}
    ]'::jsonb,
    'Kubernetes cluster with Endpoint/EndpointSlice resources, RBAC configured, Admin access',
    'Cluster upgraded to fixed version, RBAC policies scoped correctly, No cross-namespace forwarding detected',
    'Endpoint permissions can allow cross-namespace service forwarding bypassing network policies. EndpointSlice API introduced in v1.17 also affected. RBAC must restrict Endpoint modification to namespace owners. GitHub issue #103675 has exploitation techniques. NetworkPolicy alone insufficient without RBAC fix.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://kubernetes.io/docs/reference/issues-security/official-cve-feed/'
),
(
    'CVE-2024-9042: Windows node command injection via logs/query API',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade Windows nodes to Kubernetes version with CVE-2024-9042 patch applied", "percentage": 95, "note": "Critical fix for command injection vulnerability"},
        {"solution": "Restrict access to nodes/*/logs/query API endpoint using RBAC", "percentage": 90, "command": "kubectl create clusterrole deny-logs-query --verb=get --resource=nodes/log"},
        {"solution": "Disable log query API on Windows nodes if not required", "percentage": 85, "note": "Reduce attack surface by disabling unused features"},
        {"solution": "Monitor kubelet logs on Windows nodes for suspicious query API access", "percentage": 80, "note": "Enable audit logging for node API access"}
    ]'::jsonb,
    'Windows Kubernetes nodes, Admin access to upgrade nodes and configure RBAC',
    'Nodes upgraded to patched version, Log query API access restricted via RBAC, No suspicious activity in audit logs',
    'Command injection vulnerability specific to Windows nodes through logs/query API. Requires authenticated access to API server. Can lead to arbitrary code execution on Windows nodes. GitHub issue #129654 contains technical details. Linux nodes not affected. Upgrade Windows nodes immediately.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://kubernetes.io/docs/reference/issues-security/official-cve-feed/'
),
(
    'CVE-2025-5187: Nodes can delete themselves by adding OwnerReference',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade to Kubernetes version containing CVE-2025-5187 fix", "percentage": 95, "note": "Patch prevents node self-deletion via OwnerReference"},
        {"solution": "Review and restrict node object modification permissions in RBAC", "percentage": 90, "command": "kubectl get clusterroles -o yaml | grep -A 10 ''nodes.*update''"},
        {"solution": "Implement ValidatingAdmissionWebhook to block suspicious OwnerReference modifications on node objects", "percentage": 85, "note": "Prevent unauthorized node metadata changes"},
        {"solution": "Monitor node deletion events and alert on unexpected node removals", "percentage": 80, "command": "kubectl get events --all-namespaces --field-selector reason=NodeDeleted"}
    ]'::jsonb,
    'Kubernetes cluster with node permissions configured, Admin access to upgrade and configure admission control',
    'Cluster upgraded to fixed version, Node modification RBAC restricted, No unauthorized node deletions',
    'Nodes can add OwnerReference to themselves causing unintended deletion. Requires node update permissions. Can lead to cluster instability and service disruption. GitHub issue #133471 describes attack scenario. Admission webhooks provide defense-in-depth.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://kubernetes.io/docs/reference/issues-security/official-cve-feed/'
),
(
    'CVE-2025-4563: Nodes bypass dynamic resource allocation authorization',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade to Kubernetes version with CVE-2025-4563 authorization fix", "percentage": 95, "note": "Patch enforces proper authorization for dynamic resource allocation"},
        {"solution": "Review and restrict ResourceClaim and ResourceClaimTemplate permissions", "percentage": 90, "command": "kubectl get clusterroles -o yaml | grep -A 5 resourceclaims"},
        {"solution": "Audit existing ResourceClaim allocations for unauthorized node assignments", "percentage": 85, "command": "kubectl get resourceclaims --all-namespaces -o yaml"},
        {"solution": "Implement resource quotas and limits to prevent resource exhaustion attacks", "percentage": 80, "note": "Limit dynamic resource allocation per namespace"}
    ]'::jsonb,
    'Kubernetes cluster with dynamic resource allocation enabled, RBAC configured',
    'Cluster upgraded to fixed version, Authorization properly enforced, No unauthorized resource claims',
    'Dynamic resource allocation authorization checks can be bypassed by nodes. Feature introduced in v1.26 as alpha. Nodes can claim resources without proper authorization. GitHub issue #132151 has technical analysis. ResourceClaim API must have proper RBAC controls.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://kubernetes.io/docs/reference/issues-security/official-cve-feed/'
),
(
    'CVE-2020-8559: Privilege escalation from compromised node to cluster',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade to Kubernetes v1.18.6, v1.17.9, or v1.16.13 containing CVE-2020-8559 fix", "percentage": 95, "note": "Critical patch for node privilege escalation"},
        {"solution": "Restrict node permissions using NodeRestriction admission plugin", "percentage": 90, "note": "Enable --enable-admission-plugins=NodeRestriction on API server"},
        {"solution": "Implement network segmentation to isolate node traffic from control plane", "percentage": 85, "note": "Use NetworkPolicy to limit node-to-apiserver communication"},
        {"solution": "Enable API server audit logging to detect privilege escalation attempts from nodes", "percentage": 90, "command": "kubectl logs -n kube-system kube-apiserver-* | grep -i escalation"},
        {"solution": "Review and minimize node bootstrap token permissions", "percentage": 80, "note": "Follow principle of least privilege for node authentication"}
    ]'::jsonb,
    'Kubernetes cluster with nodes, Admin access to upgrade and configure admission plugins',
    'Cluster upgraded to patched version, NodeRestriction enabled, Audit logs show no escalation attempts',
    'Compromised node can escalate privileges to cluster admin. Requires initial node compromise. NodeRestriction admission plugin essential mitigation. GitHub issue #92914 details full attack chain. Network policies provide defense-in-depth. Bootstrap tokens must have minimal permissions.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://kubernetes.io/docs/reference/issues-security/official-cve-feed/'
),
(
    'CVE-2023-2727: ImagePolicyWebhook bypass through specific API paths',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade to Kubernetes version patching CVE-2023-2727 ImagePolicyWebhook bypass", "percentage": 95, "note": "Fix ensures webhook enforcement on all API paths"},
        {"solution": "Configure OPA Gatekeeper or Kyverno as additional image policy enforcement layer", "percentage": 90, "note": "Defense-in-depth for image validation"},
        {"solution": "Review ImagePolicyWebhook configuration for completeness and test all API paths", "percentage": 85, "command": "kubectl get pods -o json | jq ''.items[].spec.containers[].image'' | sort -u"},
        {"solution": "Enable admission controller audit mode to log policy decisions", "percentage": 80, "note": "Monitor for webhook bypass attempts"}
    ]'::jsonb,
    'Kubernetes cluster with ImagePolicyWebhook enabled, Webhook endpoint accessible',
    'Cluster upgraded to fixed version, Image policies enforced on all API paths, Audit logs confirm enforcement',
    'ImagePolicyWebhook can be bypassed through specific API request paths. Related to CVE-2023-2728. GitHub issue #118640 covers both vulnerabilities. Webhook must be configured for all relevant admission paths. OPA/Kyverno provide additional enforcement layer.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://kubernetes.io/docs/reference/issues-security/official-cve-feed/'
);
