-- Bun Runtime Errors Documentation Mining - Batch 1
-- Source: https://bun.sh/docs (Official Bun Documentation)
-- Category: bun
-- Mined: 2025-11-24

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'Illegal Instruction error when running Bun',
    'bun',
    'HIGH',
    '[
        {"solution": "Download and use the baseline build instead of the standard build: bun-linux-x64-baseline.zip or bun-windows-x64-baseline.zip", "percentage": 95, "note": "Baseline builds target older CPU architectures (Nehalem/Bulldozer) that lack AVX/AVX2 instructions"},
        {"solution": "Verify your CPU architecture meets minimum requirements: Intel Haswell (4th gen) or AMD Excavator for standard builds", "percentage": 90, "note": "Use uname -r to check kernel version is 5.6+"},
        {"solution": "Accept slower performance with baseline builds as trade-off for compatibility", "percentage": 85, "note": "Baseline builds are slower than regular builds but work on older hardware"}
    ]'::jsonb,
    'Attempted Bun installation or execution, x64 or ARM64 architecture',
    'Bun runs without Illegal Instruction error, bun --version returns version number',
    'Standard builds require AVX/AVX2 CPU instructions. Baseline builds are necessary for older CPUs but have performance penalty.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://bun.sh/docs/installation'
),
(
    'GLIBC version not found error when running Bun on Linux',
    'bun',
    'MEDIUM',
    '[
        {"solution": "Use musl binaries instead of glibc versions: download bun-linux-x64-musl.zip or bun-linux-aarch64-musl.zip", "percentage": 95, "note": "Musl binaries are compatible with Alpine, Void Linux, and other musl-based distributions"},
        {"solution": "Verify your Linux distribution uses musl instead of glibc before choosing build", "percentage": 90, "command": "ldd --version"},
        {"solution": "Use Docker with appropriate base image if managing multiple environments", "percentage": 85, "note": "Alpine images require musl builds, Ubuntu/Debian require glibc"}
    ]'::jsonb,
    'Linux system with musl libc instead of glibc, Bun installation attempted',
    'Bun executes without GLIBC errors, successful command execution',
    'Alpine and similar distributions use musl instead of glibc. Standard builds expect glibc and will fail on musl systems.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://bun.sh/docs/installation'
),
(
    'Bun.build returns AggregateError with build failures',
    'bun',
    'HIGH',
    '[
        {"solution": "Wrap Bun.build in try/catch to handle AggregateError and access individual BuildMessage errors", "percentage": 90, "note": "Each error contains name, position, message, and level properties", "command": "try { await Bun.build({...}) } catch (e) { console.error(e.errors); }"},
        {"solution": "Set throw: false to return {success: false} instead of throwing exception", "percentage": 88, "note": "Allows programmatic handling without try/catch"},
        {"solution": "Check error.level to filter by severity: error, warning, info, debug, verbose", "percentage": 85, "note": "Warnings may not prevent build but indicate issues"}
    ]'::jsonb,
    'Bun runtime installed, build configuration with entrypoints defined',
    'Build completes or errors are properly caught and logged, error messages show file positions',
    'Default behavior throws on failure. Use throw: false for programmatic control. AggregateError contains array of individual errors.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://bun.sh/docs/bundler'
),
(
    'Bun.build could not resolve Node.js builtin module in browser target',
    'bun',
    'HIGH',
    '[
        {"solution": "Change target to node or bun instead of browser", "percentage": 90, "note": "Node.js builtins like perf_hooks, worker_threads only available in node/bun targets", "command": "Bun.build({ target: \"node\" })"},
        {"solution": "Mark Node.js builtins as external if bundling for browser", "percentage": 85, "note": "Prevents bundler from trying to include server-only modules", "command": "Bun.build({ external: [\"perf_hooks\", \"worker_threads\"] })"},
        {"solution": "Use conditional imports or polyfills for cross-platform code", "percentage": 80, "note": "Check environment before importing Node builtins"}
    ]'::jsonb,
    'Bun.build configuration with target set to browser, code imports Node.js builtins',
    'Build completes without resolve errors, bundle works in target environment',
    'Browser target cannot use Node.js builtins. Set target correctly or mark as external. Bun does not automatically polyfill Node modules for browser.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://bun.sh/docs/bundler'
),
(
    'Bun install fails with Unexpected installing package error',
    'bun',
    'MEDIUM',
    '[
        {"solution": "Clear Bun cache and retry installation", "percentage": 85, "command": "bun pm cache rm && bun install"},
        {"solution": "Use --frozen-lockfile flag for reproducible installs with exact lockfile versions", "percentage": 80, "command": "bun install --frozen-lockfile"},
        {"solution": "Check filesystem permissions on node_modules and package directories", "percentage": 75, "note": "Permission errors may not cause non-zero exit codes in some versions"},
        {"solution": "Update to latest Bun version as many install bugs have been fixed", "percentage": 85, "command": "bun upgrade"}
    ]'::jsonb,
    'Valid package.json file, network connectivity, Bun package manager installed',
    'Packages install successfully, node_modules populated, bun.lockb created or updated',
    'Cache corruption can cause install failures. Some errors do not cause non-zero exit codes. File dependencies and git repositories may have specific issues.',
    0.80,
    'sonnet-4',
    NOW(),
    'https://bun.sh/docs/pm/cli/install'
),
(
    'Bun install hangs on Windows when resolving packages not in cache',
    'bun',
    'MEDIUM',
    '[
        {"solution": "Update to Bun v1.1.13 or later where this issue was fixed", "percentage": 90, "command": "bun upgrade"},
        {"solution": "Pre-populate cache by installing packages individually if issue persists", "percentage": 70, "note": "Workaround for older versions"},
        {"solution": "Use npm install as temporary fallback if Bun install hangs", "percentage": 75, "note": "Then switch back to Bun after node_modules populated"}
    ]'::jsonb,
    'Windows operating system, Bun package manager, empty or partial package cache',
    'Packages resolve and install without hanging, installation completes in reasonable time',
    'Specific to Windows in Bun v1.1.12 and earlier. Installing only works when packages are cached. Removing cache causes hanging.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://bun.sh/blog/bun-v1.1.13'
),
(
    'Bun test runner not detecting all test files',
    'bun',
    'MEDIUM',
    '[
        {"solution": "Verify test files match expected patterns: *.test.{js|jsx|ts|tsx}, *_test.{js|jsx|ts|tsx}, *.spec.{js|jsx|ts|tsx}, *_spec.{js|jsx|ts|tsx}", "percentage": 90, "note": "Bun recursively searches for these patterns"},
        {"solution": "Check folder structure and rename folders if tests not detected", "percentage": 80, "note": "Folder naming can affect test discovery in some cases"},
        {"solution": "Use explicit file paths to run specific tests", "percentage": 85, "command": "bun test path/to/specific.test.ts"},
        {"solution": "Verify fewer tests in CI vs local is not due to environment-specific test skips", "percentage": 75, "note": "Tests may be conditionally skipped based on environment variables"}
    ]'::jsonb,
    'Bun test runner installed, test files in project directory',
    'All test files detected and executed, bun test output shows expected test count',
    'Test files must match naming patterns. Folder structure can affect discovery. Tests run in single process sharing global state.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://bun.sh/docs/test/writing'
),
(
    'Bun test timeout exceeded default 5000ms',
    'bun',
    'MEDIUM',
    '[
        {"solution": "Increase timeout for specific test using timeout option", "percentage": 90, "command": "test(\"long test\", async () => {...}, { timeout: 10000 })"},
        {"solution": "Set global timeout via --timeout flag", "percentage": 85, "command": "bun test --timeout 10000"},
        {"solution": "Optimize slow test operations: database queries, API calls, file I/O", "percentage": 80, "note": "Mock external dependencies to speed up tests"},
        {"solution": "Use --inspect-wait flag to debug hanging tests", "percentage": 75, "note": "Allows debugger attachment to investigate slowness"}
    ]'::jsonb,
    'Bun test runner, test suite with long-running operations',
    'Tests complete within timeout period, no timeout errors in test output',
    'Default timeout is 5000ms (5 seconds) per test. Long operations need explicit timeout configuration. Tests run in single process.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://bun.sh/docs/test/runtime-behavior'
),
(
    'Bun WebSocket connection drops messages or fails with backpressure',
    'bun',
    'MEDIUM',
    '[
        {"solution": "Check return value of ws.send(): -1 indicates backpressure, 0 indicates dropped message", "percentage": 90, "note": "Implement retry logic or buffering for -1 return values"},
        {"solution": "Reduce message size or sending rate to stay under 1 MB packet sequence limit", "percentage": 85, "note": "Bun starts dropping packets if sequence exceeds 1 MB"},
        {"solution": "Implement drain handler to know when backpressure is resolved", "percentage": 85, "note": "Use drain event to resume sending after backpressure"},
        {"solution": "Adjust idleTimeout if connections close prematurely (default 120 seconds)", "percentage": 80, "command": "Bun.serve({ websocket: { idleTimeout: 300 } })"}
    ]'::jsonb,
    'Bun WebSocket server or client implementation, active message sending',
    'All messages delivered successfully, ws.send() returns positive numbers, no dropped messages',
    'Send returns -1 for backpressure, 0 for dropped. Default 120s idle timeout. 1 MB limit on packet sequences. Must handle backpressure explicitly.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://bun.sh/docs/api/websockets'
),
(
    'Bun WebSocket error event has undefined error property',
    'bun',
    'LOW',
    '[
        {"solution": "Check for undefined before accessing event.error in WebSocket error handler", "percentage": 90, "command": "ws.onerror = (event) => { if (event.error) { console.error(event.error) } }"},
        {"solution": "Use alternative error detection methods: connection state, close events", "percentage": 80, "note": "Monitor close events with error codes for connection issues"},
        {"solution": "Update to latest Bun version if this affects critical error handling", "percentage": 75, "note": "Known issue that libraries like @discord/ws expect non-null error"}
    ]'::jsonb,
    'Bun WebSocket client, error event handlers registered',
    'Error handling works without undefined reference errors, graceful error recovery',
    'Unlike Node.js ws module, Bun may set event.error to undefined on connection loss. Libraries expecting non-null may break.',
    0.80,
    'sonnet-4',
    NOW(),
    'https://github.com/oven-sh/bun/issues/19176'
),
(
    'Bun Node.js compatibility: process.binding partially implemented',
    'bun',
    'MEDIUM',
    '[
        {"solution": "Avoid using process.binding() as it is internal Node.js API", "percentage": 85, "note": "Use documented public APIs instead"},
        {"solution": "Use Bun-specific alternatives where available (e.g., Bun.env for process.env)", "percentage": 80, "note": "Bun.env is alias for process.env"},
        {"solution": "Check Bun.version to conditionally use Bun vs Node APIs", "percentage": 75, "command": "if (typeof Bun !== \"undefined\") { /* use Bun APIs */ }"},
        {"solution": "File issue on Bun GitHub if specific binding is needed", "percentage": 70, "note": "Bun team prioritizes based on real-world usage"}
    ]'::jsonb,
    'Code using Node.js internal APIs, running on Bun runtime',
    'Code executes without binding errors, functionality works as expected',
    'process.binding is internal Node.js API not guaranteed stable. Only partially implemented in Bun. Use public APIs instead.',
    0.80,
    'sonnet-4',
    NOW(),
    'https://bun.sh/docs/runtime/nodejs-apis'
),
(
    'Bun Node.js compatibility: node:http outgoing request body buffered instead of streamed',
    'bun',
    'MEDIUM',
    '[
        {"solution": "Be aware of memory implications when sending large request bodies", "percentage": 85, "note": "Request body held in memory until complete"},
        {"solution": "Break large payloads into multiple smaller requests if memory is concern", "percentage": 80, "note": "Workaround until streaming is implemented"},
        {"solution": "Use fetch() API instead of node:http for more predictable behavior", "percentage": 90, "note": "Bun fetch implementation is more optimized", "command": "await fetch(url, { method: \"POST\", body: data })"},
        {"solution": "Monitor memory usage when uploading large files via node:http", "percentage": 75, "note": "May cause OOM on very large uploads"}
    ]'::jsonb,
    'Code using node:http for outgoing requests, especially with large payloads',
    'Requests complete successfully, memory usage acceptable for use case',
    'Unlike Node.js, Bun buffers entire outgoing request body in memory. Use fetch() for better performance. Streaming not yet implemented.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://bun.sh/docs/runtime/nodejs-apis'
);
