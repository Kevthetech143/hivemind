-- Add Blazor common errors batch 1
-- Extracted from Microsoft Learn documentation: https://learn.microsoft.com/en-us/aspnet/core/blazor/

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'Blazor component file naming error: lowercase component names not recognized',
    'blazor',
    'HIGH',
    '[
        {"solution": "Rename component file to start with uppercase letter (e.g., ProductDetail.razor instead of productDetail.razor)", "percentage": 95, "note": "Component file names are case-sensitive in Blazor"},
        {"solution": "Verify filename matches the component class name exactly", "percentage": 90, "note": "Both single-file and code-behind approaches require uppercase start"},
        {"solution": "Check component reference in parent components matches the uppercase name", "percentage": 85, "command": "<ProductDetail /> not <productDetail />"}
    ]'::jsonb,
    'Blazor project created, Visual Studio or code editor open',
    'Component compiles successfully, Component renders without errors in browser',
    'Component naming must start with uppercase. Do not assume case-insensitive naming like some other frameworks. Check all file renames propagate to all references.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/components/'
),
(
    'Blazor debugging error: Unable to find debuggable browser tab',
    'blazor',
    'HIGH',
    '[
        {"solution": "Ensure browser is launched with remote debugging enabled via launch configuration in Visual Studio", "percentage": 92, "note": "Default browser launch may not enable debugging"},
        {"solution": "Check that Visual Studio has ''Enable JavaScript debugging for ASP.NET (Chrome and Edge)'' enabled in Tools > Options > Debugging > JavaScript", "percentage": 90, "command": "Tools > Options > Debugging > JavaScript > Enable JS debugging"},
        {"solution": "Confirm HTTPS development certificate is installed and trusted on the system", "percentage": 85, "note": "Invalid certificates prevent debugging connections"}
    ]'::jsonb,
    'Visual Studio 2019+ or compatible IDE, Chrome or Edge browser, Blazor project',
    'Debugger attaches successfully, Breakpoints trigger as expected, Console shows no connection errors',
    'Firefox debugging from Visual Studio is not supported. Ensure localhost is added to proxy bypass settings via NO_PROXY environment variable. Check firewall does not block NodeJS debug proxy.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/debug'
),
(
    'Blazor component security error: secrets stored in client-side code',
    'blazor',
    'VERY_HIGH',
    '[
        {"solution": "Move all secrets to a backend Web API service and call from Blazor component via HttpClient", "percentage": 95, "note": "All client-side code is visible to users"},
        {"solution": "Store connection strings and API keys in server configuration (appsettings.json) or environment variables, not client-side", "percentage": 95, "note": "Never expose secrets to browser"},
        {"solution": "Use backend endpoints to authenticate API requests and validate credentials server-side before returning data", "percentage": 92, "note": "Client-side authentication can be bypassed"}
    ]'::jsonb,
    'Backend API project, Understanding of ASP.NET Core security',
    'No secrets visible in browser DevTools Network tab, Backend validates all requests, Application passes security scan',
    'Do not store connection strings, API keys, passwords, PINs, tokens, or private keys in client-side Razor or C# code. All client code can be modified by users. Client-side authorization checks are always bypassable.',
    0.99,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/security/'
),
(
    'Blazor component lifecycle error: OnInitializedAsync executes twice in prerendered apps',
    'blazor',
    'HIGH',
    '[
        {"solution": "Add a flag to track execution state: create a private bool _initialized field and check it at start of OnInitializedAsync", "percentage": 90, "note": "Prevents duplicate service calls and database queries"},
        {"solution": "Wrap expensive operations with if (!_initialized) { ... _initialized = true; } pattern", "percentage": 88, "note": "Executes once during prerender, once during client activation"},
        {"solution": "Use OnInitializedAsync only for essential initialization; defer non-critical logic to OnAfterRenderAsync", "percentage": 85, "note": "OnAfterRenderAsync runs only on client after prerendering"}
    ]'::jsonb,
    'Blazor Web App with prerendering enabled, Component using OnInitializedAsync',
    'Service calls execute once per load, No duplicate database queries, Component state is correct',
    'Remember OnInitializedAsync is called twice: once during server prerendering, once when component activates on client. Without tracking, you execute initialization code twice.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/components/lifecycle'
),
(
    'Blazor JavaScript interop error: Missing [JSInvokable] attribute on .NET methods',
    'blazor',
    'HIGH',
    '[
        {"solution": "Add [JSInvokable] attribute to public static method that should be callable from JavaScript", "percentage": 95, "note": "Attribute is mandatory for JS interop"},
        {"solution": "Ensure method is public and static, as these are requirements for JS invocation", "percentage": 93, "command": "[JSInvokable] public static async Task<string> MyMethod() { ... }"},
        {"solution": "Use DotNetObjectReference.Create() for instance methods, and call via invokeMethodAsync with proper reference disposal", "percentage": 90, "note": "Prevents memory leaks from uncollected references"}
    ]'::jsonb,
    'Blazor component or .NET class, JavaScript code attempting to call .NET',
    'JavaScript successfully invokes .NET method, Return value received in JavaScript, No runtime errors in console',
    'Methods must be marked [JSInvokable] and be public static. Instance methods require DotNetObjectReference.Create() and proper disposal. Open generic methods not supported with static invocation.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/call-dotnet-from-javascript'
),
(
    'Blazor StateHasChanged error: calling outside Blazor dispatcher context',
    'blazor',
    'HIGH',
    '[
        {"solution": "Wrap external callbacks (timers, event handlers) with InvokeAsync(): _ = InvokeAsync(() => { StateHasChanged(); });", "percentage": 94, "note": "Ensures execution in Blazor dispatcher context"},
        {"solution": "Use InvokeAsync for any state changes triggered outside normal event handling or lifecycle methods", "percentage": 92, "command": "_ = InvokeAsync(async () => { await SomeAsync(); StateHasChanged(); });"},
        {"solution": "For timer callbacks, wrap the entire callback logic within InvokeAsync, not just StateHasChanged", "percentage": 90, "note": "Timer threads do not have Blazor dispatcher"}
    ]'::jsonb,
    'Blazor component with event handlers or timers, Component state that needs refresh',
    'UI updates correctly after external event, No ''thread not associated with dispatcher'' errors, State changes visible immediately',
    'Error message: ''The current thread is not associated with the Dispatcher.'' This happens with timers, background tasks, and external event subscriptions. Always use InvokeAsync() when calling StateHasChanged outside event handlers.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/components/rendering'
),
(
    'Blazor event handler error: using void-returning async methods',
    'blazor',
    'VERY_HIGH',
    '[
        {"solution": "Always return Task or ValueTask from async event handlers, never void: async Task OnClick() { ... }", "percentage": 96, "note": "Framework cannot track void-returning async methods"},
        {"solution": "Change method signatures from ''async void OnHandler()'' to ''async Task OnHandler()''", "percentage": 95, "command": "private async Task HandleClick() { await Task.Delay(100); }"},
        {"solution": "Ensure all exceptions in async event handlers are caught and logged by returning Task", "percentage": 93, "note": "Unhandled exceptions in void methods will crash silently"}
    ]'::jsonb,
    'Blazor component with event handlers, Understanding of async/await patterns',
    'Event handlers execute without exceptions, Exceptions are properly logged, UI updates after async operations complete',
    'Never use async void for event handlers. The framework cannot track void-returning async methods. If exceptions occur, the entire process fails silently. Always return Task or ValueTask.',
    0.96,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/components/event-handling'
),
(
    'Blazor file upload error: file size exceeds 500 KB limit',
    'blazor',
    'HIGH',
    '[
        {"solution": "Check file size before upload using InputFile.FileSize property; reject files > 500 KB", "percentage": 92, "note": "OpenReadStream() throws exception for files > 500 KB"},
        {"solution": "Stream large files directly to storage instead of loading into MemoryStream to prevent memory exhaustion", "percentage": 94, "command": "Copy stream directly to FileStream without buffering"},
        {"solution": "Use chunked upload for files > 500 KB: split file into chunks on client, upload separately, reassemble on server", "percentage": 88, "note": "More reliable for large files"}
    ]'::jsonb,
    'Blazor component with InputFile, Server-side storage, InputFile.FileSize support',
    'Files up to size limit upload successfully, Large files use chunked upload, No out-of-memory exceptions',
    'Default limit is 500 KB; OpenReadStream() throws exception for larger files. Never load entire large files into MemoryStream. Always stream to disk or external storage. Client-side Blazor on non-Chromium browsers may fail with 2GB+ files.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/file-uploads'
),
(
    'Blazor data binding error: improper @bind syntax with wrong case sensitivity',
    'blazor',
    'HIGH',
    '[
        {"solution": "Use @bind in lowercase only; @Bind, @BIND, and other cases are invalid and will not compile", "percentage": 96, "note": "Blazor binding directives are case-sensitive"},
        {"solution": "Ensure property is properly declared with public getter/setter: @bind=\"PropertyName\"", "percentage": 93, "command": "[Parameter] public string Value { get; set; }"},
        {"solution": "Use @bind:event=\"onchange\" for select elements, @bind:event=\"oninput\" for text inputs", "percentage": 90, "note": "Different events for different input types"}
    ]'::jsonb,
    'Blazor component with input elements, Understanding of two-way binding',
    'Binding updates component state, UI reflects state changes, Input events trigger correctly',
    'Binding directives are case-sensitive: @bind is valid, @Bind and @BIND are not. Do not use @oninput event handler alone expecting two-way binding; Blazor will not synchronize state. Avoid writing directly to component parameters.',
    0.96,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/data-binding'
),
(
    'Blazor virtualization error: inconsistent item heights or root-level scrolling',
    'blazor',
    'HIGH',
    '[
        {"solution": "Ensure all rendered items have identical height; use CSS to enforce consistent dimensions", "percentage": 94, "note": "Virtualization calculations require uniform item heights"},
        {"solution": "Avoid using overflow-y: scroll on <html> or <body>; use div container with max-height instead", "percentage": 95, "note": "Root scrolling freezes browser with large datasets"},
        {"solution": "Do not assign both Items and ItemsProvider simultaneously; choose one item source only", "percentage": 92, "command": "Either use Items or ItemsProvider, never both"}
    ]'::jsonb,
    'Blazor component using Virtualize, Large dataset to render, Custom CSS styling',
    'Virtual scrolling works smoothly, Items render/unrender as user scrolls, No browser freezing with large datasets',
    'All virtualized items must have identical height including placeholders. Layout structure must be single vertical stack. Do not interfere with spacer elements via CSS. Without focusable scroll container, keyboard scrolling fails in Chromium.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/components/virtualization'
),
(
    'Blazor dependency injection error: service not registered for prerendering',
    'blazor',
    'HIGH',
    '[
        {"solution": "Register services in main project (not just Client project) for prerendering to access them: builder.Services.AddScoped<IMyService, MyService>()", "percentage": 93, "note": "Prerendering happens on server before client activation"},
        {"solution": "Disable prerendering on components requiring client-only services: @rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))", "percentage": 90, "note": "Alternative if services cannot be shared"},
        {"solution": "Use OwningComponentBase<TService> instead of regular ComponentBase to properly manage service lifetimes", "percentage": 88, "note": "Ensures service disposal with component"}
    ]'::jsonb,
    'Blazor Web App project, Service implementation, Understanding of DI scopes',
    'Services resolve successfully during prerendering, No DI exceptions in startup, Components render correctly',
    'Prerendering runs on server and needs access to services. Services in .Client project are not available. Scoped services on server are not reconstructed on client over SignalR. Transient disposable services cause memory leaks in circuit lifetime.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/fundamentals/dependency-injection'
),
(
    'Blazor authorization error: [Authorize] on child components does not prevent rendering',
    'blazor',
    'VERY_HIGH',
    '[
        {"solution": "Use <AuthorizeView> component wrapper instead of [Authorize] attribute on child components", "percentage": 95, "note": "[Authorize] only works on routable page components"},
        {"solution": "Wrap sensitive UI sections with <AuthorizeView>: <AuthorizeView Roles=\"admin\">Protected content</AuthorizeView>", "percentage": 94, "command": "<AuthorizeView Roles=\"Admin\">Content</AuthorizeView>"},
        {"solution": "Always validate authorization server-side via Web API even if client has authorization checks", "percentage": 96, "note": "Client-side checks are always bypassable by users"}
    ]'::jsonb,
    'Blazor component, Authentication configured, User claims/roles setup',
    'Unauthorized users cannot view protected UI sections, Protected resources validate server-side, No console warnings about authorization',
    '[Authorize] attribute on child components provides false security - it does not prevent rendering. Always use <AuthorizeView>. Client-side authorization is always bypassable. Never trust client validation for sensitive operations; validate server-side.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/blazor/security/'
);
