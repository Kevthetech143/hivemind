-- Phase 2: Add pgvector for Semantic Search
-- Enables hybrid search combining FTS + vector similarity
-- Expected improvement: +40-60% total search quality

-- Enable pgvector extension
CREATE EXTENSION IF NOT EXISTS vector;

-- Add embedding column (OpenAI text-embedding-3-small = 1536 dimensions)
ALTER TABLE knowledge_entries
ADD COLUMN IF NOT EXISTS embedding vector(1536);

-- Create HNSW index for fast vector similarity search
-- Using cosine distance (most common for OpenAI embeddings)
CREATE INDEX IF NOT EXISTS idx_knowledge_embedding_hnsw
ON knowledge_entries
USING hnsw (embedding vector_cosine_ops);

-- Add metadata columns for embedding management
ALTER TABLE knowledge_entries
ADD COLUMN IF NOT EXISTS embedding_model TEXT DEFAULT 'text-embedding-3-small',
ADD COLUMN IF NOT EXISTS embedding_generated_at TIMESTAMPTZ;

COMMENT ON COLUMN knowledge_entries.embedding IS
'Vector embedding for semantic search. Generated using OpenAI text-embedding-3-small (1536 dimensions).';

COMMENT ON INDEX idx_knowledge_embedding_hnsw IS
'HNSW index for fast approximate nearest neighbor search using cosine distance.';
