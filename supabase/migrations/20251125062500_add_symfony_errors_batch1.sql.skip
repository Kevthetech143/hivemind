-- Add Symfony framework common errors from official documentation batch 1

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Symfony error: Cannot autowire service - argument must have type-hint or be given value explicitly',
    'symfony',
    'HIGH',
    '[
        {"solution": "Add explicit type-hint to scalar arguments in constructor, e.g., type-hint with a class interface instead of string", "percentage": 90, "note": "Autowiring requires proper type hints"},
        {"solution": "Use services.yaml bind configuration to inject scalar values by name: bind: { $adminEmail: ''admin@example.com'' }", "percentage": 85, "command": "Add to config/services.yaml under services._defaults"},
        {"solution": "Reference another service using @ prefix: ''@service-id'' instead of plain string ''service-id''", "percentage": 80, "note": "@ symbol tells container to treat as service reference"}
    ]'::jsonb,
    'Symfony project created, services.yaml file accessible',
    'Service loads without error, Dependency is injected correctly, debug:container shows service configured',
    'Forgetting @ prefix when referencing services. Scalar parameters need explicit binding, not just type-hints.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://symfony.com/doc/current/service_container/dependency_injection.html'
),
(
    'Symfony routing error: Route parameter contains slash character causing URL mismatch',
    'symfony',
    'HIGH',
    '[
        {"solution": "Add requirement to route parameter: add requirements attribute with regex .+ to allow slashes: #[Route(''/path/{param}'', requirements: [''param'' => ''.+''])]", "percentage": 90, "note": "Default behavior blocks slash in route params"},
        {"solution": "For numeric parameters only, use requirement ''\\d+'' to enforce digit-only matching", "percentage": 85, "command": "requirements: [''param'' => ''\\d+'']"},
        {"solution": "Debug route matching with command: symfony console router:match /your/test/url", "percentage": 80, "command": "symfony console router:match /blog/my-post/extra"}
    ]'::jsonb,
    'Symfony project setup, route defined with parameters',
    'URL matches expected route, debug:router shows correct route order, router:match returns expected route',
    'Slash characters break route matching by default. Multiple similar routes need requirement specification to avoid ambiguity. Optional parameters must come after required ones.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://symfony.com/doc/current/routing.html'
),
(
    'Symfony CSRF token validation fails: Form login not protected against CSRF attacks',
    'symfony',
    'HIGH',
    '[
        {"solution": "Enable CSRF protection in security.yaml: set enable_csrf: true under form_login authenticator", "percentage": 95, "note": "Required for form-based authentication"},
        {"solution": "Add hidden token field to login form template: {{ csrf_token(''authenticate'') }} wrapped in input field", "percentage": 92, "command": "<input type=\"hidden\" name=\"_csrf_token\" value=\"{{ csrf_token(''authenticate'') }}\">"},
        {"solution": "Verify request includes _csrf_token parameter matching server token value", "percentage": 85, "note": "Token mismatch causes 403 Forbidden error"}
    ]'::jsonb,
    'Symfony security bundle installed, form_login configured in security.yaml',
    'Form submission succeeds with 200 response, No 403 Forbidden errors, CSRF token validation passes silently',
    'Forgetting to include _csrf_token hidden field in form. enable_csrf: true must be explicitly set. Token field name must be _csrf_token.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://symfony.com/doc/current/security/form_login_setup.html'
),
(
    'Symfony database error: Missing DATABASE_URL environment variable',
    'symfony',
    'VERY_HIGH',
    '[
        {"solution": "Set DATABASE_URL in .env file with format: DATABASE_URL=mysql://user:password@127.0.0.1:3306/dbname or postgresql://...", "percentage": 95, "note": "Required before any database operations"},
        {"solution": "For local development, use sqlite: DATABASE_URL=sqlite:///%kernel.project_dir%/var/app.db", "percentage": 90, "command": "echo ''DATABASE_URL=sqlite:///var/app.db'' >> .env"},
        {"solution": "Override in .env.local for machine-specific values without committing to git", "percentage": 88, "note": ".env.local takes precedence over .env"}
    ]'::jsonb,
    '.env file exists in project root, Composer installed, Database server accessible',
    'doctrine:database:create executes successfully, Doctrine commands connect to database, Migrations run without connection errors',
    '.env.local must not be committed to version control. DATABASE_URL is case-sensitive. Missing credentials cause "Connection refused" errors.',
    0.96,
    'sonnet-4',
    NOW(),
    'https://symfony.com/doc/current/doctrine.html'
),
(
    'Symfony validation error: Required field NotBlank constraint validation fails',
    'symfony',
    'VERY_HIGH',
    '[
        {"solution": "Add #[Assert\\NotBlank] attribute to required entity properties: #[Assert\\NotBlank] public string $title;", "percentage": 94, "note": "Most common validation constraint"},
        {"solution": "Use form field required option with NotBlank together - required option alone does not enforce server-side validation", "percentage": 90, "command": "''title'' => TextType::class, ''required'' => true combined with #[Assert\\NotBlank]"},
        {"solution": "Retrieve error messages in controller: foreach ($form->getErrors(true) as $error) { echo $error->getMessage(); }", "percentage": 85, "note": "Display validation feedback to user"}
    ]'::jsonb,
    'Symfony validator component installed, Entity class created, Constraint attributes imported',
    'Form validation works, Error messages display correctly, Data persists only after passing validation',
    'required option on form field does not trigger server-side validation. NotBlank constraint required for mandatory fields. Client-side validation can be bypassed, always validate server-side.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://symfony.com/doc/current/validation.html'
),
(
    'Symfony error: User authentication fails - missing PasswordUpgraderInterface implementation',
    'symfony',
    'MEDIUM',
    '[
        {"solution": "Implement PasswordUpgraderInterface in user repository class: implements PasswordUpgraderInterface", "percentage": 92, "note": "Required when using password hashing with Doctrine"},
        {"solution": "Add upgradePassword() method to repository to update hashed passwords: public function upgradePassword(PasswordAuthenticatedUserInterface $user, string $hashedPassword)", "percentage": 90, "command": "Use UserPasswordHasherInterface in setter"},
        {"solution": "Hash passwords before saving with UserPasswordHasherInterface: $hashedPassword = $this->passwordHasher->hashPassword($user, $plainPassword);", "percentage": 88, "note": "Never store plaintext passwords"}
    ]'::jsonb,
    'Symfony security bundle installed, User entity created, Doctrine ORM configured',
    'User login succeeds, Password verification passes, getUser() returns authenticated user object',
    'Storing plaintext passwords causes failed authentication. Repository must implement required interface. Password hashing must happen before persist/flush.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://symfony.com/doc/current/security.html'
),
(
    'Symfony deploy error: Cache not cleared in production environment',
    'symfony',
    'HIGH',
    '[
        {"solution": "Clear cache with environment variables before deployment: APP_ENV=prod APP_DEBUG=0 php bin/console cache:clear", "percentage": 93, "note": "Required every deployment"},
        {"solution": "Use Composer install with optimization flag: composer install --no-dev --optimize-autoloader", "percentage": 88, "command": "composer install --no-dev --optimize-autoloader"},
        {"solution": "Run migrations after cache clear: php bin/console doctrine:migrations:migrate --no-interaction", "percentage": 85, "note": "Ensure database schema matches code"}
    ]'::jsonb,
    'Production server access, Composer installed, .env.prod.local configured',
    'Cache directory empty after clear, New configuration loaded, Application responds to requests without stale cache errors',
    'Using APP_ENV=dev in production causes performance issues. Forget cache clear = stale configuration. Need --no-dev flag to reduce vendor size.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://symfony.com/doc/current/deployment.html'
),
(
    'Symfony JSON login error: Request must include username and password in JSON body',
    'symfony',
    'MEDIUM',
    '[
        {"solution": "Send JSON request with username and password keys even if actual identifier is email: {\"username\": \"user@example.com\", \"password\": \"secret\"}", "percentage": 92, "note": "JSON format is literal, not flexible to identifier type"},
        {"solution": "Set Content-Type header to application/json when sending login request", "percentage": 88, "command": "Set Content-Type: application/json header in HTTP request"},
        {"solution": "Configure json_login in security.yaml with correct check_path matching form action", "percentage": 85, "note": "check_path default is /login if not specified"}
    ]'::jsonb,
    'Symfony security bundle with json_login configured, Request client capable of sending JSON',
    'Login request returns 200 with session token, User authenticated after JSON submission, Authentication persists in session',
    'Sending email in username key fails even if email is user identifier. JSON login requires exact key names. Content-Type header critical for routing.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://symfony.com/doc/current/security/form_login_setup.html'
),
(
    'Symfony service container error: Lint validation fails on invalid service definitions',
    'symfony',
    'MEDIUM',
    '[
        {"solution": "Run lint:container before deployment to catch configuration errors: php bin/console lint:container", "percentage": 93, "note": "Detects undefined services and circular dependencies"},
        {"solution": "Check syntax of YAML service definitions: php bin/console debug:container to list all available services", "percentage": 88, "command": "php bin/console debug:container --show-private"},
        {"solution": "Verify all service references use @ prefix: ''@service-name'' in config files", "percentage": 85, "note": "Missing @ treats reference as literal string"}
    ]'::jsonb,
    'Symfony project created, services.yaml configured, Console access available',
    'lint:container exits with code 0, debug:container lists services, No service not found errors at runtime',
    'Typos in service names silently pass until service loads. YAML indentation errors break parsing. Abstract services need compiler passes.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://symfony.com/doc/current/service_container/index.html'
),
(
    'Symfony HTTP Basic authenticator logout fails: Browser credentials cached',
    'symfony',
    'MEDIUM',
    '[
        {"solution": "Use form-based authentication instead of HTTP Basic for logout capability: Switch from http_basic to form_login authenticator", "percentage": 92, "note": "HTTP Basic cannot clear browser credentials"},
        {"solution": "Inform users to close browser completely to clear cached HTTP Basic credentials: credentials persist across sessions", "percentage": 80, "note": "Browser-level caching, not Symfony-level"},
        {"solution": "Use Session-based authentication with logout endpoint for proper credential clearing", "percentage": 88, "command": "Implement logout route with invalidate session"}
    ]'::jsonb,
    'Symfony security bundle installed, Authentication configured, User logged in',
    'User sees login prompt on next request, Browser cache cleared for domain, New login succeeds with different credentials',
    'HTTP Basic cannot implement proper logout. Users must close all browser windows. Switching authenticators requires security.yaml update.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://symfony.com/doc/current/security.html'
),
(
    'Symfony Doctrine migration error: Schema synchronization fails with "relation does not exist"',
    'symfony',
    'HIGH',
    '[
        {"solution": "Generate migration for schema changes: php bin/console make:migration followed by php bin/console doctrine:migrations:migrate", "percentage": 93, "note": "Always use migrations, never manual SQL for schema"},
        {"solution": "Create entity with make:entity command: php bin/console make:entity EntityName then make:migration", "percentage": 90, "command": "php bin/console make:entity Product && php bin/console make:migration"},
        {"solution": "Check migration status before flush: php bin/console doctrine:migrations:status to see pending migrations", "percentage": 85, "command": "php bin/console doctrine:migrations:status"}
    ]'::jsonb,
    'Symfony project with Doctrine ORM, Entity created, Migrations directory exists',
    'Migration executes without error, Table exists in database, Doctrine queries return results',
    'Manual SQL in production breaks Doctrine. Migrations must be tracked in version control. Forgetting migrate step before deployment causes runtime errors.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://symfony.com/doc/current/doctrine.html'
);
