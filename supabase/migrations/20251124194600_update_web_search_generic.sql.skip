-- Update web research step to be tool-agnostic (not everyone has Brave MCP)

CREATE OR REPLACE FUNCTION start_troubleshooting_ticket(
    p_problem TEXT,
    p_category TEXT
) RETURNS JSONB AS $$
DECLARE
    v_ticket_id TEXT;
    v_checklist JSONB;
    v_result JSONB;
BEGIN
    -- Generate ticket ID
    v_ticket_id := generate_ticket_id();

    -- Category-specific checklists (web research added as step 1 for all)
    v_checklist := CASE p_category
        WHEN 'mcp-troubleshooting' THEN '["Search official docs/web for similar issues", "Check MCP server status with claude mcp list", "Review MCP server logs", "Verify configuration in mcp_config.json", "Test with minimal configuration"]'::jsonb
        WHEN 'web-automation' THEN '["Search official docs/web for similar issues", "Check browser console for errors", "Verify selector exists in DOM", "Test with longer timeout", "Check for iframes or shadow DOM"]'::jsonb
        WHEN 'database' THEN '["Search official docs/web for similar issues", "Check database logs", "Verify RLS policies", "Test query in SQL editor", "Check authentication token"]'::jsonb
        WHEN 'authentication' THEN '["Search official docs/web for similar issues", "Check localStorage for auth token", "Verify API keys in environment", "Test auth flow in incognito", "Review auth configuration"]'::jsonb
        ELSE '["Search official docs/web for similar issues", "Review error logs", "Check configuration", "Test in isolation", "Verify dependencies"]'::jsonb
    END;

    -- Insert ticket
    INSERT INTO troubleshooting_sessions (ticket_id, problem, category, status)
    VALUES (v_ticket_id, p_problem, p_category, 'open')
    RETURNING jsonb_build_object(
        'ticket_id', ticket_id,
        'problem', problem,
        'category', category,
        'status', status,
        'checklist', v_checklist,
        'created_at', created_at
    ) INTO v_result;

    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
