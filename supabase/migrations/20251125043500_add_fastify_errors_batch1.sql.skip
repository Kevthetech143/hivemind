-- Add Fastify error codes and solutions batch 1
-- Sourced from: https://fastify.dev/docs/latest/Reference/Errors/

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Fastify: FST_ERR_OPTIONS_NOT_OBJ',
    'fastify',
    'HIGH',
    '[
        {"solution": "Ensure Fastify options are passed as an object, not a string or array", "percentage": 95, "note": "Common when destructuring config files", "command": "const fastify = Fastify({ logger: true }) // correct"},
        {"solution": "Verify no middleware or configuration layers modify the options object before passing to Fastify", "percentage": 85, "note": "Check config loaders"}
    ]'::jsonb,
    'Fastify installed, Node.js 14+',
    'Fastify server starts successfully without throwing FST_ERR_OPTIONS_NOT_OBJ',
    'Common pitfall: Passing configuration as JSON string. Always destructure config first.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_options_not_obj'
),
(
    'Fastify: FST_ERR_CTP_BODY_TOO_LARGE',
    'fastify',
    'HIGH',
    '[
        {"solution": "Increase bodyLimit option in Fastify config: Fastify({ bodyLimit: 1048576 })", "percentage": 92, "note": "Default is 1MB, value in bytes", "command": "bodyLimit: 2097152 // 2MB"},
        {"solution": "Compress request payloads on client side before sending", "percentage": 85, "note": "Use gzip compression"},
        {"solution": "Split large uploads into chunks using multipart/form-data", "percentage": 80, "note": "Use @fastify/multipart plugin"}
    ]'::jsonb,
    'Fastify server configured, Client sending large payloads',
    'Request payload accepted, response returns 200 status',
    'Setting bodyLimit too high can cause memory issues. Start at 50MB and adjust based on needs. Default 1MB works for most APIs.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_ctp_body_too_large'
),
(
    'Fastify: FST_ERR_HOOK_INVALID_HANDLER',
    'fastify',
    'MEDIUM',
    '[
        {"solution": "Ensure hook callback is a function: fastify.addHook(''onRequest'', async (request, reply) => {})", "percentage": 95, "note": "Handler must be async or sync function"},
        {"solution": "Avoid passing non-function values to hook: check if handler is defined before registering", "percentage": 85, "command": "if (typeof handler === ''function'') { fastify.addHook(''onRequest'', handler) }"}
    ]'::jsonb,
    'Fastify server initialized, Hook registration attempted',
    'Hook executes without error, request/reply flow continues normally',
    'Common mistake: Passing hook handler as string or object. Hooks must be functions.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_hook_invalid_handler'
),
(
    'Fastify: FST_ERR_DUPLICATED_ROUTE',
    'fastify',
    'MEDIUM',
    '[
        {"solution": "Check for duplicate route registration using different HTTP methods or paths", "percentage": 90, "note": "Same method+path is not allowed"},
        {"solution": "List all routes to find duplicates: fastify.printRoutes()", "percentage": 88, "command": "fastify.printRoutes()"},
        {"solution": "Use version prefixes to distinguish routes: fastify.register(async (fastify) => { fastify.get(''/api'', v1Handler) }, { prefix: ''/v1'' })", "percentage": 82, "note": "Separate versioned routes"}
    ]'::jsonb,
    'Fastify server initialized, Multiple route handlers registered',
    'All routes accessible with unique methods/paths, no FST_ERR_DUPLICATED_ROUTE thrown',
    'Pitfall: Routes with same method/path in different plugins are still duplicates. Use versioning or paths to separate.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_duplicated_route'
),
(
    'Fastify: FST_ERR_PLUGIN_NOT_VALID',
    'fastify',
    'MEDIUM',
    '[
        {"solution": "Register plugin as function: fastify.register(async (fastify, opts) => { /* plugin code */ })", "percentage": 96, "note": "Plugin must be function or promise-returning function"},
        {"solution": "Verify plugin exports a function, not object or string: module.exports = async (fastify) => {}", "percentage": 90, "command": "typeof plugin === ''function''"},
        {"solution": "Use third-party plugins with @fastify/ prefix from npm", "percentage": 85, "note": "Official plugins are pre-tested"}
    ]'::jsonb,
    'Fastify server ready, Plugin available',
    'Plugin initializes without error, fastify instance available to plugin',
    'Common error: Importing plugin default export when using CommonJS. Check module.exports format.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_plugin_not_valid'
),
(
    'Fastify: FST_ERR_SCH_VALIDATION_BUILD',
    'fastify',
    'HIGH',
    '[
        {"solution": "Validate JSON schema structure using AJV or ajv CLI: ajv validate -s schema.json", "percentage": 91, "note": "Schema must be valid JSON Schema"},
        {"solution": "Check schema properties are correctly defined: properties must be object with type definitions", "percentage": 88, "command": "properties: { name: { type: ''string'' } }"},
        {"solution": "Ensure $ref paths are correct and point to existing schemas", "percentage": 85, "note": "$ref is resolved before validation"}
    ]'::jsonb,
    'Fastify schema defined, Route with schema configured',
    'Schema validates successfully, requests pass validation without schema errors',
    'Pitfall: Circular schema references cause infinite loops. Use $defs to define reusable schemas.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_sch_validation_build'
),
(
    'Fastify: FST_ERR_REP_ALREADY_SENT',
    'fastify',
    'MEDIUM',
    '[
        {"solution": "Ensure only one response is sent per request: avoid multiple reply.send() calls", "percentage": 94, "note": "Use early returns after reply.send()"},
        {"solution": "Check for promise resolution after reply.send(): use return statement to exit handler", "percentage": 90, "command": "return reply.send(data); // exits handler after send"},
        {"solution": "In hooks, verify send is only called once: add guard with reply.sent", "percentage": 85, "note": "reply.sent is true after first send"}
    ]'::jsonb,
    'Fastify route handler registered, Request processed',
    'Request/response completes successfully, only one response sent per request',
    'Common pitfall: Multiple await reply.send() in same handler. Each request handler should send response once.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_rep_already_sent'
),
(
    'Fastify: FST_ERR_CTP_INVALID_TYPE',
    'fastify',
    'MEDIUM',
    '[
        {"solution": "Register content-type parser with string type: fastify.register(fastifyJson, { contentType: ''application/json'' })", "percentage": 93, "note": "Must be string MIME type"},
        {"solution": "Verify MIME type format is correct: application/json, text/plain, etc.", "percentage": 88, "command": "fastify.register(plugin, { contentType: ''application/custom+json'' })"},
        {"solution": "For custom parsers, ensure content-type is string, not object or array", "percentage": 85, "note": "Type validation happens at registration"}
    ]'::jsonb,
    'Fastify server initialized, Custom content-type parser registered',
    'Parser registers without error, requests with matching content-type are parsed correctly',
    'Pitfall: Passing content-type as object or regex instead of string. Always use string MIME type.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_ctp_invalid_type'
),
(
    'Fastify: FST_ERR_DEC_ALREADY_PRESENT',
    'fastify',
    'MEDIUM',
    '[
        {"solution": "Use unique decorator names: fastify.decorate(''utils'', utilities) instead of reusing existing names", "percentage": 92, "note": "Each decorator name must be unique"},
        {"solution": "Check plugin dependency order: load plugins that register decorators before plugins that use them", "percentage": 85, "note": "Register base plugins first"},
        {"solution": "Scope decorators to plugin context: use fastify.decorate() for global or fastify.register() for plugin-scoped", "percentage": 82, "note": "Avoids namespace collisions"}
    ]'::jsonb,
    'Fastify server running, Multiple plugins registering decorators',
    'All decorators accessible on fastify instance without naming conflicts',
    'Common error: Reusing decorator names across plugins. Prefix decorator names with plugin name for clarity.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_dec_already_present'
),
(
    'Fastify: FST_ERR_VALIDATION',
    'fastify',
    'HIGH',
    '[
        {"solution": "Verify request payload matches schema: check request body against route schema definition", "percentage": 89, "note": "Include all required fields with correct types"},
        {"solution": "Review schema for required vs optional fields: ensure client sends required fields", "percentage": 88, "command": "POST body must include all fields in schema.body.required"},
        {"solution": "Check Content-Type header matches schema: application/json, form-data, etc.", "percentage": 85, "note": "Validation uses appropriate parser"}
    ]'::jsonb,
    'Fastify route with schema defined, Client sends request',
    'Request passes validation, returns 200 response with data',
    'Pitfall: Sending extra fields not in schema (set additionalProperties: false). Numeric strings fail when type: number.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_validation'
),
(
    'Fastify: FST_ERR_PLUGIN_TIMEOUT',
    'fastify',
    'LOW',
    '[
        {"solution": "Increase pluginTimeout in Fastify config: Fastify({ pluginTimeout: 30000 })", "percentage": 92, "note": "Default is 10 seconds, increase for long-running plugins"},
        {"solution": "Optimize plugin initialization: move heavy computations outside plugin registration", "percentage": 85, "note": "Register should be fast, lazy-load on first use"},
        {"solution": "Check for blocking operations in plugin: ensure all I/O is async", "percentage": 80, "command": "// Use async/await, not sync fs.readFileSync()"}
    ]'::jsonb,
    'Fastify configured with plugins, Long-running plugin initialization',
    'Plugin initializes before timeout, fastify.listen() completes successfully',
    'Common cause: Synchronous operations or blocking I/O in plugin setup. Always use async patterns.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_plugin_timeout'
),
(
    'Fastify: FST_ERR_ROUTE_HANDLER_NOT_FN',
    'fastify',
    'MEDIUM',
    '[
        {"solution": "Ensure route handler is a function: fastify.get(''/route'', async (request, reply) => {})", "percentage": 94, "note": "Handler must be function, not string/object"},
        {"solution": "Verify handler is imported correctly: check if import/require resolves to function", "percentage": 88, "command": "const handler = require(''./handler''); typeof handler === ''function''"},
        {"solution": "Use middleware patterns correctly: fastify.get(''/route'', [middleware, handler])", "percentage": 82, "note": "Array of functions where last is handler"}
    ]'::jsonb,
    'Fastify server configured, Route registration attempted',
    'Route registers without error, requests to route are handled correctly',
    'Pitfall: Passing route config object as handler. Structure must be (request, reply) => function.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://fastify.dev/docs/latest/Reference/Errors/#fst_err_route_handler_not_fn'
);
