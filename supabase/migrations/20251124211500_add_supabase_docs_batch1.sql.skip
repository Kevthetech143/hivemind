-- Add Supabase Edge Functions official documentation solutions batch 1

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Supabase Edge Function error 500: Internal Server Error',
    'supabase',
    'HIGH',
    '[
        {"solution": "Check Edge Function logs in Dashboard under Functions > [Your Function] > Logs to identify the uncaught exception", "percentage": 95, "note": "Most common cause is unhandled JavaScript errors"},
        {"solution": "Add proper try-catch error handling for async operations", "percentage": 90, "command": "try { const result = await operation() } catch (error) { console.error(error); return new Response(\"Internal error\", { status: 500 }) }"},
        {"solution": "Add error handling for JSON parsing operations", "percentage": 85, "note": "Invalid JSON parsing is a frequent cause of 500 errors"}
    ]'::jsonb,
    'Deployed Edge Function, Access to Supabase Dashboard logs',
    'Function logs show specific error message, Error handler catches exceptions and returns proper response',
    'Not checking logs first. 500 errors always leave traces in logs. Always wrap async operations in try-catch blocks.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/functions/status-codes'
),
(
    'Supabase Edge Function error 503: Service Unavailable',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Check logs for syntax errors preventing function from loading (BOOT_ERROR)", "percentage": 95, "note": "503 indicates function failed to start"},
        {"solution": "Verify function can execute locally with supabase functions serve", "percentage": 90, "command": "supabase functions serve your-function --debug"},
        {"solution": "Check for import errors or missing dependencies in function code", "percentage": 85, "note": "Common with NPM module imports"}
    ]'::jsonb,
    'Supabase CLI installed, Function code accessible locally',
    'Function starts successfully locally, Function deploys without errors, Function responds with 200 status',
    'Not testing locally first. Always verify functions work with supabase functions serve before deploying.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/functions/status-codes'
),
(
    'Supabase Edge Function error 504: Gateway Timeout',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Optimize slow database queries to complete faster", "percentage": 90, "note": "Functions must respond within timeout limit"},
        {"solution": "Add timeout handling to external API requests", "percentage": 88, "note": "Prevent waiting indefinitely on external calls"},
        {"solution": "Break large operations into smaller chunks or use streaming responses", "percentage": 85, "note": "For processing large datasets"}
    ]'::jsonb,
    'Access to function code, Database query access',
    'Function responds within timeout limit, External requests complete successfully, No timeout errors in logs',
    'Functions have a 60-second execution limit. Check for infinite loops or blocking operations. Slow external API calls are a common cause.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/functions/status-codes'
),
(
    'Supabase Edge Function error 546: Resource Limit',
    'supabase',
    'HIGH',
    '[
        {"solution": "Check Edge Function logs to identify which resource limit was exceeded (memory, CPU, or event loop)", "percentage": 95, "note": "Logs show specific resource that was exhausted"},
        {"solution": "Run function locally with supabase functions serve to get full stack trace", "percentage": 90, "command": "supabase functions serve your-function"},
        {"solution": "If event loop completed, check for syntax errors, infinite loops, or unresolved promises", "percentage": 85, "note": "Review function code for implementation issues"}
    ]'::jsonb,
    'Supabase CLI installed, Access to function logs',
    'Function executes without resource limit errors, Stack trace shows error location, Function completes successfully',
    'Event loop completion errors indicate code implementation issues. Check for promises that were not properly awaited.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/functions/troubleshooting'
),
(
    'Supabase Edge Function deploy failed: Function deploy failed due to an internal error',
    'supabase',
    'HIGH',
    '[
        {"solution": "Deploy via CLI with --debug flag to gather extra information", "percentage": 95, "command": "supabase functions deploy FUNCTION_NAME --project-ref $PROJECT_ID --debug"},
        {"solution": "Try alternative bundle method with --use-api flag", "percentage": 85, "command": "supabase functions deploy FUNCTION_NAME --use-api"},
        {"solution": "Try alternative bundle method with --use-docker flag", "percentage": 85, "command": "supabase functions deploy FUNCTION_NAME --use-docker"}
    ]'::jsonb,
    'Supabase CLI installed and authenticated, Docker installed (for --use-docker option)',
    'Debug output shows specific error cause, Function deploys successfully, Function is accessible via API',
    'Check if function exceeds 20MB Edge Function size limit. Debug output often reveals size issues.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/troubleshooting/edge-function-fails-deploy'
),
(
    'Supabase Edge Function bundle size too large',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Check bundle size with deno info command", "percentage": 95, "command": "deno info /path/to/function/index.ts"},
        {"solution": "Remove unused dependencies from imports", "percentage": 90, "note": "Functions have 10MB source code limit"},
        {"solution": "Use selective imports instead of importing entire packages", "percentage": 88, "command": "import { specific } from \"npm:package/specific\" instead of import * as pkg from \"npm:package\""},
        {"solution": "Split large functions into smaller separate functions", "percentage": 80, "note": "Better for maintainability too"}
    ]'::jsonb,
    'Deno installed locally, Access to function source code',
    'Bundle size under 10MB limit, Function deploys successfully, deno info shows reduced dependency size',
    'NPM packages often include unnecessary polyfills and large dependency trees. Always use selective imports from npm: packages.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/functions/troubleshooting'
),
(
    'Supabase Edge Function unable to deploy: syntax errors',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Run deno check on function files locally before deploying", "percentage": 95, "command": "deno check ./supabase/functions/your-function/index.ts"},
        {"solution": "Review dependencies for compatibility with Deno runtime", "percentage": 88, "note": "Not all Node.js packages work in Deno"},
        {"solution": "Deploy with verbose output to see detailed error", "percentage": 85, "command": "supabase functions deploy your-function --debug"}
    ]'::jsonb,
    'Deno installed, Supabase CLI installed, Function source code',
    'deno check passes without errors, Function deploys successfully, No syntax errors in deployment logs',
    'Always run deno check locally before deploying. Deno has different module resolution than Node.js.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/functions/troubleshooting'
),
(
    'Supabase Edge Function CORS error: Unable to call Edge Function',
    'supabase',
    'HIGH',
    '[
        {"solution": "Add proper CORS headers including OPTIONS method handler", "percentage": 95, "note": "Must handle preflight OPTIONS requests"},
        {"solution": "Ensure Access-Control-Allow-Origin header is set in response", "percentage": 90, "command": "headers: { \"Access-Control-Allow-Origin\": \"*\" }"},
        {"solution": "Add Access-Control-Allow-Headers for Content-Type and Authorization", "percentage": 88, "note": "Required for authenticated requests"}
    ]'::jsonb,
    'Access to Edge Function code, Ability to redeploy function',
    'OPTIONS preflight request returns 200 status, Browser allows cross-origin request, Function invocation succeeds from browser',
    'Must handle OPTIONS method separately for CORS preflight. Always include Access-Control-Allow-Origin in response headers.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/functions/troubleshooting'
),
(
    'Supabase Edge Function error 401: Unauthorized',
    'supabase',
    'HIGH',
    '[
        {"solution": "Ensure valid JWT token is passed in Authorization header", "percentage": 95, "note": "Function has JWT verification enabled"},
        {"solution": "Check that JWT token has not expired", "percentage": 90, "note": "Tokens expire after configured duration"},
        {"solution": "For webhooks or public endpoints, disable JWT verification when deploying", "percentage": 85, "command": "supabase functions deploy function-name --no-verify-jwt"}
    ]'::jsonb,
    'Valid Supabase project credentials, User authentication setup',
    'Request includes valid Authorization header, Token is not expired, Function returns 200 status',
    'Edge Functions require JWT verification by default. Use --no-verify-jwt flag for public endpoints only.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/functions/status-codes'
),
(
    'Supabase Edge Function local serve fails: Issues serving functions locally',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Run with --debug flag for detailed output", "percentage": 95, "command": "supabase functions serve your-function --debug"},
        {"solution": "Check ports 54321 and 8081 are not already in use", "percentage": 90, "command": "lsof -i :54321"},
        {"solution": "Update Supabase CLI to latest version", "percentage": 85, "command": "supabase update"}
    ]'::jsonb,
    'Supabase CLI installed, Ports 54321 and 8081 available',
    'Function serves successfully on localhost, Debug output shows function running, No port conflict errors',
    'Always check CLI version first. Port conflicts are common on development machines. Use debug flag for troubleshooting.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/functions/troubleshooting'
),
(
    'Supabase Edge Function shutdown: Memory limit exceeded',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Use streaming instead of buffering entire files or responses", "percentage": 92, "note": "Prevents loading large data into memory"},
        {"solution": "Process data in smaller chunks rather than loading everything at once", "percentage": 90, "note": "Reduces memory footprint"},
        {"solution": "Check memory_used fields in logs to identify heap vs external memory issues", "percentage": 85, "note": "Helps pinpoint specific memory type"}
    ]'::jsonb,
    'Access to Edge Function logs, Function source code access',
    'Function completes without memory errors, Memory usage stays within limits, Logs show normal memory consumption',
    'Avoid buffering large files. Edge Functions have limited memory. Stream data whenever possible.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/functions/troubleshooting'
),
(
    'Supabase Edge Function shutdown: CPU time limit exceeded',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Profile code to identify CPU-intensive sections", "percentage": 90, "note": "Currently limited to 200ms CPU time"},
        {"solution": "Optimize algorithms for better performance and reduce computational complexity", "percentage": 88, "note": "Focus on reducing CPU cycles"},
        {"solution": "Consider caching computed results to avoid repeated calculations", "percentage": 85, "note": "Especially for expensive operations"},
        {"solution": "Move heavy processing to background jobs or external services", "percentage": 80, "note": "For unavoidably complex computations"}
    ]'::jsonb,
    'Access to function code, Understanding of function performance',
    'Function completes within CPU time limit, CPU-intensive operations optimized, No CPU time limit errors in logs',
    'CPU time measures actual processing cycles, not wall-clock time. Complex calculations and encryption are common causes.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/functions/troubleshooting'
);
