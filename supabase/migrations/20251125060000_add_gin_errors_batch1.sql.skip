-- Add official documentation solutions for Gin Web Framework batch 1

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Gin BindJSON validation error: field not validated',
    'gin',
    'HIGH',
    '[
        {"solution": "Use ShouldBindJSON() instead of BindJSON() to get error details and return custom error response", "percentage": 95, "note": "ShouldBindJSON returns error to handler, BindJSON auto-responds with 400", "command": "if err := c.ShouldBindJSON(&data); err != nil { c.JSON(400, gin.H{\"error\": err.Error()}) }"},
        {"solution": "Register custom validators using binding.Validator.Engine() before binding", "percentage": 90, "note": "Use go-playground/validator package", "command": "v.RegisterValidation(\"customTag\", validationFunc)"},
        {"solution": "Use struct tags like `binding:\"required\"` with proper validator imports", "percentage": 85, "note": "Ensure validator package is properly configured"}
    ]'::jsonb,
    'Go 1.16+, Gin v1.6+, proper struct definition with binding tags',
    'JSON request validates successfully, handler receives correct data, custom error messages returned for invalid data',
    'BindJSON silently returns 400 without giving handler error details. Required tag alone does not guarantee validation. Must use ShouldBindJSON for custom error handling. Validator tags are case-sensitive.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://pkg.go.dev/github.com/gin-gonic/gin#Context.ShouldBindJSON'
),
(
    'Gin panic in handler not caught by Recovery middleware',
    'gin',
    'HIGH',
    '[
        {"solution": "Ensure Recovery() middleware is registered early with r.Use(gin.Recovery())", "percentage": 95, "note": "Recovery must be registered before other middleware"},
        {"solution": "Use CustomRecovery() for custom panic handling: r.Use(gin.CustomRecovery(func(c *gin.Context, recovered any) { ... }))", "percentage": 90, "note": "Allows logging panic details and custom response"},
        {"solution": "Create copy of context for goroutines: ctxCopy := c.Copy() to avoid freed memory access", "percentage": 85, "note": "Original context becomes invalid after request completes"}
    ]'::jsonb,
    'Gin v1.0+, panic occurs in HTTP handler or middleware',
    'Server continues running after panic, 500 error response returned, panic logged',
    'Do not launch goroutines with original context after handler returns. Recovery must be first middleware registered. CustomRecovery function must call c.AbortWithStatus() to send response.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://pkg.go.dev/github.com/gin-gonic/gin#Recovery'
),
(
    'Gin warning: "You trusted all proxies, this is NOT safe"',
    'gin',
    'VERY_HIGH',
    '[
        {"solution": "Set trusted proxies explicitly: r.SetTrustedProxies([]string{\"127.0.0.1\", \"10.0.0.0/8\"})", "percentage": 95, "note": "Only trust actual proxy IPs in your infrastructure"},
        {"solution": "If behind CDN, use SetTrustedPlatform(\"cloudflare\") or similar instead of SetTrustedProxies", "percentage": 90, "note": "TrustedPlatform has higher priority than TrustedProxies"},
        {"solution": "If no proxy used, disable with r.SetTrustedProxies(nil)", "percentage": 85, "note": "ClientIP() will return direct remote address"}
    ]'::jsonb,
    'Gin v1.7+, application uses c.ClientIP() or c.RemoteIP()',
    'No warning in logs, c.ClientIP() returns correct client IP, security validation passes',
    'X-Forwarded-For can be spoofed if all proxies are trusted. Wildcard trusting proxies allows IP spoofing attacks. Must explicitly configure trusted proxy IPs based on your deployment topology.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://gin-gonic.com/en/docs/deployment/'
),
(
    'Gin CORS middleware: "Access-Control-Allow-Headers" error',
    'gin',
    'HIGH',
    '[
        {"solution": "Use official gin-contrib/cors package with AllowAllOrigins instead of manual header setting", "percentage": 95, "note": "go get github.com/gin-contrib/cors && import cors middleware"},
        {"solution": "Use AllowHeaders config instead of manually setting headers: cors.Config{AllowHeaders: []string{\"Content-Type\", \"Authorization\"}}", "percentage": 92, "note": "Properly escapes and validates header names"},
        {"solution": "Avoid mixing AllowAllOrigins with AllowOrigins - choose one approach", "percentage": 88, "note": "AllowAllOrigins=true, AllowOrigins=[] will cause panic"}
    ]'::jsonb,
    'Gin v1.0+, github.com/gin-contrib/cors imported',
    'CORS preflight requests return 200, browser does not block requests, custom headers are allowed',
    'Manual CORS header setting is error-prone and browser-incompatible. Wildcard (*) origin with credentials is not allowed. AllowAllOrigins prevents cookie setting. Do not mix AllowAllOrigins with AllowOrigins config.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://github.com/gin-contrib/cors'
),
(
    'Gin context accessed in goroutine after request completes: nil pointer',
    'gin',
    'HIGH',
    '[
        {"solution": "Create context copy in goroutine: go func() { ctxCopy := c.Copy(); /* use ctxCopy */ }()", "percentage": 95, "note": "Copy() creates read-only copy safe for async access"},
        {"solution": "Extract required values before launching goroutine: id := c.Param(\"id\"); go func() { /* use id */ }()", "percentage": 90, "note": "Safer than using context copy"},
        {"solution": "Pass context values as function parameters instead of accessing context directly", "percentage": 88, "note": "Clearer and avoids context lifecycle issues"}
    ]'::jsonb,
    'Gin v1.0+, goroutines spawned from HTTP handlers',
    'Goroutine executes successfully, no nil pointer dereference, data is accessible',
    'Original context is freed after handler returns. Accessing c.Params, c.Request after request completion causes panic. Context.Copy() must be used for async operations. Do not pass original context to goroutines.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://pkg.go.dev/github.com/gin-gonic/gin#Context.Copy'
),
(
    'Gin route not matching with trailing slash inconsistency',
    'gin',
    'MEDIUM',
    '[
        {"solution": "Define routes consistently: r.GET(\"/path\") for no trailing slash, r.GET(\"/path/\") for with trailing slash", "percentage": 90, "note": "Gin treats these as different routes"},
        {"solution": "Use RedirectTrailingSlash option: r.RedirectTrailingSlash = true", "percentage": 85, "note": "Automatically redirects /path/ to /path or vice versa"},
        {"solution": "Register both versions if consistency is not enforced: r.GET(\"/api/users\", handler); r.GET(\"/api/users/\", handler)", "percentage": 75, "note": "Works but not best practice"}
    ]'::jsonb,
    'Gin v1.0+, route defined in router',
    'Route matches with and without trailing slash, 404 errors eliminated',
    'Gin distinguishes between /path and /path/. RedirectTrailingSlash setting must be enabled before registering routes. Route groups inherit RedirectTrailingSlash from parent engine. Inconsistent trailing slash configuration causes 404 errors.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://pkg.go.dev/github.com/gin-gonic/gin#Engine'
),
(
    'Gin file upload: "filename" field may contain path traversal vulnerability',
    'gin',
    'MEDIUM',
    '[
        {"solution": "Validate and sanitize filename: filepath.Base(file.Filename) to extract only filename without directories", "percentage": 95, "note": "Always use filepath.Base for multipart uploads"},
        {"solution": "Use random filename generation: uuid.New().String() + filepath.Ext(file.Filename)", "percentage": 93, "note": "Prevents both traversal and filename conflicts"},
        {"solution": "Validate destination path with filepath.Join and reject paths outside safe directory", "percentage": 90, "note": "Prevent directory traversal attacks"}
    ]'::jsonb,
    'Gin v1.0+, file upload handler implemented, multipart form parsing',
    'Files uploaded to intended directory only, no path traversal possible, filenames are safe',
    'file.Filename from multipart form can contain \"../\" sequences for directory traversal. Never trust file.Filename directly - always sanitize with filepath.Base(). Random filenames prevent execution attacks.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://pkg.go.dev/github.com/gin-gonic/gin#Context.SaveUploadedFile'
),
(
    'Gin middleware continues executing after c.Abort() called',
    'gin',
    'MEDIUM',
    '[
        {"solution": "Check c.IsAborted() in middleware after Abort(): if c.IsAborted() { return }", "percentage": 90, "note": "Abort only prevents further handler execution, not middleware"},
        {"solution": "Call c.Next() conditionally: if !authorized { c.AbortWithStatus(401); return }; c.Next()", "percentage": 88, "note": "Prevent calling Next() prevents remaining handlers/middleware"},
        {"solution": "Use c.AbortWithStatus() or c.AbortWithStatusJSON() to send response and abort chain", "percentage": 85, "note": "More efficient than setting status manually"}
    ]'::jsonb,
    'Gin v1.0+, middleware chain with multiple handlers',
    'Aborted requests do not execute handlers, response sent immediately, middleware respects abort status',
    'Abort() does not stop middleware execution automatically. Must check c.IsAborted() or return from middleware function. Subsequent middleware after abort should check IsAborted(). Not calling c.Next() prevents handler execution but middleware continues.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://pkg.go.dev/github.com/gin-gonic/gin#Context.Abort'
),
(
    'Gin custom validation function "Undefined validation function" error',
    'gin',
    'MEDIUM',
    '[
        {"solution": "Register custom validator before any BindJSON calls: v := binding.Validator.Engine().(*validator.Validate); v.RegisterValidation(\"myvalidator\", myFunc)", "percentage": 93, "note": "Cast Validator.Engine() to *validator.Validate"},
        {"solution": "Ensure validator package version matches Gin version - use go.mod to pin compatible versions", "percentage": 88, "note": "Version mismatches cause undefined function errors"},
        {"solution": "Register all custom validators in init() function called on app startup", "percentage": 85, "note": "Ensures validators available before handlers execute"}
    ]'::jsonb,
    'Gin v1.6+, go-playground/validator imported, custom validation tag defined',
    'Struct validation succeeds, custom validator function executes, binding errors properly returned',
    'Validator must be registered before binding occurs. Function name must match tag name exactly. Validator.Engine() may return nil if not properly initialized. Custom validators must accept (fl validator.FieldLevel) bool parameter.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://pkg.go.dev/github.com/go-playground/validator/v10'
),
(
    'Gin html/template rendering fails: "template not found"',
    'gin',
    'MEDIUM',
    '[
        {"solution": "Load all templates with LoadHTMLGlob: r.LoadHTMLGlob(\"templates/**/*.html\")", "percentage": 92, "note": "Glob pattern must match actual template file paths"},
        {"solution": "Set template directory correctly: r.LoadHTMLGlob(\"./templates/*.html\") for local paths", "percentage": 88, "note": "Use relative paths from working directory or absolute paths"},
        {"solution": "Use c.HTML(200, \"template.html\", data) with exact filename (no path): r.LoadHTMLGlob(\"templates/**/*.html\"); c.HTML(200, \"index.html\", data)", "percentage": 85, "note": "Template name is basename only, not full path"}
    ]'::jsonb,
    'Gin v1.0+, templates directory exists, HTML files present',
    'Templates render successfully, c.HTML() returns 200, no 500 errors',
    'LoadHTMLGlob must be called before routes. Glob pattern must match template locations. c.HTML() uses template basename only, not full path. Working directory affects relative paths. Template files must be readable.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://pkg.go.dev/github.com/gin-gonic/gin#Engine.LoadHTMLGlob'
),
(
    'Gin form binding uppercase field name ignored: binding:"form:fieldname"',
    'gin',
    'MEDIUM',
    '[
        {"solution": "Use lowercase form field names that match Go struct fields: type User struct { Name string `form:\"name\"` }", "percentage": 93, "note": "Form field names are case-sensitive in binding"},
        {"solution": "Use query tags for URL parameters: type Filter struct { Search string `form:\"search\" binding:\"required\"` }", "percentage": 88, "note": "Query and form fields must match exactly"},
        {"solution": "Enable ShouldBindQuery or ShouldBindForm for custom handling: c.ShouldBindQuery(&params)", "percentage": 85, "note": "Explicit binding method gives more control"}
    ]'::jsonb,
    'Gin v1.0+, HTML forms or query strings with form binding',
    'Form fields bind correctly to struct, all fields populated, validation succeeds',
    'Form field names are case-sensitive. HTML form fields must match Go struct form tags exactly. Uppercase form field names will not bind to lowercase struct tags. Query string parameters are case-sensitive. Form tag must specify field name explicitly.',
    0.84,
    'sonnet-4',
    NOW(),
    'https://pkg.go.dev/github.com/gin-gonic/gin#Context.ShouldBindQuery'
),
(
    'Gin router compile panic with invalid regex in path parameter',
    'gin',
    'LOW',
    '[
        {"solution": "Use path parameters without regex if not needed: r.GET(\"/users/:id\", handler) instead of r.GET(\"/users/:id(\\\\d+)\", handler)", "percentage": 90, "note": "Simple parameters are more compatible"},
        {"solution": "For regex parameters, ensure pattern is valid Go regex: r.GET(\"/users/:id([0-9]+)\", handler)", "percentage": 88, "note": "Test regex separately before using in routes"},
        {"solution": "Validate route definition by running app - syntax errors panic at startup, not runtime", "percentage": 85, "note": "Panics catch invalid patterns early"}
    ]'::jsonb,
    'Gin v1.0+, custom path parameters with regex defined',
    'Application starts without panic, routes compile successfully, parameters match correctly',
    'Invalid Go regex in path parameter causes panic during route compilation. Parentheses in regex must be escaped in Go strings. Route compilation is immediate, errors surface at startup. Complex regexes should be tested separately.',
    0.80,
    'sonnet-4',
    NOW(),
    'https://pkg.go.dev/github.com/gin-gonic/gin#Engine'
);
