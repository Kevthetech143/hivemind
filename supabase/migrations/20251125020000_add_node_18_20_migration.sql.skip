-- Node.js 18â†’20 Migration Guide - Official Release Notes
-- Source: https://nodejs.org/en/blog/release/v20.0.0
-- Category: Migration guide
-- Extracted: 2025-11-25

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'Node.js 20 WASI version option now required - no default value',
    'nodejs-migration',
    'MEDIUM',
    '[
        {"solution": "Add explicit version when instantiating WASI: new WASI({version: ''preview1''})", "percentage": 95, "command": "const wasi = new WASI({ version: ''preview1'' })", "note": "Breaking change in Node 20"},
        {"solution": "Check WASI documentation for available versions: preview0, preview1", "percentage": 90, "note": "preview1 is recommended for most use cases"},
        {"solution": "Update existing WASI code to include version parameter in constructor", "percentage": 92, "note": "Previously defaulted to preview1"}
    ]'::jsonb,
    'Node.js 20.0.0+, WASI module usage, Valid WASI version string',
    'WASI instantiates without error, WebAssembly modules execute correctly, No missing version errors',
    'Version parameter is mandatory in Node 20 - code relying on default will break. Always specify version explicitly. Check WASI spec compatibility for your WASM modules.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
),
(
    'Node.js 20 test runner now stable - experimental APIs may have changed',
    'nodejs-migration',
    'HIGH',
    '[
        {"solution": "Update test imports from node:test (no longer experimental flag needed)", "percentage": 95, "command": "import { test, describe } from ''node:test''", "note": "No --experimental-test-runner flag required"},
        {"solution": "Review test runner documentation for API changes during stabilization", "percentage": 88, "note": "Some experimental APIs may have been removed or renamed"},
        {"solution": "Remove --experimental-test-runner flag from scripts and CI config", "percentage": 92, "command": "node test.js (instead of node --experimental-test-runner test.js)", "note": "Flag no longer needed"},
        {"solution": "Verify test hooks and assertion APIs match stable version", "percentage": 85, "note": "beforeEach, afterEach, describe, it now stable"}
    ]'::jsonb,
    'Node.js 20.0.0+, Tests using node:test module, Migration from experimental APIs',
    'Tests run without experimental warnings, Test runner APIs work as expected, No deprecated API errors',
    'Test runner stabilized but some experimental features may have changed. Remove experimental flags. Check for renamed or removed APIs. Use official test runner docs.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
),
(
    'Node.js 20 Permission Model restricts file system and child process access',
    'nodejs-migration',
    'MEDIUM',
    '[
        {"solution": "Run with permission flag: node --experimental-permission --allow-fs-read=/path script.js", "percentage": 90, "command": "node --experimental-permission --allow-fs-read=. --allow-fs-write=./data script.js", "note": "Whitelist specific paths"},
        {"solution": "Use --allow-child-process flag for spawning processes", "percentage": 88, "command": "node --experimental-permission --allow-child-process script.js", "note": "Required for exec, spawn, fork"},
        {"solution": "Enable worker thread creation: --allow-worker flag", "percentage": 85, "command": "node --experimental-permission --allow-worker script.js", "note": "Needed for Worker threads"},
        {"solution": "Audit application for required permissions and apply minimal permission set", "percentage": 92, "note": "Security best practice - least privilege principle"}
    ]'::jsonb,
    'Node.js 20.0.0+, Application requiring restricted operations, Permission requirements identified',
    'Application runs with permission model enabled, Required operations succeed, No permission denied errors',
    'Permission model is experimental but restrictive. Must explicitly allow file system access, child processes, and worker threads. Default denies all. Test thoroughly before production.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
),
(
    'Node.js 20 V8 11.3 upgrade - new JavaScript features available',
    'nodejs-migration',
    'LOW',
    '[
        {"solution": "Use String.prototype.isWellFormed() to check for well-formed Unicode strings", "percentage": 85, "command": "if (!str.isWellFormed()) { /* handle malformed string */ }", "note": "Detects lone surrogates"},
        {"solution": "Use String.prototype.toWellFormed() to sanitize Unicode strings", "percentage": 88, "command": "const sanitized = str.toWellFormed()", "note": "Replaces lone surrogates with replacement char"},
        {"solution": "Utilize new Array methods: toReversed(), toSorted(), toSpliced(), with()", "percentage": 82, "note": "Immutable array operations - return new arrays"},
        {"solution": "Use ArrayBuffer.prototype.resize() and transfer() for resizable buffers", "percentage": 78, "note": "Requires resizable ArrayBuffer creation"}
    ]'::jsonb,
    'Node.js 20.0.0+ with V8 11.3, Modern JavaScript code, No legacy browser support needed',
    'New V8 features work as expected, Code uses modern JavaScript APIs, No compatibility errors',
    'V8 11.3 is forward-compatible but check for deprecated APIs. New features are additions. ResizableArrayBuffer requires opt-in. WebAssembly tail calls enabled by default.',
    0.82,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
),
(
    'Node.js 20 url.parse() warns on non-numeric ports',
    'nodejs-migration',
    'MEDIUM',
    '[
        {"solution": "Validate port is numeric before parsing: if (!/^\\d+$/.test(port)) throw error", "percentage": 92, "command": "const port = parseInt(urlPort, 10); if (isNaN(port)) throw new Error()", "note": "Prevent invalid port values"},
        {"solution": "Migrate to WHATWG URL API: new URL(urlString) which validates strictly", "percentage": 95, "command": "const url = new URL(''http://example.com:3000'')", "note": "WHATWG URL is modern standard"},
        {"solution": "Handle non-numeric ports explicitly in code before URL parsing", "percentage": 88, "note": "Sanitize input URLs"},
        {"solution": "Update URL construction to ensure ports are numeric strings", "percentage": 85, "note": "Fix at source - generate valid URLs"}
    ]'::jsonb,
    'Node.js 20.0.0+, Code using url.parse(), URL validation requirements',
    'url.parse() works without warnings, URLs have numeric ports, WHATWG URL validates correctly',
    'url.parse() is legacy API - prefer WHATWG URL. Non-numeric ports will cause errors in future Node versions. This is deprecation warning, not breaking change yet.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
),
(
    'Node.js 20 ESM loader hooks run in dedicated thread',
    'nodejs-migration',
    'MEDIUM',
    '[
        {"solution": "Ensure loader hooks are thread-safe - no shared mutable state with main thread", "percentage": 92, "note": "Loaders isolated in separate thread"},
        {"solution": "Remove assumptions about loader code running in main thread context", "percentage": 90, "note": "No access to main thread globals"},
        {"solution": "Use message passing for communication between loader and main thread if needed", "percentage": 85, "note": "Similar to Worker thread communication"},
        {"solution": "Test custom loaders thoroughly in Node 20 for thread isolation issues", "percentage": 88, "note": "Breaking change for some custom loaders"}
    ]'::jsonb,
    'Node.js 20.0.0+, Custom ESM loaders via --experimental-loader, Thread-safe code',
    'Loaders execute without errors, Module resolution works correctly, No cross-thread access violations',
    'Loader thread isolation prevents cross-contamination but breaks loaders assuming main thread context. Global state not shared. Check for race conditions.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
),
(
    'Node.js 20 import.meta.resolve() is synchronous for application code',
    'nodejs-migration',
    'LOW',
    '[
        {"solution": "Use import.meta.resolve(specifier) synchronously in application code", "percentage": 90, "command": "const resolved = import.meta.resolve(''./module.js'')", "note": "Returns resolved URL string"},
        {"solution": "For custom loaders, async resolve hooks still supported", "percentage": 85, "note": "Loaders can be async, application code is sync"},
        {"solution": "Replace dynamic async import.meta.resolve() with synchronous version", "percentage": 88, "note": "No need for await in app code"},
        {"solution": "Handle resolution errors with try/catch - throws on failure", "percentage": 82, "command": "try { const url = import.meta.resolve(spec) } catch(e) {}", "note": "Synchronous error handling"}
    ]'::jsonb,
    'Node.js 20.0.0+, ESM modules using import.meta.resolve(), Valid module specifiers',
    'import.meta.resolve() returns resolved URLs synchronously, No async/await needed, Resolution succeeds',
    'Synchronous for application code but loaders can still be async. This simplifies most use cases. Still requires ESM context (not CommonJS).',
    0.85,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
),
(
    'Node.js 20 Web Crypto API strict argument coercion per WebIDL',
    'nodejs-migration',
    'MEDIUM',
    '[
        {"solution": "Ensure all Web Crypto arguments match expected types exactly", "percentage": 92, "note": "No implicit type conversion"},
        {"solution": "Pass ArrayBuffer or TypedArray views, not plain arrays to crypto functions", "percentage": 95, "command": "crypto.subtle.encrypt(algorithm, key, new Uint8Array(data))", "note": "Requires proper buffer types"},
        {"solution": "Validate algorithm objects match WebIDL specifications", "percentage": 88, "note": "Check algorithm name and parameter types"},
        {"solution": "Update crypto code to use strict types - test for type errors", "percentage": 85, "note": "May break loose typing from Node 18"}
    ]'::jsonb,
    'Node.js 20.0.0+, Code using Web Crypto API, Proper TypedArray usage',
    'Web Crypto operations succeed, No type coercion errors, Arguments validated correctly',
    'Web Crypto now strictly follows WebIDL spec. Implicit conversions removed for spec compliance. Use TypedArrays not plain arrays. Check argument object shapes.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
),
(
    'Node.js 20 Ada 2.0 URL parser - improved performance and removed ICU dependency',
    'nodejs-migration',
    'LOW',
    '[
        {"solution": "Benefit from automatic performance improvements in URL parsing - no code changes", "percentage": 95, "note": "Drop-in replacement"},
        {"solution": "Remove ICU-specific workarounds if using url.domainToASCII or url.domainToUnicode", "percentage": 85, "note": "Ada handles internationalization natively"},
        {"solution": "Test URL parsing edge cases for behavioral differences from legacy parser", "percentage": 82, "note": "Ada is more spec-compliant"},
        {"solution": "Leverage faster URL validation in performance-critical paths", "percentage": 88, "note": "Significant speed improvement"}
    ]'::jsonb,
    'Node.js 20.0.0+, Code using URL parsing (WHATWG URL or url module)',
    'URL parsing works correctly, Performance improves, No ICU dependency issues, Domain conversion accurate',
    'Ada 2.0 is mostly compatible but more spec-compliant. May expose bugs in non-compliant URL usage. Performance gains are automatic. ICU no longer needed for hostnames.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
),
(
    'Node.js 20 AsyncResource.bind asyncResource property deprecated',
    'nodejs-migration',
    'LOW',
    '[
        {"solution": "Stop relying on asyncResource property of bound functions", "percentage": 90, "note": "Property will be removed in future versions"},
        {"solution": "Use AsyncResource.bind() for binding but access resource via closure if needed", "percentage": 85, "note": "Store reference separately"},
        {"solution": "Refactor code to not depend on accessing AsyncResource from bound function", "percentage": 88, "note": "Architectural change may be needed"},
        {"solution": "Check async_hooks documentation for alternative patterns", "percentage": 82, "note": "Official migration guidance"}
    ]'::jsonb,
    'Node.js 20.0.0+, Code using AsyncResource.bind, Async context tracking',
    'Async context tracking works without deprecated property, No deprecation warnings, Code migrated to supported APIs',
    'Deprecation warning only - still works in Node 20. Plan migration before property removal. Consider if asyncResource access is actually necessary.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
),
(
    'Node.js 20 ARM64 Windows official support with binaries',
    'nodejs-migration',
    'LOW',
    '[
        {"solution": "Download ARM64 Windows binaries from nodejs.org for native performance", "percentage": 95, "command": "Download from https://nodejs.org/dist/v20.0.0/", "note": "Official release includes ARM64 Windows"},
        {"solution": "Remove x64 emulation workarounds if using ARM64 Windows", "percentage": 90, "note": "Native binaries available"},
        {"solution": "Update CI/CD pipelines to test on ARM64 Windows if targeting platform", "percentage": 85, "note": "Full CI coverage now available"},
        {"solution": "Verify native modules are compatible with ARM64 Windows architecture", "percentage": 88, "note": "Some native addons may need recompilation"}
    ]'::jsonb,
    'ARM64 Windows machine, Node.js 20.0.0+ ARM64 binaries, Compatible native modules',
    'Node runs natively on ARM64 Windows, Performance matches native expectations, No emulation overhead',
    'First official ARM64 Windows support. Experimental in Node 19. Check native module compatibility. Significant performance improvement over x64 emulation.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
),
(
    'Node.js 20 multiple crypto constants removed - DEFAULT_ENCODING, SSL_OP_*, ALPN_ENABLED',
    'nodejs-migration',
    'MEDIUM',
    '[
        {"solution": "Remove references to crypto.DEFAULT_ENCODING - specify encoding explicitly", "percentage": 92, "command": "hash.digest(''hex'') instead of relying on DEFAULT_ENCODING", "note": "Always specify encoding parameter"},
        {"solution": "Replace SSL_OP_* constants with modern TLS configuration", "percentage": 88, "note": "Use secureOptions or ciphers instead"},
        {"solution": "Remove checks for crypto.ALPN_ENABLED - ALPN always available in modern Node", "percentage": 90, "note": "ALPN support is standard now"},
        {"solution": "Audit crypto code for deprecated constant usage and update", "percentage": 85, "note": "Breaking change - code will fail if using removed constants"}
    ]'::jsonb,
    'Node.js 20.0.0+, Code using crypto module, No deprecated constant dependencies',
    'Crypto operations work without removed constants, No reference errors, Modern APIs used',
    'These constants removed, not deprecated - immediate breaking change. DEFAULT_ENCODING removal forces explicit encoding. SSL_OP_* replaced by modern TLS config.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v20.0.0'
);
