-- PostgreSQL 15→16 Migration Guide: Breaking Changes & Migration Issues
-- Source: https://www.postgresql.org/docs/16/release-16.html
-- Category: migration-guide
-- Extracted: 2025-11-25

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'PostgreSQL 15→16: PL/pgSQL bound cursor variable string assignment changed',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Explicitly assign desired portal name to cursor variable before OPEN statement", "percentage": 95, "note": "Required for PL/pgSQL code compatibility"},
        {"solution": "Review all cursor assignments in PL/pgSQL functions that relied on variable name matching", "percentage": 90, "note": "Changes occur at OPEN time in PostgreSQL 16"}
    ]'::jsonb,
    'PostgreSQL 15 database with PL/pgSQL functions, Access to function definitions',
    'Cursor variables properly reference intended portals, Functions execute without naming conflicts',
    'String values no longer automatically match variable names during cursor assignment. Must explicitly set portal names before OPEN.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
),
(
    'PostgreSQL 15→16: Cannot create NULLS NOT DISTINCT indexes for primary keys',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Remove NULLS NOT DISTINCT clause from primary key index definitions", "percentage": 95, "note": "Apply to all primary key definitions before upgrade"},
        {"solution": "Review schema for primary keys defined with NULLS NOT DISTINCT", "percentage": 90, "command": "SELECT constraint_name FROM information_schema.table_constraints WHERE constraint_type = ''PRIMARY KEY''"}
    ]'::jsonb,
    'PostgreSQL 15 database, SQL access to table definitions',
    'Primary key indexes created successfully in PostgreSQL 16, Table constraints remain intact',
    'Attempting to create NULLS NOT DISTINCT primary key indexes will fail in PostgreSQL 16. Must remove clause before upgrade.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
),
(
    'PostgreSQL 15→16: REINDEX DATABASE no longer processes system catalog indexes by default',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Use REINDEX SYSTEM instead of REINDEX DATABASE to explicitly reindex system catalogs", "percentage": 95, "command": "REINDEX SYSTEM;"},
        {"solution": "Update reindexdb command to use --system flag for catalog reindexing", "percentage": 92, "command": "reindexdb --system"},
        {"solution": "Review maintenance scripts that use REINDEX DATABASE and update to REINDEX SYSTEM where catalog indexes needed", "percentage": 88, "note": "Old behavior was less efficient; new approach explicitly targets system vs user indexes"}
    ]'::jsonb,
    'PostgreSQL 15 database, Superuser or appropriate role privileges',
    'System catalog indexes reindexed successfully, REINDEX SYSTEM command executes without error',
    'Forgetting to use REINDEX SYSTEM will leave system catalog indexes fragmented. REINDEX DATABASE in 16 only touches user-defined indexes.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
),
(
    'PostgreSQL 15→16: GENERATED expression inheritance requirements - parent/child generation status must match',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Ensure parent and child tables have matching GENERATED column status before upgrade", "percentage": 95, "note": "Expressions themselves can differ, but generation status must align"},
        {"solution": "For partitioned tables, verify all partitions have same generation status as parent table", "percentage": 92, "command": "SELECT tablename, column_name FROM pg_tables WHERE is_generated = true"},
        {"solution": "Review inheritance relationships and align GENERATED column definitions across table hierarchy", "percentage": 90, "note": "This applies to both table inheritance and partitioned tables"}
    ]'::jsonb,
    'PostgreSQL 15 database with inherited or partitioned tables, Table definitions accessible',
    'All inherited/partitioned tables have matching GENERATED column status, Queries execute without inheritance conflicts',
    'Mismatched GENERATED status between parent and child tables will cause upgrade failures. Must align before migration.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
),
(
    'PostgreSQL 15→16: pg_walinspect functions removed - pg_get_wal_records_info_till_end_of_wal() and pg_get_wal_stats_till_end_of_wal()',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Replace pg_get_wal_records_info_till_end_of_wal() with pg_get_wal_records_info() using appropriate ending LSN values", "percentage": 94, "note": "Requires manual LSN endpoint specification"},
        {"solution": "Replace pg_get_wal_stats_till_end_of_wal() with pg_get_wal_stats() and specify ending LSN parameter", "percentage": 92, "command": "SELECT * FROM pg_get_wal_stats(start_lsn, end_lsn)"},
        {"solution": "Update WAL analysis scripts to explicitly calculate and pass ending LSN values", "percentage": 88, "note": "More explicit approach gives better control over LSN ranges"}
    ]'::jsonb,
    'PostgreSQL 15 database with WAL inspection functions, Access to applications using pg_walinspect',
    'Replaced functions work with explicit LSN parameters, WAL analysis completes successfully',
    'Old functions removed entirely in PostgreSQL 16. Must update all code referencing _till_end_of_wal variants before upgrade.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
),
(
    'PostgreSQL 15→16: Server variable renamed - force_parallel_mode to debug_parallel_query',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Update postgresql.conf configuration file: change force_parallel_mode to debug_parallel_query", "percentage": 95, "command": "sed -i ''s/force_parallel_mode/debug_parallel_query/g'' postgresql.conf"},
        {"solution": "Search application code and scripts for references to force_parallel_mode and update to debug_parallel_query", "percentage": 93, "note": "Check SQL scripts, monitoring tools, and configuration management code"},
        {"solution": "Update any monitoring or diagnostic tools that reference the old variable name", "percentage": 88, "note": "Tools checking postgres config via SQL will need updates"}
    ]'::jsonb,
    'PostgreSQL 15 database, Config file access, Application codebase',
    'postgresql.conf loads without errors, Parallel query debugging works with debug_parallel_query, Applications execute without undefined variable errors',
    'Failing to update force_parallel_mode will cause PostgreSQL 16 to fail to recognize the setting. No automatic migration.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
),
(
    'PostgreSQL 15→16: Cannot manually create views with ON SELECT rules - use CREATE VIEW syntax',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Replace manual ON SELECT rule creation with standard CREATE VIEW syntax", "percentage": 96, "note": "Standard CREATE VIEW is cleaner and officially supported"},
        {"solution": "Review any views created via CREATE RULE ... AS ON SELECT and convert to CREATE VIEW statements", "percentage": 91, "command": "SELECT * FROM pg_rules WHERE rulename LIKE ''_view_%''"},
        {"solution": "If custom rule behavior needed beyond view creation, document use case and implement via triggers or RLS policies", "percentage": 85, "note": "Views with ON SELECT rules should migrate to standard views"}
    ]'::jsonb,
    'PostgreSQL 15 database with custom view rules, Access to view definitions',
    'Views created successfully with CREATE VIEW syntax, View queries return expected results',
    'Attempting to manually create ON SELECT rules for views will fail in PostgreSQL 16. Standard CREATE VIEW is the supported method.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
),
(
    'PostgreSQL 15→16: vacuum_defer_cleanup_age variable removed - use replication slots',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Remove vacuum_defer_cleanup_age from postgresql.conf - rely on hot_standby_feedback instead", "percentage": 92, "note": "Replication slots provide better mechanism for standby cleanup management"},
        {"solution": "Enable hot_standby_feedback on standby servers for automatic cleanup coordination", "percentage": 90, "command": "hot_standby_feedback = on"},
        {"solution": "If using replication, configure replication slots to manage WAL retention instead", "percentage": 88, "note": "More explicit and reliable than vacuum_defer_cleanup_age"}
    ]'::jsonb,
    'PostgreSQL 15 database with vacuum_defer_cleanup_age configured, Streaming replication setup',
    'Configuration loads without errors, Standby servers stay in sync, WAL cleanup operates correctly',
    'Leaving vacuum_defer_cleanup_age in config will cause warnings or errors. Must remove before upgrade.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
),
(
    'PostgreSQL 15→16: promote_trigger_file variable removed - use pg_ctl promote or pg_promote()',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Replace promote_trigger_file variable with pg_ctl promote command for manual failover", "percentage": 95, "command": "pg_ctl promote -D $PGDATA"},
        {"solution": "Update failover scripts to use pg_promote() SQL function instead of file-based promotion", "percentage": 93, "command": "SELECT pg_promote();"},
        {"solution": "For automated failover orchestration, integrate with pg_ctl or pg_promote() via application logic", "percentage": 87, "note": "File-based promotion was removed in favor of explicit commands"}
    ]'::jsonb,
    'PostgreSQL 15 database in replication setup, Superuser access, Failover scripts',
    'Promotion completes successfully via pg_ctl or pg_promote(), Standby becomes new primary',
    'Attempting to use promote_trigger_file will be silently ignored in PostgreSQL 16. Must switch to pg_ctl promote or pg_promote().',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
),
(
    'PostgreSQL 15→16: Read-only locale variables lc_collate and lc_ctype removed',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Query individual database collation settings directly via pg_database instead of server-wide variables", "percentage": 94, "command": "SELECT datname, datcollate, datctype FROM pg_database"},
        {"solution": "Use SHOW statement per-database: SHOW lc_collate in specific database context", "percentage": 89, "note": "Locales now per-database instead of server-wide"},
        {"solution": "Update monitoring and diagnostic scripts that relied on lc_collate and lc_ctype server variables", "percentage": 85, "note": "Must query pg_database for locale information"}
    ]'::jsonb,
    'PostgreSQL 15 database, SQL access to pg_database catalog',
    'Database collation queries return correct values, Applications work without locale variable dependencies',
    'Server-wide lc_collate and lc_ctype variables no longer exist. Queries must target individual databases.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
),
(
    'PostgreSQL 15→16: Role inheritance now controlled at GRANT time with WITH INHERIT clause',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Explicitly specify inheritance preference in GRANT statements using WITH INHERIT or WITH NOINHERIT", "percentage": 95, "command": "GRANT role_name TO member_role WITH INHERIT;"},
        {"solution": "Review all role membership GRANT statements and explicitly set inheritance behavior", "percentage": 92, "note": "Default behavior may differ from your intent"},
        {"solution": "Update access control systems that manage role inheritance to use new WITH clause syntax", "percentage": 88, "note": "Per-member inheritance gives finer control than role-wide setting"}
    ]'::jsonb,
    'PostgreSQL 15 database, Role management access',
    'GRANT statements execute successfully with new syntax, Role inheritance works as intended',
    'Existing GRANT statements without WITH clause may inherit different privileges in PostgreSQL 16. Must explicitly specify inheritance.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
),
(
    'PostgreSQL 15→16: CREATEROLE privilege now requires ADMIN OPTION to modify roles and properties',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Grant ADMIN OPTION privileges for roles that need to modify CREATEDB, REPLICATION, BYPASSRLS properties", "percentage": 95, "command": "GRANT role_name TO admin_role WITH ADMIN OPTION;"},
        {"solution": "Review permissions for roles with CREATEROLE privilege and grant appropriate ADMIN OPTION selectively", "percentage": 92, "note": "Restricted to only needed permissions"},
        {"solution": "Update role creation/modification workflows to include ADMIN OPTION grants where role changes required", "percentage": 88, "note": "More restrictive than PostgreSQL 15"}
    ]'::jsonb,
    'PostgreSQL 15 database with role hierarchy, Superuser or role admin access',
    'Role modifications execute successfully with ADMIN OPTION, Role hierarchy maintained correctly',
    'CREATEROLE without ADMIN OPTION cannot modify role properties in PostgreSQL 16. Must explicitly grant ADMIN OPTION.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/16/release-16.html'
);
