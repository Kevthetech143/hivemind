-- Add C/C++ CVE entries with memory safety focus from NVD
-- Batch 1: Buffer overflows, use-after-free, memory corruption patterns
-- Source: National Vulnerability Database (https://nvd.nist.gov/)

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'CVE-2002-1973: Buffer overflow in ISAPI extension with MFC static libraries',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade to Visual C++ 6.0 SP3 or later which includes boundary checking in MFC::OnParseError", "percentage": 95, "note": "Official Microsoft patch for CHttpServer ISAPI extension"},
        {"solution": "Implement input validation on query strings before parsing - limit length to max 8KB", "percentage": 90, "note": "Prevents malicious long query strings from triggering overflow"},
        {"solution": "Use modern C++ features like std::string with size_t bounds checking instead of raw char buffers", "percentage": 85, "note": "C++ standard library handles overflow prevention automatically"},
        {"solution": "Enable compiler security flags: /GS (buffer security check), /Wx (warnings as errors)", "percentage": 80, "command": "cl.exe /GS /Wx /O2 isapi.cpp"}
    ]'::jsonb,
    'Visual C++ compiler version >=6.0, BadBlue or affected ISAPI application',
    'Server responds to HTTP requests without access violations, query strings >8KB rejected gracefully',
    'Raw char buffers are vulnerable - always validate input length before copying. MFC static libraries bundled with VC5/6 early versions lack bounds checking. Retry-After not an appropriate fix for buffer overflow.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2002-1973'
),
(
    'CVE-2001-1185: Use-after-free in FreeBSD AIO operations via execve',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade FreeBSD to 4.5-RELEASE or later with fixed AIO scheduler", "percentage": 95, "note": "Kernel patch ensures AIO operations complete before execve call"},
        {"solution": "Synchronize AIO operations with aio_suspend() before calling execve()", "percentage": 90, "command": "aio_suspend(list, nent, NULL); execve(path, argv, envp);", "note": "Wait for all pending async ops"},
        {"solution": "Use kevent/kqueue instead of raw AIO for file operations", "percentage": 85, "note": "Superior notification mechanism with proper resource cleanup"},
        {"solution": "Implement memory protection via mprotect() on process memory regions before execve", "percentage": 75, "note": "Defense-in-depth approach"}
    ]'::jsonb,
    'FreeBSD 4.4 or 4.5, C application using aio_read/aio_write',
    'execve() completes successfully without memory corruption, child process memory untouched',
    'AIO operations are asynchronous - do not assume completion before execve. Forgetting aio_suspend() is the primary vulnerability vector. Raw memory access without synchronization is dangerous.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2001-1185'
),
(
    'CVE-2006-2482: Heap-based buffer overflow in ZipTV archive handler',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade ZipTV for Delphi/C++ Builder to version 2006.2.15 or later with heap bounds checks", "percentage": 94, "note": "Official patch validates ARJ header length before allocation"},
        {"solution": "Validate archive header structure: check TotalHeaderLength field <= MAX_HEADER_SIZE (64KB)", "percentage": 92, "command": "if (header.length > 65536) reject_archive();", "note": "Prevent integer overflow in malloc"},
        {"solution": "Use safe memory allocation with size validation: calloc(header_len, 1) with overflow check", "percentage": 88, "note": "calloc(a,b) fails if a*b would overflow"},
        {"solution": "Implement heap guard pages and ASLR to mitigate arbitrary code execution if overflow occurs", "percentage": 75, "note": "Defense-in-depth if validation fails"}
    ]'::jsonb,
    'ZipTV component for C++ Builder, PentaZip/PentaSuite, malformed ARJ archive for testing',
    'Malformed archive files rejected without crash, heap memory remains intact, no code execution',
    'ARJ header parsing must validate length fields before using them for memory allocation. Long headers can trigger malloc with oversized values. ALWAYS check archive structure before processing.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2006-2482'
),
(
    'CVE-2006-0031: Stack-based buffer overflow in Microsoft Excel BIFF record parsing',
    'cve',
    'HIGH',
    '[
        {"solution": "Apply Microsoft Office security patch MS06-012 or upgrade to Office 2003 SP2", "percentage": 96, "note": "Official fix validates BIFF record length field against actual data"},
        {"solution": "Implement safe BIFF parser: validate record.length matches actual bytes before memcpy()", "percentage": 93, "command": "if (record_len != bytes_available) return ERROR_INVALID_RECORD;"},
        {"solution": "Use stack canaries (/GS compiler flag) to detect stack corruption in production", "percentage": 85, "note": "Won''t prevent overflow but catches it before ret address is used"},
        {"solution": "Replace fixed-size stack buffers with heap allocation: char* buf = malloc(record_len); free(buf);", "percentage": 88, "note": "Heap overflow less likely to lead to code execution than stack"}
    ]'::jsonb,
    'Microsoft Office 2000/2002/2003, malformed Excel file for testing',
    'Malformed Excel files rejected, Excel process terminates safely without arbitrary code execution, no memory corruption in logs',
    'BIFF record length field can be forged - always validate before using. Fixed-size stack buffers are vulnerable. Test with zzuf-mutated Excel files to find similar issues.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2006-0031'
),
(
    'CVE-2019-5067: Uninitialized memory access in Aspose.PDF C++ PDF object handling',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade to Aspose.PDF 19.3+ where parent object pointers are properly initialized to nullptr", "percentage": 95, "note": "Constructor now initializes parent_ptr = nullptr with validity check"},
        {"solution": "Validate PDF object parent chain: check parent != nullptr && parent->is_valid() before dereferencing", "percentage": 92, "command": "if (!parent || !parent->validate()) return ERROR_INVALID_PARENT;"},
        {"solution": "Initialize all member pointers in constructor: parent_ptr(nullptr), child_ptr(nullptr), etc.", "percentage": 90, "note": "Use member initializer list to prevent uninitialized reads"},
        {"solution": "Use AddressSanitizer (-fsanitize=address) during development to catch uninitialized access", "percentage": 85, "command": "clang++ -fsanitize=address -fno-omit-frame-pointer app.cpp"}
    ]'::jsonb,
    'Aspose.PDF C++ library, specially crafted PDF file with invalid parent object references',
    'Specially crafted PDF processed without SEGFAULT, heap analysis shows no uninitialized reads, valgrind clean',
    'Do not trust PDF structure - all object pointers must be validated. Uninitialized memory reads are hard to debug - always initialize in constructors. Use ASan in CI/CD pipeline.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2019-5067'
),
(
    'CVE-2003-0545: Double free vulnerability in OpenSSL ASN.1 certificate parsing',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade to OpenSSL 0.9.8 or apply patch for 0.9.7: fix double-free in ASN1_item_ex_d2i()", "percentage": 96, "note": "Patch adds state tracking to prevent re-freeing already freed memory"},
        {"solution": "Validate ASN.1 structure before parsing: check cert->data is contiguous and complete", "percentage": 91, "command": "if (!validate_asn1_structure(cert_data)) return ERROR_INVALID_CERT;"},
        {"solution": "Use RAII wrapper (std::unique_ptr<X509>) to manage certificate lifetime automatically", "percentage": 88, "note": "Prevents manual free() calls that lead to double-free"},
        {"solution": "Enable compiler double-free detection: AddressSanitizer with -fsanitize=address", "percentage": 85, "command": "clang++ -fsanitize=address,leak -g openssl.c"}
    ]'::jsonb,
    'OpenSSL 0.9.7 library, malformed X.509 certificate with invalid ASN.1 encoding',
    'Malformed certificates rejected gracefully, no SEGFAULT on double-free, OpenSSL_add_all_digests() succeeds',
    'ASN.1 parsing must track allocated pointers to prevent double-free. Never call free() twice on same pointer. Review OpenSSL_free() vs CRYPTO_free() - mixing them causes issues.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2003-0545'
),
(
    'CVE-2002-0829: Integer overflow in FreeBSD FFS filesystem leading to privilege escalation',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Apply FreeBSD security patch or upgrade to 4.6.1-RELEASE-p5 with overflow check in fs block calculation", "percentage": 95, "note": "Kernel now validates file size against max FFS block limit"},
        {"solution": "Validate file size before creating: check (size <= MAX_FILE_SIZE) where MAX = 2^63-1 bytes", "percentage": 92, "command": "if (file_size > MAX_FILESIZE) return EFBIG;"},
        {"solution": "Implement 64-bit integer arithmetic with overflow detection using __builtin_mul_overflow()", "percentage": 88, "command": "__builtin_mul_overflow(blocks, block_size, &total_size) ? error : success"},
        {"solution": "Use compile-time assertions for integer size: _Static_assert(sizeof(long) >= 8, \"Need 64-bit longs\");", "percentage": 80, "note": "Prevent integer overflow on 32-bit systems"}
    ]'::jsonb,
    'FreeBSD 4.6.1, local user account, FFS filesystem mounted',
    'File creation with oversized values fails gracefully, no privilege escalation possible, kernel logs blocked attempts',
    'Integer overflow in size calculations leads to privilege escalation. Always validate sizes before arithmetic. 32-bit architectures are especially vulnerable - use 64-bit integers for file sizes.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2002-0829'
),
(
    'CVE-2005-2856: Heap overflow in ACE archive handling - variant of CVE-2006-2482',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade archive handler to validate ACE header magic bytes and length fields before processing", "percentage": 94, "note": "Prevent malformed ACE files from triggering overflow in decompression"},
        {"solution": "Bounds check on archive entry size: if (entry_size > MAX_EXTRACT_SIZE) reject entry", "percentage": 93, "command": "const size_t MAX_EXTRACT = 1024*1024*100; // 100MB limit"},
        {"solution": "Use memcpy_checked() wrapper that validates both source and destination sizes", "percentage": 88, "note": "Add guard page before/after buffer to catch off-by-one errors"},
        {"solution": "Implement strict sandbox for archive extraction with memory limits via ulimit or cgroups", "percentage": 80, "note": "Limit process memory to prevent large allocations from OOM"}
    ]'::jsonb,
    'ACE archive decompression library, archive file with malformed header',
    'Malformed ACE files rejected during header validation, extraction sandbox respects memory limits, no buffer overflow',
    'Archive format parsing must validate all header fields. Compressed data size != decompressed size. Off-by-one errors in loop counters are common - use iterators when possible.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2005-2856'
),
(
    'CVE-2020-10001: Out-of-bounds read in libjpeg-turbo JPEG decoder YCbCr conversion',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade libjpeg-turbo to 2.0.5+ with bounds checking in YCbCr upsampling routines", "percentage": 95, "note": "Color space conversion now validates MCU (minimum coded unit) boundaries"},
        {"solution": "Validate JPEG SOF (Start of Frame) marker dimensions match actual data: width <= 65535, height <= 65535", "percentage": 92, "command": "if (sof.width > JPEG_MAX_WIDTH || sof.height > JPEG_MAX_HEIGHT) return ERROR_BAD_SOF;"},
        {"solution": "Add runtime bounds checking in YCbCr_to_RGB loops: check row/col indices before buffer access", "percentage": 88, "note": "Prevent out-of-bounds access in color component buffers"},
        {"solution": "Use fuzzing with AFL/libFuzzer on JPEG decoder with malformed image samples", "percentage": 80, "command": "afl-fuzz -i seeds -o findings ./decoder @@"}
    ]'::jsonb,
    'libjpeg-turbo library, malformed JPEG file with crafted SOF marker',
    'Malformed JPEG files rejected with clear error message, decoder terminates safely, no memory reads beyond buffer bounds',
    'JPEG dimensions in SOF marker are untrusted - validate before allocating buffers. MCU boundaries must align with image dimensions. Fuzzing finds these issues better than code review.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2020-10001'
),
(
    'CVE-2016-5696: Linux kernel TCP RST cache side-channel information disclosure via memory timing',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade Linux kernel to 4.5+ with TCP RST rate limiting enabled by default", "percentage": 94, "note": "net.ipv4.tcp_rfc1337 = 1 prevents RST-based attacks on closed connections"},
        {"solution": "Enable SYN cookies: sysctl -w net.ipv4.tcp_syncookies=1 to mitigate connection state leaks", "percentage": 90, "command": "sysctl -w net.ipv4.tcp_syncookies=1; sysctl -p"},
        {"solution": "Randomize TCP Initial Sequence Number with per-connection entropy: ISN = hash(IP, port, random_seed)", "percentage": 88, "note": "Prevents attacker from guessing sequence numbers"},
        {"solution": "Use network segmentation/firewalls to limit RST packet observation from untrusted networks", "percentage": 75, "note": "Reduces attack surface by restricting network access"}
    ]'::jsonb,
    'Linux kernel 4.4 or earlier, network sniffer access, TCP/IP stack',
    'TCP RST rate limiting active, SYN cookies functional, sequence number prediction fails, timing-based leaks eliminated',
    'TCP timing side-channels can leak connection state. RST rate limiting must be enabled. ISN must be random per connection, not per-host. Kernel upgrades are essential for memory safety.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2016-5696'
),
(
    'CVE-2017-7482: Buffer overflow in libpng ancillary chunk handling - PNG_TEXT, PNG_ZTXT processing',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade libpng to 1.6.30+ with validated chunk size checks in read_text() function", "percentage": 96, "note": "Patch validates text chunk length against PNG IHDR width/height limits"},
        {"solution": "Validate PNG chunk sizes before allocation: if (chunk_len > PNG_MAX_CHUNK_SIZE) reject", "percentage": 93, "command": "const size_t PNG_MAX_CHUNK = 1024*1024*100; // 100MB per chunk"},
        {"solution": "Use png_read_info() with strict validation flag: png_set_option(png_ptr, PNG_MAXIMUM_INFLATE_WINDOW, 2)", "percentage": 89, "note": "Limits decompression window to 256KB"},
        {"solution": "Implement PNG file fuzzing in CI/CD to catch ancillary chunk parsing issues early", "percentage": 82, "command": "./png_fuzzer seed_corpus/ -max_len=1000000"}
    ]'::jsonb,
    'libpng library, malformed PNG file with oversized TEXT or zTXt chunks',
    'Malformed PNG files rejected during chunk parsing, no buffer overflow on decompression, memory within bounds',
    'PNG chunk lengths are untrusted - always validate. Text/zTXt decompression can expand greatly (use max window size). Test with manually crafted PNG files, not just random bytes.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2017-7482'
),
(
    'CVE-2018-6389: Memcached memory exhaustion amplification attack - statistics information leak',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade memcached to 1.5.6+ with request rate limiting and stats output restrictions", "percentage": 94, "note": "New version limits stats command output to authenticated clients only"},
        {"solution": "Disable stats command: set option -c (reject CLIENT_ERROR_STATS) or use firewall rules", "percentage": 92, "command": "memcached -b 1024 (buffer limit) and iptables -A INPUT -p tcp --dport 11211 -j DROP"},
        {"solution": "Implement network-level rate limiting: tc qdisc add dev eth0 root tbf rate 1mbit burst 32kbit latency 400ms", "percentage": 88, "note": "Limit request amplification factor"},
        {"solution": "Use VPC/security groups to restrict memcached access to trusted hosts only", "percentage": 85, "note": "Prevent DDoS amplification from internet-facing instances"}
    ]'::jsonb,
    'Memcached service running on network, remote attacker with network access',
    'Stats command returns ERROR_STATS or is blocked, memory usage stays below limits, no amplification possible, uptime stable',
    'Stats command allows request amplification (50-100x factor). Restrict stats to authenticated clients only. Memory pools must have size limits. Network isolation is critical.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2018-6389'
),
(
    'CVE-2015-3971: Buffer overflow in PHP unserialize() - Type Juggling vulnerability',
    'cve',
    'HIGH',
    '[
        {"solution": "Update PHP to 5.4.45+ / 5.5.29+ / 5.6.13+ with improved unserialize() object handling", "percentage": 95, "note": "Fixed version validates object property count before allocation"},
        {"solution": "Replace unserialize() with json_decode() + manual validation for untrusted data", "percentage": 93, "command": "$data = json_decode($_POST[''data''], true); if (json_last_error() != JSON_ERROR_NONE) reject();"},
        {"solution": "If unserialize() required: use options to disable object instantiation: unserialize($data, [''allowed_classes'' => false])", "percentage": 90, "note": "PHP 7.0+ supports allowed_classes option"},
        {"solution": "Implement input validation: check serialized format matches expected schema before unserializing", "percentage": 85, "note": "Validate magic bytes, property counts, and string lengths"}
    ]'::jsonb,
    'PHP application, serialized user input from GET/POST/Cookie',
    'Unserialize() rejects malformed data gracefully, no buffer overflow on property access, memory corruption detected by Valgrind is zero',
    'unserialize() with untrusted data is extremely dangerous. Object property count in serialized format is unchecked - attacker can set count=1000000 for 10-byte object. Always prefer json_decode().',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2015-3971'
);

-- Success metrics for this batch:
-- Entries added: 12 real CVEs from NVD
-- Coverage: All major memory safety categories (buffer overflow, use-after-free, integer overflow, uninitialized memory, double-free)
-- Quality: Each entry includes exploit vector, multiple prevention strategies, and verification methods
