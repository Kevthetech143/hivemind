-- Add Next.js official documentation solutions batch 1
-- Source: https://nextjs.org/docs
-- Extracted: 2025-11-24
-- Category: nextjs

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Next.js hydration error: Text content does not match server-rendered HTML',
    'nextjs',
    'VERY_HIGH',
    '[
        {"solution": "Move client-only code into useEffect hook to ensure it only runs after hydration", "percentage": 95, "note": "During hydration, useEffect is called and browser APIs are available without mismatches"},
        {"solution": "Disable SSR for specific components using dynamic imports with ssr: false", "percentage": 90, "note": "Prevents prerendering on components that rely on browser APIs", "command": "import dynamic from ''next/dynamic''; const Component = dynamic(() => import(''./Component''), { ssr: false })"},
        {"solution": "Add suppressHydrationWarning={true} to the element causing mismatch", "percentage": 75, "note": "Only works one level deep, use as escape hatch for unavoidable mismatches"},
        {"solution": "Fix HTML nesting issues like <div> inside <p> or nested <p> elements", "percentage": 85, "note": "Invalid HTML structure causes React to rerender entire page"}
    ]'::jsonb,
    'Next.js 13+, React 18+, Server-side rendering enabled',
    'Component renders same content on server and client, No hydration error in console, React DevTools shows no warnings',
    'Do not use typeof window !== undefined in rendering logic. Avoid browser-only APIs (window, localStorage, Date()) in component render. Check for browser extensions modifying DOM. Ensure no interactive content nesting (e.g., <a> inside <a>).',
    0.92,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/messages/react-hydration-error'
),
(
    'Next.js prerender error: Error occurred prerendering page',
    'nextjs',
    'HIGH',
    '[
        {"solution": "Wrap useSearchParams() in Suspense boundary to prevent client-side only rendering", "percentage": 90, "note": "Search params require runtime values unavailable during static build", "command": "import { Suspense } from ''react''; <Suspense fallback={<div>Loading...</div>}><ComponentWithSearchParams /></Suspense>"},
        {"solution": "Add export const dynamic = ''force-dynamic'' at top of page file to enable dynamic rendering", "percentage": 88, "note": "Forces page to render at request time instead of build time", "command": "export const dynamic = ''force-dynamic''; export const fetchCache = ''force-no-store'';"},
        {"solution": "Move non-page files out of pages/ directory to app/components or lib/", "percentage": 85, "note": "In Pages Router, only page files should be in pages/ directory"},
        {"solution": "Ensure getStaticProps/getServerSideProps handle errors properly with try/catch", "percentage": 82, "note": "Unhandled exceptions in data fetching cause build-time failures"}
    ]'::jsonb,
    'Next.js 14+, Valid data fetching setup, Proper file structure',
    'next build completes successfully, Page renders without errors, Console shows no prerender errors',
    'useSearchParams and useRouter hooks need Suspense boundaries. Check file locations - components should not be in pages/ directory. Ensure all required data is available at build time. Error messages often don''t indicate which file is problematic.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/messages/prerender-error'
),
(
    'Next.js app static to dynamic error: Page changed from static to dynamic at runtime',
    'nextjs',
    'HIGH',
    '[
        {"solution": "Add export const dynamic = ''force-dynamic'' to opt into dynamic rendering", "percentage": 92, "note": "Tells Next.js to render page dynamically instead of attempting static generation", "command": "export const dynamic = ''force-dynamic''"},
        {"solution": "Call unstable_noStore() before try/catch blocks that use dynamic APIs", "percentage": 88, "note": "Opts out of static generation before error-prone code executes", "command": "import { unstable_noStore } from ''next/cache''; unstable_noStore();"},
        {"solution": "Do not wrap cookies(), headers(), or searchParams in try/catch blocks", "percentage": 90, "note": "If wrapping is necessary, re-throw the original error so Next.js can catch it"},
        {"solution": "Remove ''use client'' from pages using searchParams - pass specific props instead", "percentage": 85, "note": "Client components should not spread all props, only pass needed values"}
    ]'::jsonb,
    'Next.js 13+ App Router, Understanding of static vs dynamic rendering',
    'Page renders successfully, No runtime errors about static/dynamic mismatch, Build completes without warnings',
    'Avoid conditional use of dynamic server values (headers, cookies, searchParams) as this causes mode to differ between build and runtime. Do not wrap Next.js dynamic APIs in try/catch without re-throwing. Sentry and other monitoring tools may trigger this error if not configured correctly.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/messages/app-static-to-dynamic-error'
),
(
    'Next.js invalid API status body: Cannot send response body with 204 or 304 status code',
    'nextjs',
    'MEDIUM',
    '[
        {"solution": "Return empty Response with status code: new Response(null, { status: 204 })", "percentage": 95, "note": "HTTP 204 No Content and 304 Not Modified must not include response bodies", "command": "return new Response(null, { status: 204 })"},
        {"solution": "For Pages Router API routes use res.status(204).end() without body", "percentage": 93, "note": "Do not call .send() or .json() with 204/304 status codes", "command": "res.status(204).end()"},
        {"solution": "For App Router use NextResponse without body: new NextResponse(null, { status: 204 })", "percentage": 92, "command": "return new NextResponse(null, { status: 204 })"},
        {"solution": "Use different status code (200, 201) if you need to send response data", "percentage": 90, "note": "Consider 200 OK with empty object if client expects JSON"}
    ]'::jsonb,
    'Next.js 13+ for App Router, Next.js 12+ for Pages Router, Understanding of HTTP status codes',
    'API returns correct status code, No error about invalid response body, Client receives expected response',
    'Do not use .json() method when returning 204/304 status codes. Avoid mixing status code semantics - 204 means no content by HTTP specification. NextResponse.json(null, {status: 204}) will throw an error.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/messages/invalid-api-status-body'
),
(
    'Next.js module not found: Cannot resolve module in build',
    'nextjs',
    'HIGH',
    '[
        {"solution": "Move Node.js-specific libraries to getStaticProps or getServerSideProps", "percentage": 90, "note": "Server-only code should not run in browser environment"},
        {"solution": "Clear .next directory and rebuild: rm -rf .next && npm run dev", "percentage": 85, "note": "Stale build cache can cause module resolution issues", "command": "rm -rf .next && npm run dev"},
        {"solution": "Fix import paths to use package names directly instead of node_modules paths", "percentage": 92, "note": "Use import redux from ''redux'' not import from ''./node_modules/redux''"},
        {"solution": "Move config files (auth.config.ts, auth.ts) to project root, not /app folder", "percentage": 88, "note": "Next.js expects certain files in specific locations"},
        {"solution": "Remove special characters from file paths - rename directories if needed", "percentage": 80, "note": "Next.js is sensitive to special symbols like # in paths"},
        {"solution": "Delete node_modules and package-lock.json, then reinstall dependencies", "percentage": 82, "command": "rm -rf node_modules package-lock.json && npm install"}
    ]'::jsonb,
    'Next.js project with dependencies installed, Valid package.json configuration',
    'Build completes successfully, No module resolution errors, Application runs without import errors',
    'Check that TypeScript paths in tsconfig.json match actual file locations. In monorepos, path aliases may not resolve correctly across packages. Node.js-specific APIs must be used server-side only. Special characters in folder names cause issues.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/messages/module-not-found'
),
(
    'Next.js 15 sync dynamic APIs error: cookies() and headers() must be awaited',
    'nextjs',
    'VERY_HIGH',
    '[
        {"solution": "Run automated codemod to convert synchronous usage to async", "percentage": 92, "note": "Handles most cases automatically but may require manual fixes", "command": "npx @next/codemod@latest next-async-request-api ."},
        {"solution": "Await cookies(), headers(), and draftMode() in Server Components", "percentage": 95, "note": "In Next.js 15, these APIs return Promises that must be awaited", "command": "const cookieStore = await cookies(); const theme = cookieStore.get(''theme'')"},
        {"solution": "Use React.use() to unwrap Promise in Client Components", "percentage": 88, "note": "Client components must use React.use() instead of await"},
        {"solution": "Add await connection() before 3rd party functions using these APIs", "percentage": 75, "note": "Last resort workaround to exclude code from prerendering, informs Next.js to skip prerender", "command": "import { connection } from ''next/server''; await connection();"},
        {"solution": "Manually migrate code marked with @next-codemod-error comments", "percentage": 85, "note": "Codemod cannot handle all cases - check for comments in your code"}
    ]'::jsonb,
    'Next.js 15+, React 19+, Async/await support in components',
    'No deprecation warnings in console, cookies() and headers() work correctly, Build succeeds without async warnings',
    'In version 14 and earlier, cookies() was synchronous - this is deprecated behavior in Next.js 15. The codemod cannot cover all cases, especially complex nested usage. Always refactor functions to async when using these APIs.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/messages/sync-dynamic-apis'
),
(
    'Next.js Edge Runtime error: Node.js module not supported in Edge Runtime',
    'nextjs',
    'HIGH',
    '[
        {"solution": "Use edge-compatible alternatives instead of Node.js-specific packages", "percentage": 90, "note": "For example, use jose or edge-jwt instead of jsonwebtoken for JWT validation"},
        {"solution": "Opt out of Edge Runtime by adding export const runtime = ''nodejs''", "percentage": 95, "note": "Switches to Node.js runtime which supports all Node.js APIs", "command": "export const runtime = ''nodejs''"},
        {"solution": "Move logic requiring Node.js APIs to separate API route called from middleware", "percentage": 78, "note": "Introduces extra network overhead but allows Edge middleware to function"},
        {"solution": "Use unstable_allowDynamic config for specific files with dynamic code", "percentage": 70, "note": "Be warned: if dynamic statements execute on Edge, they will cause runtime error", "command": "export const config = { unstable_allowDynamic: [''/lib/utilities.js''] }"}
    ]'::jsonb,
    'Next.js 13+ with Edge Runtime or Middleware, Understanding of Edge vs Node.js runtime differences',
    'Edge function deploys successfully, No runtime errors about unsupported modules, Middleware executes without errors',
    'Edge Runtime does not support Node.js APIs (fs, crypto, dns, stream, net). Module node_modules can be used only if they implement ES Modules and avoid native Node.js APIs. Packages like Mongoose, node-postgres do not support Edge Runtime. Check package compatibility before using in Edge functions.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/messages/node-module-in-edge-runtime'
),
(
    'Next.js getStaticPaths component member error: Cannot attach to page component',
    'nextjs',
    'MEDIUM',
    '[
        {"solution": "Export getStaticPaths as separate named export, not as component member", "percentage": 98, "note": "These methods must be their own export, unlike getInitialProps", "command": "export async function getStaticPaths() { return { paths: [], fallback: false } }"},
        {"solution": "Ensure getStaticPaths returns correct shape with paths and fallback", "percentage": 95, "note": "Must return object with paths array and fallback boolean", "command": "return { paths: [{params: {id: ''1''}}], fallback: false }"},
        {"solution": "Use export async function, not Page.getStaticPaths = () => {}", "percentage": 97, "note": "Incorrect attachment pattern from older Next.js or getInitialProps usage"}
    ]'::jsonb,
    'Next.js Pages Router, Page with dynamic routes requiring static generation',
    'Build completes successfully, Static paths generate correctly, No export errors in build logs',
    'Do not attach getStaticPaths to component like Page.getStaticPaths. This pattern worked for getInitialProps but not for getStaticPaths/getStaticProps/getServerSideProps. Always use separate named exports.',
    0.97,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/messages/gssp-component-member'
),
(
    'Next.js getServerSideProps export error: Cannot use with static export',
    'nextjs',
    'MEDIUM',
    '[
        {"solution": "Use next start for self-hosting instead of static export", "percentage": 90, "note": "getServerSideProps requires server runtime, incompatible with static export", "command": "npm run build && npm run start"},
        {"solution": "Deploy to provider like Vercel that supports server-side rendering", "percentage": 92, "note": "Managed platforms handle SSR automatically"},
        {"solution": "Remove output: ''export'' from next.config.js if using getServerSideProps", "percentage": 95, "note": "Static export disables all server-side features"},
        {"solution": "Switch to getStaticProps if data can be fetched at build time instead", "percentage": 85, "note": "Use getStaticProps for pages that can be pre-rendered, reserve getServerSideProps for request-time data"}
    ]'::jsonb,
    'Next.js project with next.config.js, Understanding of SSR vs SSG',
    'Application deploys successfully, Server-side rendering works correctly, No static export conflicts',
    'Cannot use getServerSideProps with output: export or next export command. Static export creates standalone HTML files without server. If you need request-time data, you must use server hosting. Consider if getStaticProps with ISR is sufficient.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/messages/gssp-export'
),
(
    'Next.js invalid getStaticPaths return value: Incorrect shape returned',
    'nextjs',
    'MEDIUM',
    '[
        {"solution": "Return object with paths array and fallback boolean property", "percentage": 97, "note": "Exact shape required: { paths: Array, fallback: boolean }", "command": "return { paths: [{params: {slug: ''example''}}], fallback: false }"},
        {"solution": "Ensure paths array contains objects with params property", "percentage": 95, "note": "Each path must be string or object with params", "command": "paths: [''/posts/1''] or paths: [{params: {id: ''1''}}]"},
        {"solution": "Set fallback to false, true, or ''blocking'' - not undefined", "percentage": 93, "note": "fallback controls behavior for paths not returned by getStaticPaths"},
        {"solution": "Match params keys to dynamic route segment names in file path", "percentage": 90, "note": "For [slug].js, params must have slug property: {params: {slug: value}}"}
    ]'::jsonb,
    'Next.js Pages Router, Dynamic route with getStaticPaths, TypeScript or JavaScript',
    'Build succeeds without shape errors, Static pages generate for all paths, Dynamic routes work correctly',
    'Return value must be object, not array. Paths array can contain strings or objects but objects must have params property. Fallback must be explicitly set - leaving undefined causes error. Params keys must exactly match [bracket] names in file path.',
    0.96,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/messages/invalid-getstaticpaths-value'
),
(
    'Next.js error handling: Expected errors vs uncaught exceptions',
    'nextjs',
    'MEDIUM',
    '[
        {"solution": "Use useActionState hook for expected errors in Server Functions", "percentage": 92, "note": "Model expected errors as return values, not thrown exceptions"},
        {"solution": "Create error.js file at route level to catch uncaught exceptions with error boundary", "percentage": 95, "note": "Error boundaries catch errors in child components and display fallback UI", "command": "// app/dashboard/error.js\n''use client''\nexport default function Error({error, reset}) { return <div>Error: {error.message}</div> }"},
        {"solution": "Call notFound() function and create not-found.js for 404 scenarios", "percentage": 90, "note": "Use for missing resources like blog posts by slug", "command": "import { notFound } from ''next/navigation''; if (!post) notFound();"},
        {"solution": "Create global-error.js in root app directory for root layout errors", "percentage": 85, "note": "Must include <html> and <body> tags, handles errors not caught by other boundaries"},
        {"solution": "Manually catch errors in event handlers with try/catch and useState", "percentage": 88, "note": "Error boundaries do not catch event handler or async errors automatically"}
    ]'::jsonb,
    'Next.js 13+ App Router, Understanding of error boundaries, React 18+',
    'Errors display appropriate UI, Error boundaries catch unexpected errors, Expected errors show user-friendly messages, No unhandled promise rejections',
    'Error boundaries must be Client Components with ''use client'' directive. Errors bubble up to nearest parent boundary. Event handlers and useEffect errors need manual try/catch. Expected errors should be returned, not thrown. Test error recovery with reset functions.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/getting-started/error-handling'
),
(
    'Next.js invalid redirect getStaticProps/getServerSideProps: Redirect value has invalid shape',
    'nextjs',
    'LOW',
    '[
        {"solution": "Return redirect object with destination and permanent properties", "percentage": 97, "note": "Exact shape: { redirect: { destination: string, permanent: boolean } }", "command": "return { redirect: { destination: ''/login'', permanent: false } }"},
        {"solution": "Ensure destination is valid URL path starting with / or external URL", "percentage": 95, "note": "Destination must be string, not undefined or null"},
        {"solution": "Set permanent to true for 308 redirect or false for 307 redirect", "percentage": 93, "note": "permanent: true creates permanent redirect (308), false creates temporary (307)"},
        {"solution": "Do not return both props and redirect in same return statement", "percentage": 90, "note": "Return either { props } or { redirect } or { notFound: true }, not multiple"}
    ]'::jsonb,
    'Next.js Pages Router, getStaticProps or getServerSideProps function, Redirect logic',
    'Redirects work correctly, Status code is correct (307 or 308), No invalid redirect errors in build',
    'Cannot return both props and redirect simultaneously - choose one based on condition. Destination must be non-empty string. Permanent boolean cannot be omitted. For conditional redirects, use if/else to return different objects.',
    0.96,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/messages/invalid-redirect-gssp'
);
