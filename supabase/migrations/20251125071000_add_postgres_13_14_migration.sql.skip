-- PostgreSQL 13 → 14 Migration Guide - Breaking Changes & Compatibility Issues
-- Source: https://www.postgresql.org/docs/14/release-14.html

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'PostgreSQL 14: Containment operators @ and ~ removed for geometric types',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Replace @ operator with <@ (contained by) in all geometric type operations and contrib modules (cube, hstore, intarray, seg)", "percentage": 95, "command": "Search code for @ and ~ operators, replace with <@ and @> equivalents", "note": "Breaking change - pg_upgrade will fail if old operators referenced in functions/views"},
        {"solution": "Update cube, hstore, intarray, and seg contrib module queries to use new operators before upgrade", "percentage": 90, "note": "Contrib modules also affected"},
        {"solution": "Test query migration in dev environment with pg_upgrade --check before production upgrade", "percentage": 85, "command": "pg_upgrade --check -d old_cluster -D new_cluster"}
    ]'::jsonb,
    'PostgreSQL 13 cluster, pg_upgrade utility, access to all database code/views',
    'pg_upgrade completes without operator-related errors, geometric queries return correct results, all views and functions compile',
    'Failing to update custom functions using @ operator will cause pg_upgrade to abort. This is not auto-fixed by pg_upgrade.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14: Postfix operators ! and !! factorial operators removed',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Replace postfix ! and !! operators with factorial() function call: x! becomes factorial(x)", "percentage": 95, "command": "Replace x! with factorial(x), x!! with factorial(x)", "note": "All postfix operators removed, not just factorial"},
        {"solution": "Verify no custom postfix operators defined - pg_dump will warn if present", "percentage": 90, "note": "pg_upgrade will generate warnings for any postfix operators"},
        {"solution": "Check application code for computed column definitions using ! operator syntax", "percentage": 85}
    ]'::jsonb,
    'PostgreSQL 13 cluster with potential postfix operator usage, pg_dump utility',
    'pg_upgrade completes without factorial operator errors, queries using factorial() return correct results, no warnings in upgrade log',
    'Forgetting to update application SQL that uses postfix factorial ! will cause query compilation to fail after upgrade.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14: Password encryption default changed from md5 to scram-sha-256',
    'migration-guide',
    'VERY_HIGH',
    '[
        {"solution": "Set password_encryption = scram-sha-256 in postgresql.conf before upgrade to enforce SHA256 for all new passwords", "percentage": 95, "command": "ALTER SYSTEM SET password_encryption = ''scram-sha-256''", "note": "Default in 14, but verify explicitly set"},
        {"solution": "Reset all user passwords after upgrade to re-hash with SCRAM-SHA-256: ALTER USER username WITH PASSWORD ''newpassword''", "percentage": 90, "note": "MD5 hashes from PG13 still work in PG14 but new password sets use SHA256"},
        {"solution": "Update application connection strings if using legacy MD5-only authentication methods", "percentage": 85, "note": "Most drivers support SCRAM-SHA-256, verify compatibility"},
        {"solution": "If legacy MD5 required, set password_encryption = md5 (not recommended), but note this is deprecated", "percentage": 60, "note": "Do not rely on MD5 - plan full migration to SHA256"}
    ]'::jsonb,
    'PostgreSQL 13 cluster with existing user accounts, authentication credentials, database connection configuration',
    'New passwords hash with SCRAM-SHA-256, psql connects successfully with reset passwords, no authentication failures in logs',
    'Forgetting to reset passwords = old MD5 hashes stay in system. New password_encryption default does NOT auto-migrate existing hashes. Applications may fail if they reject non-MD5 auth.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14: EXTRACT() return type changed from float8 to numeric',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Verify all EXTRACT() calls that expect float8 results - may need CAST to float8 for backward compatibility", "percentage": 92, "command": "Cast EXTRACT epoch to float8", "note": "Prevents precision loss when extracting timestamps"},
        {"solution": "Update application code expecting float return values - numeric type is more precise but may require type adjustments", "percentage": 88, "note": "numeric is now returned by default instead of float8"},
        {"solution": "Use date_part() function if legacy float8 behavior required", "percentage": 75, "command": "Use date_part for epoch extraction", "note": "date_part() preserves old float8 return behavior"}
    ]'::jsonb,
    'PostgreSQL 13 cluster with EXTRACT() queries, application code parsing results',
    'EXTRACT() queries return numeric type, application handles numeric values correctly, date calculations maintain precision',
    'Code expecting float8 results may break silently - numeric values may not deserialize as floats in some drivers. Test EXTRACT() output type in all applications.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14: Wire protocol v2 removed - only v3 supported',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Verify all database drivers support PostgreSQL protocol v3 - most modern drivers do (psycopg2, node-postgres, libpq, Java JDBC)", "percentage": 94, "command": "Check driver version compatibility with PG14", "note": "Wire protocol v2 was from PostgreSQL 7.3 (2002)"},
        {"solution": "Update any legacy client libraries that explicitly request protocol v2 to latest versions supporting v3", "percentage": 90, "note": "No configuration needed - drivers auto-negotiate v3"},
        {"solution": "Test connections from all application client libraries before production upgrade", "percentage": 88, "command": "Connection test in dev environment"}
    ]'::jsonb,
    'PostgreSQL 13 cluster, list of database drivers and their versions, test environment',
    'All client libraries successfully connect using v3 protocol, no ''protocol version'' errors in logs, applications work post-upgrade',
    'Very old drivers (pre-2005) using protocol v2 will fail to connect. Check driver versions before upgrading production systems.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14: SSL compression removed - no longer supported',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Remove ssl_compression setting from postgresql.conf - it is now completely unsupported (was disabled by default)", "percentage": 95, "command": "Remove ssl_compression line from postgresql.conf", "note": "SSL compression was already disabled in PG13, now removed entirely"},
        {"solution": "If SSL connections required, use standard TLS compression settings in client libraries instead", "percentage": 85, "note": "Rely on TLS layer compression, not PostgreSQL-specific"}
    ]'::jsonb,
    'PostgreSQL 13 cluster configuration with potential ssl_compression setting',
    'postgresql.conf loads without ssl_compression warnings, SSL connections still work, no compression-related errors',
    'Leaving ssl_compression in config will cause startup error. Remove it before upgrade.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14: Array functions parameter type changed from anyarray to anycompatiblearray',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Recreate user-defined functions/objects referencing modified array functions: array_append, array_prepend, array_cat, array_position, array_positions, array_remove, array_replace", "percentage": 93, "command": "DROP FUNCTION old_func; CREATE FUNCTION new_func with updated array parameter types", "note": "Parameter type signature changed - functions must be recreated"},
        {"solution": "Update stored procedure calls passing anyarray to use anycompatiblearray semantics", "percentage": 88, "note": "anycompatiblearray allows mixed but compatible types"},
        {"solution": "Review width_bucket() function calls - parameter type also changed to anycompatiblearray", "percentage": 85}
    ]'::jsonb,
    'PostgreSQL 13 cluster with user-defined functions using modified array functions, function source code or pg_dump output',
    'pg_upgrade completes without function signature errors, custom functions compile and work, array operations return correct results',
    'Forgetting to recreate functions with old parameter types will cause pg_upgrade to abort or functions to fail post-upgrade. pg_upgrade --check will catch this.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14: pg_hba.conf clientcert values changed - only verify-ca and verify-full allowed',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Replace clientcert = 1 with clientcert = ''verify-ca'' and clientcert = 0/''no-verify'' with clientcert = ''verify-full'' in pg_hba.conf", "percentage": 94, "command": "Edit pg_hba.conf, replace legacy numeric values with named values", "note": "Legacy numeric values 1/0/no-verify no longer accepted"},
        {"solution": "Verify certificate authority is properly configured before changing to verify-ca", "percentage": 88, "note": "verify-ca requires valid CA cert setup"},
        {"solution": "Use verify-full for strictest security (verifies CN matches hostname)", "percentage": 85, "note": "Most secure option"}
    ]'::jsonb,
    'PostgreSQL 13 cluster with existing pg_hba.conf using legacy clientcert values, CA certificates if using verify-ca',
    'pg_hba.conf loads without deprecation errors, SSL connections work with named clientcert values, certificate validation passes',
    'PostgreSQL 14 will reject numeric clientcert values at startup. Update pg_hba.conf before upgrading or server will fail to start.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14: Configuration parameters removed - vacuum_cleanup_index_scale_factor and operator_precedence_warning',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Remove vacuum_cleanup_index_scale_factor from postgresql.conf if present - parameter was ignored since v13.3", "percentage": 95, "command": "Remove vacuum_cleanup_index_scale_factor line from postgresql.conf", "note": "Safe to remove - had no effect for 2+ years"},
        {"solution": "Remove operator_precedence_warning from postgresql.conf if present - PostgreSQL 9.5 migration helper now obsolete", "percentage": 93, "command": "Remove operator_precedence_warning line from postgresql.conf", "note": "Migration helper from 2016, no longer needed"},
        {"solution": "Run pg_upgrade --check to identify any deprecated parameters before actual upgrade", "percentage": 90, "command": "pg_upgrade --check will warn about invalid parameters"}
    ]'::jsonb,
    'PostgreSQL 13 cluster with postgresql.conf file, list of custom configuration parameters',
    'postgresql.conf loads without deprecated parameter errors, no warnings in upgrade log, system runs normally',
    'Leaving removed parameters in config will cause PostgreSQL 14 to reject them at startup. Clean config before upgrade.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14: Geometric type index operators - intarray <@/> operators no longer use GiST indexes',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Rebuild GiST indexes on intarray columns after upgrade - <@ and @> operators now force heap scans instead of using indexes", "percentage": 92, "command": "REINDEX TABLE intarray_table; or DROP INDEX idx_name; CREATE INDEX idx_name ON table USING GIST (column);", "note": "Counter-intuitively, heap scans prove faster than GiST for intarray"},
        {"solution": "Monitor query performance on intarray columns post-upgrade - slower queries may require index redesign", "percentage": 85, "note": "Heap scans can actually be faster for smaller datasets"},
        {"solution": "Consider BRIN or BTREE indexes as alternatives if query performance degrades", "percentage": 70, "note": "Depends on specific use case and data distribution"}
    ]'::jsonb,
    'PostgreSQL 13 cluster with intarray contrib module tables, GiST indexes on intarray columns, query performance baselines',
    'GiST indexes rebuilt post-upgrade, intarray containment queries complete successfully, query plans show expected access patterns',
    'Forgetting to reindex can leave old GiST indexes on disk - they won''t be used. This won''t break queries but wastes space. Monitor EXPLAIN plans.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14: Text search query parsing fixes - to_tsquery() and websearch_to_tsquery() behavior changed',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Test full-text search queries using to_tsquery() and websearch_to_tsquery() after upgrade - output may differ from v13 for queries with discarded tokens", "percentage": 90, "command": "SELECT to_tsquery(''english'', ''user_input''); -- Compare results pre/post upgrade", "note": "Fixes cases where underscores and other special chars were incorrectly handled"},
        {"solution": "Review search result sets in applications - queries that previously failed silently may now return correct results or error", "percentage": 85, "note": "This is a bug fix, not a feature change - old behavior was incorrect"},
        {"solution": "Update test cases for full-text search if they relied on old (incorrect) behavior", "percentage": 80}
    ]'::jsonb,
    'PostgreSQL 13 cluster with full-text search queries, test data for text search functionality, application search code',
    'to_tsquery() and websearch_to_tsquery() return correct parsed results, search results match expected output, no errors in search logs',
    'Applications relying on old incorrect parsing may see different search results. Test FTS thoroughly before production upgrade.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14: Window function frame handling fixed - infinite PRECEDING/FOLLOWING now return correct results',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Review window function queries using infinite frame clauses (UNBOUNDED/inf PRECEDING/FOLLOWING) after upgrade - results may differ from v13", "percentage": 93, "command": "SELECT COUNT(*) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)", "note": "This is a correctness fix - old results were incorrect"},
        {"solution": "Update application logic expecting old (incorrect) window function results", "percentage": 85, "note": "Query results will be mathematically correct post-upgrade"},
        {"solution": "Test analytical queries and financial calculations using window functions", "percentage": 82, "note": "Critical for reports and dashboards"}
    ]'::jsonb,
    'PostgreSQL 13 cluster with window function queries, test data, analytical query code',
    'Window functions with infinite frames return correct aggregate values, reports and analytics show accurate results, query output verifies mathematically',
    'Old queries may have depended on incorrect window results in reports. Upgrade and verify all analytical queries produce expected figures.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
),
(
    'PostgreSQL 13 to 14 upgrade: Use pg_upgrade, pg_dumpall, or logical replication - no in-place upgrade',
    'migration-guide',
    'VERY_HIGH',
    '[
        {"solution": "Use pg_upgrade utility for fastest upgrade: pg_upgrade -b old_bin -B new_bin -d old_data -D new_data", "percentage": 95, "command": "pg_upgrade --check first to validate, then pg_upgrade without --check for actual upgrade", "note": "Fastest method, preserves OID assignments"},
        {"solution": "Alternative: pg_dumpall from v13, restore to v14: pg_dumpall | psql -d postgres on v14", "percentage": 90, "command": "pg_dumpall | psql -h new_host -U postgres", "note": "Slower but most portable, safe for major differences"},
        {"solution": "Use logical replication for zero-downtime upgrade: Create v14 standby with logical replication from v13", "percentage": 85, "note": "Complex setup but no service interruption"},
        {"solution": "Always run pg_upgrade --check on copy of production cluster first", "percentage": 93, "command": "pg_upgrade --check -b /path/to/13/bin -B /path/to/14/bin -d /path/to/13/data -D /path/to/14/data"}
    ]'::jsonb,
    'PostgreSQL 13 cluster, PostgreSQL 14 binaries installed, backup of all databases, sufficient disk space for pg_upgrade',
    'pg_upgrade --check completes without errors, pg_upgrade succeeds with 0 exit code, all data present in v14 cluster, applications connect successfully',
    'Attempting in-place upgrade or skipping --check phase can lead to data loss. Always test on backup first.',
    0.96,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/14/release-14.html#RELEASE-14.0-INCOMPATIBILITIES'
);

-- Summary: Extracted 12 breaking changes and migration issues from PostgreSQL 13→14 official release notes
-- All entries sourced from: https://www.postgresql.org/docs/14/release-14.html
-- Categories include: deprecated operators, password encryption, protocol changes, index behavior, array functions, and upgrade procedures
