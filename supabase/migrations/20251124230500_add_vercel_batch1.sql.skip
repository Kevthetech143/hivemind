-- Add Vercel deployment error documentation batch 1
-- Mined from official Vercel error reference documentation
-- Date: 2024-11-24

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Vercel FUNCTION_INVOCATION_TIMEOUT (504): Function exceeded execution duration',
    'vercel',
    'VERY_HIGH',
    '[
        {"solution": "Optimize function code to complete within time limits (10s Hobby, 60s Pro, 300s Enterprise)", "percentage": 90, "note": "Address root cause - most reliable solution"},
        {"solution": "Upgrade to Pro or Enterprise plan for higher timeout limits", "percentage": 85, "note": "Increases timeout from 10s to 60s+ depending on plan"},
        {"solution": "Move long-running tasks to background job system (Queue, Inngest, or external worker)", "percentage": 95, "note": "Best practice for operations >60s"},
        {"solution": "For Edge Functions: Optimize to complete within 30s limit (not configurable)", "percentage": 88, "note": "Edge Functions have strict 30s timeout on all plans"}
    ]'::jsonb,
    'Deployed Vercel function, Access to function logs, Understanding of plan limits',
    'Function completes within timeout period, 200 response returned, No 504 errors in logs',
    'Timeout limits are strictly enforced and vary by plan: Hobby (10s), Pro (60s), Enterprise (300s). Edge Functions always timeout at 30s regardless of plan. Cannot be increased beyond plan limits. Background jobs are required for truly long operations.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/FUNCTION_INVOCATION_TIMEOUT'
),
(
    'Vercel EDGE_FUNCTION_INVOCATION_TIMEOUT (504): Edge function exceeded time limit',
    'vercel',
    'HIGH',
    '[
        {"solution": "Optimize Edge Function to complete within 30 second timeout limit", "percentage": 92, "note": "Edge Functions have strict 30s limit on all plans"},
        {"solution": "Move heavy computation to serverless function with higher timeout (60s Pro, 300s Enterprise)", "percentage": 90, "note": "Use Edge for routing/lightweight logic, Serverless for heavy work"},
        {"solution": "Cache expensive operations using Vercel Edge Cache or KV storage", "percentage": 88, "note": "Reduces computation time on subsequent requests"},
        {"solution": "Defer long-running work to background job after returning response", "percentage": 85, "note": "Return immediately, process asynchronously"}
    ]'::jsonb,
    'Deployed Edge Function, Access to Edge Function logs, Understanding of Edge runtime constraints',
    'Edge Function completes within 30s, Response returned successfully, No timeout errors',
    'Edge Functions ALWAYS timeout at 30 seconds regardless of plan - this cannot be increased. Edge runtime has limited APIs compared to Node.js. Use Edge Functions for lightweight operations (auth, redirects, headers) not heavy computation.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/EDGE_FUNCTION_INVOCATION_TIMEOUT'
),
(
    'Vercel FUNCTION_PAYLOAD_TOO_LARGE (413): Request size exceeds function limits',
    'vercel',
    'HIGH',
    '[
        {"solution": "Reduce request body size to under 4.5MB (Hobby/Pro) or 5MB (Enterprise)", "percentage": 90, "note": "Hard limit enforced at infrastructure level"},
        {"solution": "Use direct file upload to storage (S3, Vercel Blob, Cloudinary) then pass URL/ID to function", "percentage": 95, "note": "Best practice for large files - avoids function payload entirely"},
        {"solution": "Split large payloads into multiple smaller requests processed sequentially", "percentage": 85, "note": "Useful for batch operations that can be chunked"},
        {"solution": "For file uploads: Implement client-side compression before uploading", "percentage": 88, "note": "Reduces payload size, faster uploads"}
    ]'::jsonb,
    'Understanding of plan payload limits, Access to storage service for direct uploads',
    'Request completes without 413 error, Payload size under plan limit, Function processes data successfully',
    'Payload limits: 4.5MB (Hobby/Pro), 5MB (Enterprise) - cannot be increased. This includes request body AND headers. For file uploads, always use direct-to-storage upload patterns, not uploading through functions. Edge Functions have even stricter limits.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/FUNCTION_PAYLOAD_TOO_LARGE'
),
(
    'Vercel DEPLOYMENT_NOT_READY_REDIRECTING (303): Deployment still initializing',
    'vercel',
    'MEDIUM',
    '[
        {"solution": "Wait for deployment to complete - typically takes 30-120 seconds", "percentage": 95, "note": "Temporary state during deployment process"},
        {"solution": "Check deployment status in Vercel dashboard or via API before accessing", "percentage": 90, "note": "Programmatic verification prevents premature access"},
        {"solution": "Implement retry logic with exponential backoff when programmatically accessing new deployments", "percentage": 88, "note": "Handles timing automatically in automation"},
        {"solution": "Use deployment webhooks to trigger actions only after deployment is ready", "percentage": 92, "note": "Event-driven approach avoids polling"}
    ]'::jsonb,
    'Active Vercel deployment in progress, Access to Vercel dashboard or API',
    'Deployment shows READY status in dashboard, Visiting URL returns 200 status, No redirect to deployment initializing page',
    'This is a normal temporary state during deployment. DO NOT cancel or restart deployment. Build time increases with project size and complexity. First deployment of a branch may take longer due to cold start.',
    0.96,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/DEPLOYMENT_NOT_READY_REDIRECTING'
),
(
    'Vercel NO_RESPONSE_FROM_FUNCTION (502): Function failed to return response',
    'vercel',
    'HIGH',
    '[
        {"solution": "Ensure function always returns Response object - check all code paths including error handlers", "percentage": 92, "note": "Most common cause - missing return statement"},
        {"solution": "Add explicit error handling to catch and return errors: try/catch with Response.json() in catch block", "percentage": 90, "note": "Prevents unhandled errors causing no response"},
        {"solution": "For Next.js API routes: Always call res.status().json() or res.send() before function ends", "percentage": 88, "note": "Next.js-specific pattern"},
        {"solution": "Check for infinite loops or unresolved promises blocking function completion", "percentage": 85, "note": "Function must complete and return"}
    ]'::jsonb,
    'Function code access, Understanding of Response API, Ability to view function logs',
    'Function returns valid Response object on all code paths, 200/error status returned, No 502 errors in production logs',
    'Every function MUST return a Response. Common mistakes: forgetting return in if/else branches, not awaiting async operations, throwing without catching. Edge Functions require new Response(), Next.js API routes use res object.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/NO_RESPONSE_FROM_FUNCTION'
),
(
    'Vercel DEPLOYMENT_BLOCKED (403): Deployment prevented',
    'vercel',
    'MEDIUM',
    '[
        {"solution": "Check VERCEL_BLOCKED_DEPLOYMENTS environment variable - may contain branch/commit patterns", "percentage": 90, "note": "Administrative deployment controls"},
        {"solution": "Verify account payment status and plan limits - unpaid invoices block deployments", "percentage": 88, "note": "Billing-related blocks"},
        {"solution": "Check for violated usage limits (bandwidth, function execution) in dashboard", "percentage": 85, "note": "Automatic block when limits exceeded"},
        {"solution": "Review team permissions - user may lack deployment rights for project", "percentage": 82, "note": "Access control issue"}
    ]'::jsonb,
    'Admin access to Vercel project settings, Billing access, Team management permissions',
    'Deployment proceeds without 403 error, Build starts successfully, No deployment blocks shown in dashboard',
    'Deployments can be blocked at multiple levels: project settings, team settings, account billing, or usage limits. Check all layers. Blocked deployments show specific reason in dashboard. Contact support if block reason is unclear.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/DEPLOYMENT_BLOCKED'
),
(
    'Vercel MIDDLEWARE_INVOCATION_TIMEOUT (504): Middleware exceeded time limit',
    'vercel',
    'HIGH',
    '[
        {"solution": "Optimize middleware to complete within 30 second timeout (Edge Middleware limit)", "percentage": 92, "note": "Middleware runs on Edge Runtime with strict limits"},
        {"solution": "Move heavy logic from middleware to API routes or serverless functions", "percentage": 90, "note": "Middleware should be lightweight - routing, auth checks, header modifications only"},
        {"solution": "Reduce external API calls in middleware - cache responses or defer to later in request lifecycle", "percentage": 88, "note": "Network calls add significant latency"},
        {"solution": "Use matcher config to limit middleware execution to necessary paths only", "percentage": 85, "note": "Reduces unnecessary middleware invocations"}
    ]'::jsonb,
    'Next.js middleware.ts file access, Understanding of Edge Runtime constraints',
    'Middleware completes within 30s, Requests proceed without timeout, No 504 errors in middleware logs',
    'Middleware runs on Edge Runtime with 30s timeout (not configurable). Runs on EVERY matching request - keep extremely lightweight. Avoid database queries, heavy computation, multiple external API calls. Use for: auth checks, redirects, header modifications, A/B testing.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/MIDDLEWARE_INVOCATION_TIMEOUT'
),
(
    'Vercel FUNCTION_INVOCATION_FAILED (500): Function execution failure',
    'vercel',
    'VERY_HIGH',
    '[
        {"solution": "Check function logs in Vercel dashboard for specific error message and stack trace", "percentage": 95, "note": "Logs contain exact error cause"},
        {"solution": "Add try/catch blocks around error-prone code and log errors: console.error(err)", "percentage": 90, "note": "Catches and identifies runtime errors"},
        {"solution": "Verify all environment variables are set correctly in Vercel project settings", "percentage": 88, "note": "Missing env vars cause common runtime failures"},
        {"solution": "Test function locally with vercel dev to reproduce error in development", "percentage": 92, "note": "Local debugging is faster than production iteration"}
    ]'::jsonb,
    'Access to Vercel function logs, Vercel CLI installed for local testing, Environment variables configured',
    'Function executes without throwing errors, Returns expected response, No 500 errors in logs',
    'This is a generic error - actual cause is in logs. Common causes: uncaught exceptions, missing env vars, database connection failures, external API errors. Always check logs first. Test with vercel dev before deploying.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/FUNCTION_INVOCATION_FAILED'
),
(
    'Vercel INFINITE_LOOP_DETECTED (508): Infinite loop prevention triggered',
    'vercel',
    'MEDIUM',
    '[
        {"solution": "Check middleware for redirect loops - ensure redirects have proper exit conditions", "percentage": 95, "note": "Most common cause - middleware redirecting to itself"},
        {"solution": "Review rewrite rules in next.config.js or vercel.json for circular rewrites", "percentage": 90, "note": "Rewrite A → B → A creates loop"},
        {"solution": "Verify redirect chains do not exceed 8 hops (Vercel limit)", "percentage": 88, "note": "Even non-circular chains fail after 8 redirects"},
        {"solution": "Use matcher config in middleware to exclude redirect targets from middleware execution", "percentage": 92, "note": "Prevents middleware from processing its own redirects"}
    ]'::jsonb,
    'Access to middleware.ts and routing config, Understanding of Next.js routing, Vercel deployment logs',
    'Requests complete without redirect loops, No 508 errors, Middleware processes correctly',
    'Vercel detects infinite loops by tracking redirect/rewrite chains. Limit is 8 hops. Most common cause: middleware redirects to path that triggers same middleware. Always exclude redirect destinations from middleware matcher. Check for: middleware redirects, next.config.js rewrites, _redirects file rules.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/INFINITE_LOOP_DETECTED'
),
(
    'Vercel MIDDLEWARE_INVOCATION_FAILED (500): Middleware execution failure',
    'vercel',
    'HIGH',
    '[
        {"solution": "Check middleware logs for specific error - often shows line number and cause", "percentage": 95, "note": "Logs provide exact error details"},
        {"solution": "Verify middleware only uses Edge Runtime compatible APIs - no Node.js APIs", "percentage": 92, "note": "Edge Runtime has restricted API surface"},
        {"solution": "Test middleware locally: next dev catches most Edge compatibility issues", "percentage": 90, "note": "Development mode validates Edge constraints"},
        {"solution": "Ensure middleware exports config object and default function correctly", "percentage": 88, "note": "Incorrect exports prevent middleware from loading"}
    ]'::jsonb,
    'Next.js middleware.ts file, Access to deployment logs, Next.js 12+ installed locally',
    'Middleware executes without errors, Requests proceed normally, No 500 errors in middleware logs',
    'Middleware runs on Edge Runtime - cannot use Node.js APIs (fs, crypto, buffer). Use Edge-compatible alternatives. Common errors: importing Node.js modules, using unavailable APIs, incorrect export format. Check Edge Runtime docs for API compatibility.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/MIDDLEWARE_INVOCATION_FAILED'
),
(
    'Vercel FUNCTION_RESPONSE_PAYLOAD_TOO_LARGE (500): Response exceeds size constraints',
    'vercel',
    'MEDIUM',
    '[
        {"solution": "Reduce response payload to under 4.5MB limit - paginate large datasets", "percentage": 92, "note": "Hard limit cannot be increased"},
        {"solution": "Stream large responses using streaming API or chunked transfer encoding", "percentage": 90, "note": "Bypasses payload limit by streaming"},
        {"solution": "Upload large content to storage (S3, Vercel Blob) and return URL instead of data", "percentage": 95, "note": "Best practice for large files/data"},
        {"solution": "Implement pagination or cursor-based pagination for large result sets", "percentage": 88, "note": "Return data in smaller chunks"}
    ]'::jsonb,
    'Understanding of response size limits, Access to storage solution for large files, API design flexibility',
    'Response size under 4.5MB, Function returns successfully, No 500 payload errors',
    'Maximum response size: 4.5MB (Hobby/Pro), 5MB (Enterprise). This includes headers and body. Cannot be increased. For large data: use pagination, streaming, or direct storage links. Compression (gzip) is applied after size check, so does not help avoid this error.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/FUNCTION_RESPONSE_PAYLOAD_TOO_LARGE'
),
(
    'Vercel DEPLOYMENT_DISABLED (402): Deployment temporarily unavailable',
    'vercel',
    'MEDIUM',
    '[
        {"solution": "Update payment method in Vercel account billing settings", "percentage": 95, "note": "Most common cause - payment failure"},
        {"solution": "Check account for outstanding invoices and resolve payment", "percentage": 92, "note": "Unpaid invoices disable deployments"},
        {"solution": "Verify account is not suspended for Terms of Service violations", "percentage": 85, "note": "Review account status and emails from Vercel"},
        {"solution": "Contact Vercel support if payment is current but deployments still disabled", "percentage": 88, "note": "May be billing system issue"}
    ]'::jsonb,
    'Billing access to Vercel account, Payment method on file, Account ownership or billing permissions',
    'Account status shows Active, Deployments proceed normally, No 402 errors',
    'Deployments are disabled when: payment fails, account has unpaid invoices, plan limits exceeded without upgrade, ToS violations. Check billing dashboard first. Deployments re-enable immediately after payment resolves. Existing deployments remain accessible during disabled state.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://vercel.com/docs/errors/DEPLOYMENT_DISABLED'
);
