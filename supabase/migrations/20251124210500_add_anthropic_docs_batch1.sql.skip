-- Add official Anthropic API documentation solutions - Batch 1
-- Source: https://platform.claude.com/docs/en/api/errors
-- Extracted: 2025-11-24

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'Anthropic API error 400: invalid_request_error',
    'ai-api',
    'HIGH',
    '[
        {"solution": "Verify request JSON syntax is valid and properly formatted", "percentage": 90, "note": "Use a JSON validator before sending requests"},
        {"solution": "Check that all required parameters are included (model, messages, max_tokens)", "percentage": 88, "note": "Missing required fields trigger 400 errors"},
        {"solution": "Ensure parameter types match API specification (e.g., max_tokens is integer, not string)", "percentage": 85, "note": "Type mismatches are a common cause"},
        {"solution": "Verify content format in messages array follows proper structure", "percentage": 82, "note": "Each message needs role and content fields"}
    ]'::jsonb,
    'Valid Anthropic API key, Network connectivity to api.anthropic.com',
    'Request returns 200 status code, Response contains expected completion data',
    'Do not send malformed JSON. Verify all parameter types before sending. Check API version compatibility.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://platform.claude.com/docs/en/api/errors'
),
(
    'Anthropic API error 401: authentication_error',
    'ai-api',
    'HIGH',
    '[
        {"solution": "Verify API key is correctly set in x-api-key header", "percentage": 95, "note": "Most common cause of 401 errors"},
        {"solution": "Check that API key has not been revoked or expired in Console", "percentage": 92, "note": "Keys can be disabled in the dashboard"},
        {"solution": "Ensure API key string has no leading/trailing whitespace", "percentage": 88, "note": "Whitespace causes authentication to fail silently"},
        {"solution": "Regenerate API key if compromised", "percentage": 85, "command": "Create new key in Anthropic Console > API Keys"}
    ]'::jsonb,
    'Active Anthropic account with Console access, Valid API key created',
    'Authentication succeeds, Request proceeds to processing, No 401 in response',
    'API keys are sensitive - never commit to version control. Store in environment variables. Check for whitespace in key string.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://platform.claude.com/docs/en/api/errors'
),
(
    'Anthropic API error 403: permission_error',
    'ai-api',
    'MEDIUM',
    '[
        {"solution": "Verify your plan includes access to the requested model", "percentage": 90, "note": "Some models require specific plan tiers"},
        {"solution": "Check workspace permissions if using workspaces", "percentage": 88, "note": "Workspace-level restrictions may apply"},
        {"solution": "Ensure API key has correct scope for requested operation", "percentage": 85, "note": "Some operations require special permissions"},
        {"solution": "Contact Anthropic support if you believe you should have access", "percentage": 75, "note": "May be account-level restriction"}
    ]'::jsonb,
    'Valid authenticated API key, Account in good standing',
    'Request succeeds with 200 status, Resource access granted',
    'Permissions are set at account and workspace level. Upgrading API tier may be required for certain models.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://platform.claude.com/docs/en/api/errors'
),
(
    'Anthropic API error 404: not_found_error',
    'ai-api',
    'LOW',
    '[
        {"solution": "Verify the API endpoint URL is correct and properly formatted", "percentage": 92, "note": "Common with typos in endpoint path"},
        {"solution": "Check that the model name is valid and currently available", "percentage": 88, "note": "Model names must match exactly"},
        {"solution": "Ensure API version in URL path is supported", "percentage": 85, "note": "Use /v1/ for current API version"},
        {"solution": "Verify resource ID exists if accessing specific resources", "percentage": 80, "note": "IDs must be valid and accessible"}
    ]'::jsonb,
    'Valid API endpoint URL, Correct API version path',
    'Request reaches correct endpoint, Returns 200 status code',
    'Double-check endpoint URLs against official documentation. Model names are case-sensitive.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://platform.claude.com/docs/en/api/errors'
),
(
    'Anthropic API error 413: request_too_large',
    'ai-api',
    'MEDIUM',
    '[
        {"solution": "Reduce total request payload size below endpoint limits (32 MB standard)", "percentage": 92, "note": "Standard Messages API has 32 MB limit"},
        {"solution": "Use Batch API for large requests (256 MB limit)", "percentage": 88, "note": "Batch API supports larger payloads"},
        {"solution": "Compress or split large inputs into multiple requests", "percentage": 85, "note": "Consider chunking strategy"},
        {"solution": "For file uploads, use Files API (500 MB limit)", "percentage": 90, "note": "Files API designed for large uploads"}
    ]'::jsonb,
    'Request payload calculated and measured, Network connection stable',
    'Request completes successfully, No size limit errors',
    'Error originates from Cloudflare before reaching API servers. Different endpoints have different size limits: Messages (32 MB), Batch (256 MB), Files (500 MB).',
    0.90,
    'sonnet-4',
    NOW(),
    'https://platform.claude.com/docs/en/api/errors'
),
(
    'Anthropic API error 429: rate_limit_error',
    'ai-api',
    'VERY_HIGH',
    '[
        {"solution": "Check retry-after header and wait specified duration before retrying", "percentage": 95, "note": "Official recommended approach - header specifies exact wait time"},
        {"solution": "Implement exponential backoff with jitter for retries", "percentage": 92, "note": "Prevents thundering herd when limits reset"},
        {"solution": "Reduce request rate to stay within tier limits", "percentage": 90, "note": "Check Console Usage page for current limits"},
        {"solution": "Use prompt caching to increase effective token throughput", "percentage": 88, "note": "Cached tokens do not count toward input token rate limits"},
        {"solution": "Upgrade account tier if consistently hitting limits", "percentage": 85, "command": "Request limit increase via Anthropic Console"}
    ]'::jsonb,
    'Valid API key, Previously successful requests, Rate limit tracking implemented',
    'Request succeeds after waiting retry-after duration, Returns 200 status code',
    'Do not retry immediately - always respect retry-after header. Ramp up traffic gradually to avoid acceleration limits. Token bucket algorithm means limits continuously replenish.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://platform.claude.com/docs/en/api/rate-limits'
),
(
    'Anthropic API error 500: api_error',
    'ai-api',
    'LOW',
    '[
        {"solution": "Retry the request after a brief delay (1-2 seconds)", "percentage": 90, "note": "Internal errors are often transient"},
        {"solution": "Check Anthropic status page for ongoing incidents", "percentage": 88, "note": "May be platform-wide issue"},
        {"solution": "Include request_id from response headers when contacting support", "percentage": 95, "note": "Critical for debugging internal errors"},
        {"solution": "Implement exponential backoff if errors persist", "percentage": 85, "note": "Wait longer between each retry"}
    ]'::jsonb,
    'Valid API request that previously succeeded, Network connectivity',
    'Request succeeds on retry, API returns expected response',
    'These are Anthropic internal errors, not client errors. Always capture and log request_id header for support. Brief retries usually succeed.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://platform.claude.com/docs/en/api/errors'
),
(
    'Anthropic API error 529: overloaded_error',
    'ai-api',
    'MEDIUM',
    '[
        {"solution": "Retry request with exponential backoff starting at 2 seconds", "percentage": 92, "note": "Overload is temporary during high-traffic periods"},
        {"solution": "Check retry-after header if present and wait specified duration", "percentage": 95, "note": "Header indicates when capacity may be available"},
        {"solution": "Implement circuit breaker pattern to pause requests during overload", "percentage": 88, "note": "Prevents request pile-up"},
        {"solution": "Switch to Batch API for non-time-sensitive requests", "percentage": 85, "note": "Batch API processes during lower-traffic periods"}
    ]'::jsonb,
    'Valid API key, Request that previously succeeded',
    'Request succeeds after waiting, API returns 200 status code',
    'This indicates temporary API overload, not account-level rate limits. Always use exponential backoff. Consider Batch API for bulk processing.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://platform.claude.com/docs/en/api/errors'
);
