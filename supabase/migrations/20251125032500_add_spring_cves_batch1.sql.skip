-- Add Spring Framework CVEs batch 1
-- Mined from https://spring.io/security/ and official CVE advisories

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'CVE-2022-22965 Spring4Shell RCE via data binding',
    'spring-framework-cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade Spring Framework to 5.3.18, 5.2.20 or later versions patched on March 31 2022", "percentage": 95, "note": "Official patch released immediately after disclosure"},
        {"solution": "Only vulnerable if deployed as WAR on Tomcat JDK 9+. Spring Boot JAR deployments are NOT vulnerable", "percentage": 90, "note": "Deployment architecture affects exploitation possibility"},
        {"solution": "Implement request filtering to block class name parameters in request payload", "percentage": 80, "note": "Temporary mitigation if immediate upgrade not possible"}
    ]'::jsonb,
    'Spring Framework 5.2.x or 5.3.x installed, JDK 9+, WAR deployment on Tomcat',
    'Application starts without errors, DataBinder accepts only legitimate request parameters, exploit attempts return 400 Bad Request',
    'Spring Boot JAR deployments are safe by default. WAR deployments on Tomcat with JDK 9+ are vulnerable. This is incomplete fix for CVE-2010-1622.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2022-22965/'
),
(
    'CVE-2022-22980 Spring Data MongoDB SpEL injection in @Query annotations',
    'spring-framework-cve',
    'HIGH',
    '[
        {"solution": "Upgrade Spring Data MongoDB to 3.4.1 or 3.3.5 or later versions released June 20 2022", "percentage": 95, "note": "Official patch released 7 days after responsible disclosure"},
        {"solution": "Use array syntax [0], [1] to reference SpEL arguments instead of parameter placeholders", "percentage": 90, "command": "@Query(\"{ name: ?#{[0]} }\") instead of @Query(\"{ name: ?#{#name} }\")", "note": "Safe workaround without upgrading"},
        {"solution": "Sanitize all user input before passing to query methods with @Query or @Aggregation annotations", "percentage": 85, "note": "Application-level input validation"}
    ]'::jsonb,
    'Spring Data MongoDB 3.3.0-3.3.4 or 3.4.0 installed, @Query or @Aggregation annotations used with SpEL',
    'Query methods execute without SpEL evaluation errors, User input does not trigger expression evaluation, Authentication required for data access',
    'SpEL injection occurs during query assembly before execution. Input sanitization on application side is critical. Array syntax [n] is safe.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2022-22980/'
),
(
    'CVE-2024-38821 Spring Security authorization bypass on WebFlux static resources',
    'spring-framework-cve',
    'HIGH',
    '[
        {"solution": "Upgrade Spring Security to 5.7.13, 5.8.15, 6.0.13, 6.1.11, 6.2.7, 6.3.4 or later", "percentage": 96, "note": "Critical patch for WebFlux applications with static resource authorization"},
        {"solution": "Verify application uses WebFlux AND has Spring Security authorization rules on static resources AND rules are not permitAll", "percentage": 90, "note": "All three conditions must be true for vulnerability to exist"},
        {"solution": "Implement Spring Security HTTP Firewall to block malicious requests", "percentage": 85, "note": "Additional defense-in-depth measure"}
    ]'::jsonb,
    'Spring WebFlux application, Spring Security 5.8+ or 6.x installed, Non-permitAll authorization rules on static resources',
    'Static resources respect authorization rules, Unauthorized users receive 403 Forbidden, Authorized users access static resources successfully',
    'Only WebFlux applications vulnerable. Spring MVC not affected. Static resources must have non-permitAll rules configured.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2024-38821/'
),
(
    'CVE-2024-22234 Spring Security broken access control isFullyAuthenticated method',
    'spring-framework-cve',
    'HIGH',
    '[
        {"solution": "Upgrade Spring Security to 6.1.7 or 6.2.2 or later versions released February 2024", "percentage": 96, "note": "Fix prevents null authentication from returning true"},
        {"solution": "Avoid directly calling AuthenticationTrustResolver.isFullyAuthenticated(Authentication) with null parameters", "percentage": 90, "note": "Use isFullyAuthenticated via Method Security or HTTP Request Security instead"},
        {"solution": "If null authentication is possible, validate it before passing to isFullyAuthenticated method", "percentage": 85, "command": "if (authentication != null && trustResolver.isFullyAuthenticated(authentication)) {}", "note": "Application-level null check"}
    ]'::jsonb,
    'Spring Security 6.1.x prior to 6.1.7 or 6.2.x prior to 6.2.2, Direct use of AuthenticationTrustResolver',
    'Authentication checks return false for null authentication, Unauthorized requests rejected, Only fully authenticated users gain access',
    'Null authentication incorrectly returns true without patch. Method Security and HTTP Request Security are safe by default.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2024-22234/'
),
(
    'CVE-2024-38819 Spring Framework path traversal in functional web frameworks',
    'spring-framework-cve',
    'HIGH',
    '[
        {"solution": "Upgrade Spring Framework to 5.3.41, 6.0.25, 6.1.14 or later versions", "percentage": 96, "note": "High-severity path traversal patch released October 2024"},
        {"solution": "Verify application uses RouterFunctions with FileSystemResource for static resources and patch accordingly", "percentage": 90, "note": "Not all applications using functional frameworks are vulnerable"},
        {"solution": "Spring Security HTTP Firewall blocks exploitation on Tomcat and Jetty deployments automatically", "percentage": 85, "note": "Additional protection from web server configuration"}
    ]'::jsonb,
    'Spring Framework 5.3.0-5.3.40, 6.0.0-6.0.24, or 6.1.0-6.1.13 with RouterFunctions serving static files via FileSystemResource',
    'Directory traversal attempts blocked, Only authorized files accessible, Static resource requests return correct files only',
    'Applications on Tomcat/Jetty may be protected. Double URL encoding allows bypass. Different from CVE-2024-38816.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2024-38819/'
),
(
    'CVE-2024-38816 Spring path traversal via WebMvc.fn and WebFlux.fn static resources',
    'spring-framework-cve',
    'HIGH',
    '[
        {"solution": "Upgrade Spring Framework to 5.3.40, 6.0.24, 6.1.13 or later versions", "percentage": 96, "note": "Path traversal fix for functional web framework static resource serving"},
        {"solution": "Ensure application does NOT use RouterFunctions with FileSystemResource for static resources", "percentage": 90, "note": "Safe if using alternative resource serving mechanisms"},
        {"solution": "Enable Spring Security HTTP Firewall for additional protection on Tomcat and Jetty", "percentage": 85, "note": "Web server firewall blocks exploitation attempts"}
    ]'::jsonb,
    'Spring Framework 5.3.0-5.3.39, 6.0.0-6.0.23, or 6.1.0-6.1.12 with WebMvc.fn or WebFlux.fn serving static resources',
    'File system traversal attempts blocked, Access restricted to configured resource directory, Sensitive files not accessible via request',
    'Not vulnerable on Tomcat/Jetty due to web server filtering. Spring Security HTTP Firewall provides defense. Different from CVE-2024-38819.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2024-38816/'
),
(
    'CVE-2024-38808 Spring Expression Language DoS via resource exhaustion',
    'spring-framework-cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade Spring Framework to 5.3.39 or later versions released August 2024", "percentage": 95, "note": "Medium-severity DoS fix for SpEL expression evaluation"},
        {"solution": "Avoid evaluating untrusted SpEL expressions with complex patterns that consume excessive resources", "percentage": 85, "note": "Application-level input validation of SpEL expressions"},
        {"solution": "Implement resource limits and timeouts on SpEL expression evaluation", "percentage": 80, "note": "Add execution timeout configuration for SpEL"}
    ]'::jsonb,
    'Spring Framework 5.3.0-5.3.38 installed, User-supplied SpEL expressions evaluated via SpEL parser',
    'SpEL expressions evaluate without resource exhaustion, Application remains responsive under load, System memory/CPU stable',
    'Resource exhaustion possible with specially crafted SpEL expressions. User input validation critical. Timeout configuration recommended.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2024-38808/'
),
(
    'CVE-2024-38809 Spring HTTP conditional request DoS via ETag headers',
    'spring-framework-cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade Spring Framework to 5.3.38+, 6.0.23+, or 6.1.12+ versions released August 2024", "percentage": 95, "note": "DoS fix for improper ETag/conditional header validation"},
        {"solution": "Validate ETag and If-Match/If-None-Match headers before processing conditional requests", "percentage": 85, "note": "Application-level header validation"},
        {"solution": "Implement request header size limits and malformed header rejection", "percentage": 80, "note": "Web server or servlet filter configuration"}
    ]'::jsonb,
    'Spring Framework 5.3.0-5.3.37, 6.0.0-6.0.22, or 6.1.0-6.1.11 with HTTP conditional request handling enabled',
    'Malformed ETag headers rejected safely, Application remains responsive, Legitimate conditional requests processed normally',
    'Specially crafted ETag headers trigger DoS. Input validation on conditional request headers critical. Web server filtering helps.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2024-38809/'
),
(
    'CVE-2024-38820 Spring DataBinder case sensitive match exception in disallowedFields',
    'spring-framework-cve',
    'LOW',
    '[
        {"solution": "Upgrade Spring Framework to 5.3.41, 6.0.25, or 6.1.14 or later versions", "percentage": 94, "note": "Low-severity fix for DataBinder field protection bypass"},
        {"solution": "Use Locale-independent field validation patterns in DataBinder configuration", "percentage": 85, "note": "Avoid case-sensitive patterns affected by Locale-specific toLowerCase"},
        {"solution": "Implement additional field-level validation independent of DataBinder patterns", "percentage": 80, "note": "Defense-in-depth validation approach"}
    ]'::jsonb,
    'Spring Framework 5.3.0-5.3.40, 6.0.0-6.0.24, or 6.1.0-6.1.13 with DataBinder and disallowedFields configuration',
    'DataBinder correctly rejects disallowed fields, Field protection patterns work consistently across locales, No field access bypass',
    'Case conversion has Locale-specific exceptions. Only affects disallowedFields patterns. Led to CVE-2025-22233.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2024-38820/'
),
(
    'CVE-2023-34055 Spring Boot actuator Web Observations DoS vulnerability',
    'spring-framework-cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade Spring Boot to 2.7.18, 3.0.13, or 3.1.6 or later versions released November 2023", "percentage": 95, "note": "Medium-severity DoS fix for web metrics processing"},
        {"solution": "Disable web metrics temporarily: management.metrics.enable.http.server.requests=false in application.properties", "percentage": 90, "command": "management.metrics.enable.http.server.requests=false", "note": "Workaround if immediate upgrade not possible"},
        {"solution": "Validate and sanitize HTTP request properties before metrics collection", "percentage": 80, "note": "Application-level request validation"}
    ]'::jsonb,
    'Spring Boot 2.7.0-2.7.17, 3.0.0-3.0.12, or 3.1.0-3.1.5 with spring-boot-actuator on classpath and Spring MVC or WebFlux',
    'Application handles specially crafted requests without DoS, Metrics collection completes normally, Server CPU and memory stable',
    'Only vulnerable with spring-boot-actuator on classpath. Specially crafted HTTP requests trigger metrics processing DoS.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2023-34055/'
),
(
    'CVE-2024-22233 Spring Framework HTTP ForwardedHeaderFilter DoS vulnerability',
    'spring-framework-cve',
    'HIGH',
    '[
        {"solution": "Upgrade Spring Framework to 6.0.16 or 6.1.3 or later versions released January 2024", "percentage": 96, "note": "High-severity DoS fix for malformed forwarded headers"},
        {"solution": "Ensure Spring Security 6.1.6+ or 6.2.1+ is on classpath along with patched Spring Framework", "percentage": 90, "note": "Vulnerability requires both Spring MVC and recent Spring Security"},
        {"solution": "Implement input validation for Forwarded HTTP headers before processing", "percentage": 85, "note": "Request-level header validation and sanitization"}
    ]'::jsonb,
    'Spring Framework 6.0.15 or 6.1.2 with Spring Security 6.1.6+ or 6.2.1+, Spring MVC enabled, ForwardedHeaderFilter active',
    'Malformed forwarded headers handled without exceptions, Application remains responsive, Server not impacted by crafted requests',
    'ForwardedHeaderFilter lacks exception handling for invalid headers. Spring Boot starter-security includes vulnerable dependencies.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2024-22233/'
),
(
    'CVE-2025-41249 Spring Framework annotation detection vulnerability in method security',
    'spring-framework-cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade Spring Framework to 5.3.45, 6.1.23, or 6.2.11 or later versions released September 2025", "percentage": 95, "note": "Medium-severity fix for annotation detection on parameterized generic superclasses"},
        {"solution": "Do not use security annotations on methods in generic superclasses with unbounded generics if possible", "percentage": 85, "note": "Architecture change to avoid affected pattern"},
        {"solution": "Add explicit @EnableMethodSecurity verification that security annotations are correctly detected", "percentage": 80, "note": "Testing and validation approach"}
    ]'::jsonb,
    'Spring Framework 5.3.0-5.3.44, 6.1.0-6.1.22, or 6.2.0-6.2.10 with @EnableMethodSecurity and method security annotations on generic types',
    'Method security annotations correctly detected on generic superclasses, Authorization checks enforced on all methods, Access control working as expected',
    'Annotation detection fails on methods in superclasses with parameterized unbounded generics. Affects @EnableMethodSecurity only.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://spring.io/security/cve-2025-41249/'
);
