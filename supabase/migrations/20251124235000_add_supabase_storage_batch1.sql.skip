-- Add Supabase Storage documentation solutions batch 1
-- Extracted from: https://supabase.com/docs/guides/storage

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Supabase Storage error: NoSuchBucket - The specified bucket does not exist',
    'supabase',
    'HIGH',
    '[
        {"solution": "Verify the bucket name is correct and matches exactly (case-sensitive)", "percentage": 90, "note": "Bucket names must match exactly"},
        {"solution": "Check if you have permissions to access the bucket via RLS policies on storage.objects table", "percentage": 85, "note": "404 can mean no permissions, not just missing bucket"},
        {"solution": "Create the bucket if it does not exist via Dashboard or supabase.storage.createBucket()", "percentage": 95, "note": "Ensure bucket exists before operations"}
    ]'::jsonb,
    'Valid Supabase project, Authenticated user session for private buckets',
    'Bucket operations succeed without 404 error, Bucket appears in storage dashboard',
    'Bucket names are case-sensitive. A 404 error can mean either the bucket does not exist OR you lack permissions to access it.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/debugging/error-codes'
),
(
    'Supabase Storage error: EntityTooLarge - The entity being uploaded is too large',
    'supabase',
    'HIGH',
    '[
        {"solution": "Check the max file upload limit in Project Settings > Storage and increase if needed", "percentage": 95, "note": "Default limits vary by plan"},
        {"solution": "Verify bucket-level file size restrictions and adjust in bucket settings", "percentage": 90, "note": "Bucket limits override if lower than global"},
        {"solution": "Use resumable uploads for files larger than 6MB instead of standard uploads", "percentage": 85, "note": "Standard uploads max at 5GB but resumable is more reliable for large files"}
    ]'::jsonb,
    'Valid file to upload, Supabase project with storage enabled',
    'File uploads successfully without 413 error, File appears in storage bucket',
    'Standard uploads support up to 5GB but are only recommended for files under 6MB. For larger files, use TUS resumable uploads or S3 multipart uploads. Check both global AND bucket-level limits.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/debugging/error-codes'
),
(
    'Supabase Storage error: AccessDenied - Access to the specified resource is denied',
    'supabase',
    'VERY_HIGH',
    '[
        {"solution": "Create RLS policy on storage.objects table with appropriate permissions (SELECT, INSERT, UPDATE, DELETE)", "percentage": 95, "note": "Storage requires RLS policies by default"},
        {"solution": "Ensure Authorization header with valid JWT is included in request for private buckets", "percentage": 90, "note": "Authentication required for private bucket operations"},
        {"solution": "Verify the RLS policy conditions match your user context (auth.uid(), bucket_id, folder path)", "percentage": 85, "note": "Policy logic must allow the specific operation"}
    ]'::jsonb,
    'Authenticated user session, Valid JWT token, Storage bucket created',
    'Storage operation succeeds without 403 error, User can perform intended action',
    'By default Storage does not allow any uploads without RLS policies. Public buckets still require RLS for upload/delete/update operations. Use service_role key only on trusted servers, never in client code.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/security/access-control'
),
(
    'Supabase Storage error: ResourceAlreadyExists or KeyAlreadyExists - File already exists at path',
    'supabase',
    'HIGH',
    '[
        {"solution": "Add upsert: true option to upload method to overwrite existing file", "percentage": 95, "note": "JavaScript: {upsert: true} in options"},
        {"solution": "Add x-upsert: true header to HTTP request for REST API calls", "percentage": 90, "note": "Header-based approach for non-SDK usage"},
        {"solution": "Use a different file path or add timestamp/UUID to filename to avoid conflicts", "percentage": 85, "note": "Better for immutable storage pattern"}
    ]'::jsonb,
    'Valid file to upload, Existing file at target path',
    'File uploads successfully, Either overwrites existing or creates with new name',
    'Default behavior prevents accidental overwrites. When using upsert, CDN propagation can take time - uploading to a new path avoids stale cached content. First concurrent upload wins unless upsert is enabled.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/uploads/standard-uploads'
),
(
    'Supabase Storage error 404: not_found - Resource not found or no permission',
    'supabase',
    'VERY_HIGH',
    '[
        {"solution": "Add RLS policy with SELECT permission on storage.objects for the target bucket/path", "percentage": 90, "note": "Most common cause is missing RLS policy"},
        {"solution": "Ensure Authorization header with valid user JWT is included in the request", "percentage": 85, "note": "Required for authenticated access"},
        {"solution": "Verify the object path and bucket name are correct and file actually exists", "percentage": 80, "note": "Check spelling and case sensitivity"}
    ]'::jsonb,
    'Storage object exists, Valid authentication credentials',
    'Object can be accessed without 404 error, Download or query succeeds',
    '404 indicates either the resource does not exist OR you lack permission to see it. Check RLS policies first before assuming the file is missing.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/debugging/error-codes'
),
(
    'Supabase Storage: How to create RLS policy for file uploads',
    'supabase',
    'VERY_HIGH',
    '[
        {"solution": "Create INSERT policy on storage.objects with bucket_id filter", "percentage": 95, "command": "create policy \"Allow uploads\" on storage.objects for insert to authenticated with check (bucket_id = ''my_bucket'');"},
        {"solution": "For upsert operations, grant INSERT, SELECT, and UPDATE permissions", "percentage": 90, "note": "Upsert requires all three permissions"},
        {"solution": "Restrict uploads to user-specific folders using storage.foldername() helper", "percentage": 85, "command": "with check (bucket_id = ''bucket'' and (storage.foldername(name))[1] = auth.uid()::text)"}
    ]'::jsonb,
    'Supabase project with Storage enabled, Admin access to SQL editor',
    'Users can upload files to bucket, RLS policy appears in policies list',
    'Storage requires explicit RLS policies - uploads are blocked by default. Use storage.foldername() and storage.filename() helpers for path-based restrictions. Test policies with different user contexts.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/security/access-control'
),
(
    'Supabase Storage error: InvalidJWT - The provided JWT is invalid',
    'supabase',
    'HIGH',
    '[
        {"solution": "Refresh the user session to get a new valid JWT token", "percentage": 90, "command": "await supabase.auth.refreshSession()"},
        {"solution": "Check if JWT has expired and re-authenticate the user", "percentage": 85, "note": "JWTs expire after 1 hour by default"},
        {"solution": "Verify JWT is properly formatted and not corrupted in Authorization header", "percentage": 80, "note": "Should be Bearer <token> format"}
    ]'::jsonb,
    'User authentication configured, Valid Supabase project',
    'Storage request succeeds with refreshed token, No 401 errors',
    'JWTs expire after 1 hour by default. Always handle token refresh in your application. Malformed tokens can occur from improper header formatting or string manipulation.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/debugging/error-codes'
),
(
    'Supabase Storage error 429: too many requests - Request rate too high',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Increase max_clients limit of the database pooler in project settings", "percentage": 85, "note": "High concurrent storage usage"},
        {"solution": "Upgrade to larger compute instance for higher connection limits", "percentage": 90, "note": "Pro/Team plans have higher limits"},
        {"solution": "Implement request queuing or rate limiting in your application", "percentage": 75, "note": "Prevent hitting pooler limits"}
    ]'::jsonb,
    'Supabase project experiencing high traffic, Admin access to project settings',
    'Requests succeed without 429 errors, Connection pool can handle load',
    'This occurs when many clients concurrently access Storage and the pooler reaches max_clients limit. Monitor connection pool usage in dashboard.',
    0.82,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/debugging/error-codes'
),
(
    'Supabase Storage error 544: database_timeout - Database connection timeout',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Increase pool_size limit of the pooler in project settings", "percentage": 85, "note": "More connections available for Storage"},
        {"solution": "Upgrade to larger compute instance with more available connections", "percentage": 90, "note": "Higher tier plans have better performance"},
        {"solution": "Optimize RLS policies by adding indexes on commonly filtered columns", "percentage": 80, "note": "Reduce query execution time"}
    ]'::jsonb,
    'Supabase project with Storage enabled, High concurrent usage',
    'Storage operations complete without timeout, No 544 errors',
    'Postgres lacks enough available connections to handle Storage requests efficiently. This is distinct from max_clients (429) - it is about connection availability.',
    0.83,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/debugging/error-codes'
),
(
    'Supabase Storage: Public vs Private buckets - When to use each',
    'supabase',
    'HIGH',
    '[
        {"solution": "Use public buckets for assets that anyone can download via URL (profile pics, blog images)", "percentage": 95, "note": "Better CDN performance, no auth required for downloads"},
        {"solution": "Use private buckets for sensitive files requiring access control (user documents, private media)", "percentage": 95, "note": "Downloads require signed URLs or Authorization header"},
        {"solution": "Remember public buckets still require RLS policies for upload/delete/update operations", "percentage": 90, "note": "Public only affects download access"}
    ]'::jsonb,
    'Understanding of application access requirements, Storage bucket to configure',
    'Correct bucket type selected for use case, Access control working as intended',
    'Public buckets only bypass access control for downloads/serving. All other operations still require RLS policies. Public buckets have better CDN cache performance.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/buckets/fundamentals'
),
(
    'Supabase Storage: Signed URL expired or invalid for private bucket',
    'supabase',
    'HIGH',
    '[
        {"solution": "Generate new signed URL with createSignedUrl() method and appropriate expiration time", "percentage": 95, "command": "await supabase.storage.from(''bucket'').createSignedUrl(''path'', 3600)"},
        {"solution": "Increase expiration time parameter (in seconds) when creating signed URL", "percentage": 90, "note": "Default 1 hour may be too short for some use cases"},
        {"solution": "Implement URL regeneration logic before expiration in your application", "percentage": 85, "note": "Refresh URLs proactively"}
    ]'::jsonb,
    'Private storage bucket, File exists in bucket, Valid authentication',
    'Signed URL successfully downloads file, URL works within expiration window',
    'Signed URLs are time-limited and expire after specified duration. They cannot be refreshed - you must generate a new URL. Store expiration time to know when to regenerate.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/serving/downloads'
),
(
    'Supabase Storage: MissingContentLength header error during upload',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Ensure Content-Length header is included in HTTP request with correct file size", "percentage": 95, "note": "Required for all upload operations"},
        {"solution": "If using SDK, verify file object has size property or use proper File/Blob type", "percentage": 90, "note": "SDK typically handles this automatically"},
        {"solution": "For streaming uploads, calculate and set content length before initiating upload", "percentage": 80, "note": "Cannot be dynamically determined"}
    ]'::jsonb,
    'Valid file to upload, HTTP client or SDK configured',
    'File uploads successfully with proper Content-Length header, No 411 error',
    'Content-Length is mandatory for S3-compatible storage. Most SDKs handle this automatically but raw HTTP requests must include it manually.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/storage/debugging/error-codes'
);
