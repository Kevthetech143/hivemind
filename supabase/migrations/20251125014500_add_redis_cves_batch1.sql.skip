-- Add Redis CVE security advisories batch 1
-- Source: Official Redis Security Advisories (https://redis.io/blog/)
-- Coverage: Command injection, Lua sandbox escapes, replication vulnerabilities, heap overflow attacks
-- Last updated: November 25, 2025

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'CVE-2024-46981: Lua Use-After-Free Remote Code Execution in Redis',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade to Redis Software 7.4.6-102+, 7.2.4-117+, 6.4.2-115+, or 6.2.18-88+ immediately", "percentage": 95, "note": "Critical security patch for Lua VM garbage collector vulnerability"},
        {"solution": "Upgrade Redis OSS/CE to version 7.4.2+, 7.2.7+, or 6.2.17+ containing the fix", "percentage": 95, "note": "Open source Redis patch"},
        {"solution": "Restrict Lua script execution permissions to trusted users only via ACL", "percentage": 90, "command": "ACL SETUSER untrusted -@scripting"},
        {"solution": "Disable Lua scripting entirely if not required for production workload", "percentage": 85, "note": "Reduces attack surface but may break functionality"},
        {"solution": "Monitor Redis logs for suspicious Lua script execution patterns", "percentage": 80, "note": "Enable audit logging for script commands"}
    ]'::jsonb,
    'Redis instance with Lua scripting enabled, Authenticated user access, Admin privileges to upgrade Redis',
    'Redis upgraded to patched version, redis-server --version shows fixed release, No suspicious Lua executions in audit logs, Script execution permissions restricted via ACL',
    'Only authenticated users with permission to run Lua scripts can exploit this vulnerability. Affects all Redis versions supporting Lua scripting. Specially crafted Lua scripts can manipulate the Lua VM garbage collector leading to use-after-free and RCE. CVSS score 7.0 (High). Redis Cloud already patched automatically.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://redis.io/blog/security-advisory-cve-2024-46981-cve-2024-51737-cve-2024-51480-cve-2024-55656/'
),
(
    'CVE-2024-31449: Lua library commands exploited for remote code execution',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade to Redis Software 7.4.2-169+, 7.2.4-109+, or 6.4.2-110+ with CVE-2024-31449 fix", "percentage": 95, "note": "Patch for Lua bit library stack buffer overflow"},
        {"solution": "Upgrade Redis OSS/CE/Stack to version 7.4.1+, 7.2.6+, or 6.2.16+ containing the patch", "percentage": 95, "note": "Open source and Stack versions with fix"},
        {"solution": "Review and restrict ACL permissions for Lua script execution to trusted users", "percentage": 90, "command": "ACL SETUSER scriptuser on >password ~* +@all -@scripting"},
        {"solution": "Audit existing Lua scripts for potential exploitation of bit library functions", "percentage": 85, "note": "Check for suspicious bit manipulation in stored scripts"},
        {"solution": "Enable Redis command audit logging to track script execution", "percentage": 80, "command": "CONFIG SET logfile /var/log/redis/redis.log"}
    ]'::jsonb,
    'Redis instance running vulnerable version, Authenticated user access, Lua scripting enabled',
    'Redis upgraded to patched version (7.4.1+, 7.2.6+, or 6.2.16+), ACL restrictions enforced, Audit logs enabled and monitoring script execution, No suspicious bit library usage detected',
    'Stack buffer overflow in embedded Lua engine bit library. Requires authentication and script execution privileges. Commands run with privileges of Redis process owner. CVSS score 7.0 (High). Related to CVE-2024-31227 and CVE-2024-31228 in same advisory. Affects all versions before patches.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://redis.io/blog/security-advisory-cve-2024-31449-cve-2024-31227-cve-2024-31228/'
),
(
    'CVE-2022-0543: Debian-specific Lua sandbox escape leading to RCE',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade to fixed Redis packages: redis/5:6.0.16-1+deb11u2, 5:5.0.14-1+deb10u2, 5:6.0.16-2, or 5:7.0~rc2-2", "percentage": 95, "note": "Debian/Ubuntu-specific patch for Lua sandbox escape"},
        {"solution": "Verify Lua library is statically linked, not dynamic, to prevent package variable exploitation", "percentage": 90, "command": "ldd $(which redis-server) | grep lua"},
        {"solution": "Restrict network access to Redis instances to trusted clients only", "percentage": 85, "note": "Limit exposure while preparing to patch"},
        {"solution": "Disable Lua scripting via rename-command directive if not required", "percentage": 80, "command": "CONFIG SET rename-command EVAL \"\""},
        {"solution": "Monitor for exploitation attempts via CISA KEV catalog indicators", "percentage": 75, "note": "Check for unauthorized library loading in logs"}
    ]'::jsonb,
    'Debian-based Linux distribution (Ubuntu, Linux Mint, Raspberry Pi OS), Redis version <= 5:5.0.14-1+deb10u1, 5:5.0.3-4, or 5:6.0.15-1',
    'Redis package upgraded to fixed version, Lua library statically linked (ldd shows no dynamic lua), No unauthorized library loads in logs, CISA KEV remediation deadline met',
    'CRITICAL Debian-specific vulnerability with CVSS 10.0. Packaging issue allowed dynamic Lua library loading with package variable populated. Attackers can load arbitrary libraries and escape sandbox. Added to CISA KEV catalog March 28, 2022 with April 18, 2022 remediation deadline. Does NOT affect official Redis builds - only Debian derivatives. Discovered by Reginaldo Silva.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://ine.com/blog/cve-20220543-lua-sandbox-escape-in-redis'
),
(
    'CVE-2022-24735: Lua code injection via script execution environment bypassing ACL',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade to Redis 7.0.0 or 6.2.7 containing CVE-2022-24735 Lua readonly tables fix", "percentage": 95, "note": "Official patch makes Lua global tables readonly"},
        {"solution": "Block SCRIPT LOAD and EVAL commands using ACL rules if Lua not required", "percentage": 90, "command": "ACL SETUSER limited -@scripting -script|load -eval"},
        {"solution": "Review ACL configurations to ensure least privilege for script execution", "percentage": 85, "note": "Prevent low-privilege users from executing scripts"},
        {"solution": "Audit existing stored Lua scripts for privilege escalation attempts", "percentage": 80, "command": "SCRIPT DEBUG YES; INFO REPLICATION"},
        {"solution": "Implement network segmentation to isolate Redis instances with ACLs enabled", "percentage": 75, "note": "Defense-in-depth approach"}
    ]'::jsonb,
    'Redis 6.0+ with ACL support enabled, Multiple users with different privilege levels, Lua scripting in use',
    'Redis upgraded to 7.0.0+ or 6.2.7+, ACL rules enforce script execution restrictions, Audit completed for existing scripts, No privilege escalation detected in logs',
    'Introduced with ACLs in Redis 6.0. Low-privilege users can inject Lua code executing with higher privileges later. Exploits weaknesses in Lua execution environment side-effect prevention. CVSS 3.1 score 3.9 (Low) / CVSS 2 score 6.8 (Medium). CWE-94 Code Injection. Workaround: block EVAL/SCRIPT LOAD if Lua not used. Related to CVE-2022-24736.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://github.com/redis/redis/security/advisories/GHSA-647m-2wmq-qmvq'
),
(
    'CVE-2022-24834: Heap overflow in Lua cJSON and cmsgpack libraries',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade Redis Enterprise to 6.2.12-82+, 6.2.18-1+, 6.4 (all), or 7.2.0+ containing the fix", "percentage": 95, "note": "Enterprise patch for cJSON/cmsgpack heap overflow"},
        {"solution": "Upgrade Redis Open Source to 6.0.20, 6.2.13, 7.0.12, or 7.2 RC3 with patches", "percentage": 95, "note": "Open source versions with fix"},
        {"solution": "Upgrade Redis Stack to 6.2.6-v8 or 7.2 RC3 containing the security patch", "percentage": 95, "note": "Stack distribution patch"},
        {"solution": "Restrict Lua script execution to trusted administrators only", "percentage": 85, "command": "ACL SETUSER app -@scripting"},
        {"solution": "Review and sanitize all Lua scripts processing external data", "percentage": 80, "note": "Prevent malicious script injection"}
    ]'::jsonb,
    'Redis instance with Lua scripting enabled, Access to execute crafted Lua scripts, Admin privileges to upgrade',
    'Redis upgraded to patched version (6.0.20+, 6.2.13+, 7.0.12+, or 7.2+), Script execution restricted to admins, No heap corruption events in logs, Redis Cloud users automatically patched',
    'Specially crafted Lua scripts trigger heap overflow in cJSON and cmsgpack libraries. Results in heap corruption and potential RCE. Affects all Redis versions with Lua support. Redis Enterprise Cloud patched automatically. Related to CVE-2023-36824 (7.X only). Immediate upgrade strongly encouraged for self-managed instances.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://redis.io/blog/security-notice-heap-overflow-vulnerabilties/'
),
(
    'CVE-2023-36824: Heap overflow via command arguments in Redis 7.X',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade Redis Open Source to 7.0.12 or 7.2 RC3 containing CVE-2023-36824 fix", "percentage": 95, "note": "Patch for key name extraction heap overflow"},
        {"solution": "Upgrade Redis Stack to 7.2 RC3 with security patch applied", "percentage": 95, "note": "Stack version with fix"},
        {"solution": "Restrict authenticated user permissions to minimize command execution", "percentage": 85, "command": "ACL SETUSER readonly on >password ~* +@read -@write -@dangerous"},
        {"solution": "Monitor Redis for unusual command patterns that extract many key names", "percentage": 80, "note": "Enable slowlog and monitor for suspicious activity"},
        {"solution": "For Redis Enterprise Cloud 7.0 Preview: verify auto-patch applied", "percentage": 90, "note": "Cloud instances patched automatically"}
    ]'::jsonb,
    'Redis 7.X version (7.0.0 through 7.0.11 or 7.2 pre-RC3), Authenticated user access',
    'Redis upgraded to 7.0.12+, 7.2 RC3+, or later, ACL restrictions implemented, No heap overflow errors in logs, Redis Enterprise Cloud users verified auto-patch',
    'ONLY affects Redis 7.X versions. Heap overflow when extracting key names from commands with specially crafted argument lists. Enables reading heap memory, heap corruption, and potential RCE. Redis Enterprise unaffected. Redis Enterprise Cloud 7.0 Preview locations patched automatically. Related to CVE-2022-24834 but 7.X specific.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://redis.io/blog/security-notice-heap-overflow-vulnerabilties/'
),
(
    'CVE-2024-31228: Denial-of-service via long string match patterns',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade to Redis 7.4.1+, 7.2.6+, or 6.2.16+ containing unbounded recursion fix", "percentage": 95, "note": "Patch prevents stack overflow from pattern matching"},
        {"solution": "Restrict access to pattern matching commands (KEYS, SCAN, PSUBSCRIBE) via ACL", "percentage": 90, "command": "ACL SETUSER limited -keys -scan -psubscribe"},
        {"solution": "Implement command rename to disable vulnerable pattern commands if not needed", "percentage": 85, "command": "CONFIG SET rename-command KEYS \"\""},
        {"solution": "Monitor for unusually long pattern strings in command logs", "percentage": 80, "note": "Set up alerts for pattern length anomalies"},
        {"solution": "Rate limit command execution per user to mitigate DoS impact", "percentage": 75, "note": "Configure maxclients and client-output-buffer-limit"}
    ]'::jsonb,
    'Redis instance with authenticated users, Commands KEYS, SCAN, PSUBSCRIBE, FUNCTION LIST, COMMAND LIST, or ACL definitions enabled',
    'Redis upgraded to patched version (7.4.1+, 7.2.6+, or 6.2.16+), Pattern matching commands restricted via ACL, No stack overflow crashes, Command monitoring active',
    'Authenticated users can trigger DoS with specially crafted long string match patterns. Causes unbounded recursion leading to stack overflow and process crash. Affects KEYS, SCAN, PSUBSCRIBE, FUNCTION LIST, COMMAND LIST commands and ACL definitions. CVSS 5.5 (Moderate). Same affected versions as CVE-2024-31449. Service availability impact only - no data corruption or RCE.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://redis.io/blog/security-advisory-cve-2024-31449-cve-2024-31227-cve-2024-31228/'
),
(
    'CVE-2024-31227: Denial-of-service via malformed ACL selectors',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade Redis OSS/CE/Stack to 7.4.1+ or 7.2.6+ with ACL selector validation fix", "percentage": 95, "note": "Patch validates ACL selector syntax to prevent panic"},
        {"solution": "Review all ACL configurations for malformed selector syntax", "percentage": 90, "command": "ACL LIST | grep selector"},
        {"solution": "Restrict ACL management permissions to trusted administrators only", "percentage": 85, "command": "ACL SETUSER admin on >password +@all +acl"},
        {"solution": "Implement ACL configuration validation in CI/CD before deployment", "percentage": 80, "note": "Test ACL changes in staging environment first"},
        {"solution": "Monitor Redis for unexpected panics and crashes", "percentage": 75, "note": "Set up alerting for Redis process restarts"}
    ]'::jsonb,
    'Redis 7.0.0+ with ACL support, Users with sufficient privileges to create ACL rules, ACL selectors in use',
    'Redis upgraded to 7.4.1+ or 7.2.6+, ACL configurations validated and tested, ACL management restricted to admins, No server panics in logs',
    'Authenticated user with sufficient privileges can create malformed ACL selector triggering server panic and DoS. CVSS 4.4 (Moderate). Introduced in Redis 7.0 with ACL selectors feature. Redis Software (Enterprise) reports no exposure. Only affects OSS/CE/Stack versions before 7.4.1 or 7.2.6. Requires elevated privileges to exploit. Related to CVE-2024-31449 and CVE-2024-31228.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://redis.io/blog/security-advisory-cve-2024-31449-cve-2024-31227-cve-2024-31228/'
),
(
    'CVE-2021-32675: Denial-of-service via RESP request memory exhaustion',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade to Redis 6.2.6, 6.0.16, or 5.0.14 containing CVE-2021-32675 fix", "percentage": 95, "note": "Patch limits memory allocation based on user-specified values"},
        {"solution": "Configure maxmemory limit to prevent memory exhaustion attacks", "percentage": 90, "command": "CONFIG SET maxmemory 2gb; CONFIG SET maxmemory-policy allkeys-lru"},
        {"solution": "Enable protected mode to require authentication for all connections", "percentage": 90, "command": "CONFIG SET protected-mode yes"},
        {"solution": "Implement firewall rules to restrict Redis access to trusted networks only", "percentage": 85, "note": "Prevent unauthenticated attacker access"},
        {"solution": "Monitor memory usage and set alerts for abnormal spikes", "percentage": 80, "command": "INFO memory | grep used_memory_human"}
    ]'::jsonb,
    'Redis version prior to 6.2.6, 6.0.16, or 5.0.14, Network access to Redis instance, Unauthenticated or authenticated attacker',
    'Redis upgraded to patched version (6.2.6+, 6.0.16+, or 5.0.14+), maxmemory configured and enforced, Protected mode enabled, Network access restricted, Memory monitoring active',
    'RESP (Redis Standard Protocol) parsing allocates memory according to user-specified values. Attackers can deliver crafted requests over multiple connections causing significant memory allocation. Can be exploited by UNAUTHENTICATED users. DoS vulnerability affecting availability. Configure network isolation and authentication as defense-in-depth. Related to CVE-2021-32687, CVE-2021-32626, CVE-2021-32627, CVE-2021-32628.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/cve-2021-32675'
),
(
    'CVE-2021-32687: Integer overflow in intsets causing heap buffer overflow',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade to Redis 6.2.6+ containing CVE-2021-32687 intset overflow fix", "percentage": 95, "note": "Patch validates set-max-intset-entries configuration"},
        {"solution": "Review and reset set-max-intset-entries to default value if manually configured", "percentage": 90, "command": "CONFIG GET set-max-intset-entries; CONFIG SET set-max-intset-entries 512"},
        {"solution": "Restrict authenticated user access to trusted clients only", "percentage": 85, "note": "Prevent malicious data injection"},
        {"solution": "Enable Redis authentication and use strong passwords", "percentage": 80, "command": "CONFIG SET requirepass strongpassword123"},
        {"solution": "Monitor for unusual intset operations or configuration changes", "percentage": 75, "note": "Set up audit logging for CONFIG commands"}
    ]'::jsonb,
    'Redis 5.0.0 through 6.2.5, set-max-intset-entries configured to non-default large value, Authenticated remote attacker access',
    'Redis upgraded to 6.2.6 or later, set-max-intset-entries at safe default (512), Authentication enabled with strong password, No suspicious intset operations in logs',
    'Integer to heap buffer overflow when set-max-intset-entries manually configured to very large non-default value. Remote attacker can pass specially crafted data triggering integer overflow and executing arbitrary code. Potential complete system compromise. High/Important security impact. Fixed in Redis 6.2.6+. Part of July 2021 security advisory with CVE-2021-32675 and others.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/cve-2021-32687'
),
(
    'CVE-2021-32626: Lua heap-based stack overflow leading to heap corruption',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade to Redis 6.2.6, 6.0.16, or 5.0.14 with Lua stack overflow fix", "percentage": 95, "note": "Patch prevents heap-based Lua stack overflow"},
        {"solution": "Restrict Lua script execution to trusted administrators via ACL", "percentage": 90, "command": "ACL SETUSER app -@scripting -eval -evalsha -script|*"},
        {"solution": "Audit and review all Lua scripts for potential stack overflow triggers", "percentage": 85, "note": "Identify and remove deeply recursive scripts"},
        {"solution": "Disable Lua scripting if not required for application", "percentage": 80, "command": "rename-command EVAL \"\" in redis.conf"},
        {"solution": "Monitor Redis memory and CPU for anomalies indicating exploitation", "percentage": 75, "note": "Set up alerts for unusual resource consumption"}
    ]'::jsonb,
    'Redis version with Lua scripting support (prior to 6.2.6, 6.0.16, 5.0.14), Authenticated user with script execution permissions',
    'Redis upgraded to patched version (6.2.6+, 6.0.16+, or 5.0.14+), Lua script execution restricted to admins, Script audit completed, No heap corruption events detected',
    'Specially crafted Lua scripts can cause heap-based Lua stack to overflow resulting in heap corruption and potentially RCE. Requires authentication and script execution privileges. Discovered by Meir Shpilraien. Part of July 2021 security update addressing multiple vulnerabilities. Related to CVE-2021-32627 and CVE-2021-32628 also affecting Lua/data structures.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://access.redhat.com/errata/RHSA-2021:3873'
),
(
    'CVE-2021-32627: Integer overflow in streams causing heap buffer overflow',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade to Redis 6.2.6, 6.0.16, or 5.0.14 containing streams integer overflow fix", "percentage": 95, "note": "Patch for proto-max-bulk-len and client-query-buffer-limit overflow"},
        {"solution": "Review and reset proto-max-bulk-len to default value (512mb) if customized", "percentage": 90, "command": "CONFIG GET proto-max-bulk-len; CONFIG SET proto-max-bulk-len 536870912"},
        {"solution": "Review and reset client-query-buffer-limit to safe value", "percentage": 90, "command": "CONFIG GET client-query-buffer-limit; CONFIG SET client-query-buffer-limit 1073741824"},
        {"solution": "Restrict access to Redis streams to trusted authenticated users", "percentage": 85, "note": "Use ACL to control stream command access"},
        {"solution": "Monitor stream operations for unusual sizes or patterns", "percentage": 80, "note": "Enable slowlog for stream commands"}
    ]'::jsonb,
    'Redis 5.0 or newer (before 6.2.6, 6.0.16, 5.0.14), proto-max-bulk-len and client-query-buffer-limit configured to non-default large values',
    'Redis upgraded to 6.2.6+, 6.0.16+, or 5.0.14+, Configuration values at safe defaults, Stream access restricted, No heap corruption detected',
    'Integer overflow in Redis 5.0+ exploitable to corrupt heap and potentially achieve RCE. Integer to heap buffer overflow issue with streams when configuring large non-default values for proto-max-bulk-len AND client-query-buffer-limit. Discovered by sundb. Part of July 2021 security advisory. Related to CVE-2021-32628 (ziplist) and CVE-2021-32626 (Lua).',
    0.95,
    'sonnet-4',
    NOW(),
    'https://access.redhat.com/errata/RHSA-2021:3873'
);
