-- Add Cloudflare incident postmortems - Batch 1
-- Category: Incident Postmortem (BGP routing, DNS resolution, WAF, Workers, CDN)
-- Extracted: 2025-11-24
-- Source: Cloudflare Blog official incident reports

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'BGP route hijack incident: AS announces more specific prefix causing traffic blackhole',
    'incident-postmortem',
    'MEDIUM',
    '[
        {"solution": "Implement RPKI Route Origin Validation (ROV) to reject RPKI-invalid announcements", "percentage": 92, "note": "ROV deployment at 50% adoption prevents unauthorized origin AS"},
        {"solution": "Filter IPv4 prefixes longer than /24 in Default-Free Zone per MANRS guidelines", "percentage": 90, "note": "Prevents longest-prefix-match hijacks via /32 announcements"},
        {"solution": "Deploy Autonomous System Provider Authorization (ASPA) objects to validate AS paths", "percentage": 88, "note": "Prevents unauthorized upstream propagation"},
        {"solution": "Monitor BGP announcements via BGP Monitoring Protocol (BMP) for unexpected route changes", "percentage": 85, "note": "Real-time detection of prefix hijacks"},
        {"solution": "Implement Discard Origin Authorization (DOA) to prevent unauthorized RTBH blackholing", "percentage": 87, "note": "Blocks Tier-1 acceptance of blackhole routes from unauthorized parties"}
    ]'::jsonb,
    'RPKI ROAs configured, BGP monitoring infrastructure, AS-SET filtering policies',
    'No RPKI-invalid routes accepted, BGP announcements match ROA policies, Traffic routes correctly',
    'RPKI-invalid routes can be accepted by networks without ROV enabled. /32 announcements preferred via longest-prefix matching. RTBH routes from unauthorized sources cause blackholing.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/cloudflare-1111-incident-on-june-27-2024/'
),
(
    'BGP route leak incident: AS leaks customer routes upstream to transit provider',
    'incident-postmortem',
    'MEDIUM',
    '[
        {"solution": "Implement RFC9234 Only-To-Customer (OTC) BGP attribute to prevent upstream leaks", "percentage": 90, "note": "Marks routes that should not be advertised upstream"},
        {"solution": "Deploy strict AS-SET filtering on customer BGP sessions", "percentage": 88, "note": "Reject announcements not in customer AS-SET"},
        {"solution": "Monitor for unexpected route propagation via route server visibility", "percentage": 85, "note": "Detect when customer routes appear in upstream peers"},
        {"solution": "Disable BGP sessions at peering locations with leaking AS", "percentage": 92, "note": "Immediate mitigation to stop leak propagation"},
        {"solution": "Implement prefix filtering - only accept customer-owned prefixes", "percentage": 95, "note": "Prevents redistribution of third-party routes"}
    ]'::jsonb,
    'BGP filtering policies configured, AS-SET definitions maintained, Route monitoring enabled',
    'Customer routes not visible upstream, BGP sessions stable, No unexpected prefix advertisements',
    'Route leaks occur when provider fails to filter customer announcements. Tier-1 acceptance of leaked routes causes global propagation. Loose filtering on customer sessions root cause.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/cloudflare-1111-incident-on-june-27-2024/'
),
(
    'BGP policy misconfiguration: Route policy term reordering causes prefix withdrawal',
    'incident-postmortem',
    'HIGH',
    '[
        {"solution": "Implement automated commit-confirm rollback mechanisms for BGP changes", "percentage": 95, "note": "Auto-rollback if health checks fail post-deployment"},
        {"solution": "Test BGP policy changes in staging with identical Multi-Colo PoP configuration", "percentage": 92, "note": "Catch reordering issues before production"},
        {"solution": "Use granular rollout staging - deploy to 1-2 data centers before global", "percentage": 90, "note": "Limits blast radius of misconfigurations"},
        {"solution": "Architect policy statements to prevent unintended term reordering", "percentage": 88, "note": "Place REJECT-THE-REST clauses explicitly at end"},
        {"solution": "Monitor site-local prefix announcements - alert if withdrawn unexpectedly", "percentage": 87, "note": "Detect prefix withdrawal within seconds"}
    ]'::jsonb,
    'BGP policy testing environment, Automated rollback capabilities, Prefix monitoring alerts',
    'Site-local prefixes remain announced, BGP policies apply in correct order, Traffic routes normally',
    'Policy term reordering moves ADV-SITE-LOCALS behind REJECT-THE-REST causing withdrawal. 4% of network handling 50% of traffic = massive impact. Multimog load balancer fails when site-locals withdrawn.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/cloudflare-outage-on-june-21-2022/'
),
(
    'WAF rule deployment: Regex CPU exhaustion causing global outage',
    'incident-postmortem',
    'VERY_HIGH',
    '[
        {"solution": "Implement progressive WAF rule rollout - deploy to subset of DCs before global", "percentage": 95, "note": "Prevents global CPU exhaustion from bad regex"},
        {"solution": "Add pre-deployment CPU profiling tests for regex patterns", "percentage": 92, "note": "Catch CPU-intensive regex before production"},
        {"solution": "Set CPU resource limits per WAF rule execution", "percentage": 90, "note": "Prevent single rule from consuming 100% CPU"},
        {"solution": "Monitor CPU utilization per WAF rule - alert if >20% for single rule", "percentage": 88, "note": "Detect CPU exhaustion early"},
        {"solution": "Implement global WAF ruleset termination kill switch", "percentage": 93, "note": "Immediate recovery mechanism used at 1409 UTC"}
    ]'::jsonb,
    'WAF ruleset testing environment, CPU monitoring per rule, Progressive deployment capability',
    'CPU utilization stays below 80%, WAF rules execute within time limits, No 502 errors',
    'Regex with catastrophic backtracking causes 100% CPU globally. Deploying rules globally in one go = no gradual detection. Traffic drop of 82% at peak impact.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/cloudflare-outage/'
),
(
    'Workers KV outage: Third-party storage provider failure affecting cold reads',
    'incident-postmortem',
    'VERY_HIGH',
    '[
        {"solution": "Implement multi-provider redundancy for Workers KV backing datastores", "percentage": 95, "note": "Remove single cloud provider dependency"},
        {"solution": "Build product-level resiliency to survive backing storage failures", "percentage": 92, "note": "Graceful degradation when KV unavailable"},
        {"solution": "Deploy progressive namespace re-enabling tooling during recovery", "percentage": 88, "note": "Controlled recovery prevents thundering herd"},
        {"solution": "Implement kill switches for identity-dependent features (Turnstile, Gateway)", "percentage": 90, "note": "Prevent blocking users when KV fails"},
        {"solution": "Monitor KV error rates across all dependent services - alert at 1% failure", "percentage": 87, "note": "25+ services depend on KV"}
    ]'::jsonb,
    'Multi-provider storage configuration, Service degradation policies, KV dependency mapping',
    'KV cold reads succeed, Dependent services operational, No identity authentication failures',
    'Third-party storage outage = 2.5 hour total outage. 100% failure for identity-based auth. Gap in migration coverage exposed during provider incident.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/cloudflare-service-outage-june-12-2025/'
),
(
    'Workers KV deployment: Misconfigured deployment tool pointing to non-existent version',
    'incident-postmortem',
    'HIGH',
    '[
        {"solution": "Add pre-deployment validation checks confirming target version exists in environment", "percentage": 95, "note": "Prevent pointing to non-running versions"},
        {"solution": "Harden deployment tools for multi-tenancy - separate staging and production release lists", "percentage": 92, "note": "Latent bug returned both environments together"},
        {"solution": "Ensure rollback processes work when Access service is unavailable", "percentage": 90, "note": "Break-glass mechanisms must bypass Auth dependencies"},
        {"solution": "Migrate to standardized Workers deployment models with built-in validation", "percentage": 88, "note": "Avoid custom deployment tooling"},
        {"solution": "Verify deployments match their intended environment post-deployment", "percentage": 87, "note": "Automated verification prevents environment mismatch"}
    ]'::jsonb,
    'Deployment tool with environment separation, Pre-deployment validation, Break-glass rollback access',
    'Deployments target correct environment, No HTTP 401 errors from KV, All dependent services operational',
    'Deployment tool returned staging + production releases together. Production pointed to version not authorized for prod = HTTP 401. 37 minute outage affecting 10+ services.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/cloudflare-incident-on-october-30-2023/'
),
(
    'DNS DNSSEC failure: Expired root zone signatures causing SERVFAIL responses',
    'incident-postmortem',
    'HIGH',
    '[
        {"solution": "Add monitoring alerts when static_zone serves stale root zone file (>24 hours old)", "percentage": 95, "note": "DNSSEC signatures from Sept 21 expired Oct 4"},
        {"solution": "Implement graceful handling of unknown DNS record types - skip vs reject zone", "percentage": 92, "note": "ZONEMD record type caused parser error"},
        {"solution": "Update DNS parsing library to support new RR types per RFC specifications", "percentage": 90, "note": "static_zone parser lacked ZONEMD support"},
        {"solution": "Improve root zone data lifetime management per RFC 8806", "percentage": 88, "note": "Prevent serving expired DNSSEC signatures"},
        {"solution": "Monitor SERVFAIL response rates - alert when exceeding 5% baseline", "percentage": 87, "note": "Peaked at 15% during incident"}
    ]'::jsonb,
    'DNSSEC validation enabled, Root zone parsing infrastructure, SERVFAIL monitoring',
    'Root zone updates successfully, DNSSEC signatures valid, SERVFAIL rate below 3% baseline',
    'Parser rejected entire zone update when encountering unknown ZONEMD record. Served stale Sept 21 data until Oct 4 signature expiration. rec_disable_static tag not propagated to forwarded queries.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/1-1-1-1-lookup-failures-on-october-4th-2023/'
),
(
    'DNS DNSSEC failure: TLD nameserver returning expired DNSSEC signatures',
    'incident-postmortem',
    'MEDIUM',
    '[
        {"solution": "Monitor DNSSEC validation failure rates per TLD - alert at 1% threshold", "percentage": 92, "note": "7% of APAC queries failed for .com/.net"},
        {"solution": "Implement rerouting of DNS queries away from TLD servers with validation errors", "percentage": 90, "note": "Route to different geographic TLD nameservers"},
        {"solution": "Deploy redundant DNSSEC validation paths across multiple TLD server locations", "percentage": 88, "note": "Avoid single-location TLD dependencies"},
        {"solution": "Monitor for site migration events at TLD operators causing DNSSEC issues", "percentage": 85, "note": "Verisign lost management access during migration"},
        {"solution": "Escalate to TLD operator when validation errors exceed 5% for sustained period", "percentage": 87, "note": "Provider must fix root cause"}
    ]'::jsonb,
    'DNSSEC validation monitoring per TLD, Multi-location TLD server routing, Escalation procedures',
    'DNSSEC validation success rate >99%, Queries distributed across TLD locations, No expired signatures',
    'TLD site migration lost management access leaving peering router active. DNSSEC signatures began expiring on isolated location. CNAME records to .com/.net domains most affected.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/connection-errors-in-asia-pacific-region-on-july-9-2023/'
),
(
    'Control plane outage: Data center power failure causing analytics and API unavailability',
    'incident-postmortem',
    'HIGH',
    '[
        {"solution": "Implement geographic redundancy for control plane services - no single DC dependency", "percentage": 95, "note": "Analytics and logging exclusively in PDX-04"},
        {"solution": "Mandate high-availability cluster integration for all GA products", "percentage": 92, "note": "Kafka and ClickHouse had tight dependencies"},
        {"solution": "Deploy distributed network-first control plane architecture", "percentage": 90, "note": "Remove core data center dependencies"},
        {"solution": "Conduct comprehensive disaster recovery testing for all products", "percentage": 88, "note": "Newer products lacked DR procedures"},
        {"solution": "Implement automated failover to backup regions within 15 minutes", "percentage": 87, "note": "Manual failover to EU at 13:40 UTC took 2 hours"}
    ]'::jsonb,
    'Multi-region control plane deployment, HA cluster configuration, DR testing procedures',
    'Control plane accessible from all regions, Analytics data replicated, API responses normal',
    'Cascading power failure - utility maintenance + ground fault = simultaneous generator shutdown. 36-hour outage. Non-replicated datasets lost permanently.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/post-mortem-on-cloudflare-control-plane-and-analytics-outage/'
),
(
    'Bot Management outage: Database permissions change causing duplicate column metadata',
    'incident-postmortem',
    'VERY_HIGH',
    '[
        {"solution": "Filter ClickHouse query results by database name to prevent duplicate columns", "percentage": 95, "note": "Permissions change at 11:05 returned duplicates"},
        {"solution": "Harden ingestion of Cloudflare-generated config files like user input", "percentage": 92, "note": "Validate feature file size before loading"},
        {"solution": "Implement additional global kill switches for core proxy features", "percentage": 90, "note": "Bot Management lacks emergency disable"},
        {"solution": "Set configuration file size limits with graceful degradation vs panic", "percentage": 88, "note": "200 feature limit exceeded causing proxy panic"},
        {"solution": "Prevent error reports from overwhelming system resources during incidents", "percentage": 87, "note": "Status page coincidentally down delayed detection"}
    ]'::jsonb,
    'Database query result validation, Configuration file size limits, Feature kill switches',
    'Feature file generation succeeds, Config files within size limits, Core CDN operational',
    'Duplicate columns expanded config beyond 200-feature limit. Proxy panic on load = HTTP 5xx globally. Oscillating errors (good/bad config every 5 min) masked as DDoS.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/18-november-2025-outage/'
),
(
    'CDN Tiered Cache outage: Distributed tracing clearing control headers between cache tiers',
    'incident-postmortem',
    'HIGH',
    '[
        {"solution": "Preserve control headers when adding distributed tracing to inter-tier requests", "percentage": 95, "note": "Tracing module auto-cleared hostname headers"},
        {"solution": "Include larger data centers in earlier rollout stages to detect issues faster", "percentage": 92, "note": "Gradual rollout delayed detection"},
        {"solution": "Expand test coverage for all Tiered Cache topology configurations", "percentage": 90, "note": "Bug only triggered during upper-tier lookups"},
        {"solution": "Alert aggressively when critical control headers are missing from requests", "percentage": 88, "note": "Missing hostname caused DNS resolution failures"},
        {"solution": "Implement faster rollback triggers - automated rollback at 1% error threshold", "percentage": 87, "note": "Nearly 6 hour duration before rollback"}
    ]'::jsonb,
    'Inter-tier header preservation, Tiered Cache test environments, Error rate monitoring',
    'Cache tier communication succeeds, Control headers present, No HTTP 530 errors',
    'Control headers cleared = DNS failures for origin resolution. Only manifested for Tiered Cache, Images, Bandwidth Alliance. Local cache unaffected. Peaked at 5% of all requests.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/partial-cloudflare-outage-on-october-25-2022/'
),
(
    'Service token incident: Feature code overwriting token secrets with empty strings',
    'incident-postmortem',
    'HIGH',
    '[
        {"solution": "Implement database validation to reject empty strings for secret fields", "percentage": 95, "note": "Database lacked empty string validation"},
        {"solution": "Separate read and write data paths - do not reuse redacted read data for writes", "percentage": 92, "note": "Read redacted secret, wrote back empty value"},
        {"solution": "Add unit tests specifically for service token CRUD operations", "percentage": 90, "note": "Last seen at feature lacked token overwrite tests"},
        {"solution": "Monitor authentication failure spike rates - alert at 2x baseline", "percentage": 88, "note": "WARP posture uploads dropped to zero"},
        {"solution": "Implement automated alerts for service token modifications", "percentage": 87, "note": "Detect token secret changes within 1 minute"}
    ]'::jsonb,
    'Database field validation, Separate read/write data models, Service token monitoring',
    'Service tokens retain secrets after updates, Authentication success rate normal, No failed posture uploads',
    'Code read token with redacted secret, then wrote back without secret = empty string overwrite. 4 internal accounts affected. 121 minute outage. 50,000+ Gateway 5XX errors/min at peak.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://blog.cloudflare.com/cloudflare-incident-on-january-24th-2023/'
);
