-- Add MCP (Model Context Protocol) troubleshooting documentation batch 1
-- Source: Official MCP documentation and GitHub issues
-- Category: mcp-troubleshooting

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'MCP server transport closed unexpectedly',
    'mcp-troubleshooting',
    'VERY_HIGH',
    '[
        {"solution": "Check server stdout for log contamination - all logs must go to stderr only, not stdout. JSON-RPC messages on stdout must be clean and newline-delimited.", "percentage": 95, "note": "Most common cause of unexpected disconnections", "command": "Reconfigure logger to stderr: System.err.println() for logs, System.out.println() only for JSON"},
        {"solution": "Verify all JSON messages are complete and properly formatted with newline terminators after each message", "percentage": 90, "note": "Prevents Unexpected end of JSON input errors"},
        {"solution": "Run server manually with all required command arguments and verify it starts without crashing", "percentage": 85, "command": "mcp-server start --port 8080 --host localhost"},
        {"solution": "Check for port conflicts using lsof -i :PORT or netstat -an | grep :PORT and kill conflicting processes", "percentage": 80, "command": "kill $(lsof -t -i:8080)"}
    ]'::jsonb,
    'MCP server installed, Valid configuration file, Required dependencies present',
    'Server stays running without crashes, JSON messages parse successfully in client logs, No stdout contamination in server output',
    'Logging to stdout corrupts JSON-RPC stream. Always use stderr for logs. JSON must be newline-delimited. Check server logs before client logs.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://github.com/modelcontextprotocol/modelcontextprotocol/discussions/1231'
),
(
    'MCP Inspector SSE connection not established with stdio transport',
    'mcp-troubleshooting',
    'HIGH',
    '[
        {"solution": "Close all existing Inspector browser tabs and restart the dev server before opening a single new tab", "percentage": 90, "note": "Multiple tabs cause session conflicts in proxy server"},
        {"solution": "Use VS Code Simple Browser extension instead of Chrome/Edge to avoid browser caching issues", "percentage": 85, "note": "Reported to resolve all connection issues"},
        {"solution": "Clear browser cache and cookies for localhost:6274 before reconnecting", "percentage": 75, "note": "Browser caching can interfere with SSE connections"}
    ]'::jsonb,
    'MCP Inspector @0.10.2 or higher, Server using stdio transport, Node.js installed',
    'Inspector connects successfully, Server capabilities visible in UI, No Connection Error message',
    'Multiple browser tabs to same Inspector instance cause conflicts. Error message misleading - says SSE issue even when using stdio. Browser choice matters.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://github.com/modelcontextprotocol/python-sdk/issues/542'
),
(
    'MCP SSE connection failure: Not connected error',
    'mcp-troubleshooting',
    'HIGH',
    '[
        {"solution": "Ensure SSE transport initialization completes before attempting to send data - add connection state checks", "percentage": 85, "note": "Error thrown when send() called before connection established"},
        {"solution": "Verify Node.js version compatibility - upgrade to stable LTS version if using v23+ experimental builds", "percentage": 80, "note": "Issue reported on Node.js v23.11.0"},
        {"solution": "Check that SSE server endpoint is accessible: curl -I http://localhost:PORT/sse", "percentage": 75, "command": "curl -I http://localhost:8080/sse"}
    ]'::jsonb,
    'SSE transport configured, Server running, Network connectivity available',
    'MCP proxy completes Set up MCP Proxy stage, SSE endpoint returns 200 status, Connection established without errors',
    'Timing issues in SSE initialization can cause send() to be called too early. Windows 11 24H2 may have specific compatibility issues.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://github.com/modelcontextprotocol/python-sdk/issues/432'
),
(
    'MCP stdio vs SSE transport selection',
    'mcp-troubleshooting',
    'MEDIUM',
    '[
        {"solution": "Use stdio transport for traditional client-server apps and sandboxed environments - it creates secure 1:1 subprocess relationships", "percentage": 95, "note": "Recommended default per MCP specification"},
        {"solution": "Use SSE transport for cloud-based applications requiring multiple clients to access central server with proper authentication", "percentage": 85, "note": "Requires HTTPS and auth tokens for security"},
        {"solution": "For Claude Desktop, use stdio only - SSE not natively supported. Use mcp-proxy or Supergateway to wrap SSE over stdio if needed", "percentage": 80, "note": "Claude Desktop limitation"}
    ]'::jsonb,
    'Understanding of application architecture, Security requirements defined, Client capabilities known',
    'Transport choice matches use case, Connection establishes successfully, Security requirements met',
    'Claude Desktop does not support SSE natively. stdio launches subprocesses, cannot connect to existing processes. SSE has cross-origin security risks without proper auth.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://github.com/modelcontextprotocol/modelcontextprotocol/discussions/63'
),
(
    'MCP Inspector stdio transport ERR_CONNECTION_REFUSED on macOS',
    'mcp-troubleshooting',
    'HIGH',
    '[
        {"solution": "Understand that stdio transport cannot connect to already-running processes - it must spawn subprocesses. Start fresh server instance via Inspector.", "percentage": 95, "note": "Architectural limitation, not a bug"},
        {"solution": "Use explicit full path to Python binary and set PYTHONPATH environment variable when launching subprocess", "percentage": 90, "note": "Virtual environment fails to apply correctly in subprocess", "command": "PYTHONPATH=/path/to/venv /full/path/to/python server.py"},
        {"solution": "Consider using uv package manager as alternative which simplifies dependency management in subprocess context", "percentage": 80, "note": "Reduces virtual environment configuration issues"}
    ]'::jsonb,
    'Python virtual environment configured, Python binary path known, PYTHONPATH can be set',
    'Inspector successfully spawns subprocess, Server starts without connection errors, MCP messages exchanged successfully',
    'stdio transport spawns child processes, does not connect to existing ones. Python venv does not automatically apply in subprocess. Must use absolute paths.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://github.com/modelcontextprotocol/inspector/issues/106'
),
(
    'MCP invalid JSON syntax in Claude Desktop configuration',
    'mcp-troubleshooting',
    'HIGH',
    '[
        {"solution": "Remove all trailing commas from JSON configuration file - JSON spec does not allow trailing commas", "percentage": 95, "note": "Most common JSON syntax error"},
        {"solution": "Validate JSON syntax using online validator or jq command before saving config", "percentage": 90, "command": "cat claude_desktop_config.json | jq ."},
        {"solution": "Use absolute paths for server executables, not relative paths: /full/path/to/server.js or use npx with package names", "percentage": 85, "note": "Relative paths often fail to resolve"}
    ]'::jsonb,
    'Text editor that shows line numbers, Access to config file location, jq or JSON validator available',
    'Config file passes JSON validation, Claude Desktop loads servers without errors, MCP servers appear in Claude Desktop',
    'Trailing commas break JSON parsing. Paths must be absolute. Windows requires %APPDATA%, macOS uses ~/Library/Application Support, Linux uses ~/.config.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://mcp.harishgarg.com/learn/mcp-server-troubleshooting-guide-2025'
),
(
    'MCP Claude Desktop configuration file location',
    'mcp-troubleshooting',
    'MEDIUM',
    '[
        {"solution": "macOS: ~/Library/Application Support/Claude/claude_desktop_config.json", "percentage": 100, "note": "Official Claude Desktop config location on macOS"},
        {"solution": "Windows: %APPDATA%\\Claude\\claude_desktop_config.json", "percentage": 100, "note": "Official Claude Desktop config location on Windows"},
        {"solution": "Linux: ~/.config/claude/claude_desktop_config.json", "percentage": 100, "note": "Official Claude Desktop config location on Linux"}
    ]'::jsonb,
    'Claude Desktop installed, File system access, Text editor',
    'Config file exists at correct location, File is readable and writable, JSON is valid',
    'Path differs by OS. Use environment variables for Windows (%APPDATA%). Create directory if it does not exist.',
    1.0,
    'sonnet-4',
    NOW(),
    'https://mcp.harishgarg.com/learn/mcp-server-troubleshooting-guide-2025'
),
(
    'MCP server permission denied or execution errors',
    'mcp-troubleshooting',
    'MEDIUM',
    '[
        {"solution": "Make server executable with chmod +x on Unix systems", "percentage": 95, "command": "chmod +x mcp-server-executable && sudo chown $USER:$USER /path/to/mcp-server"},
        {"solution": "On Windows PowerShell, set execution policy: Set-ExecutionPolicy RemoteSigned -Scope CurrentUser", "percentage": 90, "command": "Set-ExecutionPolicy RemoteSigned -Scope CurrentUser"},
        {"solution": "Verify file ownership and permissions allow current user to execute", "percentage": 85, "command": "ls -la /path/to/mcp-server"}
    ]'::jsonb,
    'Administrative access (sudo for Unix, admin for Windows), Server file downloaded, Terminal access',
    'Server launches without permission errors, Process starts and stays running, No access denied in logs',
    'Windows requires execution policy change. Unix requires executable bit set. Ownership matters - must match running user.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://mcp.harishgarg.com/learn/mcp-server-troubleshooting-guide-2025'
),
(
    'MCP SSE firewall blocking connections',
    'mcp-troubleshooting',
    'MEDIUM',
    '[
        {"solution": "Allow port through firewall on Linux/Mac: sudo ufw allow PORT", "percentage": 90, "command": "sudo ufw allow 8080"},
        {"solution": "Bind server to 0.0.0.0 instead of 127.0.0.1 for external connections", "percentage": 85, "note": "127.0.0.1 only allows localhost connections"},
        {"solution": "Test network connectivity with curl or telnet: curl -I http://localhost:PORT/sse", "percentage": 80, "command": "curl -I http://localhost:8080/sse or telnet localhost 8080"}
    ]'::jsonb,
    'Administrative access for firewall changes, Server configured with correct host binding, Network tools installed',
    'curl/telnet successfully connects to SSE endpoint, No connection refused errors, SSE stream establishes',
    'Firewall rules differ by OS. 127.0.0.1 vs 0.0.0.0 binding matters for external access. Test connectivity before debugging code.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://mcp.harishgarg.com/learn/mcp-server-troubleshooting-guide-2025'
),
(
    'MCP tool definition not showing input parameters in Inspector',
    'mcp-troubleshooting',
    'MEDIUM',
    '[
        {"solution": "Include complete inputSchema in tool definition with type, properties, descriptions, and required fields array", "percentage": 95, "note": "Schema must follow JSON Schema specification"},
        {"solution": "Register tools using @server.call_tool() decorator with proper implementation and ensure server.run() is called", "percentage": 90, "note": "Python SDK specific registration pattern"},
        {"solution": "Validate tool schema against JSON Schema validator before testing in Inspector", "percentage": 80, "note": "Catches schema definition errors early"}
    ]'::jsonb,
    'MCP server running, Tools registered in code, Inspector connected successfully',
    'Tools appear in Inspector with input parameter fields, Parameters have correct types and descriptions, Tool execution succeeds',
    'inputSchema is required for parameters to appear. Must follow JSON Schema spec exactly. Required array must list mandatory fields.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://mcp.harishgarg.com/learn/mcp-server-troubleshooting-guide-2025'
),
(
    'MCP authentication errors: 401 Unauthorized or Invalid token',
    'mcp-troubleshooting',
    'HIGH',
    '[
        {"solution": "For Home Assistant MCP: Generate long-lived token in Profile â†’ Security and configure with token and URL parameters", "percentage": 95, "note": "Must use long-lived token, not temporary auth"},
        {"solution": "For GitHub MCP: Ensure token has required scopes (repo, read:org, workflow) using gh auth login", "percentage": 90, "command": "gh auth login"},
        {"solution": "Decode JWT to check expiration: echo TOKEN | cut -d. -f2 | base64 -d | jq .exp and implement refresh logic 5 minutes before expiry", "percentage": 85, "command": "echo TOKEN | cut -d. -f2 | base64 -d | jq .exp"}
    ]'::jsonb,
    'API credentials available, Token generation access, jq command installed for JWT decoding',
    'API returns 200 status instead of 401, Token validation succeeds, Operations execute without auth errors',
    'Token expiration often overlooked. GitHub scopes must be exact. Home Assistant requires long-lived tokens. Refresh before expiry, not after.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://mcp.harishgarg.com/learn/mcp-server-troubleshooting-guide-2025'
),
(
    'MCP debugging: Enable debug logging and monitoring',
    'mcp-troubleshooting',
    'MEDIUM',
    '[
        {"solution": "Enable MCP debug logging with environment variables", "percentage": 95, "command": "export MCP_DEBUG=1 && export MCP_LOG_LEVEL=debug"},
        {"solution": "Monitor server processes to ensure they stay running", "percentage": 90, "command": "ps aux | grep mcp-server"},
        {"solution": "Test endpoints manually with curl POST requests to verify server responses", "percentage": 85, "command": "curl -X POST http://localhost:8080/endpoint -H Content-Type: application/json -d {test:data}"}
    ]'::jsonb,
    'Terminal access, Environment variable support, curl or similar HTTP client installed',
    'Debug logs show detailed execution flow, Server process visible in ps output, Manual API calls return expected responses',
    'Debug logging can be verbose - use only during troubleshooting. Check both client and server logs. Server must stay running - check ps output.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://mcp.harishgarg.com/learn/mcp-server-troubleshooting-guide-2025'
);
