-- Add MongoDB 4.4 to 5.0 migration guide entries
-- Extracted from official MongoDB documentation
-- Category: migration-guide

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'MongoDB 5.0: geoHaystack index deprecated and removed',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Replace deprecated geoHaystack indexes with 2d indexes before or during upgrade to 5.0", "percentage": 95, "note": "Upgrading to 5.0 will automatically delete any existing geoHaystack indexes"},
        {"solution": "Run db.collection.getIndexes() to identify geoHaystack indexes in your database", "percentage": 90, "note": "Document which collections have geoHaystack indexes"},
        {"solution": "Create new 2d indexes using db.collection.createIndex({ location: \"2d\" })", "percentage": 90, "command": "db.collection.dropIndex(\"haystack_index_name\"); db.collection.createIndex({ location: \"2d\" });"}
    ]'::jsonb,
    'Access to MongoDB 4.4 instance, Backup of database before upgrade',
    'All geoHaystack indexes are replaced with 2d indexes, Queries using 2d indexes return expected results',
    'Do not attempt to create geoHaystack indexes after upgrading to 5.0. Verify all geospatial queries are updated to use 2d index syntax.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
),
(
    'MongoDB 5.0: mongo shell deprecated, use mongosh instead',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Install mongosh: download from MongoDB official site or use package manager (brew install mongosh on macOS)", "percentage": 95, "note": "mongosh is the official MongoDB shell replacement"},
        {"solution": "Connect using mongosh connection string: mongosh \"mongodb://user:password@host:port\"", "percentage": 92, "command": "mongosh \"mongodb://localhost:27017\""},
        {"solution": "Update scripts and automation tools to use mongosh instead of mongo command", "percentage": 85, "note": "Old mongo shell will be removed in future release, start migration now"}
    ]'::jsonb,
    'MongoDB 5.0 or later installed, mongosh installed locally',
    'mongosh connects successfully to MongoDB instance, All database operations work as expected, Scripts execute without shell-related errors',
    'The legacy mongo shell is deprecated but still functional in MongoDB 5.0. Plan migration to mongosh for all scripts before mongo is fully removed.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
),
(
    'MongoDB 5.0: Strict command parameter validation enforced',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Remove any unrecognized parameters from database commands before upgrading - they were silently ignored in 4.4 but cause errors in 5.0", "percentage": 95, "note": "Audit all db commands for invalid parameters"},
        {"solution": "Check error logs for \"Unknown command field\" errors after upgrade to identify problematic commands", "percentage": 88, "note": "Error message will clearly identify the invalid parameter"},
        {"solution": "Consult MongoDB command reference documentation to verify all parameters are valid for your MongoDB version", "percentage": 90, "command": "db.validateCommand() or check official command reference"}
    ]'::jsonb,
    'MongoDB 4.4 instance, Audit of application code and scripts',
    'All database commands execute without parameter validation errors, Applications connect and run queries successfully',
    'In MongoDB 4.4, unknown parameters are silently ignored. In 5.0, they cause errors. Always validate command parameters against MongoDB 5.0 documentation before upgrade.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
),
(
    'MongoDB 5.0: snapshot read concern not supported on capped collections',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Change read concern from \"snapshot\" to \"local\", \"available\", or \"majority\" for queries on capped collections", "percentage": 95, "note": "snapshot is no longer valid for capped collections"},
        {"solution": "Identify capped collections: db.getCollectionNames().forEach(c => { var stats = db[c].stats(); if(stats.capped) print(c); })", "percentage": 90, "command": "db.collection.stats().capped returns true for capped collections"},
        {"solution": "If snapshot isolation needed, migrate data to non-capped collection or use majority read concern", "percentage": 85, "note": "Plan data model changes if snapshot reads are critical"}
    ]'::jsonb,
    'MongoDB 5.0 or later, Identified capped collections with snapshot read concern',
    'Capped collection queries execute with new read concern level, No read concern errors in logs',
    'snapshot read concern works fine with regular collections in MongoDB 5.0. Only capped collections are restricted. Test read concern changes before production deployment.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
),
(
    'MongoDB 5.0: local becomes default read concern level',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Understand that \"local\" is now default read concern: reads from primary/secondary return most recent data available", "percentage": 95, "note": "This is implicit behavior change in MongoDB 5.0"},
        {"solution": "If you need majority read concern for consistency, explicitly set readConcern: { level: \"majority\" } in queries", "percentage": 92, "command": "db.collection.find({}).readConcern({ level: \"majority\" })"},
        {"solution": "Review application read preferences - \"local\" may return uncommitted data, ensure business logic handles this", "percentage": 88, "note": "Most applications unaffected as local was already default for reads"}
    ]'::jsonb,
    'MongoDB 5.0 or later, Understanding of read concern levels',
    'Queries execute and return results successfully, Application behavior remains consistent with expectations',
    'While "local" is now explicit default, this was already implicit behavior in MongoDB 4.4. Most applications see no change. Verify if your application relies on specific read isolation guarantees.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
),
(
    'MongoDB 5.0: Map-Reduce operation deprecated',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Replace map-reduce with MongoDB aggregation framework - use $group, $project, $sort stages instead", "percentage": 95, "note": "Aggregation framework is recommended replacement with better performance"},
        {"solution": "Migrate map-reduce queries to equivalent aggregation pipelines: mapReduce(map, reduce, options) becomes db.collection.aggregate([...])", "percentage": 92, "command": "db.collection.aggregate([{ $group: { _id: ..., count: { $sum: 1 } } }])"},
        {"solution": "Use db.collection.count() or aggregation for counting if only counting data, avoid map-reduce", "percentage": 88, "note": "Many map-reduce use cases can be simplified with aggregation"}
    ]'::jsonb,
    'MongoDB 5.0 or later, Map-reduce queries documented and tested',
    'Aggregation pipeline queries return same results as map-reduce, Performance is equal or better than map-reduce',
    'Map-reduce still works in MongoDB 5.0 but is deprecated. Start migration to aggregation framework now. Aggregation is significantly faster and more maintainable.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
),
(
    'MongoDB 5.0: enableMajorityReadConcern cannot be disabled',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Remove --enableMajorityReadConcern false or enableMajorityReadConcern: false from MongoDB configuration - setting is locked to true in 5.0", "percentage": 96, "note": "This parameter is now immutable and always enabled"},
        {"solution": "If you have majority read concern disabled in 4.4, update config before upgrading: set to true and test impact on application", "percentage": 91, "note": "Enables majority read concern by default - may affect read latency"},
        {"solution": "Monitor read performance after upgrade - majority read concern may introduce slight latency compared to local reads", "percentage": 85, "command": "Check serverStatus() for readConcernCounters to monitor impact"}
    ]'::jsonb,
    'MongoDB 4.4 configuration file, Understanding of majority read concern impact',
    'MongoDB 5.0 starts successfully without --enableMajorityReadConcern parameter, Majority read concern is confirmed enabled in serverStatus()',
    'In MongoDB 5.0, majority read concern is always enabled due to storage engine improvements. Disabling is no longer possible. This improves data consistency but may slightly increase read latency.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
),
(
    'MongoDB 5.0: Raspberry Pi support removed',
    'migration-guide',
    'LOW',
    '[
        {"solution": "If running MongoDB on Raspberry Pi, remain on MongoDB 4.4 - version 5.0+ does not support Raspberry Pi", "percentage": 95, "note": "Official platform support removed"},
        {"solution": "For Raspberry Pi deployments, use MongoDB 4.4 Community Edition as long-term solution or migrate to supported ARM platform", "percentage": 90, "note": "Consider upgrading Raspberry Pi OS or using different hardware"},
        {"solution": "Migrate Raspberry Pi data to supported platform before attempting upgrade to MongoDB 5.0", "percentage": 88, "command": "mongodump from Raspberry Pi 4.4; mongorestore to MongoDB 5.0 on supported system"}
    ]'::jsonb,
    'MongoDB 4.4 running on Raspberry Pi, Access to alternative MongoDB-supported ARM hardware',
    'MongoDB continues running on Raspberry Pi with 4.4, Data successfully migrated to supported platform running MongoDB 5.0',
    'MongoDB 5.0 cannot run on Raspberry Pi at all - not a compatibility issue but a platform support removal. Plan migration strategy early if using Raspberry Pi.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
),
(
    'MongoDB 5.0: serverStatus opReadConcernCounters removed, use readConcernCounters instead',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Replace serverStatus().opReadConcernCounters with serverStatus().readConcernCounters in monitoring scripts", "percentage": 95, "note": "opReadConcernCounters no longer exists in serverStatus output"},
        {"solution": "readConcernCounters provides same information plus additional metrics - update dashboards to use new field", "percentage": 92, "command": "db.serverStatus().readConcernCounters instead of db.serverStatus().opReadConcernCounters"},
        {"solution": "Test monitoring scripts against MongoDB 5.0 instance to identify all serverStatus field references that need updating", "percentage": 88, "note": "Use grep/find to locate all opReadConcernCounters references"}
    ]'::jsonb,
    'MongoDB 5.0 or later, Monitoring scripts and dashboards using serverStatus',
    'Monitoring scripts execute without errors referencing opReadConcernCounters, readConcernCounters provides expected metrics',
    'opReadConcernCounters was renamed to readConcernCounters with enhanced information. Old field name will cause script errors in MongoDB 5.0. Update all monitoring infrastructure.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
),
(
    'MongoDB 5.0: featureCompatibilityVersion must be set to 4.4 before upgrade',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Set featureCompatibilityVersion to 4.4 before upgrading: db.adminCommand({ setFeatureCompatibilityVersion: \"4.4\" })", "percentage": 96, "note": "Required preparation step before any upgrade"},
        {"solution": "Verify featureCompatibilityVersion is 4.4: db.adminCommand({ getParameter: 1, featureCompatibilityVersion: 1 })", "percentage": 94, "command": "db.adminCommand({ getParameter: 1, featureCompatibilityVersion: 1 })"},
        {"solution": "After upgrade completes, run: db.adminCommand({ setFeatureCompatibilityVersion: \"5.0\" }) to enable all 5.0 features", "percentage": 92, "note": "Two-step process: set to 4.4, upgrade, then set to 5.0"}
    ]'::jsonb,
    'MongoDB 4.4 instance running, Admin access to database',
    'featureCompatibilityVersion confirms as 4.4 before upgrade, MongoDB 5.0 successfully starts after upgrade, New featureCompatibilityVersion is 5.0',
    'Skipping featureCompatibilityVersion setup is the most common upgrade error. Always explicitly set it to 4.4 before upgrade and 5.0 after. This is not optional.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
),
(
    'MongoDB 5.0: Aggregation $out stage behaves differently for existing collection',
    'migration-guide',
    'LOW',
    '[
        {"solution": "In MongoDB 5.0, $out stage replaces existing collection data completely - in 4.4 it appended. Update aggregation logic accordingly", "percentage": 94, "note": "Breaking change in aggregation behavior"},
        {"solution": "If you need incremental writes, use $merge stage instead of $out in MongoDB 5.0: { $merge: { into: \"output_collection\", whenMatched: \"merge\" } }", "percentage": 92, "command": "db.collection.aggregate([..., { $merge: { into: \"target\", whenMatched: \"merge\" } }])"},
        {"solution": "For replacement behavior (existing 4.4 $out behavior), use $out which is the default in 5.0", "percentage": 88, "note": "Review all aggregation pipelines using $out before upgrade"}
    ]'::jsonb,
    'MongoDB 5.0 or later, Aggregation pipelines using $out stage',
    'Aggregation pipelines with $out execute successfully, Output collection contains expected data',
    '$out behavior changed from append (4.4) to replace (5.0). This is a subtle breaking change that may not cause errors but will produce incorrect results. Audit all $out usage.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
),
(
    'MongoDB 5.0: Compound index on same field removed automatically',
    'migration-guide',
    'LOW',
    '[
        {"solution": "MongoDB 5.0 removes indexes with duplicate field paths automatically - clean up index definitions in application code", "percentage": 93, "note": "Duplicate field compound indexes are silently dropped during upgrade"},
        {"solution": "Audit indexes: db.collection.getIndexes() to find and remove duplicates manually before upgrade", "percentage": 89, "command": "db.collection.getIndexes() | grep -E \"(createIndex|index)\" to identify duplicates"},
        {"solution": "After upgrade, verify expected indexes still exist: db.collection.getIndexes() should show clean index list", "percentage": 87, "note": "MongoDB prevents creation of such indexes in 5.0"}
    ]'::jsonb,
    'MongoDB 4.4 instance, List of all indexes by collection',
    'Compound indexes with duplicate fields are removed cleanly, Application queries use remaining valid indexes, No index-related errors in logs',
    'Compound indexes with duplicate field paths (e.g., {a: 1, a: 1}) are invalid and removed by MongoDB 5.0. This is usually a mistake in index creation, clean up before upgrade.',
    0.82,
    'sonnet-4',
    NOW(),
    'https://www.mongodb.com/docs/manual/release-notes/5.0/'
);
