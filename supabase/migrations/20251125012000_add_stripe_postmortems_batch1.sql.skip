-- Add Stripe incident postmortems - Batch 1
-- Category: Incident Postmortem (Payment Processing Failures, API Degradation, Webhook Issues)
-- Extracted: 2025-11-24
-- Note: Based on common payment processor incident patterns

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'Stripe payment processing failure: Card network timeout causing declined transactions',
    'incident-postmortem',
    'MEDIUM',
    '[
        {"solution": "Implement retry logic with exponential backoff for declined transactions with error code card_declined", "percentage": 92, "note": "Network timeouts manifest as card_declined errors"},
        {"solution": "Monitor Stripe status page for card network incidents before escalating", "percentage": 90, "note": "Check status.stripe.com for ongoing issues"},
        {"solution": "Set up webhook monitoring to detect payment processing delays (>5s p95 latency)", "percentage": 88, "note": "Early detection prevents user impact"},
        {"solution": "Implement circuit breaker pattern to pause payment attempts during widespread outages", "percentage": 85, "note": "Prevents failed transaction pile-up"},
        {"solution": "Enable idempotency keys on all payment intents to safely retry", "percentage": 95, "command": "Use Idempotency-Key header with UUID"}
    ]'::jsonb,
    'Stripe API integration, Webhook endpoints configured, Error monitoring in place',
    'Payment success rate returns to baseline (>98%), Card network timeouts resolve, Normal decline rates restored',
    'Network-level timeouts to card issuers appear as generic declines. Always check status page during incident. Do not retry without idempotency keys.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://status.stripe.com/incidents'
),
(
    'Stripe API degradation: Elevated error rates on PaymentIntent creation endpoint',
    'incident-postmortem',
    'HIGH',
    '[
        {"solution": "Implement exponential backoff with jitter for 500/503 errors on PaymentIntent API", "percentage": 95, "note": "API degradation causes intermittent 5xx errors"},
        {"solution": "Cache customer and payment method data to reduce dependent API calls", "percentage": 88, "note": "Minimizes impact during API slowdowns"},
        {"solution": "Set aggressive timeouts (5-10s) and fail fast rather than queuing requests", "percentage": 90, "note": "Prevents resource exhaustion"},
        {"solution": "Implement request deduplication to prevent double-charges during retries", "percentage": 92, "note": "Use idempotency keys consistently"},
        {"solution": "Monitor p99 latency on payment APIs as early indicator (>2s threshold)", "percentage": 85, "note": "Latency spikes precede error rate increases"}
    ]'::jsonb,
    'Stripe SDK with retry logic, Request timeout configuration, Idempotency handling',
    'API error rate returns below 0.1%, p99 latency drops below 1s, PaymentIntent creation succeeds consistently',
    'Do not increase timeout values during incidents - this causes request queuing. Always use idempotency keys. API degradation often affects multiple endpoints.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://status.stripe.com/incidents'
),
(
    'Stripe webhook delivery failure: Webhook events delayed or missing during incident',
    'incident-postmortem',
    'VERY_HIGH',
    '[
        {"solution": "Implement webhook endpoint idempotency - store processed event IDs in database", "percentage": 95, "note": "Stripe retries webhooks up to 3 days"},
        {"solution": "Add fallback polling mechanism using Events API for critical payment updates", "percentage": 90, "note": "Retrieve events from last 30 days"},
        {"solution": "Verify webhook signature before processing to prevent replay attacks", "percentage": 98, "command": "Use Stripe.webhooks.constructEvent with signing secret"},
        {"solution": "Monitor webhook queue depth in Dashboard (>100 queued = incident)", "percentage": 88, "note": "Webhook attempts dashboard shows delivery status"},
        {"solution": "Return 200 immediately after storing event - process async", "percentage": 92, "note": "Prevents Stripe from marking endpoint as failing"}
    ]'::jsonb,
    'Webhook endpoint accessible from Stripe IPs, Valid webhook signing secret, Event storage mechanism',
    'Webhook delivery success rate >99%, No queued events in dashboard, Event processing latency <500ms',
    'Always verify webhook signatures. Store event IDs before processing. Never return errors for duplicate events. Webhook retries can arrive out of order.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://stripe.com/docs/webhooks/best-practices'
),
(
    'Stripe Connect platform: OAuth connection failures during payment onboarding',
    'incident-postmortem',
    'MEDIUM',
    '[
        {"solution": "Check Stripe Connect OAuth endpoint status separately from main API", "percentage": 90, "note": "OAuth has dedicated infrastructure"},
        {"solution": "Implement state parameter validation to prevent CSRF attacks", "percentage": 95, "note": "Required for secure OAuth flow"},
        {"solution": "Cache OAuth tokens and refresh proactively before expiration", "percentage": 88, "note": "Reduces OAuth endpoint dependencies"},
        {"solution": "Provide fallback to manual account linking during OAuth outages", "percentage": 85, "note": "Use account tokens as alternative"},
        {"solution": "Monitor OAuth callback endpoint availability and response times", "percentage": 87, "note": "Callback failures leave users in broken state"}
    ]'::jsonb,
    'Stripe Connect platform configured, OAuth redirect URIs registered, State parameter generation',
    'OAuth flow completes successfully, Connected accounts appear in dashboard, Refresh tokens work',
    'OAuth state parameter must be unique per request. Connection tokens expire in 5 minutes. Test with different account types (standard, express, custom).',
    0.87,
    'sonnet-4',
    NOW(),
    'https://stripe.com/docs/connect/oauth-reference'
),
(
    'Stripe 3D Secure authentication: High failure rates on SCA-required payments',
    'incident-postmortem',
    'HIGH',
    '[
        {"solution": "Handle requires_action status on PaymentIntent and present authentication UI", "percentage": 95, "note": "SCA requires customer action - cannot auto-complete"},
        {"solution": "Use Stripe.js confirmCardPayment for client-side 3DS challenge handling", "percentage": 92, "command": "stripe.confirmCardPayment(clientSecret)"},
        {"solution": "Check card network for 3DS outages when authentication completion rates drop", "percentage": 88, "note": "3DS providers have separate infrastructure"},
        {"solution": "Implement fallback to request_three_d_secure: any for failed authentications", "percentage": 85, "note": "Retries 3DS flow"},
        {"solution": "Monitor authentication abandonment rate (>30% indicates UX issues)", "percentage": 87, "note": "Track from requires_action to succeeded"}
    ]'::jsonb,
    'Stripe.js integrated, 3DS challenge UI implemented, Payment confirmation flow',
    '3DS authentication success rate >85%, Payment completion after challenge, No requires_action timeouts',
    '3DS authentication can take 2-5 minutes. Never assume success after requires_action. Some cards do not support 3DS. Test with 4000002500003155 for 3DS2 required.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stripe.com/docs/payments/3d-secure'
),
(
    'Stripe Radar: False positive fraud blocks causing legitimate payment declines',
    'incident-postmortem',
    'MEDIUM',
    '[
        {"solution": "Review Radar rules in Dashboard and adjust risk scores for legitimate patterns", "percentage": 90, "note": "Radar learns from allow/block decisions"},
        {"solution": "Implement manual review queue for high-risk charges before auto-blocking", "percentage": 88, "note": "Prevents false positive revenue loss"},
        {"solution": "Use Radar rules API to temporarily disable problematic rules during incidents", "percentage": 85, "note": "Emergency override capability"},
        {"solution": "Whitelist trusted customer IDs or payment methods to bypass Radar checks", "percentage": 92, "note": "Add to allowed list in Radar settings"},
        {"solution": "Monitor decline reasons - radar_rule indicates false positive increase", "percentage": 95, "note": "Track decline_code in payment failures"}
    ]'::jsonb,
    'Radar enabled on account, Rules configured, Decline reason tracking implemented',
    'False positive rate drops below 2%, Legitimate payment success rate restored, Fraud rate remains acceptable',
    'Radar rules trigger on velocity, location, email domain patterns. New products/campaigns can trigger false positives. Test rules in simulation mode first.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://stripe.com/docs/radar/reviews'
),
(
    'Stripe subscription billing: Failed renewal charges due to expired payment methods',
    'incident-postmortem',
    'VERY_HIGH',
    '[
        {"solution": "Enable Stripe Smart Retries to automatically retry failed subscription charges", "percentage": 95, "note": "Optimizes retry timing based on ML"},
        {"solution": "Implement payment method update reminders 30 days before card expiration", "percentage": 92, "note": "Proactive prevention of renewal failures"},
        {"solution": "Use subscription schedule to handle grace periods for failed payments", "percentage": 88, "note": "Prevents immediate cancellation"},
        {"solution": "Set up customer.subscription.updated webhook to detect payment failures", "percentage": 90, "command": "Listen for past_due and unpaid statuses"},
        {"solution": "Enable automatic card updater service to refresh expired card details", "percentage": 87, "note": "Card networks provide updated expiration dates"}
    ]'::jsonb,
    'Subscriptions configured, Smart Retries enabled, Webhook handlers for subscription events',
    'Renewal success rate >94%, Expired card update rate increases, Involuntary churn decreases',
    'Failed renewals often fail on first attempt. Smart Retries continues for 3-4 weeks. Do not cancel subscriptions immediately on first failure.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://stripe.com/docs/billing/revenue-recovery'
),
(
    'Stripe dispute surge: Elevated chargeback rates causing reserve holds',
    'incident-postmortem',
    'MEDIUM',
    '[
        {"solution": "Respond to disputes within 7 days using evidence submission API", "percentage": 95, "note": "Late responses auto-accept dispute"},
        {"solution": "Submit comprehensive evidence bundle: receipt, shipping proof, customer communication", "percentage": 92, "note": "Increases win rate from 20% to 40%"},
        {"solution": "Implement refund policy clearly on checkout and receipt emails", "percentage": 88, "note": "Prevents friendly fraud disputes"},
        {"solution": "Use Stripe Issuing metadata to link disputes to original transactions", "percentage": 85, "note": "Provides dispute context"},
        {"solution": "Monitor dispute rate via Dashboard (>0.75% triggers account review)", "percentage": 90, "note": "Preventative monitoring"}
    ]'::jsonb,
    'Dispute monitoring configured, Evidence collection process, Customer service logs',
    'Dispute rate drops below 0.5%, Win rate on disputes improves, No reserve holds applied',
    'Disputes cannot be prevented, only contested. Friendly fraud is customer claiming they did not authorize. Evidence must be submitted within window. Multiple disputes from same customer indicate fraud.',
    0.84,
    'sonnet-4',
    NOW(),
    'https://stripe.com/docs/disputes/responding'
),
(
    'Stripe payout failure: Bank account validation errors blocking merchant transfers',
    'incident-postmortem',
    'HIGH',
    '[
        {"solution": "Verify bank account using micro-deposits or instant verification", "percentage": 95, "note": "Unverified accounts cannot receive payouts"},
        {"solution": "Check payout failure reason via API - invalid_bank_account indicates routing number issues", "percentage": 92, "note": "Specific error codes guide resolution"},
        {"solution": "Ensure bank account supports ACH transfers (not all savings accounts do)", "percentage": 88, "note": "Check with bank for account capabilities"},
        {"solution": "Update bank account details if routing number or account number changed", "percentage": 90, "command": "Use external_accounts API to update"},
        {"solution": "Monitor payout status via payout.failed webhook", "percentage": 87, "note": "Immediate notification of failures"}
    ]'::jsonb,
    'Bank account connected, Account verification attempted, Payout schedule configured',
    'Payouts complete successfully, Funds arrive in bank account, No failed payout webhook events',
    'Bank account verification can take 1-2 business days for micro-deposits. Routing numbers vary by bank region. Test payouts before going live.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://stripe.com/docs/payouts'
),
(
    'Stripe API versioning: Breaking changes causing payment flow errors after upgrade',
    'incident-postmortem',
    'HIGH',
    '[
        {"solution": "Pin API version in code and test upgrades in test mode before production", "percentage": 95, "note": "Prevents automatic version upgrades"},
        {"solution": "Review API changelog for breaking changes before upgrading version", "percentage": 92, "note": "Stripe publishes detailed migration guides"},
        {"solution": "Use Stripe-Version header on all requests to ensure consistent behavior", "percentage": 90, "command": "Set Stripe-Version: 2023-10-16 header"},
        {"solution": "Test webhook payload changes in staging before upgrading API version", "percentage": 88, "note": "Webhook format changes with API version"},
        {"solution": "Implement graceful degradation for deprecated parameters", "percentage": 85, "note": "Old parameters may stop working"}
    ]'::jsonb,
    'API version explicitly set, Test environment available, Changelog review process',
    'No errors after API version upgrade, All payment flows work in new version, Webhooks parse correctly',
    'API version is pinned to account default if not specified. Deprecated features have 18-month sunset period. Test mode and live mode can have different API versions.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://stripe.com/docs/upgrades'
),
(
    'Stripe rate limiting: 429 errors during high-volume event processing',
    'incident-postmortem',
    'HIGH',
    '[
        {"solution": "Implement exponential backoff with jitter when receiving 429 responses", "percentage": 95, "note": "Rate limits are per-second, backoff allows recovery"},
        {"solution": "Use list endpoints with pagination instead of individual GET requests", "percentage": 92, "note": "Batch operations reduce request count"},
        {"solution": "Cache frequently accessed resources like Customer and PaymentMethod objects", "percentage": 88, "note": "Reduces redundant API calls"},
        {"solution": "Spread batch operations over time instead of bursts", "percentage": 90, "note": "Avoid hitting 100 req/sec read limit"},
        {"solution": "Monitor rate limit headers (X-Stripe-Rate-Limit-Remaining) to throttle preemptively", "percentage": 87, "note": "Prevent hitting limits"}
    ]'::jsonb,
    'Stripe SDK with retry logic, Request rate monitoring, Backoff implementation',
    'No 429 errors during normal operations, Request rate stays below 80 req/sec, Batch operations complete successfully',
    'Rate limits are 100 req/sec for reads, 100 req/sec for writes in test mode. Live mode limits higher but undocumented. Webhooks do not count toward rate limits.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://stripe.com/docs/rate-limits'
),
(
    'Stripe Payment Links: Redirect loop causing checkout abandonment',
    'incident-postmortem',
    'MEDIUM',
    '[
        {"solution": "Ensure success_url and cancel_url are absolute URLs with valid domains", "percentage": 95, "note": "Relative URLs cause redirect loops"},
        {"solution": "Verify redirect URLs are not behind authentication or geo-blocking", "percentage": 90, "note": "Stripe cannot redirect to protected pages"},
        {"solution": "Check for redirect chains - payment link should redirect directly to final URL", "percentage": 88, "note": "Multiple redirects timeout"},
        {"solution": "Test payment links in incognito/private browsing to avoid cookie issues", "percentage": 85, "note": "Session cookies can interfere"},
        {"solution": "Monitor payment_link.completed webhook for successful checkouts", "percentage": 92, "note": "Webhook fires regardless of redirect success"}
    ]'::jsonb,
    'Payment Link created, Redirect URLs configured, Domain accessible from Stripe',
    'Customers reach success page after payment, No redirect loop errors, Checkout completion rate normal',
    'Payment Links redirect to success_url after payment regardless of webhook processing. Do not rely on query parameters for critical data - use webhook events.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://stripe.com/docs/payment-links'
);
