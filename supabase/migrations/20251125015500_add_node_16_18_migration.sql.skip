-- Add Node.js 16â†’18 migration guide entries
-- Focus: OpenSSL 3.0, fetch API, V8 10.1, crypto deprecations, DNS changes, HTTP defaults
-- Source: https://nodejs.org/en/blog/release/v18.0.0, v17.0.0
-- Extracted: 2025-11-24

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'Node.js 18 ERR_OSSL_EVP_UNSUPPORTED after upgrading from Node 16',
    'nodejs-migration',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade dependencies to versions compatible with OpenSSL 3.0 - webpack 5.62.2+, babel-loader 8.3.0+", "percentage": 90, "note": "Root cause solution - update packages using legacy crypto"},
        {"solution": "Temporary workaround: Set NODE_OPTIONS=--openssl-legacy-provider environment variable", "percentage": 85, "command": "export NODE_OPTIONS=--openssl-legacy-provider", "note": "Reverts to legacy provider but reduces security"},
        {"solution": "Add legacy provider flag to package.json scripts: node --openssl-legacy-provider script.js", "percentage": 83, "note": "Per-script configuration"},
        {"solution": "Identify specific package causing issue and update it: npm list | grep <package>", "percentage": 80, "command": "npm outdated", "note": "Find outdated dependencies"}
    ]'::jsonb,
    'Node.js 18 installed, npm/package.json available, Build tools configured',
    'Application builds/runs without ERR_OSSL_EVP_UNSUPPORTED, No OpenSSL errors, Crypto operations succeed',
    'Legacy provider flag weakens security - only use temporarily. Common in webpack 4.x and older build tools. OpenSSL 3.0 disables MD4, DES, RC2, and weak key sizes by default.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v18.0.0'
),
(
    'Node.js 18 experimental fetch API warning or conflicts',
    'nodejs-migration',
    'HIGH',
    '[
        {"solution": "Disable global fetch with --no-experimental-fetch flag if conflicts with polyfills", "percentage": 88, "command": "node --no-experimental-fetch app.js", "note": "Removes native fetch from global scope"},
        {"solution": "Remove node-fetch polyfill if using native fetch - conflicts cause issues", "percentage": 92, "note": "Native fetch available in Node 18+"},
        {"solution": "Update code to use native fetch instead of axios/node-fetch for better performance", "percentage": 85, "note": "Fetch is stable in Node 18.17+"},
        {"solution": "Suppress experimental warning: NODE_NO_WARNINGS=1 or --no-warnings flag", "percentage": 80, "command": "export NODE_NO_WARNINGS=1", "note": "Hides warnings but fetch still experimental in 18.0-18.16"}
    ]'::jsonb,
    'Node.js 18+ installed, Application uses HTTP requests',
    'No fetch conflicts, HTTP requests work, No experimental warnings in production builds',
    'Native fetch is experimental in Node 18.0-18.16, stable in 18.17+. Conflicts with existing fetch polyfills like node-fetch or whatwg-fetch. Global fetch includes FormData, Headers, Request, Response.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v18.0.0'
),
(
    'Node.js 18 V8 serialization format breaks compatibility with Node 16/17',
    'nodejs-migration',
    'MEDIUM',
    '[
        {"solution": "Do not share v8.serialize() data between Node 18 and older versions - use JSON instead", "percentage": 93, "note": "V8 9.9+ uses format version 14, incompatible with older versions"},
        {"solution": "Implement fallback deserialization with try/catch and JSON.parse as backup", "percentage": 88, "command": "try { v8.deserialize(data) } catch { JSON.parse(data) }", "note": "Graceful degradation"},
        {"solution": "Version your serialized data and use appropriate deserializer per version", "percentage": 85, "note": "Add metadata indicating serialization format"},
        {"solution": "Upgrade all systems to Node 18+ if sharing serialized data", "percentage": 90, "note": "Ensures consistent serialization format"}
    ]'::jsonb,
    'Systems sharing serialized data, v8.serialize/deserialize usage, Multiple Node versions',
    'Deserialization succeeds across systems, No version mismatch errors, Data integrity maintained',
    'Node 18 can deserialize Node 16 data, but Node 16 cannot deserialize Node 18 data. Only affects v8.serialize/deserialize, not JSON. IPC and cluster messaging affected.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v18.0.0'
),
(
    'Node.js 18 dns.lookup() returns IPv6 addresses first breaking IPv4 connections',
    'nodejs-migration',
    'HIGH',
    '[
        {"solution": "Use --dns-result-order=ipv4first CLI flag to restore Node 16 behavior", "percentage": 92, "command": "node --dns-result-order=ipv4first app.js", "note": "Process-wide configuration"},
        {"solution": "Set default order programmatically: dns.setDefaultResultOrder(''ipv4first'')", "percentage": 90, "command": "require(''dns'').setDefaultResultOrder(''ipv4first'')", "note": "Per-application setting"},
        {"solution": "Use autoSelectFamily socket option for happy eyeballs algorithm", "percentage": 88, "command": "http.request(url, { autoSelectFamily: true })", "note": "Tries IPv4 and IPv6 until connection succeeds"},
        {"solution": "Specify order per lookup: dns.lookup(host, { order: ''ipv4first'' }, callback)", "percentage": 85, "note": "Per-request control"}
    ]'::jsonb,
    'Node.js 18+ installed, DNS resolution used, Network supports IPv4/IPv6',
    'Connections establish successfully, No ECONNREFUSED on localhost, Expected IP version used',
    'Default changed from ipv4first to verbatim in Node 17. Affects localhost resolution where OS may return ::1 (IPv6) before 127.0.0.1. verbatim parameter deprecated in favor of order.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v17.0.0'
),
(
    'Node.js 18 crypto.createCipher deprecated or removed',
    'nodejs-migration',
    'MEDIUM',
    '[
        {"solution": "Replace crypto.createCipher with crypto.createCipheriv using proper key derivation", "percentage": 95, "command": "const key = crypto.scryptSync(password, salt, 32); crypto.createCipheriv(''aes-256-cbc'', key, iv)", "note": "Use scrypt or pbkdf2 for key derivation"},
        {"solution": "Generate random IV for each encryption: crypto.randomBytes(16)", "percentage": 92, "command": "const iv = crypto.randomBytes(16)", "note": "Never reuse IVs with same key"},
        {"solution": "Use random salt for key derivation: crypto.randomBytes(32)", "percentage": 90, "note": "Salt prevents dictionary attacks"},
        {"solution": "Replace crypto.createDecipher with crypto.createDecipheriv using stored IV/salt", "percentage": 93, "note": "Store IV with ciphertext, salt separately"}
    ]'::jsonb,
    'Node.js 18+ installed, Encryption/decryption code, crypto module available',
    'Encryption/decryption succeeds, No deprecation warnings, Secure key derivation used',
    'createCipher uses weak MD5 KDF with no salt. Replaced by createCipheriv which requires explicit IV and key. Old encrypted data must be decrypted with legacy method and re-encrypted.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/api/crypto.html'
),
(
    'Node.js 18 fs.write and fs.writeFileSync string coercion deprecated',
    'nodejs-migration',
    'MEDIUM',
    '[
        {"solution": "Explicitly convert objects to strings: fs.writeFileSync(path, String(obj))", "percentage": 93, "note": "Manual string conversion required"},
        {"solution": "Use JSON.stringify for objects: fs.writeFileSync(path, JSON.stringify(obj))", "percentage": 95, "command": "fs.writeFileSync(path, JSON.stringify(obj, null, 2))", "note": "Proper object serialization"},
        {"solution": "Validate input type before writing: if (typeof data !== ''string'') data = String(data)", "percentage": 88, "note": "Type checking prevents errors"},
        {"solution": "Update code to only pass strings or buffers to fs.write methods", "percentage": 90, "note": "Follows new strict typing"}
    ]'::jsonb,
    'Node.js 18+ installed, File writing code, fs module usage',
    'File writes succeed without deprecation warnings, Data written correctly, Type errors caught early',
    'Runtime deprecation in Node 18 (DEP0162), removed in Node 20. Affects objects with custom toString methods. Implicit coercion can hide bugs.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v18.0.0'
),
(
    'Node.js 18 HTTP connections slower or behave differently',
    'nodejs-migration',
    'MEDIUM',
    '[
        {"solution": "TCP noDelay now enabled by default - disable if needed: socket.setNoDelay(false)", "percentage": 85, "command": "server.on(''connection'', socket => socket.setNoDelay(false))", "note": "Nagle''s algorithm now disabled by default"},
        {"solution": "New timeout defaults: headersTimeout=60s, requestTimeout=300s - adjust if needed", "percentage": 88, "command": "server.headersTimeout = 120000; server.requestTimeout = 600000", "note": "Server responds with 408 if exceeded"},
        {"solution": "Enable HTTP keep-alive for connection pooling: new http.Agent({ keepAlive: true })", "percentage": 90, "command": "const agent = new http.Agent({ keepAlive: true, maxSockets: 50 })", "note": "Reuses connections, reduces overhead"},
        {"solution": "Monitor server.timeout separate from request timeout - both affect connection lifecycle", "percentage": 82, "note": "server.timeout is idle timeout, requestTimeout is total request time"}
    ]'::jsonb,
    'Node.js 18+ installed, HTTP server or client, Network configuration',
    'HTTP performance acceptable, Timeouts configured appropriately, Connections stable',
    'noDelay disables Nagle''s algorithm (reduces latency, may increase bandwidth). Timeout changes can break long-running requests. keepAlive is connection pooling, not TCP keep-alive.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v18.0.0'
),
(
    'Node.js 18 stream behavior changes breaking existing code',
    'nodejs-migration',
    'MEDIUM',
    '[
        {"solution": "Remove listeners for ''data'' events after ''error'' or ''close'' - no longer emitted", "percentage": 90, "note": "Streams now stop emitting after error/close"},
        {"solution": "Update error handling: stream.finished() now properly errors on errored streams", "percentage": 88, "command": "finished(stream, err => { if (err) handle(err) })", "note": "More reliable error detection"},
        {"solution": "Wrap Readable async iterator in try/catch for premature close errors", "percentage": 85, "command": "try { for await (const chunk of stream) {} } catch (err) {}", "note": "Premature close now throws"},
        {"solution": "Check stream.destroyed before reading to avoid errors", "percentage": 82, "note": "Destroyed streams no longer emit data"}
    ]'::jsonb,
    'Node.js 18+ installed, Stream-based code, Error handling in place',
    'Streams behave as expected, No unexpected errors, Proper cleanup occurs',
    'Breaking changes introduced in Node 17, persist in 18. Stricter stream lifecycle enforcement. Improves error handling but may break code relying on old behavior.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v17.0.0'
),
(
    'Node.js 18 new globals (Blob, BroadcastChannel, fetch) conflict with polyfills',
    'nodejs-migration',
    'HIGH',
    '[
        {"solution": "Remove polyfills for Blob, BroadcastChannel, fetch, FormData, Headers, Request, Response", "percentage": 92, "note": "Native implementations available in Node 18"},
        {"solution": "Check for global existence before polyfilling: if (!globalThis.fetch) { ... }", "percentage": 90, "command": "if (typeof fetch === ''undefined'') require(''node-fetch'')", "note": "Conditional polyfill loading"},
        {"solution": "Update imports to use native globals instead of packages", "percentage": 88, "note": "Remove imports from buffer, node-fetch, etc."},
        {"solution": "Use ReadableStream, WritableStream, TransformStream from globals instead of web-streams-polyfill", "percentage": 85, "note": "Web Streams API now built-in"}
    ]'::jsonb,
    'Node.js 18+ installed, Code with polyfills, Web platform API usage',
    'No conflicts between native and polyfilled globals, APIs work correctly, Dependencies reduced',
    'Blob graduated from experimental, fetch is experimental in 18.0-18.16. Web Streams API also available. Check Node version before removing polyfills if supporting older versions.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v18.0.0'
),
(
    'Node.js 18 test runner experimental warnings',
    'nodejs-migration',
    'LOW',
    '[
        {"solution": "Accept that node:test is experimental in Node 18 - stable in Node 20+", "percentage": 85, "note": "Experimental status expected in v18"},
        {"solution": "Suppress warnings with NODE_NO_WARNINGS=1 if tests work correctly", "percentage": 80, "command": "NODE_NO_WARNINGS=1 node --test", "note": "Hides experimental warnings"},
        {"solution": "Continue using existing test framework (Jest, Mocha) until node:test is stable", "percentage": 88, "note": "Avoid experimental features in production"},
        {"solution": "Upgrade to Node 20+ for stable test runner", "percentage": 90, "note": "Test runner stable in Node 20"}
    ]'::jsonb,
    'Node.js 18+ installed, Test suite configured, node:test module usage',
    'Tests run successfully, Warnings acceptable or suppressed, CI/CD pipeline works',
    'node:test introduced in Node 18 as experimental. Provides TAP output. API may change. Use --test flag to run tests. Stable alternative to Jest/Mocha in Node 20+.',
    0.83,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v18.0.0'
),
(
    'Node.js 18 requires C++17 compiler breaking custom builds',
    'nodejs-migration',
    'LOW',
    '[
        {"solution": "Update GCC to version 8.3+ or Clang to version 6.0+ for C++17 support", "percentage": 93, "command": "gcc --version", "note": "Check compiler version first"},
        {"solution": "On older systems, install newer compiler from repositories: apt install gcc-9 g++-9", "percentage": 90, "command": "sudo apt install gcc-9 g++-9", "note": "Ubuntu/Debian example"},
        {"solution": "Set CC and CXX environment variables to use newer compiler", "percentage": 88, "command": "export CC=gcc-9 CXX=g++-9", "note": "Forces use of specific compiler version"},
        {"solution": "Use pre-built Node binaries instead of building from source", "percentage": 85, "note": "Avoids compiler requirement"}
    ]'::jsonb,
    'Building Node.js from source, C++ compiler available, Build tools configured',
    'Node.js builds successfully, C++17 features compile, No compiler errors',
    'Only affects building Node from source, not using pre-built binaries. Node 16 required C++14. C++17 is standard in modern compilers. Check compiler support before upgrading build environment.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v17.0.0'
),
(
    'Node.js 18 V8 10.1 new array methods or Intl features not working',
    'nodejs-migration',
    'LOW',
    '[
        {"solution": "Use new Array.prototype.findLast() and findLastIndex() methods", "percentage": 90, "command": "[1,2,3,4].findLast(x => x > 2)", "note": "Returns 4 - searches from end"},
        {"solution": "Use Intl.supportedValuesOf() to query supported values", "percentage": 88, "command": "Intl.supportedValuesOf(''currency'')", "note": "Returns array of supported currencies"},
        {"solution": "Leverage improved Intl.Locale API features", "percentage": 85, "note": "Enhanced locale manipulation"},
        {"solution": "Update polyfills or transpilation targets to exclude these features", "percentage": 82, "note": "Native support available"}
    ]'::jsonb,
    'Node.js 18+ installed, JavaScript code using modern features',
    'New methods work correctly, Intl features available, No polyfills needed',
    'V8 10.1 upgrade provides new ECMAScript features. findLast/findLastIndex complement find/findIndex. Intl improvements help internationalization. Check V8 blog for full feature list.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://nodejs.org/en/blog/release/v18.0.0'
);
