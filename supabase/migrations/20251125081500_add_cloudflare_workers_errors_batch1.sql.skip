-- Add Cloudflare Workers common errors documentation batch 1
-- DOC-MINER-CF-WORKERS-2: Advanced runtime errors, request/response issues, DNS/fetch problems
-- Source: Official Cloudflare Workers documentation
-- Mined: 2025-11-25

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Cloudflare Workers error 1024: Cannot subrequest to Cloudflare IP address',
    'cloudflare-workers',
    'MEDIUM',
    '[
        {"solution": "Use public endpoints only - configure your target to use a public DNS name instead of internal Cloudflare IPs", "percentage": 95, "note": "Workers cannot fetch Cloudflare internal IPs for security"},
        {"solution": "Enable global_fetch_strictly_public compatibility flag to enforce this restriction explicitly", "percentage": 85, "note": "Future default behavior"},
        {"solution": "If accessing Cloudflare services, use their public API endpoints instead of internal IPs", "percentage": 80, "note": "Official documented approach"}
    ]'::jsonb,
    'Worker making subrequests, Target service configured',
    'Subrequests to public endpoints succeed, No 1024 errors in logs, Fetch returns successful response',
    'Internal Cloudflare IPs are blocked by design for security. This includes 1.1.1.1 and similar internal addresses. Always use public hostnames for fetch() calls.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/workers/observability/errors/'
),
(
    'Cloudflare Workers: Route pattern matching with trailing wildcards not working as expected',
    'cloudflare-workers',
    'MEDIUM',
    '[
        {"solution": "Avoid overlapping route patterns with trailing wildcards - design routes with clear specificity", "percentage": 90, "note": "Known issue with wildcard pattern resolution"},
        {"solution": "Test all route patterns thoroughly during development and use wrangler dev to validate routing", "percentage": 85, "note": "Catch routing issues early"},
        {"solution": "Use exact path matching instead of wildcards when possible for predictable routing behavior", "percentage": 80, "note": "Most reliable pattern"}
    ]'::jsonb,
    'Route configuration in wrangler.toml, Multiple overlapping routes',
    'Requests route to correct Worker consistently, No unexpected route matches, Routing behaves as expected',
    'Trailing wildcards (example.com/*) may unexpectedly match other patterns like example.com*. Routes are evaluated in order of specificity. Test all edge cases.',
    0.78,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/workers/platform/known-issues/'
),
(
    'Cloudflare Workers error: Fetch to IP addresses fails - requests only work with URLs',
    'cloudflare-workers',
    'HIGH',
    '[
        {"solution": "Create DNS A/AAAA records in Cloudflare for the target IP, then fetch using the domain name", "percentage": 95, "note": "Workers only support URL-based fetches, not direct IP addresses"},
        {"solution": "If using external IPs, configure reverse DNS and add corresponding domain records in Cloudflare DNS", "percentage": 90, "note": "Creates resolvable hostname for the IP"},
        {"solution": "For private IPs in VPC setup, use internal VPC hostnames instead of IP addresses", "percentage": 85, "note": "VPC integration supports hostname-based routing"}
    ]'::jsonb,
    'Cloudflare DNS zone configured, Target server IP known',
    'fetch() calls to domain names succeed, Worker retrieves data from target, No IP-based fetch errors',
    'fetch(''http://192.0.2.1'') will fail. Must use fetch(''http://example.com''). Workers do not support raw IP address requests. Always use domain names.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/workers/platform/known-issues/'
),
(
    'Cloudflare Workers Fetch API: CNAME setup cannot resolve non-Cloudflare DNS hostnames',
    'cloudflare-workers',
    'MEDIUM',
    '[
        {"solution": "Add all required subdomains as A/AAAA records in Cloudflare DNS configuration", "percentage": 95, "note": "CNAME setup requires DNS records to be in Cloudflare"},
        {"solution": "If using third-party DNS, switch zone to Cloudflare full setup instead of CNAME partial setup", "percentage": 85, "note": "Full setup provides complete DNS resolution"},
        {"solution": "For third-party services, create corresponding DNS entries in Cloudflare pointing to their IPs", "percentage": 80, "note": "Enables resolution through Cloudflare"}
    ]'::jsonb,
    'Partial DNS setup via CNAME, Worker attempting to fetch external domain',
    'All fetch() calls resolve successfully, Worker can reach external services, Error 530 (1016) no longer appears',
    'CNAME partial setup only resolves subdomains in Cloudflare DNS. External domains without Cloudflare DNS entries return 530/1016 error. Add DNS records or switch to full setup.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/workers/platform/known-issues/'
),
(
    'Cloudflare Workers error 1015: Burst rate limited - too many requests in short time',
    'cloudflare-workers',
    'HIGH',
    '[
        {"solution": "Implement request throttling and rate limiting in Worker code using async delays", "percentage": 90, "note": "Space out requests to avoid rate limit triggers"},
        {"solution": "Distribute requests across multiple Workers or use queue-based processing for batch operations", "percentage": 85, "note": "Reduces peak request rate"},
        {"solution": "Enable caching headers on responses to reduce origin request rate", "percentage": 80, "note": "HTTP caching reduces load"}
    ]'::jsonb,
    'Worker handling rapid request bursts, Rate limiting awareness',
    'Requests succeed consistently, No 1015 rate limit errors, Request latency acceptable',
    'Burst rate limit triggers on rapid request spikes. Implement exponential backoff and rate limiting. Queue service or scheduled tasks better for batch processing.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/workers/observability/errors/'
),
(
    'Cloudflare Workers: cf-workers-preview-token header blocks same-zone requests in dev mode',
    'cloudflare-workers',
    'MEDIUM',
    '[
        {"solution": "When using wrangler dev --remote, delete the cf-workers-preview-token header before making requests", "percentage": 95, "note": "Preview token causes Cloudflare zone checks to fail"},
        {"solution": "Use wrangler dev --local for local development instead of --remote when possible", "percentage": 90, "note": "Avoids preview token issues entirely"},
        {"solution": "If accessing other Cloudflare zones, remove preview token header to bypass security checks", "percentage": 85, "note": "Documented workaround"}
    ]'::jsonb,
    'wrangler dev --remote mode enabled, Requests to other Cloudflare zones',
    'Requests from dev mode succeed, No auth header blocking errors, Cross-zone requests work correctly',
    'The cf-workers-preview-token header is automatically added in --remote dev mode. This blocks requests to other Cloudflare zones for security. Delete header for those requests.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/workers/platform/known-issues/'
),
(
    'Cloudflare D1 error: D1_EXEC_ERROR - SQL query execution failed',
    'cloudflare-workers',
    'HIGH',
    '[
        {"solution": "Check SQL syntax - fix any syntax errors by validating query against D1 database schema", "percentage": 95, "note": "Most common cause of exec errors"},
        {"solution": "Verify that all referenced tables and columns exist in database", "percentage": 90, "note": "Missing schema elements cause errors"},
        {"solution": "Test queries in Cloudflare dashboard Query Editor before deploying in Worker code", "percentage": 85, "note": "Catch errors before runtime"}
    ]'::jsonb,
    'D1 database bound to Worker, SQL query prepared',
    'D1 queries execute successfully, Results return without errors, Query produces expected output',
    'D1_EXEC_ERROR occurs when query has syntax errors or references non-existent tables. Always validate SQL schema. Use prepared statements for dynamic queries.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/d1/observability/debug-d1/'
),
(
    'Cloudflare D1 error: D1_TYPE_ERROR - Column type mismatch with provided value',
    'cloudflare-workers',
    'HIGH',
    '[
        {"solution": "Use null instead of undefined for NULL values: bind(null) not bind(undefined)", "percentage": 95, "note": "JavaScript undefined does not map to SQL NULL"},
        {"solution": "Match column types exactly - convert string to number if column expects INTEGER", "percentage": 90, "note": "Type coercion may not work as expected"},
        {"solution": "Check database schema and ensure values passed match column types defined in CREATE TABLE", "percentage": 85, "note": "Schema validation prevents runtime errors"}
    ]'::jsonb,
    'D1 database with defined schema, Values being inserted/updated',
    'All D1 type errors resolved, Queries execute successfully, Values persist in database with correct types',
    'undefined in JavaScript does not convert to NULL in SQL - always use null. String to number conversion may fail - cast explicitly. Check column types in schema.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/d1/observability/debug-d1/'
),
(
    'Cloudflare Workers VPC error: ProxyError dns_error - DNS resolution failed through tunnel',
    'cloudflare-workers',
    'MEDIUM',
    '[
        {"solution": "Update cloudflared to version 2025.7.0 or newer: cloudflared update", "percentage": 95, "note": "Older versions have known DNS resolution issues"},
        {"solution": "Verify tunnel is configured with QUIC protocol instead of HTTP/2 for UDP port 7844 support", "percentage": 90, "note": "HTTP/2 blocks DNS resolution for Workers VPC"},
        {"solution": "Check firewall allows outbound UDP traffic on port 7844 to Cloudflare network", "percentage": 85, "note": "VPC tunnel requires UDP access"}
    ]'::jsonb,
    'Cloudflare Tunnel configured, Workers VPC setup, Private network connectivity needed',
    'DNS resolution succeeds through tunnel, Worker connects to VPC services, No proxy errors in logs',
    'DNS resolution through HTTP/2 protocol is unsupported. QUIC protocol required. cloudflared must be version 2025.7.0+. Check UDP port 7844 firewall rules.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/workers-vpc/reference/troubleshooting/'
),
(
    'Cloudflare Workers VPC: Requests route outside VPC when using public hostnames',
    'cloudflare-workers',
    'MEDIUM',
    '[
        {"solution": "Update Worker code to use internal VPC hostnames instead of public domain names", "percentage": 95, "note": "Public hostnames bypass VPC routing"},
        {"solution": "Configure VPC Services with internal hostnames and update Worker fetch() calls accordingly", "percentage": 90, "note": "Routing uses hostname to determine path"},
        {"solution": "Use VPC Connector to alias public hostnames to internal VPC addresses if needed", "percentage": 80, "note": "Translates between public and internal names"}
    ]'::jsonb,
    'Workers VPC configured, Backend services registered, Private network in place',
    'Worker requests stay within VPC network, fetch() returns internal service response, No external routing occurs',
    'Using public hostnames in Worker code routes requests through public internet instead of VPC tunnel. Always use internal VPC hostnames for fetch() calls.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/workers-vpc/reference/troubleshooting/'
),
(
    'Cloudflare Workers: Wrangler build timeout - deployment exceeds 20 minute limit',
    'cloudflare-workers',
    'MEDIUM',
    '[
        {"solution": "Optimize build process by removing unnecessary dependencies and code splitting large modules", "percentage": 90, "note": "Build must complete within 20 minutes"},
        {"solution": "Use esbuild or similar bundler with aggressive tree-shaking and minification", "percentage": 85, "note": "Reduces bundle processing time"},
        {"solution": "Check for circular dependencies and infinite loops in build configuration that slow compilation", "percentage": 80, "note": "Common cause of slow builds"}
    ]'::jsonb,
    'Wrangler deployment configured, Large codebase or complex dependencies',
    'Build completes successfully within time limit, Deployment succeeds, No timeout errors',
    'Maximum build duration is 20 minutes. Large codebases, many dependencies, or build script issues cause timeouts. Optimize build configuration and dependencies.',
    0.82,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/workers/ci-cd/builds/troubleshoot/'
),
(
    'Cloudflare Workers: Invalid API token for CI/CD builds - Token deleted or revoked',
    'cloudflare-workers',
    'HIGH',
    '[
        {"solution": "Generate new API token in Cloudflare dashboard and update build configuration settings", "percentage": 95, "note": "Invalid/expired tokens prevent CI/CD builds"},
        {"solution": "Verify token has correct permissions for Workers deployment (include:workers service, include:accounts account)", "percentage": 90, "note": "Insufficient permissions cause build failures"},
        {"solution": "Set CLOUDFLARE_API_TOKEN environment variable in CI/CD pipeline instead of storing in build config", "percentage": 85, "note": "More secure approach"}
    ]'::jsonb,
    'Cloudflare account access, CI/CD pipeline configured, Build system in place',
    'Build authentication succeeds, Deployment pipeline completes, Worker deploys successfully to production',
    'Build tokens expire or get deleted if API token is revoked. Always use current tokens. CI/CD must authenticate before each deployment. Use environment variables, not hardcoded tokens.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://developers.cloudflare.com/workers/ci-cd/builds/troubleshoot/'
);
