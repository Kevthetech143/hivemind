-- Mining CodeIgniter (PHP) common errors from official documentation
-- Source: https://codeigniter.com/user_guide/

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'CodeIgniter: "No input file specified" error with URL rewriting',
    'codeigniter',
    'HIGH',
    '[
        {"solution": "Update .htaccess rewrite rule to include a question mark after index.php: RewriteRule ^(.*) index.php?/$1 [L]", "percentage": 95, "note": "The question mark prevents the REQUEST_URI from being passed twice"},
        {"solution": "Ensure mod_rewrite is enabled in Apache with a2enmod rewrite && systemctl restart apache2", "percentage": 90, "command": "a2enmod rewrite && systemctl restart apache2"},
        {"solution": "If using PHP built-in server, use php spark serve instead which processes .htaccess", "percentage": 85, "note": "Built-in server does not process .htaccess files"}
    ]'::jsonb,
    'Apache web server with mod_rewrite capability, .htaccess file in project root',
    'URLs resolve correctly without index.php, all routes accessible, 404 only for truly missing pages',
    'Many developers add the question mark without understanding why - it prevents double-passing of REQUEST_URI. Configuration varies between Apache versions.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/installation/troubleshooting.html'
),
(
    'CodeIgniter: Model validation not catching invalid data before database insert',
    'codeigniter',
    'VERY_HIGH',
    '[
        {"solution": "Perform validation BEFORE passing data to model. Use $validation->run() on controller input first", "percentage": 95, "note": "In-model validation runs just before database storage, too late for security"},
        {"solution": "Define $allowedFields array in model and use fill() or save() to restrict mass assignment", "percentage": 90, "command": "protected $allowedFields = [''name'', ''email'', ''phone''];"},
        {"solution": "Call $validation->reset() between multiple validation runs to clear previous rules and errors", "percentage": 85, "note": "Required when validating different datasets in same request"}
    ]'::jsonb,
    'CodeIgniter 4.x, Model class, Validation library configured',
    'Validation errors caught before database write, only expected fields in database, CSRF tokens not stored',
    'Developers place validation inside models and expect it to prevent bad data - but it only logs before insert. Always validate in controller first. Missing $allowedFields creates security vulnerabilities.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/models/model.html'
),
(
    'CodeIgniter: File upload validation "required" rule fails for uploaded files',
    'codeigniter',
    'HIGH',
    '[
        {"solution": "Use ''uploaded[field_name]'' instead of ''required'' for file upload validation", "percentage": 95, "note": "required() rule cannot be used with file uploads - use uploaded() instead"},
        {"solution": "Define file validation rules with field name twice: ''avatar'' => ''uploaded[avatar]|max_size[avatar,1024]''", "percentage": 92, "note": "File rules like max_size and mime_in require field name in brackets"},
        {"solution": "Call isValid() before moving uploaded file to verify successful upload", "percentage": 90, "command": "if ($file->isValid()) { $file->move(WRITEPATH . ''uploads''); }"}
    ]'::jsonb,
    'Form with file input, CodeIgniter Validation library, writable upload directory',
    'File successfully uploads and moves to directory, validation prevents oversized files, mime_in rule correctly restricts file types',
    'Most developers try using ''required'' rule with file uploads - doesn''t work. File validation rules need field name in brackets (max_size[field,size]). Forgetting isValid() check causes files to fail silently.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/libraries/uploaded_files.html'
),
(
    'CodeIgniter: Database connection fails with "Missing table name" error',
    'codeigniter',
    'HIGH',
    '[
        {"solution": "Verify app/Config/Database.php contains correct hostname, username, password, and database name for your DBDriver", "percentage": 95, "note": "Each DBDriver (MySQLi, Postgre, SQLite3) requires specific configuration"},
        {"solution": "For Postgre and OCI8, provide full DSN string in $default[''DSN''] if database name alone does not work", "percentage": 88, "note": "Some drivers require complete DSN instead of separate config values"},
        {"solution": "For SQLite3, verify database path points to writable directory: $default[''database''] = WRITEPATH . ''db.sqlite3''", "percentage": 90, "command": "$default[''database''] = WRITEPATH . ''db.sqlite3'';"}
    ]'::jsonb,
    'Database server running and accessible, correct driver extension installed (mysqli, pgsql, sqlite3)',
    'Database connection established, queries execute successfully, no "Missing DSN" errors in logs',
    'Developers often misconfigure driver type (MySQLi vs Postgre vs SQLite3). Postgre requires full DSN. SQLite3 path must be writable. Environment variable overrides in .env must match existing config keys.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/database/configuration.html'
),
(
    'CodeIgniter: Query Builder SQL injection with identifiers (table and column names)',
    'codeigniter',
    'VERY_HIGH',
    '[
        {"solution": "Never pass table or column names directly to Query Builder from user input. Use whitelist validation: $allowed_columns = [''id'', ''name'']; if(!in_array($column, $allowed_columns)) return error;", "percentage": 95, "note": "Query Builder only escapes values, NOT identifiers"},
        {"solution": "For dynamic table/column names, manually escape identifiers using backticks around column/table names", "percentage": 85, "note": "Manual escaping required - Query Builder does not handle identifiers"},
        {"solution": "Use RawSql class ONLY when absolutely necessary and ONLY after manual escaping: new RawSql(''SELECT * FROM users WHERE id = '' . $this->db->escape($id))", "percentage": 80, "note": "RawSql bypasses Query Builder protection entirely"}
    ]'::jsonb,
    'Database access in model, user input being used in queries, understanding of SQL syntax',
    'No SQL injection attempts succeed, whitelist validation working, identifiers properly escaped in logs',
    'Developers assume Query Builder protects against all SQL injection - it does NOT protect identifiers. User input directly in table/column names = critical vulnerability. RawSql requires full manual escaping.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/database/query_builder.html'
),
(
    'CodeIgniter: Model missing primaryKey or $allowedFields breaks find(), update(), delete()',
    'codeigniter',
    'VERY_HIGH',
    '[
        {"solution": "Define primaryKey in model: protected $primaryKey = ''id'';", "percentage": 96, "note": "All Models MUST have primaryKey specified for ORM features to work"},
        {"solution": "Define $allowedFields array to whitelist which fields can be mass-assigned: protected $allowedFields = [''name'', ''email'', ''phone''];", "percentage": 95, "note": "Required for security - prevents unauthorized field modification"},
        {"solution": "For soft deletes, ensure deleted_at column is NULLABLE in database: ALTER TABLE users MODIFY COLUMN deleted_at TIMESTAMP NULL;", "percentage": 90, "command": "ALTER TABLE users MODIFY COLUMN deleted_at TIMESTAMP NULL;"}
    ]'::jsonb,
    'CodeIgniter 4.x Model class, database table with primary key, migrations or direct database access',
    'find($id) returns correct record, update() modifies only whitelisted fields, delete() properly soft-deletes, no "Undefined offset" errors',
    'Many developers forget primaryKey declaration - find($id) silently returns null. Missing $allowedFields allows CSRF token or password fields to be modified. Non-nullable deleted_at breaks soft deletes.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/models/model.html'
),
(
    'CodeIgniter: Validation placeholder {id} not substituting in custom error messages',
    'codeigniter',
    'MEDIUM',
    '[
        {"solution": "Since v4.3.5, set validation rules for the placeholder field itself: $rules = [''user_id'' => ''required|numeric'', ''post_id'' => ''required|numeric|is_not_unique[posts.id]''];", "percentage": 95, "note": "Security requirement - placeholders must have validation rules to prevent injection"},
        {"solution": "Use {field} instead of {id} in custom messages when field is not numeric", "percentage": 88, "note": "Match placeholder name exactly to validation rule name"},
        {"solution": "Pass label in validation config: ''post_id'' => [''label'' => ''Post'', ''rules'' => ''required|numeric''];", "percentage": 85, "command": "''post_id'' => [''label'' => ''Post'', ''rules'' => ''required|numeric'']"}
    ]'::jsonb,
    'CodeIgniter 4.3.5+, custom validation rules with placeholders, custom error messages',
    'Placeholder substitutes correctly in error message, custom labels display, no validation bypass',
    'Before v4.3.5, placeholders substituted without validation. Developers still expect old behavior. Placeholder field must have validation rule. Using generic {id} instead of actual field name causes confusion.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/libraries/validation.html'
),
(
    'CodeIgniter: mod_rewrite not enabled causes all URLs to route to homepage',
    'codeigniter',
    'HIGH',
    '[
        {"solution": "Enable mod_rewrite in Apache: a2enmod rewrite && systemctl restart apache2", "percentage": 94, "command": "a2enmod rewrite && systemctl restart apache2"},
        {"solution": "If REQUEST_URI variable not supported by server, modify app/Config/App.php: $indexPage = ''index.php?'' (add question mark)", "percentage": 90, "note": "Some servers do not support REQUEST_URI variable properly"},
        {"solution": "Verify .htaccess exists in project root with correct rewrite rules pointing to index.php", "percentage": 88, "note": "Commonly caused by case sensitivity (linux) vs copied files"}
    ]'::jsonb,
    'Apache web server, .htaccess file, admin access to server configuration',
    'All URLs resolve correctly, homepage does not load for all requests, routing matches URL structure',
    'Developers assume mod_rewrite is always enabled - common hosting limitation. Some servers need question mark in $indexPage. Windows vs Linux case sensitivity causes .htaccess to be ignored.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/installation/troubleshooting.html'
),
(
    'CodeIgniter: "Whoops!" error page in production indicates unrecoverable error',
    'codeigniter',
    'HIGH',
    '[
        {"solution": "Switch environment to development in .env file: CI_ENVIRONMENT = development", "percentage": 96, "command": "CI_ENVIRONMENT = development", "note": "Shows detailed error messages instead of generic Whoops page"},
        {"solution": "Check error logs in writable/logs directory - CodeIgniter creates daily log files based on Logger config", "percentage": 94, "note": "Log file path configured in app/Config/Logger.php"},
        {"solution": "Adjust error reporting threshold in app/Config/Logger.php to capture more details: public $threshold = 0;", "percentage": 90, "note": "0 captures all levels, higher numbers filter out lower severity"}
    ]'::jsonb,
    'Development machine access, .env file in project root, writable/logs directory exists',
    'Detailed error messages display, error logs populated with stack trace, problem identified and fixable',
    'Production servers should never show Whoops page - indicates serious configuration issue. Some developers check wrong log directory. Daily log files can be hard to find in large projects.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/installation/troubleshooting.html'
),
(
    'CodeIgniter: Validation errors disappear after redirect without withInput()',
    'codeigniter',
    'HIGH',
    '[
        {"solution": "Use redirect()->back()->withInput() after validation fails to preserve form data and errors", "percentage": 95, "command": "return redirect()->back()->withInput();", "note": "withInput() stores submitted form data in session temporarily"},
        {"solution": "Display errors using validation_errors(), validation_list_errors(), or validation_show_error() helpers in view", "percentage": 93, "note": "Must use these helpers - not $validation->getErrors() for redirect cases"},
        {"solution": "For AJAX requests, return JSON with errors instead of redirect: return $this->response->setJSON($validation->getErrors());", "percentage": 88, "command": "return $this->response->setJSON($validation->getErrors());"}
    ]'::jsonb,
    'Form submission, validation failure, redirect in controller, session configuration working',
    'Form repopulates with submitted values, validation errors display, user can see and fix mistakes',
    'Developers expect validation errors to persist automatically - they do not. withInput() required. Using getErrors() instead of validation_*() helpers shows nothing. AJAX endpoints need JSON response, not redirect.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/libraries/validation.html'
),
(
    'CodeIgniter: Query limit(0) returns all records instead of none',
    'codeigniter',
    'MEDIUM',
    '[
        {"solution": "In CodeIgniter v4.5.0+, limit(0) produces incorrect SQL omitting LIMIT clause entirely - this is a bug fixed in later versions", "percentage": 92, "note": "Workaround: use limit(1) for testing or update CodeIgniter"},
        {"solution": "If using v4.5.0 or earlier with limit(0), verify query with getCompiledSelect(): echo $this->db->table(''users'')->limit(0)->getCompiledSelect();", "percentage": 88, "note": "Inspect actual generated SQL to confirm issue"},
        {"solution": "Use $this->db->table(''users'')->limit(0)->asArray()->findAll() - in newer versions this correctly returns empty array", "percentage": 85, "command": "echo $query->getCompiledSelect(false);"}
    ]'::jsonb,
    'CodeIgniter database queries, Query Builder usage, MySQL or compatible database',
    'limit(0) produces correct LIMIT 0 in SQL, returns empty result set, no records returned unexpectedly',
    'Bug only affects specific CodeIgniter versions. Developers assume limit(0) behaves like SQL - it does not in v4.5.0-. Easy to miss when pagination validation uses 0 as fallback.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/database/query_builder.html'
),
(
    'CodeIgniter: Case-sensitive file/folder names cause 404 on production but work locally',
    'codeigniter',
    'HIGH',
    '[
        {"solution": "Ensure all controller, model, view file and folder names exactly match how they are referenced in code - watch CASE", "percentage": 96, "note": "Windows/macOS use case-insensitive filesystems; Linux uses case-sensitive"},
        {"solution": "Import classes at top of controller: use App\\\\Controllers\\\\MyController; - PHP namespace must match file path exactly", "percentage": 94, "note": "CodeIgniter auto-loading matches namespace to file path with case-sensitivity"},
        {"solution": "When deploying to Linux server, check that views folder name matches config: app/Config/Paths.php has viewDirectory setting", "percentage": 90, "command": "find . -name ''*.php'' | xargs grep -l ''Controllers'' | head -5"}
    ]'::jsonb,
    'Local development on Windows/macOS, deployment to Linux server, file system access',
    'Controllers load correctly on production, 404 errors only for truly missing pages, all classes found by auto-loader',
    'Developers copy files from Windows to Linux without checking case. Controllers.php != controllers.php on Linux. Namespaces must match folder structure exactly. Config paths case-sensitive in references.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/installation/troubleshooting.html'
),
(
    'CodeIgniter: Config property overrides in .env file not working for array or converted scalar values',
    'codeigniter',
    'MEDIUM',
    '[
        {"solution": "You cannot create NEW properties or convert scalar values to arrays through .env - only override existing config values", "percentage": 95, "note": "If config property is string, .env can only set string. Cannot make it array."},
        {"solution": "For SSL encryption settings requiring arrays, JSON-encode in .env and decode in constructor: database.default[''encrypt''] = json_decode(getenv(''DB_ENCRYPT''), true);", "percentage": 90, "command": "json_decode(getenv(''DB_ENCRYPT''), true)"},
        {"solution": "Define all possible properties in base config file - .env can only override, not add new properties", "percentage": 88, "note": "Best practice: set all properties in app/Config/Database.php, override only in .env"}
    ]'::jsonb,
    'app/Config/*.php files configured, .env file present, database requiring encryption/special settings',
    '.env overrides apply correctly, encryption settings work, database connection established',
    'Developers try to add new array config in .env - does not work. Encryption arrays must be JSON in .env and decoded. .env is override only, not extension mechanism.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://codeigniter.com/user_guide/database/configuration.html'
);
