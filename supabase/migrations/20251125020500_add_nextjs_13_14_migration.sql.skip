-- Add Next.js 13→14 Migration Guide - Official Documentation
-- Source: https://nextjs.org/docs/app/building-your-application/upgrading/version-14
-- Additional: https://nextjs.org/blog/next-14
-- Extracted: 2025-11-24
-- Category: migration-guide

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Next.js 14 upgrade: Update to minimum Node.js 18.17',
    'migration-guide',
    'VERY_HIGH',
    '[
        {"solution": "Install Node.js 18.17 or higher before upgrading Next.js", "percentage": 95, "note": "Node.js 16.x reached end-of-life, v18.17+ required", "command": "node --version"},
        {"solution": "Use nvm to switch Node versions: nvm install 18.17 && nvm use 18.17", "percentage": 92, "note": "Easiest way to manage multiple Node versions", "command": "nvm install 18.17 && nvm use 18.17"},
        {"solution": "Update package.json engines field to enforce Node 18.17+", "percentage": 88, "note": "Prevents deployment with wrong Node version", "command": "\"engines\": { \"node\": \">=18.17.0\" }"},
        {"solution": "Verify deployment platform uses Node 18.17+ (Vercel, Netlify, etc)", "percentage": 90, "note": "Update runtime version in platform settings"}
    ]'::jsonb,
    'Node.js installed, npm/yarn/pnpm available, Next.js 13 project',
    'node --version shows 18.17 or higher, Next.js 14 installs successfully, Application runs without Node version errors',
    'Node 16.x is EOL and unsupported. Cannot run Next.js 14 with older Node versions. CI/CD pipelines must also use Node 18.17+. Docker images must use node:18.17 or later base image.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-14'
),
(
    'Next.js 14 upgrade: Migrate from next export to output: export config',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Remove next export from package.json scripts and add output: export to next.config.js", "percentage": 95, "note": "next export command removed in Next.js 14", "command": "// next.config.js\nmodule.exports = { output: ''export'' }"},
        {"solution": "Update build script to only run next build (removes separate export step)", "percentage": 93, "note": "next build now handles export when output: export configured", "command": "\"scripts\": { \"build\": \"next build\" }"},
        {"solution": "Verify static export works by checking out/ directory after build", "percentage": 88, "note": "Static files output to out/ directory by default"},
        {"solution": "Update deployment config to serve from out/ directory instead of .next/", "percentage": 85, "note": "Static hosts need to point to out/ folder"}
    ]'::jsonb,
    'Next.js 13 project using next export, next.config.js file exists',
    'next build completes successfully, out/ directory contains static HTML files, No next export command errors, Static site deploys correctly',
    'Do not run next export after next build - it will fail. Server-side features (getServerSideProps, rewrites, redirects, headers) do not work with static export. Remove trailingSlash: true if not needed. Update .gitignore to include out/ directory.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-14'
),
(
    'Next.js 14 upgrade: Migrate ImageResponse from next/server to next/og',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Run automatic codemod to update ImageResponse imports", "percentage": 95, "note": "Handles most migration automatically", "command": "npx @next/codemod@latest next-og-import ."},
        {"solution": "Manually change import from next/server to next/og", "percentage": 93, "note": "Simple import path change", "command": "import { ImageResponse } from ''next/og''"},
        {"solution": "Update all files using ImageResponse for OG images or dynamic images", "percentage": 90, "note": "Check app/api/og, app/opengraph-image, app/twitter-image routes"},
        {"solution": "Verify ImageResponse still works after migration", "percentage": 88, "note": "Test OG image generation endpoints"}
    ]'::jsonb,
    'Next.js 13 project using ImageResponse from next/server, @next/codemod installed',
    'Codemod runs without errors, All ImageResponse imports updated to next/og, OG images generate correctly, No import errors in build',
    'Do not mix old and new imports. Codemod may miss dynamic imports or conditional requires. Check app/api routes and metadata files (opengraph-image.tsx, twitter-image.tsx). ImageResponse API unchanged, only import path differs.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-14'
),
(
    'Next.js 14 upgrade: Migrate from @next/font to next/font',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Run automatic codemod to migrate font imports", "percentage": 96, "note": "Handles all @next/font → next/font migrations", "command": "npx @next/codemod@latest built-in-next-font ."},
        {"solution": "Manually update imports from @next/font/google to next/font/google", "percentage": 92, "command": "import { Inter } from ''next/font/google''"},
        {"solution": "Update imports from @next/font/local to next/font/local", "percentage": 92, "command": "import localFont from ''next/font/local''"},
        {"solution": "Remove @next/font package from package.json dependencies", "percentage": 90, "note": "No longer needed, next/font built into Next.js", "command": "npm uninstall @next/font"}
    ]'::jsonb,
    'Next.js 13 project using @next/font, @next/codemod available',
    'Codemod completes successfully, All font imports use next/font, @next/font removed from package.json, Fonts load correctly, Build succeeds without font errors',
    '@next/font package completely removed in Next.js 14. Must migrate before upgrading. Codemod handles most cases but check for dynamic imports. Font API unchanged, only package name differs. next/font has been built-in since Next.js 13.2.',
    0.96,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-14'
),
(
    'Next.js 14 upgrade: Update TypeScript types for React 18',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Upgrade @types/react and @types/react-dom to latest versions", "percentage": 95, "note": "Ensures type compatibility with React 18", "command": "npm install @types/react@latest @types/react-dom@latest --save-dev"},
        {"solution": "Update React types when upgrading Next.js 14", "percentage": 93, "note": "Next.js 14 uses React 18 types", "command": "npm i next@14 react@18 react-dom@18 && npm i @types/react@latest @types/react-dom@latest -D"},
        {"solution": "Fix type errors related to ReactNode, FC, and children props", "percentage": 88, "note": "React 18 types stricter about children prop"},
        {"solution": "Remove implicit children from component type definitions", "percentage": 85, "note": "Explicitly declare children prop when needed", "command": "interface Props { children: React.ReactNode }"}
    ]'::jsonb,
    'Next.js project with TypeScript, React 18, npm/yarn/pnpm available',
    'TypeScript compilation succeeds, No type errors in IDE, @types/react version matches React 18, Component types resolve correctly',
    'React 18 types removed implicit children from React.FC. Must explicitly type children prop. Some third-party libraries may have type mismatches. Update all React-related type packages together. Clear node_modules if seeing stale types.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-14'
),
(
    'Next.js 14 Turbopack: Enable faster local development with --turbo flag',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Add --turbo flag to dev script for 53% faster local startup", "percentage": 90, "note": "Turbopack achieves up to 53.3% faster local server startup", "command": "\"dev\": \"next dev --turbo\""},
        {"solution": "Use next dev --turbo for Fast Refresh 94% faster than Webpack", "percentage": 92, "note": "Up to 94.7% faster code updates with Fast Refresh"},
        {"solution": "Check Turbopack compatibility at areweturboyet.com before enabling", "percentage": 85, "note": "90% of tests passing in Next.js 14, approaching stable"},
        {"solution": "Keep Webpack for production builds until Turbopack fully stable", "percentage": 88, "note": "next build still uses Webpack, Turbopack for dev only"}
    ]'::jsonb,
    'Next.js 14+, Standard next dev setup, No complex custom Webpack config',
    'next dev --turbo starts successfully, Hot reload works faster, No Turbopack compilation errors, Development experience noticeably faster',
    'Turbopack in beta for dev only - production builds still use Webpack. Some custom Webpack configs not supported yet. Check compatibility before enabling. Can fallback to Webpack by removing --turbo flag. Custom loaders may not work.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/blog/next-14'
),
(
    'Next.js 14 Server Actions: Use stable Server Actions in production',
    'migration-guide',
    'VERY_HIGH',
    '[
        {"solution": "Remove experimental.serverActions flag from next.config.js", "percentage": 95, "note": "Server Actions stable in Next.js 14, no longer experimental", "command": "// Remove: experimental: { serverActions: true }"},
        {"solution": "Migrate forms to use Server Actions instead of API routes", "percentage": 90, "note": "Server Actions provide single roundtrip for mutations, revalidation, redirects", "command": "async function create(formData: FormData) {\n  ''use server''\n  await db.insert(formData)\n  revalidatePath(''/items'')\n}"},
        {"solution": "Use revalidatePath() and revalidateTag() for cache invalidation", "percentage": 92, "note": "Deep integration with Next.js caching layer"},
        {"solution": "Enable progressive enhancement with native form actions", "percentage": 88, "note": "Forms work without JavaScript using action attribute"}
    ]'::jsonb,
    'Next.js 14+, App Router enabled, TypeScript or JavaScript',
    'Server Actions execute successfully, Forms submit and revalidate cache, No experimental warnings, TypeScript types resolve for Server Actions',
    'Must use ''use server'' directive at function top. Server Actions must be async functions. Cannot pass functions or class instances as arguments. Requires App Router, not compatible with Pages Router. Security: validate all inputs server-side.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/blog/next-14'
),
(
    'Next.js 14 Partial Prerendering: Preview compiler optimization for dynamic content',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Enable Partial Prerendering in next.config.js experimental flags", "percentage": 85, "note": "Preview feature in Next.js 14", "command": "experimental: { ppr: true }"},
        {"solution": "Wrap dynamic content in Suspense boundaries for streaming", "percentage": 88, "note": "PPR uses Suspense boundaries to determine static vs dynamic", "command": "<Suspense fallback={<Skeleton />}><DynamicContent /></Suspense>"},
        {"solution": "Serve fast static shell immediately, stream dynamic parts after", "percentage": 90, "note": "Combines SSG speed with SSR flexibility in single HTTP request"},
        {"solution": "No new APIs to learn - uses existing Suspense boundaries", "percentage": 92, "note": "Builds on React Suspense, automatic optimization"}
    ]'::jsonb,
    'Next.js 14+, App Router, React 18+ with Suspense, Understanding of streaming',
    'Static shell serves immediately, Dynamic content streams after, No layout shift during streaming, Faster perceived performance',
    'Partial Prerendering is preview/experimental in Next.js 14. May have breaking changes in future releases. Requires thoughtful Suspense boundary placement. Not all dynamic APIs work with PPR. Test thoroughly before production use.',
    0.75,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/blog/next-14'
),
(
    'Next.js 14 Metadata API: Migrate deprecated viewport and themeColor options',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Migrate viewport, colorScheme, themeColor to new viewport export", "percentage": 92, "note": "These options deprecated and will be removed in future major version", "command": "export const viewport = { width: ''device-width'', initialScale: 1, themeColor: ''#000'' }"},
        {"solution": "Replace metadata.viewport with separate viewport object", "percentage": 90, "command": "export const viewport: Viewport = { themeColor: ''black'' }"},
        {"solution": "Use generateViewport function for dynamic viewport values", "percentage": 88, "command": "export function generateViewport({ params }) { return { themeColor: params.color } }"},
        {"solution": "Keep all other metadata options unchanged in metadata export", "percentage": 95, "note": "Only viewport-related options changed, rest of Metadata API stable"}
    ]'::jsonb,
    'Next.js 14+, App Router with metadata exports, TypeScript types updated',
    'No deprecation warnings for viewport/colorScheme/themeColor, viewport meta tags render correctly, TypeScript types resolve without errors, Metadata works as expected',
    'Deprecation warning appears but does not break functionality yet. Will be removed in future major version. Must separate viewport config from metadata object. All other metadata options (title, description, openGraph) unchanged. Update types from @types/react@latest.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/blog/next-14'
),
(
    'Next.js 14 Image Optimization: Migrate onLoadingComplete to onLoad',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Replace onLoadingComplete with onLoad callback on Image component", "percentage": 95, "note": "onLoadingComplete deprecated in Next.js 14", "command": "<Image onLoad={(e) => console.log(e.target.naturalWidth)} />"},
        {"solution": "Update callback signature to use native event instead of result object", "percentage": 92, "note": "onLoad receives native event, not { naturalWidth, naturalHeight } object", "command": "const handleLoad = (e: React.SyntheticEvent<HTMLImageElement>) => { console.log(e.currentTarget.naturalWidth) }"},
        {"solution": "Access naturalWidth and naturalHeight from event.currentTarget", "percentage": 90, "command": "onLoad={(e) => { const { naturalWidth, naturalHeight } = e.currentTarget }}"},
        {"solution": "Migrate all Image components in project with onLoadingComplete", "percentage": 88, "note": "Search codebase for onLoadingComplete and replace"}
    ]'::jsonb,
    'Next.js 14+, next/image usage, Image components with onLoadingComplete callbacks',
    'Images load correctly, onLoad callbacks execute, No deprecation warnings, naturalWidth/naturalHeight accessible from event',
    'onLoadingComplete signature different from onLoad. onLoad receives browser event, must access properties from event.currentTarget. onLoadingComplete will be removed in future version. Test all image load callbacks after migration.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/blog/next-14'
),
(
    'Next.js 14 Image Optimization: Migrate domains config to remotePatterns',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Replace images.domains with images.remotePatterns in next.config.js", "percentage": 95, "note": "domains deprecated in favor of more secure remotePatterns", "command": "images: { remotePatterns: [{ protocol: ''https'', hostname: ''example.com'' }] }"},
        {"solution": "Convert domain strings to remotePatterns objects with protocol and hostname", "percentage": 92, "note": "remotePatterns more granular control", "command": "{ protocol: ''https'', hostname: ''cdn.example.com'', pathname: ''/images/**'' }"},
        {"solution": "Add optional pathname and port to restrict image sources further", "percentage": 88, "note": "Enhanced security with path-level restrictions", "command": "{ protocol: ''https'', hostname: ''example.com'', port: ''3000'', pathname: ''/uploads/**'' }"},
        {"solution": "Use wildcard patterns for hostname subdomains if needed", "percentage": 85, "note": "Support for subdomain wildcards", "command": "{ protocol: ''https'', hostname: ''**.example.com'' }"}
    ]'::jsonb,
    'Next.js 14+, next.config.js with images.domains configuration',
    'Remote images load successfully, No CORS or domain errors, More secure image loading with pathname restrictions, No deprecation warnings',
    'domains still works but deprecated. remotePatterns provides better security by restricting protocols and paths. Must specify protocol (http or https). Wildcards only work for subdomains, not paths. Test all remote image sources after migration.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/blog/next-14'
),
(
    'Next.js 14 upgrade: Complete package upgrade command',
    'migration-guide',
    'VERY_HIGH',
    '[
        {"solution": "Run full upgrade command for npm: npm i next@14 react@18 react-dom@18 eslint-config-next@14", "percentage": 95, "note": "Upgrades Next.js, React, and ESLint config together", "command": "npm i next@14 react@18 react-dom@18 && npm i eslint-config-next@14 -D"},
        {"solution": "Upgrade with yarn: yarn add next@14 react@18 react-dom@18 eslint-config-next@14", "percentage": 95, "command": "yarn add next@14 react@18 react-dom@18 && yarn add eslint-config-next@14 -D"},
        {"solution": "Upgrade with pnpm: pnpm i next@14 react@18 react-dom@18 eslint-config-next@14", "percentage": 95, "command": "pnpm i next@14 react@18 react-dom@18 && pnpm i eslint-config-next@14 -D"},
        {"solution": "Upgrade with bun: bun add next@14 react@18 react-dom@18 eslint-config-next@14", "percentage": 95, "command": "bun add next@14 react@18 react-dom@18 && bun add eslint-config-next@14 -D"}
    ]'::jsonb,
    'Next.js 13 project, Node.js 18.17+, Package manager installed (npm/yarn/pnpm/bun)',
    'Package installation succeeds, next --version shows 14.x, No peer dependency warnings, Project builds successfully, Dev server starts without errors',
    'Must upgrade React to 18.x with Next.js 14. Update TypeScript types separately (@types/react). Run codemods after upgrade for font and ImageResponse. Check for deprecated features before upgrading. Delete .next folder and rebuild after upgrade.',
    0.96,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/building-your-application/upgrading/version-14'
);
