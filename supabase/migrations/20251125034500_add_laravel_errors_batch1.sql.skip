-- Mine Laravel errors from official documentation
-- Focus: Eloquent, routing, queue failures, cache problems

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'Laravel: ModelNotFoundException when using findOrFail()',
    'laravel-eloquent',
    'HIGH',
    '[
        {"solution": "Check that record exists before calling findOrFail() or use firstOrFail() with query constraints", "percentage": 95, "note": "Automatically returns 404 HTTP response"},
        {"solution": "Wrap in try-catch block to handle exception gracefully: try { Model::findOrFail($id) } catch (ModelNotFoundException $e) { ... }", "percentage": 90, "command": "Catch ModelNotFoundException exception"},
        {"solution": "Use find() instead of findOrFail() if record may not exist, returns null on failure", "percentage": 85, "note": "Returns null instead of throwing exception"}
    ]'::jsonb,
    'Eloquent model defined, Database connection working',
    'Request returns 404 response, No ModelNotFoundException in logs, Client receives proper error response',
    'findOrFail() always throws ModelNotFoundException when no record found. Use find() for optional queries. Always handle this exception at handler level.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://laravel.com/docs/eloquent'
),
(
    'Laravel: Mass assignment vulnerability - attributes silently discarded',
    'laravel-eloquent',
    'VERY_HIGH',
    '[
        {"solution": "Define $fillable array on model: protected $fillable = [\"name\", \"email\", \"password\"];", "percentage": 95, "note": "Explicitly list allowed attributes"},
        {"solution": "Use $guarded array instead: protected $guarded = [\"id\", \"created_at\"]; to exclude specific fields", "percentage": 90, "note": "Guard sensitive fields instead"},
        {"solution": "Enable debugging in service provider: Model::preventSilentlyDiscardingAttributes(); to throw exceptions during development", "percentage": 85, "command": "Call in AppServiceProvider boot() method"}
    ]'::jsonb,
    'Eloquent model defined, Service provider accessible',
    'Model accepts only specified attributes, Non-fillable attributes are rejected, Exception thrown in development for unfillable attributes',
    'Without $fillable or $guarded, unprotected attributes are silently discarded. Always define one of these properties. Test with preventSilentlyDiscardingAttributes() in development.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://laravel.com/docs/eloquent'
),
(
    'Laravel: N+1 query problem with lazy loading relationships',
    'laravel-eloquent',
    'HIGH',
    '[
        {"solution": "Eager load relationships using with(): Post::with(\"author\", \"comments\")->get()", "percentage": 95, "note": "Load relationships in single query"},
        {"solution": "Use preventLazyLoading() in non-production environments to identify issues: Model::preventLazyLoading();", "percentage": 90, "command": "Call in AppServiceProvider boot() in development"},
        {"solution": "Check relationship queries with Laravel debugbar to verify no N+1 queries", "percentage": 85, "note": "Visual inspection of query count"}
    ]'::jsonb,
    'Eloquent relationships defined, Development environment',
    'Relationship queries execute in single batch, preventLazyLoading() throws exception, Debugbar shows single query per relationship',
    'Lazy loading in loops causes multiple queries. Always eager load in controller. preventLazyLoading() only works in non-production environments.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://laravel.com/docs/eloquent'
),
(
    'Laravel: Model events not firing on mass update/delete operations',
    'laravel-eloquent',
    'HIGH',
    '[
        {"solution": "Use updateOrCreate() or create() on individual models instead of mass operations to trigger events", "percentage": 92, "note": "Process models individually to fire events"},
        {"solution": "Manually dispatch events after mass operations: Model::dispatch(new ModelDeleted($model));", "percentage": 85, "note": "Manual event triggering"},
        {"solution": "Use Model::query()->each(fn($m) => $m->delete()) to loop and trigger delete event on each", "percentage": 80, "command": "Iterate through models for batch operations"}
    ]'::jsonb,
    'Eloquent model with events defined, Event listeners configured',
    'Model events fire on individual operations, Mass operations complete without errors, Event listeners execute as expected',
    'Model::update() and Model::delete() on query builder bypass events. Always use individual model operations if events needed.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://laravel.com/docs/eloquent'
),
(
    'Laravel: Route 404 when parameter constraints not matched',
    'laravel-routing',
    'HIGH',
    '[
        {"solution": "Define route constraints using where(): Route::get(\"users/{id}\", ...)->where(\"id\", \"[0-9]+\");", "percentage": 95, "note": "Regex pattern matching required"},
        {"solution": "Use route model binding with implicit types: Route::get(\"posts/{post}\", ...) and type-hint Post model", "percentage": 90, "note": "Automatic constraint validation"},
        {"solution": "Check route order - more specific routes must come before catch-all fallback routes", "percentage": 85, "note": "Router matches top-to-bottom"}
    ]'::jsonb,
    'Routes defined, Controller methods exist',
    'Route matches incoming request, No 404 response, Parameters pass validation constraints',
    'Invalid regex constraints cause 404. Parameters must exactly match where() pattern. Check route order for conflicts.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://laravel.com/docs/routing'
),
(
    'Laravel: Queue job timeout causing worker exit',
    'laravel-queue',
    'HIGH',
    '[
        {"solution": "Increase timeout on worker: queue:work --timeout=300 for longer running jobs", "percentage": 95, "note": "Default timeout is 60 seconds"},
        {"solution": "Set $timeout property on job class: public $timeout = 300; (in seconds)", "percentage": 92, "note": "Job-level timeout configuration"},
        {"solution": "Break long operations into smaller chunks or use job batching to process in parallel", "percentage": 85, "command": "Use Bus::batch() for parallel job execution"}
    ]'::jsonb,
    'Queue worker running, Job class defined',
    'Job completes within timeout, Worker continues running, No timeout exceptions in logs',
    'Default timeout is 60 seconds. Timeout value in seconds not milliseconds. Set $failOnTimeout = true to skip retries on timeout.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://laravel.com/docs/queues'
),
(
    'Laravel: Queue job fails with unhandled exception',
    'laravel-queue',
    'VERY_HIGH',
    '[
        {"solution": "Wrap job logic in try-catch block and use $this->fail($exception) to explicitly fail", "percentage": 93, "note": "Graceful failure handling"},
        {"solution": "Configure $tries property on job: public $tries = 3; to limit retry attempts", "percentage": 91, "command": "Set max retries per job"},
        {"solution": "Use exception-specific handling with middleware FailOnException to skip retries for specific errors", "percentage": 85, "note": "Fail immediately on unrecoverable errors"}
    ]'::jsonb,
    'Queue job class defined, Queue worker configured',
    'Failed job recorded in failed_jobs table, Job retried up to $tries limit, Exception logged properly',
    'Unhandled exceptions auto-release job for retry. Set $maxExceptions to fail after threshold. Always use try-catch in job handle().',
    0.94,
    'sonnet-4',
    NOW(),
    'https://laravel.com/docs/queues'
),
(
    'Laravel: Cache LockTimeoutException when acquiring distributed lock',
    'laravel-cache',
    'MEDIUM',
    '[
        {"solution": "Increase lock timeout parameter: Cache::lock(\"key\", timeout: 30)->block(10) allows 10 seconds to acquire", "percentage": 92, "note": "block() waits for lock"},
        {"solution": "Reduce lock contention by shortening critical section or using forUpdate() for database locks instead", "percentage": 88, "note": "Better for database operations"},
        {"solution": "Handle LockTimeoutException: try { ... } catch (LockTimeoutException $e) { ... }", "percentage": 85, "command": "Catch LockTimeoutException"}
    ]'::jsonb,
    'Cache driver configured (Redis recommended for locks), Lock mechanism enabled',
    'Lock acquired within timeout, LockTimeoutException handled, No deadlocks in system',
    'block() timeout is in seconds. Redis locks have TTL for cleanup. File driver doesn''t support locks.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://laravel.com/docs/cache'
),
(
    'Laravel: Cache tags not supported on file/database drivers',
    'laravel-cache',
    'MEDIUM',
    '[
        {"solution": "Switch cache driver to Redis or Memcached: CACHE_DRIVER=redis in .env", "percentage": 96, "note": "Only Redis/Memcached support tags"},
        {"solution": "Avoid using cache tags with file/database drivers - use cache keys with prefix instead", "percentage": 85, "note": "Manual key management"},
        {"solution": "Check driver configuration in config/cache.php to verify supported features", "percentage": 80, "command": "Verify CACHE_DRIVER value"}
    ]'::jsonb,
    'Cache system configured, .env file accessible',
    'Cache tags work with Redis/Memcached, File driver used without tags, No tag-related errors',
    'File, DynamoDB, and database drivers don''t support cache tags. Error occurs silently or throws exception. Use Redis for tag support.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://laravel.com/docs/cache'
),
(
    'Laravel: Rate limit 429 Too Many Requests response',
    'laravel-routing',
    'MEDIUM',
    '[
        {"solution": "Configure rate limit middleware in route: Route::post(\"/api/action\", ...)->middleware(\"throttle:60,1\")", "percentage": 93, "note": "60 requests per 1 minute"},
        {"solution": "Check X-RateLimit-* response headers to see current limit status", "percentage": 88, "note": "Headers show remaining requests"},
        {"solution": "Implement exponential backoff retry logic when receiving 429 responses", "percentage": 85, "command": "Wait Retry-After header seconds before retrying"}
    ]'::jsonb,
    'Throttle middleware configured, Routes defined',
    'Requests return 200 below limit, 429 returned when exceeded, X-RateLimit headers present',
    'Default throttle:60,1 means 60 requests per 1 minute. Each user tracked separately. Check Retry-After header for wait time.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://laravel.com/docs/routing'
),
(
    'Laravel: Soft delete models not excluded properly from queries',
    'laravel-eloquent',
    'MEDIUM',
    '[
        {"solution": "Use withTrashed() to include soft-deleted records: Model::withTrashed()->get();", "percentage": 94, "note": "Include deleted in results"},
        {"solution": "Use onlyTrashed() to retrieve only deleted records: Model::onlyTrashed()->get();", "percentage": 92, "note": "Get only soft-deleted rows"},
        {"solution": "Use forceDelete() to permanently remove: $model->forceDelete(); instead of delete()", "percentage": 88, "command": "Permanent deletion of soft-deleted model"}
    ]'::jsonb,
    'Model uses SoftDeletes trait, Migration includes deleted_at column',
    'Soft-deleted records excluded from default queries, withTrashed() includes them, forceDelete() removes permanently',
    'SoftDeletes are automatically excluded from queries. forceDelete() cannot be undone. Always use withTrashed() if deleted records needed.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://laravel.com/docs/eloquent'
);
