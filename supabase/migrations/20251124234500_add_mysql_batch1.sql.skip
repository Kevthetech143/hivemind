-- Add MySQL official documentation solutions batch 1
-- Source: MySQL 8.0 Error Reference and Connection Troubleshooting Guide
-- Coverage: Connection errors, syntax errors, constraint violations

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'MySQL Error 1064: You have an error in your SQL syntax',
    'mysql',
    'VERY_HIGH',
    '[
        {"solution": "Review SQL syntax against MySQL manual for your server version. Check for typos, missing keywords, or incorrect clause ordering", "percentage": 90, "note": "Official MySQL recommendation"},
        {"solution": "Verify proper use of reserved words - escape with backticks if used as identifiers", "percentage": 85, "note": "Common cause of syntax errors"},
        {"solution": "Check that all opening parentheses, quotes, and brackets are properly closed", "percentage": 80, "note": "Especially in complex queries"},
        {"solution": "Validate query structure matches MySQL version requirements", "percentage": 75, "note": "Some syntax only available in newer versions"}
    ]'::jsonb,
    'MySQL server running, Valid database connection',
    'Query executes successfully without error, Expected results returned',
    'Error message shows exact location of syntax problem. Reserved words like SELECT, TABLE, ORDER must be escaped with backticks when used as column/table names. Trailing commas in SELECT lists cause this error.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html'
),
(
    'MySQL Error 1452: Cannot add or update a child row: a foreign key constraint fails',
    'mysql',
    'VERY_HIGH',
    '[
        {"solution": "Verify the parent record exists in the referenced table before inserting child record", "percentage": 95, "note": "Most common cause - missing parent data"},
        {"solution": "Check that foreign key value exactly matches parent primary key including data type and case sensitivity", "percentage": 90, "note": "Data type mismatches fail silently"},
        {"solution": "Query parent table to confirm referenced value exists: SELECT * FROM parent_table WHERE id = <value>", "percentage": 85, "command": "SELECT * FROM parent_table WHERE id = <foreign_key_value>;"},
        {"solution": "Insert parent record first, then child record", "percentage": 95, "note": "Correct insertion order"}
    ]'::jsonb,
    'InnoDB storage engine, Foreign key constraint defined, Valid database connection',
    'INSERT or UPDATE statement executes successfully, Child record created with valid foreign key reference',
    'Foreign key columns must have exact same data type as parent (INT vs BIGINT fails). Check charset and collation match. NULL values are allowed in foreign key columns unless NOT NULL specified. Temporarily disabling FOREIGN_KEY_CHECKS bypasses validation but creates data integrity issues.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html'
),
(
    'MySQL Error 1451: Cannot delete or update a parent row: a foreign key constraint fails',
    'mysql',
    'HIGH',
    '[
        {"solution": "Delete dependent child records first, then delete parent record", "percentage": 95, "note": "Maintains referential integrity"},
        {"solution": "Use CASCADE on foreign key constraint definition to automatically delete child records", "percentage": 90, "note": "ALTER TABLE child_table ADD CONSTRAINT fk_name FOREIGN KEY (col) REFERENCES parent(col) ON DELETE CASCADE"},
        {"solution": "Set foreign key to NULL in child records before deleting parent: UPDATE child SET foreign_key_col = NULL WHERE parent_id = <value>", "percentage": 85, "note": "Only works if column allows NULL"},
        {"solution": "Use ON DELETE SET NULL in constraint definition for automatic NULL assignment", "percentage": 80, "note": "Requires nullable foreign key column"}
    ]'::jsonb,
    'InnoDB storage engine, Foreign key constraint defined, Child records exist',
    'DELETE or UPDATE statement executes successfully, Parent record removed without constraint violation',
    'ON DELETE CASCADE permanently deletes child records - no recovery. Check all dependent tables before deletion. Multiple levels of foreign keys require deleting from deepest child upward. SET NULL requires foreign key column to be nullable.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html'
),
(
    'MySQL Error 1215: Cannot add foreign key constraint',
    'mysql',
    'HIGH',
    '[
        {"solution": "Verify both tables use InnoDB storage engine: SHOW TABLE STATUS LIKE table_name", "percentage": 95, "command": "SHOW TABLE STATUS LIKE ''table_name'';"},
        {"solution": "Ensure foreign key column and referenced column have identical data types including length, signedness, and character set", "percentage": 95, "note": "INT vs INT UNSIGNED fails, VARCHAR(50) vs VARCHAR(100) fails"},
        {"solution": "Confirm referenced column has an index - foreign keys require parent column to be indexed or primary key", "percentage": 90, "note": "Create index on parent: CREATE INDEX idx_name ON parent_table(column)"},
        {"solution": "Check that referenced table and column exist and are spelled correctly", "percentage": 85, "note": "Case sensitivity matters on Linux/Unix systems"}
    ]'::jsonb,
    'Both tables exist, InnoDB storage engine on both tables, Valid ALTER TABLE or CREATE TABLE permissions',
    'Foreign key constraint created successfully, SHOW CREATE TABLE displays constraint definition',
    'MyISAM tables do not support foreign keys - convert to InnoDB first. Charset mismatch between columns fails constraint creation. Check mysql error log for detailed InnoDB error 150 message. Data types must match exactly - even different INT sizes fail.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html'
),
(
    'MySQL Error 1062: Duplicate entry for key',
    'mysql',
    'VERY_HIGH',
    '[
        {"solution": "Query table to identify existing duplicate value: SELECT * FROM table WHERE column = value", "percentage": 90, "command": "SELECT * FROM table_name WHERE unique_column = ''''duplicate_value'''';"},
        {"solution": "Use INSERT IGNORE to skip duplicate entries without error", "percentage": 85, "note": "INSERT IGNORE INTO table_name VALUES (...);"},
        {"solution": "Use INSERT ... ON DUPLICATE KEY UPDATE to update existing record instead of failing", "percentage": 90, "note": "INSERT INTO table (col1, col2) VALUES (val1, val2) ON DUPLICATE KEY UPDATE col2=val2;"},
        {"solution": "Use REPLACE INTO to delete existing record and insert new one", "percentage": 80, "note": "REPLACE INTO table_name VALUES (...); - deletes old row first"}
    ]'::jsonb,
    'UNIQUE or PRIMARY KEY constraint defined on column, Valid database connection',
    'INSERT or UPDATE executes successfully using chosen approach, No duplicate key error',
    'INSERT IGNORE silently fails but does not show which rows were skipped. REPLACE deletes the old row entirely (triggers ON DELETE). ON DUPLICATE KEY UPDATE only updates specified columns. Check AUTO_INCREMENT values after REPLACE.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html'
),
(
    'MySQL Error 2002: Can''t connect to local MySQL server through socket',
    'mysql',
    'VERY_HIGH',
    '[
        {"solution": "Verify MySQL server is running: systemctl status mysql or ps aux | grep mysql", "percentage": 95, "command": "systemctl status mysql"},
        {"solution": "Check socket file location matches client configuration: mysql_config --socket", "percentage": 90, "command": "mysql_config --socket"},
        {"solution": "Specify correct socket path in connection: mysql --socket=/path/to/mysql.sock", "percentage": 85, "note": "Common paths: /var/run/mysqld/mysqld.sock, /tmp/mysql.sock"},
        {"solution": "Start MySQL server if stopped: systemctl start mysql or mysqld_safe &", "percentage": 95, "command": "systemctl start mysql"}
    ]'::jsonb,
    'MySQL installed, Proper system permissions, Socket directory writable',
    'mysql client connects successfully, Server responds to queries',
    'Socket file location varies by OS and installation method. Check /etc/my.cnf or /etc/mysql/my.cnf for socket setting. Socket file deleted if server crashes - restart required. Permission denied on socket file requires chown mysql:mysql.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/refman/8.0/en/problems-connecting.html'
),
(
    'MySQL Error 2003: Can''t connect to MySQL server on host',
    'mysql',
    'VERY_HIGH',
    '[
        {"solution": "Verify server is running and listening on correct port: netstat -ln | grep 3306", "percentage": 90, "command": "netstat -ln | grep 3306"},
        {"solution": "Check firewall allows connections on port 3306: sudo ufw allow 3306 or iptables rules", "percentage": 95, "note": "Common firewall issue blocking remote connections"},
        {"solution": "Confirm bind_address is not restricted to 127.0.0.1 for remote access: check my.cnf", "percentage": 90, "note": "Set bind_address = 0.0.0.0 to allow remote connections"},
        {"solution": "Verify hostname resolution: ping hostname or use IP address directly", "percentage": 85, "note": "DNS issues can prevent connection"}
    ]'::jsonb,
    'MySQL server installed and running, Network connectivity, Valid hostname or IP',
    'Client connects successfully to remote server, ping shows host is reachable',
    'Port 3306 must be open in firewall for remote connections. bind_address = 127.0.0.1 only allows localhost connections. Cloud servers often require security group rules. Check SELinux on RHEL/CentOS blocks connections.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/refman/8.0/en/problems-connecting.html'
),
(
    'MySQL Error 1045: Access denied for user',
    'mysql',
    'VERY_HIGH',
    '[
        {"solution": "Verify username and password are correct: mysql -u username -p and enter password when prompted", "percentage": 90, "note": "Most common cause is incorrect credentials"},
        {"solution": "Check user exists and has permissions: SELECT user, host FROM mysql.user WHERE user = username", "percentage": 85, "command": "SELECT user, host FROM mysql.user WHERE user = ''''username'''';"},
        {"solution": "Grant proper permissions to user: GRANT ALL PRIVILEGES ON database.* TO username@host IDENTIFIED BY password", "percentage": 90, "command": "GRANT ALL PRIVILEGES ON database.* TO ''''username''''@''''host'''' IDENTIFIED BY ''''password'''';"},
        {"solution": "Verify host matches - root@localhost vs root@% are different users", "percentage": 85, "note": "Create user for specific host: CREATE USER username@host IDENTIFIED BY password"},
        {"solution": "Execute FLUSH PRIVILEGES after manual grant table modifications", "percentage": 80, "command": "FLUSH PRIVILEGES;"}
    ]'::jsonb,
    'MySQL server running, Valid username, User account exists in mysql.user table',
    'Successful connection without access denied error, User can execute permitted queries',
    'Username and hostname combination must match exactly in user table. % wildcard for host allows any remote connection but not localhost - needs separate entry. Password changes require FLUSH PRIVILEGES. Empty password still requires -p flag.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/refman/8.0/en/problems-connecting.html'
),
(
    'MySQL Error 1040: Too many connections',
    'mysql',
    'HIGH',
    '[
        {"solution": "Increase max_connections system variable: SET GLOBAL max_connections = 500", "percentage": 85, "command": "SET GLOBAL max_connections = 500;"},
        {"solution": "Add max_connections to my.cnf [mysqld] section for permanent change and restart server", "percentage": 90, "note": "Add line: max_connections = 500"},
        {"solution": "Identify and kill idle or long-running connections: SHOW PROCESSLIST and KILL process_id", "percentage": 80, "command": "SHOW PROCESSLIST; KILL <process_id>;"},
        {"solution": "Fix application connection leaks - ensure connections are properly closed after use", "percentage": 95, "note": "Use connection pooling with max limits"}
    ]'::jsonb,
    'MySQL server running, Root or SUPER privilege for changing max_connections',
    'New connections succeed, SHOW VARIABLES LIKE max_connections shows increased value',
    'Default max_connections is 151. Each connection uses memory - increase RAM if raising limit high. Connection pooling in applications reduces total connections needed. Check for connection leaks with SHOW PROCESSLIST. max_connections requires server restart if set in my.cnf.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html'
),
(
    'MySQL Error 2006: MySQL server has gone away',
    'mysql',
    'HIGH',
    '[
        {"solution": "Increase max_allowed_packet for large queries: SET GLOBAL max_allowed_packet = 67108864", "percentage": 90, "command": "SET GLOBAL max_allowed_packet = 67108864;"},
        {"solution": "Increase wait_timeout and interactive_timeout to prevent idle connection closure", "percentage": 85, "note": "SET GLOBAL wait_timeout = 600; SET GLOBAL interactive_timeout = 600;"},
        {"solution": "Implement reconnection logic in application code when connection is lost", "percentage": 90, "note": "Catch exception and reconnect before retrying query"},
        {"solution": "Check server logs for crashes or out-of-memory errors during query execution", "percentage": 80, "note": "Look in /var/log/mysql/error.log"}
    ]'::jsonb,
    'MySQL server running, Proper system resources available',
    'Large queries execute successfully, Long-running connections stay alive, No server crashes in logs',
    'Default max_allowed_packet is 64MB - packets larger cause this error. Connection times out after wait_timeout seconds of inactivity. Server crash/restart causes this error. Network issues between client and server trigger this. Requires reconnection - cannot resume on same connection.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/mysql-errors/8.0/en/client-error-reference.html'
),
(
    'MySQL Error 2013: Lost connection to MySQL server during query',
    'mysql',
    'HIGH',
    '[
        {"solution": "Increase net_read_timeout and net_write_timeout for slow queries: SET GLOBAL net_read_timeout = 120", "percentage": 85, "command": "SET GLOBAL net_read_timeout = 120; SET GLOBAL net_write_timeout = 120;"},
        {"solution": "Check for network connectivity issues between client and server: ping and traceroute", "percentage": 80, "note": "Intermittent network problems cause this error"},
        {"solution": "Verify server has sufficient resources - check CPU, memory, disk I/O during query", "percentage": 85, "note": "Use top, iostat, or monitoring tools"},
        {"solution": "Reduce query complexity or add query timeout limits to prevent resource exhaustion", "percentage": 75, "note": "Break large queries into smaller chunks"}
    ]'::jsonb,
    'MySQL server running, Stable network connection, Sufficient server resources',
    'Query completes successfully, Connection remains stable throughout execution',
    'Default timeout is 30 seconds for read/write operations. Large result sets or slow queries trigger timeout. Server killing query due to resource limits causes this. Network issues mid-query cause disconnection. Check max_execution_time setting.',
    0.80,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/mysql-errors/8.0/en/client-error-reference.html'
),
(
    'MySQL Error 2005: Unknown MySQL server host',
    'mysql',
    'HIGH',
    '[
        {"solution": "Verify hostname spelling and DNS resolution: ping hostname or nslookup hostname", "percentage": 90, "command": "ping hostname"},
        {"solution": "Use IP address instead of hostname to bypass DNS issues: mysql -h 192.168.1.100", "percentage": 85, "note": "Direct IP connection avoids DNS"},
        {"solution": "Check /etc/hosts file has correct hostname-to-IP mapping on client machine", "percentage": 80, "note": "Add entry: 192.168.1.100 mysql.example.com"},
        {"solution": "Verify network connectivity and firewall rules allow DNS queries", "percentage": 75, "note": "DNS blocked by firewall causes this error"}
    ]'::jsonb,
    'Valid hostname or IP address, Network connectivity, DNS server accessible',
    'Hostname resolves successfully with ping or nslookup, MySQL client connects',
    'Typos in hostname are common cause. DNS server must be reachable for hostname resolution. /etc/hosts file checked before DNS on Linux/Mac. Windows hosts file at C:\\Windows\\System32\\drivers\\etc\\hosts. Some cloud environments use internal DNS.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://dev.mysql.com/doc/mysql-errors/8.0/en/client-error-reference.html'
);
