-- Add Stack Overflow solutions batch 5: Build tools, npm, git, auth
-- Source: Stack Overflow accepted answers with community verification

-- Webpack: Module build failed with babel
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Webpack Module build failed - babel-loader',
    'build-tools',
    'VERY_HIGH',
    '[
        {"solution": "Install babel-loader: npm install --save-dev babel-loader @babel/core @babel/preset-env", "percentage": 90, "note": "Missing babel dependencies"},
        {"solution": "Update webpack.config.js to use module.rules instead of deprecated module.loaders", "percentage": 85, "note": "Webpack 2+ syntax change"},
        {"solution": "Ensure test: /\\.js$/ and exclude: /node_modules/ in loader config", "percentage": 80, "note": "Loader not matching files"}
    ]'::jsonb,
    'Node.js and npm installed, webpack.config.js exists',
    'Webpack build completes successfully, No babel-loader errors in output',
    'module.loaders is deprecated in Webpack 2+. Use module.rules. Babel packages must be installed as devDependencies.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/33621866/'
);

-- npm: EINTEGRITY error during install
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'npm install fails with ERR! code EINTEGRITY',
    'npm',
    'HIGH',
    '[
        {"solution": "Delete package-lock.json and node_modules, then npm install", "percentage": 95, "command": "rm -rf package-lock.json node_modules && npm install", "note": "Corrupted package cache"},
        {"solution": "Clear npm cache: npm cache clean --force", "percentage": 85, "command": "npm cache clean --force"},
        {"solution": "Run npm install again - connectivity issue may resolve", "percentage": 75, "note": "Transient network error"}
    ]'::jsonb,
    'npm installed, package.json exists',
    'npm install completes without errors, node_modules folder populated',
    'EINTEGRITY means package hash mismatch - usually corrupted cache or interrupted download. Simply retrying may work.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/47545940/'
);

-- npm: Unable to resolve dependency tree
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'npm install error: Unable to resolve dependency tree',
    'npm',
    'VERY_HIGH',
    '[
        {"solution": "Use --legacy-peer-deps flag: npm install --legacy-peer-deps", "percentage": 90, "note": "Bypass peer dependency conflicts"},
        {"solution": "Use --force flag: npm install --force", "percentage": 80, "note": "Accept incorrect dependencies (risky)"},
        {"solution": "Delete package-lock.json and node_modules, then reinstall", "percentage": 85, "command": "rm -rf package-lock.json node_modules && npm install"}
    ]'::jsonb,
    'npm 7+, package.json with peer dependency conflicts',
    'Dependencies install successfully, App runs without errors',
    'npm 7+ enforces strict peer dependencies. --legacy-peer-deps uses npm 6 behavior. --force can cause runtime issues.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/64573177/'
);

-- Git: Push rejected - fetch first
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Git push error: rejected - fetch first',
    'git',
    'VERY_HIGH',
    '[
        {"solution": "Pull remote changes first: git pull, then git push", "percentage": 95, "command": "git pull && git push", "note": "Remote has commits you don''t have"},
        {"solution": "Force push if intentional: git push --force origin <branch>", "percentage": 70, "note": "WARNING: Deletes remote commits"},
        {"solution": "Pull with rebase: git pull --rebase, then git push", "percentage": 85, "command": "git pull --rebase && git push", "note": "Cleaner history"}
    ]'::jsonb,
    'Git repository, Remote configured, Commits to push',
    'git push succeeds, Changes visible on remote',
    'Remote has changes you don''t have locally. Always pull before push. Use --force only if you understand the consequences.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/8331399/'
);

-- Git: Permission denied publickey
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Git error: Permission denied (publickey)',
    'git',
    'HIGH',
    '[
        {"solution": "Add SSH key to ssh-agent: eval $(ssh-agent -s) && ssh-add ~/.ssh/id_rsa", "percentage": 90, "command": "eval $(ssh-agent -s) && ssh-add ~/.ssh/id_rsa", "note": "SSH key not loaded"},
        {"solution": "Generate new SSH key and add to GitHub: ssh-keygen -t ed25519 -C your_email@example.com", "percentage": 85, "note": "No SSH key exists"},
        {"solution": "Use HTTPS instead of SSH: git remote set-url origin https://github.com/user/repo.git", "percentage": 80, "note": "Bypass SSH auth"}
    ]'::jsonb,
    'Git installed, GitHub/GitLab account, Repository access',
    'git clone/pull/push works without errors, SSH connection succeeds',
    'SSH key must be added to both ssh-agent and GitHub account. Check with: ssh -T git@github.com',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/2643502/'
);

-- Git: fatal not a git repository
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Git fatal: not a git repository',
    'git',
    'HIGH',
    '[
        {"solution": "Change to repository directory: cd /path/to/repo", "percentage": 95, "note": "Running git command outside repo"},
        {"solution": "Initialize git repo: git init", "percentage": 85, "note": "Directory is not a git repo yet"},
        {"solution": "Clone repo instead: git clone <url>", "percentage": 80, "note": "Start fresh from remote"}
    ]'::jsonb,
    'Git installed, Directory exists',
    'git status works without error, .git folder exists in directory',
    'Git commands only work inside a git repository (directory with .git folder). Use pwd to check current directory.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/4630704/'
);

-- npm: Wrong directory error
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'npm install error: Cannot find module or wrong directory',
    'npm',
    'HIGH',
    '[
        {"solution": "Navigate to project directory containing package.json: cd /path/to/project", "percentage": 95, "note": "Running npm in wrong directory"},
        {"solution": "Verify package.json exists: ls package.json", "percentage": 90, "command": "ls package.json"},
        {"solution": "Initialize new project: npm init -y", "percentage": 75, "note": "Create package.json if missing"}
    ]'::jsonb,
    'npm installed, Project directory',
    'npm install runs without path errors, node_modules created in correct location',
    'npm install must be run in directory containing package.json. Never run in system directories like C:\\Windows.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/72480884/'
);

-- 401 Unauthorized: Missing/Invalid credentials
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url, pattern_id
) VALUES (
    'API returns 401 Unauthorized error',
    'web-api',
    'VERY_HIGH',
    '[
        {"solution": "Include Authorization header: Authorization: Bearer <token>", "percentage": 90, "note": "Missing authentication header"},
        {"solution": "Check token expiration and refresh if needed", "percentage": 85, "note": "Token expired"},
        {"solution": "Verify API key is correct and has required permissions", "percentage": 80, "note": "Invalid credentials"}
    ]'::jsonb,
    'Valid API credentials, API key or token',
    'API returns 200 status code, Response contains expected data',
    '401 means authentication failed, not authorization (that is 403). Check credentials are sent and valid.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/13279593/',
    (SELECT id FROM patterns WHERE pattern_name = 'ENV_VAR_CHAIN_DEPENDENCY')
);

-- WebSocket: Connection failed handshake
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'WebSocket connection failed during handshake',
    'websocket',
    'HIGH',
    '[
        {"solution": "Use wss:// instead of ws:// for HTTPS sites", "percentage": 90, "note": "Mixed content error"},
        {"solution": "Verify WebSocket server is running and accessible", "percentage": 85, "note": "Server not responding"},
        {"solution": "Check CORS headers on server: Access-Control-Allow-Origin", "percentage": 80, "note": "CORS blocking connection"}
    ]'::jsonb,
    'WebSocket server running, Client code with WebSocket URL',
    'WebSocket connection opens successfully, onopen event fires',
    'HTTPS pages cannot connect to ws:// (insecure WebSocket). Must use wss:// (secure WebSocket).',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/41381444/'
);

-- WebSocket: Cannot connect - URL issue
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'WebSocket connection error: URL not found',
    'websocket',
    'MEDIUM',
    '[
        {"solution": "Verify WebSocket endpoint exists and matches server route", "percentage": 90, "note": "Wrong URL path"},
        {"solution": "Change ws:// to wss:// if server uses HTTPS", "percentage": 85, "note": "Protocol mismatch"},
        {"solution": "Use correct port number: ws://localhost:3000 not ws://localhost", "percentage": 80, "note": "Missing port"}
    ]'::jsonb,
    'WebSocket server configured, Endpoint defined',
    'WebSocket connects successfully, No 404 errors in console',
    'WebSocket URL must match server endpoint exactly. Common mistake: forgetting /websocket suffix in Spring Boot.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/23384205/'
);

-- Webpack: ERR_OSSL_EVP_UNSUPPORTED (Node 17+)
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url, pattern_id
) VALUES (
    'Webpack build error: ERR_OSSL_EVP_UNSUPPORTED',
    'build-tools',
    'HIGH',
    '[
        {"solution": "Upgrade to Webpack 5.54.0+: npm install webpack@latest", "percentage": 90, "note": "Webpack uses deprecated MD4 hash"},
        {"solution": "Use NODE_OPTIONS: export NODE_OPTIONS=--openssl-legacy-provider && npm run build", "percentage": 85, "note": "Temporary workaround for Node 17+"},
        {"solution": "Downgrade Node.js to version 16 LTS", "percentage": 70, "note": "Node 17 removed OpenSSL support for MD4"}
    ]'::jsonb,
    'Node.js 17+, Webpack project',
    'Webpack builds successfully, No OpenSSL errors',
    'Node 17+ removed support for MD4 hash (deprecated). Webpack 5.54.0+ uses modern hash. Upgrade Webpack or use legacy provider flag.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/69394632/',
    (SELECT id FROM patterns WHERE pattern_name = 'VERSION_REGRESSION')
);

-- npm: ENOENT chmod error
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'npm install error: ENOENT chmod - directory not found',
    'npm',
    'MEDIUM',
    '[
        {"solution": "Create npm directory manually: mkdir -p ~/AppData/Roaming/npm (Windows) or ~/.npm (Mac/Linux)", "percentage": 90, "note": "npm cache directory missing"},
        {"solution": "Reinstall Node.js and npm completely", "percentage": 85, "note": "Corrupted npm installation"},
        {"solution": "Change npm prefix: npm config set prefix ~/.npm-global", "percentage": 75, "note": "Permission issues"}
    ]'::jsonb,
    'npm installed, File system access',
    'npm install works without ENOENT errors, Packages install successfully',
    'ENOENT means "Error NO ENTry" - file or directory does not exist. npm expects cache directory to exist.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/17990647/'
);
