-- Add GCP Cloud Functions common errors and solutions

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'GCP Cloud Functions: Missing iam.serviceAccounts.actAs permission',
    'gcp-functions',
    'HIGH',
    '[
        {"solution": "Grant the Service Account User role (roles/iam.serviceAccountUser) to the deployer account", "percentage": 95, "note": "Official GCP recommendation for deployment permissions"},
        {"solution": "Verify deployer has necessary IAM roles: gcloud projects get-iam-policy PROJECT_ID --flatten=bindings --format=table", "percentage": 90, "command": "gcloud projects get-iam-policy PROJECT_ID"}
    ]'::jsonb,
    'GCP project with Cloud Functions API enabled, Active deployer account, Existing service account',
    'Cloud Function deploys successfully, No permission denied errors in logs',
    'Ensure you are granting roles to the deployer account, not the runtime service account. The Service Account User role must be assigned on the runtime service account.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#deployment-errors'
),
(
    'GCP Cloud Functions: Default runtime service account was not found',
    'gcp-functions',
    'MEDIUM',
    '[
        {"solution": "Specify a custom user-managed runtime service account: gcloud functions deploy FUNCTION_NAME --service-account=SERVICE_ACCOUNT_EMAIL", "percentage": 93, "note": "Create custom service account first if needed"},
        {"solution": "Undelete the default service account: gcloud beta iam service-accounts undelete PROJECT_NUMBER-compute@developer.gserviceaccount.com", "percentage": 88, "note": "May require project-level permissions"}
    ]'::jsonb,
    'GCP project with Cloud Functions API enabled, gcloud CLI configured',
    'Cloud Function deploys with specified service account, No ''service account not found'' errors',
    'Deleting the default compute service account without specifying an alternative breaks function deployment. Always specify an alternative before deleting.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#deployment-errors'
),
(
    'GCP Cloud Functions: HTTP 403 Forbidden - missing Cloud Run Invoker role',
    'gcp-functions',
    'VERY_HIGH',
    '[
        {"solution": "Assign Cloud Run Invoker role (roles/run.invoker) to the caller: gcloud functions add-iam-policy-binding FUNCTION_NAME --member=serviceAccount:EMAIL --role=roles/run.invoker", "percentage": 96, "note": "Most common solution for authenticated functions"},
        {"solution": "Redeploy function with unauthenticated access: gcloud functions deploy FUNCTION_NAME --allow-unauthenticated", "percentage": 90, "note": "Only if function should be publicly accessible"},
        {"solution": "Verify caller''s identity token: gcloud auth print-identity-token", "percentage": 85, "command": "gcloud auth print-identity-token"}
    ]'::jsonb,
    'GCP project with Cloud Functions API enabled, Function already deployed, Client credentials',
    'HTTP 200 response from function endpoint, No 403 Forbidden errors, Function executes successfully',
    'Using access/refresh tokens instead of ID tokens will cause 403 errors. Always use ID tokens for authenticated Cloud Functions.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#serving-runtime-errors'
),
(
    'GCP Cloud Functions: HTTP 401 Unauthorized - invalid authentication credentials',
    'gcp-functions',
    'HIGH',
    '[
        {"solution": "Use Authorization header with ID token: Authorization: Bearer ID_TOKEN obtained from gcloud auth print-identity-token", "percentage": 94, "note": "Replace ID_TOKEN with actual token"},
        {"solution": "Verify JWT audience matches function URL exactly: aud field must be the complete function URL", "percentage": 92, "note": "Common cause of 401 with correct token format"},
        {"solution": "Obtain fresh ID token with correct audience: gcloud auth print-identity-token --audiences=https://REGION-PROJECT_ID.cloudfunctions.net/FUNCTION_NAME", "percentage": 88, "command": "gcloud auth print-identity-token --audiences=https://region-project.cloudfunctions.net/function"}
    ]'::jsonb,
    'GCP project with authenticated Cloud Function, gcloud CLI authenticated, Function URL',
    'HTTP 200 response with Authorization header, Function receives request and executes',
    'Do not use access tokens or refresh tokens - only use ID tokens. JWT audience (aud) field must match the function URL exactly.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#serving-runtime-errors'
),
(
    'GCP Cloud Functions: HTTP 404 - ingress set to allow internal traffic only',
    'gcp-functions',
    'MEDIUM',
    '[
        {"solution": "Change ingress settings to allow all traffic: gcloud functions deploy FUNCTION_NAME --ingress-settings=ALLOW_ALL", "percentage": 95, "note": "Default setting allows external access"},
        {"solution": "Ensure request originates from same project/VPC Service Controls perimeter if using ALLOW_INTERNAL_ONLY", "percentage": 90, "note": "For internal-only functions, verify caller is internal"}
    ]'::jsonb,
    'GCP project with Cloud Functions API enabled, Function deployed with ALLOW_INTERNAL_ONLY',
    'Function accessible from external clients, HTTP 200 response received',
    'ALLOW_INTERNAL_ONLY blocks all external traffic. Remember to set ALLOW_ALL if the function needs external access.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#serving-runtime-errors'
),
(
    'GCP Cloud Functions: Function fails during global scope execution - container healthcheck failed',
    'gcp-functions',
    'HIGH',
    '[
        {"solution": "Review build logs for detailed error messages: gcloud functions describe FUNCTION_NAME --gen2 --region=REGION to see logs", "percentage": 93, "note": "Check Cloud Build logs in Cloud Console"},
        {"solution": "Use lazy initialization for global variables - defer heavy computations to function execution", "percentage": 91, "note": "Global scope runs during container startup"},
        {"solution": "Increase function timeout if global initialization is time-intensive", "percentage": 87, "command": "gcloud functions deploy FUNCTION_NAME --timeout=600s"},
        {"solution": "Verify entry point is correctly specified and function exports it", "percentage": 85, "note": "Must match exact function name in code"}
    ]'::jsonb,
    'GCP project with Cloud Functions Gen2 enabled, Function code, Cloud Build API enabled',
    'Container starts successfully, Function responds to requests, No timeout errors in logs',
    'Code in global scope executes during container initialization. Heavy computations, database connections, or blocking operations will cause startup failures.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#deployment-errors'
),
(
    'GCP Cloud Functions: Serverless VPC Access Connector not found or not ready',
    'gcp-functions',
    'MEDIUM',
    '[
        {"solution": "Verify VPC connector uses /28 subnet mask: gcloud compute networks vpc-access connectors describe CONNECTOR_NAME --region=REGION", "percentage": 94, "note": "Connector requires at least /28 subnet"},
        {"solution": "Ensure connector and function are in the same region", "percentage": 92, "command": "gcloud functions deploy FUNCTION_NAME --vpc-connector=CONNECTOR_NAME --region=SAME_REGION"},
        {"solution": "Grant roles/compute.networkUser to Google Cloud service accounts in Shared VPC setup", "percentage": 88, "note": "Required for cross-project VPC connector access"}
    ]'::jsonb,
    'GCP project with VPC network, Serverless VPC Access API enabled, VPC connector created',
    'Function connects to VPC resources successfully, No ''VPC connector not found'' errors',
    'VPC connector must use /28 subnet (minimum 8 IPs). If using Shared VPC, proper service account permissions are critical.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#serving-runtime-errors'
),
(
    'GCP Cloud Functions: Pending queue request aborted - 429/500 errors under load',
    'gcp-functions',
    'HIGH',
    '[
        {"solution": "Implement exponential backoff and retries on 429/500 responses", "percentage": 93, "note": "Official GCP recommendation"},
        {"solution": "Increase max-instances limit: gcloud functions deploy FUNCTION_NAME --max-instances=1000", "percentage": 92, "command": "gcloud functions deploy FUNCTION_NAME --max-instances=1000"},
        {"solution": "Configure minimum instances to reduce cold start times: gcloud functions deploy FUNCTION_NAME --min-instances=10", "percentage": 88, "note": "Incurs baseline cost but improves performance under spikes"}
    ]'::jsonb,
    'GCP project with Cloud Functions API enabled, Function deployed, Traffic load testing tools',
    'Function handles traffic spikes without 429 errors, Response times stable under load, Max instances not exceeded',
    'Simply increasing max-instances without optimizing code will not solve the problem. Address slow cold starts and high error rates first.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#scalability-errors'
),
(
    'GCP Cloud Functions: Build service account missing permissions - cannot write logs',
    'gcp-functions',
    'MEDIUM',
    '[
        {"solution": "Add Cloud Build Service Account role to default compute service account: gcloud projects add-iam-policy-binding PROJECT_ID --member=serviceAccount:PROJECT_NUMBER@cloudbuild.gserviceaccount.com --role=roles/cloudbuild.builds.editor", "percentage": 94, "note": "Grants Cloud Build service account necessary permissions"},
        {"solution": "Create custom build service account with Artifact Registry and Cloud Storage permissions", "percentage": 90, "note": "Advanced: more granular control over permissions"}
    ]'::jsonb,
    'GCP project with Cloud Functions and Cloud Build APIs enabled, Service account exists',
    'Cloud Function builds and deploys successfully, Build logs appear in Cloud Logging',
    'Build service account permissions must include artifact.registry.writer and storage.objects.get. Insufficient permissions silently fail builds.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#deployment-errors'
),
(
    'GCP Cloud Functions: Function stops or continues past completion - asynchronous tasks',
    'gcp-functions',
    'MEDIUM',
    '[
        {"solution": "Ensure all async tasks complete before returning response - use await for all Promises in Node.js", "percentage": 95, "note": "Most common cause: forgetting to await async calls"},
        {"solution": "Resolve all promises before function termination: await Promise.all([...tasks])", "percentage": 92, "command": "await Promise.all([asyncTask1(), asyncTask2()])"},
        {"solution": "Flush buffered logs before returning to ensure all logs are captured", "percentage": 88, "note": "Applies especially to async logging calls"}
    ]'::jsonb,
    'GCP project with Cloud Functions API enabled, Function with async code',
    'All async tasks complete before function returns, All logs appear in Cloud Logging, Function execution completes cleanly',
    'Cloud Functions container shuts down immediately after function returns - any async tasks still running will be killed.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#function-execution-issues'
),
(
    'GCP Cloud Functions: SMTP port 25 blocked - email delivery fails',
    'gcp-functions',
    'LOW',
    '[
        {"solution": "Use alternate SMTP ports 587 (TLS) or 465 (SSL) instead of port 25", "percentage": 96, "note": "Google Cloud blocks outbound SMTP on port 25 for security"},
        {"solution": "Switch to third-party email service (SendGrid, Mailgun, AWS SES)", "percentage": 94, "note": "More reliable and avoids GCP port restrictions"}
    ]'::jsonb,
    'GCP project with Cloud Functions API enabled, SMTP provider account',
    'Email sends successfully through alternate port, No connection refused errors',
    'Google Cloud blocks TCP port 25 for all outbound traffic. This is a hard restriction and cannot be bypassed by configuration.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#serving-runtime-errors'
),
(
    'GCP Cloud Functions: Missing or incorrect log severity levels in structured logs',
    'gcp-functions',
    'MEDIUM',
    '[
        {"solution": "Send structured log entries with severity metadata instead of only stdout/stderr", "percentage": 94, "note": "Only structured logs support severity filtering"},
        {"solution": "Use Cloud Logging client library to write logs with severity: const logging = new CloudLogging(); logging.log(entry, {severity: ''ERROR''})", "percentage": 92, "command": "Use Cloud Logging client library for structured logs"}
    ]'::jsonb,
    'GCP project with Cloud Logging API enabled, Cloud Logging client library installed',
    'Logs appear in Cloud Logging with correct severity levels, Logs can be filtered by severity',
    'Simple console.log/print statements are captured as text logs without severity. Structured logging is required for proper log categorization.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#logging-errors'
),
(
    'GCP Cloud Functions: Log entries truncated or lost - exceeds 105 KiB limit',
    'gcp-functions',
    'LOW',
    '[
        {"solution": "Ensure individual log entries stay under 105 KiB size limit", "percentage": 96, "note": "Size limit applies to Node.js 10+, Python 3.8+, Go 1.13+, Java 11+"},
        {"solution": "Split large log payloads into multiple smaller log entries if exceeding 105 KiB", "percentage": 93, "note": "Better than losing log data"}
    ]'::jsonb,
    'GCP project with Cloud Functions API enabled, Function generating large logs',
    'All log entries captured in Cloud Logging, No truncated or lost log entries',
    'Log entries larger than 105 KiB will be truncated or lost completely. Plan log payload sizes accordingly.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://docs.cloud.google.com/functions/docs/troubleshooting#logging-errors'
);
