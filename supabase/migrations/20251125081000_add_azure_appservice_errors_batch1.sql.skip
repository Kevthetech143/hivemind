-- Add Azure App Service common errors and troubleshooting solutions batch 1

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'HTTP 502 Bad Gateway in Azure App Service',
    'azure-appservice',
    'HIGH',
    '[
        {"solution": "Check Azure portal service health and verify no ongoing incidents", "percentage": 85, "note": "First step to rule out platform issues"},
        {"solution": "Monitor app memory and CPU usage - if high, scale up App Service plan or add instances", "percentage": 90, "note": "Most common cause is resource exhaustion"},
        {"solution": "Configure auto-healing rules in web.config to recycle worker process based on memory/CPU thresholds", "percentage": 85, "command": "Enable auto-healing: set memory threshold and recycle action"},
        {"solution": "Restart the app from Azure portal (Stop/Start) - fastest recovery method", "percentage": 80, "note": "Process recycling often resolves transient issues"},
        {"solution": "Use Kudu debug console (Advanced Tools) to check application logs and environment", "percentage": 75, "command": "Access via Development Tools > Advanced Tools"}
    ]'::jsonb,
    'Access to Azure Portal, App Service instance',
    'App returns HTTP 200, response time normalizes, no 502 errors in logs',
    'Do not assume 502 always means code error - usually resource exhaustion. Check memory/CPU first. Auto-healing should be configured before issues occur.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/azure/app-service/troubleshoot-http-502-http-503'
),
(
    'HTTP 503 Service Unavailable in Azure App Service',
    'azure-appservice',
    'HIGH',
    '[
        {"solution": "Verify Application Pool is running - stopped pool causes 503", "percentage": 95, "note": "Check pool status in IIS or Azure portal"},
        {"solution": "Check Azure Service Health dashboard for platform-level incidents", "percentage": 85, "note": "May not be application-related"},
        {"solution": "Scale app service plan up or increase instance count if high load detected", "percentage": 85, "note": "Load balancer returns 503 when instances overloaded"},
        {"solution": "Review app diagnostics for application exceptions preventing requests", "percentage": 80, "note": "Use Diagnose and solve problems feature"},
        {"solution": "Restart the app via Azure portal or PowerShell", "percentage": 75, "command": "PowerShell: Restart-AzWebApp -ResourceGroupName <group> -Name <appname>"}
    ]'::jsonb,
    'Azure portal access, sufficient permissions',
    'Application Pool running, requests return 200 status, no 503 in recent logs',
    '503 often temporary - try restart first. Do not scale immediately without checking actual load metrics. Check pool status before investigating application code.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/azure/app-service/troubleshoot-http-502-http-503'
),
(
    'SNAT Port Exhaustion: Intermittent connection timeouts in Azure App Service',
    'azure-appservice',
    'HIGH',
    '[
        {"solution": "Implement connection pooling to reuse connections to same endpoints instead of creating new ones", "percentage": 92, "note": "Most effective solution - reduces SNAT port consumption by 80%+"},
        {"solution": "Use Service Endpoints or Private Endpoints to connect to Azure services - these bypass SNAT entirely", "percentage": 90, "note": "Zero SNAT port cost, recommended for Azure-to-Azure connections"},
        {"solution": "Deploy NAT Gateway to provide 64k ports instead of 128 per instance", "percentage": 88, "note": "Premium solution for high-volume outbound scenarios"},
        {"solution": "Scale horizontally by adding more App Service instances to distribute connection load", "percentage": 85, "note": "Distributes 128 ports across more instances"},
        {"solution": "Check SNAT port usage via Diagnose and Solve Problems > Availability and Performance tile", "percentage": 80, "command": "Portal > Diagnose and Solve Problems > SNAT Port Exhaustion detector"},
        {"solution": "Reduce retry logic aggressiveness and implement keepalive to reset idle timeouts", "percentage": 75, "note": "Prevents premature port exhaustion from failed retries"}
    ]'::jsonb,
    'App Service instance, outbound connectivity to external services, Azure portal access',
    'Outbound connections succeed consistently, no 5xx errors during external API calls, SNAT detector shows healthy port usage',
    'Do not assume high latency is just network - SNAT exhaustion causes timeouts. 128 ports per instance is hard limit. Azure loads 4-minute wait to reclaim closed connections. Connection pooling more effective than increasing instances.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/azure/app-service/troubleshoot-intermittent-outbound-connection-errors'
),
(
    'HTTP Error 500.0: ANCM In-Process Handler Load Failure',
    'azure-appservice',
    'MEDIUM',
    '[
        {"solution": "Verify web.config processPath is correct: use \"dotnet\" for Framework-Dependent Deployment (FDD)", "percentage": 92, "note": "Most common cause - typos in processPath"},
        {"solution": "Install .NET Hosting Bundle matching your runtime version, then restart IIS", "percentage": 90, "command": "Download from https://dotnet.microsoft.com/download/dotnet - select Hosting Bundle"},
        {"solution": "Verify C:\\Program Files\\dotnet\\ is in system PATH environment variable", "percentage": 85, "note": "Hosting bundle installer should add this automatically"},
        {"solution": "For Self-Contained Deployment (SCD), set processPath to \"./{ASSEMBLY_NAME}.exe\"", "percentage": 88, "note": "FDD vs SCD determine processPath value"},
        {"solution": "Check event logs: Windows Event Viewer > Windows Logs > Application for detailed error codes", "percentage": 80, "command": "Search Event Viewer for error codes like 0x80070002 or 0x8000ffff"}
    ]'::jsonb,
    '.NET Hosting Bundle installed, IIS with ASP.NET Core module, web.config present',
    'App loads successfully, HTTP 200 response, no errors in Event Viewer',
    'Do not confuse FDD processPath (\"dotnet\") with SCD processPath (\"./app.exe\"). Ensure Hosting Bundle version matches .NET version. IIS restart required after installation.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/azure-iis-errors-reference?view=aspnetcore-9.0'
),
(
    'HTTP Error 500.19: Invalid Configuration in web.config',
    'azure-appservice',
    'MEDIUM',
    '[
        {"solution": "Ensure ApplicationPoolIdentity has read/write permissions to deployment folder", "percentage": 92, "note": "Most common cause - HRESULT 0x80070005 (Access Denied)"},
        {"solution": "Verify all required IIS roles are installed: Web Server, ASP.NET Core Module", "percentage": 88, "note": "Some shared hosting may lack modules - contact provider"},
        {"solution": "Check sub-application web.config - remove handlers section if present (parent app handles it)", "percentage": 85, "note": "Sub-apps inherit parent handlers, declaring them again causes conflict"},
        {"solution": "Validate web.config XML syntax using XML validator or IIS Configuration Editor", "percentage": 82, "note": "Common typos in XML tags cause 500.19"},
        {"solution": "Set Application Pool Identity to ApplicationPoolIdentity instead of custom identity", "percentage": 80, "note": "If using custom identity, verify it has deployment folder permissions"}
    ]'::jsonb,
    'IIS installed, Application Pool configured, web.config file present',
    'App loads without 500.19 error, Event Viewer shows no configuration errors, permissions verified',
    'Do not modify sub-app web.config handlers - inherit from parent. Custom identity permissions often overlooked. Always validate XML before deployment.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/azure-iis-errors-reference?view=aspnetcore-9.0'
),
(
    'HTTP Error 502.5: Process Failure - .NET Framework/Runtime Mismatch',
    'azure-appservice',
    'MEDIUM',
    '[
        {"solution": "Verify Runtime Identifier (RID) matches platform bitness: win-x64 for 64-bit, win-x86 for 32-bit", "percentage": 92, "note": "Mismatched RID is primary cause - check app pool bitness"},
        {"solution": "Check Application Pool 32-bit setting: Enable 32-bit if deploying x86 app, disable for x64", "percentage": 90, "note": "Azure portal: App Service > Configuration > Platform settings"},
        {"solution": "Delete residual assemblies from wwwroot folder before re-deploying", "percentage": 85, "note": "Old DLLs can conflict with new version"},
        {"solution": "Verify deployed .NET runtime version matches application target framework", "percentage": 85, "command": "Run: dotnet --list-runtimes on deployment target"},
        {"solution": "Test locally on Kestrel to isolate IIS/hosting issues from code issues", "percentage": 80, "note": "Local testing confirms app logic vs hosting config problem"}
    ]'::jsonb,
    'Access to IIS configuration or Azure portal, .NET runtime installed, application binaries',
    'Process starts successfully, HTTP 200 response, no process-related errors in logs',
    'Do not overlook RID mismatch - easy to miss when publishing. 32-bit/64-bit setting must match deployment. Always clean old artifacts before deployment.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/azure-iis-errors-reference?view=aspnetcore-9.0'
),
(
    'Diagnostic Logging Disabled After 12 Hours: Application Logging to Filesystem',
    'azure-appservice',
    'MEDIUM',
    '[
        {"solution": "Use Blob Storage instead of Filesystem for persistent logging beyond debugging windows", "percentage": 92, "note": "Filesystem logging auto-disables after 12 hours to prevent disk space issues"},
        {"solution": "If using Filesystem logging for debugging, enable it immediately before reproducing issue", "percentage": 85, "note": "Only use for short-term troubleshooting, not production"},
        {"solution": "For production, integrate Application Insights or external logging service (Serilog, NLog to blob)", "percentage": 88, "note": "Application Insights is Azure-native best practice"},
        {"solution": "For non-.NET apps (Java, PHP, Node, Python), implement custom logging to blob storage", "percentage": 80, "note": "Only .NET natively supports blob app logs without custom code"},
        {"solution": "Set blob retention policy to auto-delete old logs and prevent unexpected storage costs", "percentage": 78, "note": "Orphaned logs continue accruing charges"}
    ]'::jsonb,
    'Azure Storage account (if using blob logging), logging feature access in portal',
    'Logs persist beyond 12 hours, logs accessible via portal or storage explorer, retention policy working',
    'Filesystem logging auto-disables - do not rely on it. Only Java/PHP/Node.js/Python support file system logging, not blob. Set retention to avoid orphaned data charges.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/azure/app-service/troubleshoot-diagnostic-logs'
),
(
    'Storage Account Key Regeneration: Logging Stops Immediately',
    'azure-appservice',
    'LOW',
    '[
        {"solution": "After regenerating storage account access key, disable logging feature in App Service, save, then re-enable", "percentage": 95, "note": "Forces App Service to fetch updated credentials"},
        {"solution": "Alternatively, update storage connection string in web.config or environment variables with new key", "percentage": 88, "note": "If custom logging code implements storage access"},
        {"solution": "Verify new key is correctly added to App Service configuration (Connection strings or app settings)", "percentage": 85, "note": "Portal: Configuration > Connection strings - verify key value"},
        {"solution": "Check app logs immediately after re-enabling to confirm logging resumed successfully", "percentage": 82, "command": "Navigate to: Log Stream or Blob > storage logs in portal"}
    ]'::jsonb,
    'Azure Storage account owner/contributor permissions, App Service logging enabled',
    'Logging resumes successfully after key rotation, new logs appear in blob storage or filesystem',
    'Never regenerate storage key without disabling/re-enabling logging. App Service caches credentials - rotation requires refresh. Custom logging code needs manual key updates.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/azure/app-service/troubleshoot-diagnostic-logs'
),
(
    'TCP Connection Limit Exceeded: 5xx Errors During High Load',
    'azure-appservice',
    'MEDIUM',
    '[
        {"solution": "Scale up App Service plan tier to increase connection limits: A1=1920, A2=3968, A3=8064, Isolated=16000", "percentage": 90, "note": "Hard connection limit per instance based on plan size"},
        {"solution": "Scale horizontally by adding more instances to distribute connections across workers", "percentage": 88, "note": "Each instance gets full connection limit"},
        {"solution": "Implement connection pooling in database/external service connections", "percentage": 85, "note": "Reduces unique connection count dramatically"},
        {"solution": "Reduce maximum concurrent connections in application code and connection string pools", "percentage": 80, "note": "Set max pool size appropriate to tier limits"},
        {"solution": "Monitor TCP connection count via Diagnose and Solve Problems > TCP connections detector", "percentage": 78, "command": "Portal: Diagnose and Solve Problems > search \"TCP connections\""}
    ]'::jsonb,
    'Azure portal access, visibility into application connection logic',
    'No connection limit errors, successful request processing under load, TCP detector shows healthy usage',
    'Connection limit is hard ceiling, not soft limit. Plan size directly determines limit - cannot exceed with config alone. Pooling and scaling are only solutions.',
    0.84,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/azure/app-service/troubleshoot-intermittent-outbound-connection-errors'
),
(
    'Incorrect IIS Physical Path: 403 Forbidden or 404 Not Found',
    'azure-appservice',
    'LOW',
    '[
        {"solution": "Verify IIS physical path points to directory where app binaries actually exist", "percentage": 95, "note": "Most common cause - deployment path mismatch"},
        {"solution": "Confirm deployed application files exist in configured physical path using Kudu console", "percentage": 90, "command": "Access Kudu: Advanced Tools > Debug Console > verify file structure"},
        {"solution": "Check file permissions: ApplicationPoolIdentity must have read access to physical path", "percentage": 88, "note": "Right-click folder > Properties > Security > Verify permissions"},
        {"solution": "For Azure, use default physical path or verify custom path during app creation", "percentage": 85, "note": "Azure typically uses D:\\home\\site\\wwwroot as default"}
    ]'::jsonb,
    'IIS configured, application files deployed, folder permissions configured',
    'App responds with HTTP 200, files are accessible, no 403 or 404 errors',
    'Do not assume application is broken - check path first. Always verify files exist before debugging code. Permissions often overlooked.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/azure-iis-errors-reference?view=aspnetcore-9.0'
),
(
    'stdoutLogFile Path Does Not Exist: Cannot Create Log Directory',
    'azure-appservice',
    'LOW',
    '[
        {"solution": "Create the stdoutLogFile directory before app starts: mkdir logs in wwwroot", "percentage": 94, "note": "App process cannot create parent directories"},
        {"solution": "Grant ApplicationPoolIdentity full write permissions to log directory", "percentage": 92, "note": "HRESULT 0x80070005 = insufficient permissions"},
        {"solution": "In web.config aspNetCore element, use relative path like \"./logs/stdout\"", "percentage": 88, "note": "Relative to wwwroot makes path portable"},
        {"solution": "Disable stdout logging in production (stdoutLogEnabled=\"false\") to avoid disk space issues", "percentage": 85, "note": "Logs grow unbounded - only enable when debugging"}
    ]'::jsonb,
    'IIS with ASP.NET Core module, web.config with aspNetCore element',
    'Log directory exists and is writable, stdout logs appear when enabled, no file permission errors',
    'Directory must exist before app starts - App Service cannot auto-create. Permissions critical - easy to miss. Disable stdout logging in production.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/azure-iis-errors-reference?view=aspnetcore-9.0'
)
ON CONFLICT DO NOTHING;
