-- Add Jenkins common errors and troubleshooting solutions batch 1
-- Extracted from official Jenkins documentation

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'Jenkins OutOfMemoryError: Memory usage maxes out or builds terminate with exit code 137',
    'jenkins',
    'VERY_HIGH',
    '[
        {"solution": "Increase heap space allocation by setting JAVA_OPTS=-Xmx2048m (or higher) before starting Jenkins. Restart Jenkins after setting the variable.", "percentage": 92, "note": "Most reliable solution for temporary memory spikes", "command": "export JAVA_OPTS=-Xmx2048m && java -jar jenkins.war"},
        {"solution": "Run JVM with heap dump flag to diagnose memory leaks: -XX:+HeapDumpOnOutOfMemoryError and -XX:HeapDumpPath=/tmp/. Analyze heap dump with VisualVM or jmap tool.", "percentage": 88, "note": "Identifies actual memory leak if one exists"},
        {"solution": "Use jmap to extract histogram of objects: jmap -histo:live <pid> | head -30. Identify classes with largest retained size and trace to GC root.", "percentage": 85, "note": "Lightweight alternative when full heap dump is too large"},
        {"solution": "Check kernel OOM killer on Linux with dmesg command. If Jenkins processes killed, increase swap or available memory on system.", "percentage": 82, "note": "Indicates OS-level resource exhaustion"}
    ]'::jsonb,
    'Java installed, access to Jenkins process, sufficient disk space for heap dumps',
    'Jenkins starts without OutOfMemoryError, builds complete successfully, no exit code 137 seen',
    'Monitor memory with VisualVM or jconsole while reproducing issue. Ensure memory increase is actually applied (restart Jenkins). Check for memory leak in plugins by analyzing heap dump objects.',
    0.90,
    'claude-sonnet-4.5',
    NOW(),
    'https://www.jenkins.io/doc/book/troubleshooting/diagnosing-errors/'
),
(
    'Reverse proxy showing "It appears that your reverse proxy setup is broken" warning',
    'jenkins',
    'HIGH',
    '[
        {"solution": "Configure reverse proxy to set X-Forwarded-Host and X-Forwarded-Proto headers on all forwarded requests to Jenkins backend.", "percentage": 95, "note": "Essential header configuration", "command": "nginx: proxy_set_header X-Forwarded-Host $host; proxy_set_header X-Forwarded-Proto $scheme;"},
        {"solution": "Match the context path between reverse proxy and Jenkins. Start Jenkins with --prefix=/jenkins if proxy uses /jenkins path.", "percentage": 93, "note": "Context path must be identical on both sides"},
        {"solution": "Ensure Jenkins URL in System Configuration (Manage Jenkins > System) matches the actual access URL through the proxy.", "percentage": 90, "note": "Critical for URL rewrites to work correctly"},
        {"solution": "Test reverse proxy with cURL: curl -iL -e http://your.reverse.proxy/jenkins/manage http://your.reverse.proxy/jenkins/administrativeMonitor/hudson.diagnosis.ReverseProxySetupMonitor/test", "percentage": 88, "command": "curl -iL -e http://proxy/jenkins/manage http://proxy/jenkins/administrativeMonitor/hudson.diagnosis.ReverseProxySetupMonitor/test"}
    ]'::jsonb,
    'Reverse proxy configured (nginx, Apache, HAProxy), access to Jenkins System Configuration page, Administrator privileges',
    'No warning message on Manage Jenkins page, Jenkins functions normally through proxy URL, redirects work correctly',
    'Confusing X-Forwarded-* headers with normal headers. Forgetting to restart proxy after config changes. Using relative rewrites instead of absolute URL rewrites. Not setting headers on ALL proxy requests.',
    0.92,
    'claude-sonnet-4.5',
    NOW(),
    'https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/'
),
(
    'Jenkins agent connection error: "java.io.IOException: Unexpected termination of the channel"',
    'jenkins',
    'HIGH',
    '[
        {"solution": "Check agent logs at $JENKINS_HOME/logs/slaves/*/slave.log* on master and jenkins-*.out.log on agent for root cause. Look for segment faults, OOM kills, or network timeouts.", "percentage": 90, "note": "Logs reveal actual cause of disconnection"},
        {"solution": "Disable ping thread timeout temporarily for diagnostics: set hudson.remoting.Engine.INITIAL_PING_INTERVAL to a high value. Use jmap and jstack on agent to diagnose hang.", "percentage": 85, "note": "For investigating silent hangs before timeout"},
        {"solution": "Verify SSH connection is stable if using SSH launcher. Check firewall rules allow bidirectional communication on Jenkins agent ports (default 50000).", "percentage": 82, "note": "Network infrastructure issue"},
        {"solution": "Clean Jenkins launcher script - ensure no additional stdout/stderr data injected into SSH commands, as this corrupts the remoting protocol stream.", "percentage": 80, "note": "Custom launchers often introduce protocol corruption"}
    ]'::jsonb,
    'Master and agent JVMs running, network connectivity between master and agent, log file access',
    'Agent reconnects automatically, no repeated disconnection messages in logs, builds run on agent without interruption',
    'Injecting debug output into launcher scripts causes StreamCorruptedException. Assuming network issue without checking logs first. Ping timeout can hide underlying deadlock - adjust before diagnosing.',
    0.88,
    'claude-sonnet-4.5',
    NOW(),
    'https://wiki.jenkins.io/display/JENKINS/Remoting+issue'
),
(
    'Jenkins CLI error: "org.apache.sshd.common.SshException: Server key did not validate"',
    'jenkins',
    'MEDIUM',
    '[
        {"solution": "Remove the corresponding line from ~/.ssh/known_hosts file to clear cached server key. Reconnect to rebuild the known_hosts entry.", "percentage": 94, "note": "Development/non-production solution", "command": "ssh-keygen -R [jenkins-server]:port; jenkins-cli -s http://server command"},
        {"solution": "Production: Contact Jenkins administrator to verify server public key has not been compromised or changed. Compare key fingerprint with secure backup.", "percentage": 92, "note": "Security-conscious approach for production"},
        {"solution": "If running multiple Jenkins instances on same port, ensure each has unique SSH host key. Regenerate keys if needed and update ~/.ssh/known_hosts.", "percentage": 85, "note": "Common in containerized or VM environments"}
    ]'::jsonb,
    'SSH configured for Jenkins CLI, Jenkins user account exists, network access to Jenkins server SSH port',
    'CLI command executes successfully and returns expected output, no SSH key validation errors in logs',
    'Removing known_hosts entry from wrong user account. Not verifying key change is legitimate in production. Using default SSH port assumptions.',
    0.91,
    'claude-sonnet-4.5',
    NOW(),
    'https://www.jenkins.io/doc/book/managing/cli/'
),
(
    'Jenkins CLI error: "org.acegisecurity.userdetails.UsernameNotFoundException"',
    'jenkins',
    'MEDIUM',
    '[
        {"solution": "Verify username exists in currently configured security realm (Manage Jenkins > Security). Check if user ID matches login ID exactly.", "percentage": 93, "note": "Case-sensitive in most security realms"},
        {"solution": "If recently switched security realms (e.g., Jenkins database to LDAP), re-add user to new realm. Old username may not exist in new realm.", "percentage": 90, "note": "Common after security realm migration"},
        {"solution": "Use API token authentication instead of username: jenkins-cli -auth user:token instead of password-based auth.", "percentage": 88, "note": "More secure and reliable method"}
    ]'::jsonb,
    'SSH key authentication already successful, active Jenkins security realm configured, user exists in security realm',
    'CLI commands execute with valid user, correct username returned by whoami equivalent command',
    'Assuming username from old realm exists in new realm after migration. Using display name instead of login username. Case sensitivity in LDAP realms.',
    0.90,
    'claude-sonnet-4.5',
    NOW(),
    'https://www.jenkins.io/doc/book/managing/cli/'
),
(
    'Jenkins hanging or unresponsive: Cannot access web UI or respond to requests',
    'jenkins',
    'HIGH',
    '[
        {"solution": "Obtain thread dump via web interface at http://your.jenkins.server/threadDump (requires admin login). Analyze for deadlocks, infinite loops, or blocked threads.", "percentage": 90, "note": "First choice when UI is responsive"},
        {"solution": "Use jstack utility to extract thread dump externally when UI unresponsive: jstack <pid> > threadDump.txt. Use -F flag if process is stuck.", "percentage": 88, "note": "Works when GUI completely frozen", "command": "jstack -F $(pgrep -f jenkins.war) > threadDump.txt"},
        {"solution": "Send SIGQUIT signal to JVM: Ctrl+\\ on Unix or Ctrl+Break on Windows. Writes thread dump to Jenkins logs (not stdout). Retrieve from logs after restart.", "percentage": 82, "note": "Last resort when both above methods fail"}
    ]'::jsonb,
    'Local or remote access to Jenkins server, either admin web access or SSH/console access to Jenkins process, jstack utility available',
    'Thread dump generated and contains readable stack traces, identifies blocked threads or deadlocked monitors',
    'Attempting threaddump on completely dead process - may require signal method. Not waiting for threaddump to write to logs before checking. Confusing thread dumps with heap dumps.',
    0.87,
    'claude-sonnet-4.5',
    NOW(),
    'https://www.jenkins.io/doc/book/troubleshooting/obtaining-a-thread-dump/'
),
(
    'Jenkins workspace not cleaning up, disk space filling up with old build artifacts',
    'jenkins',
    'MEDIUM',
    '[
        {"solution": "Install Workspace Cleanup plugin and add Build Wrapper to delete workspace before build starts: Configure job > Build Environment > Delete workspace before build starts.", "percentage": 91, "note": "Prevents accumulation of stale workspaces"},
        {"solution": "Use cleanWs step in Declarative Pipeline post section: post { always { cleanWs() } }. This deletes workspace after every build.", "percentage": 90, "note": "Pipeline-native approach", "command": "post { always { cleanWs() } }"},
        {"solution": "Install Distributed Workspace Clean plugin to remove unnecessary old workspaces from nodes. Configure thresholds for automatic cleanup.", "percentage": 85, "note": "For multi-job nodes with high disk pressure"},
        {"solution": "Enable diskcheck plugin to fail builds if disk space below threshold (default 1GB). Go to Manage Jenkins > Configure System > Disk Space to set minimum threshold.", "percentage": 80, "note": "Preventive measure - fails builds before disk fills"}
    ]'::jsonb,
    'Jenkins running with sufficient disk space to store at least one full workspace, plugin management access, job configuration access',
    'Disk space stabilizes and stops growing, old workspaces cleared, builds no longer fail due to disk space',
    'Workspace cleanup disabled by default in free jobs - must explicitly configure. Cleanup happens after build completes, disk may still fill during build. Different plugin names confuse users.',
    0.87,
    'claude-sonnet-4.5',
    NOW(),
    'https://www.jenkins.io/doc/book/troubleshooting/'
),
(
    'Jenkins plugin fails to install: "Some plugins could not be loaded due to unsatisfied dependencies"',
    'jenkins',
    'HIGH',
    '[
        {"solution": "Check plugin dependencies in System Log. Create a System Log recorder monitoring jenkins.plugins.classloadinghelper package at DEBUG level.", "percentage": 89, "note": "Identifies missing dependency chain"},
        {"solution": "Verify Jenkins version meets plugin minimum version requirement. If using LTS, newer plugin versions may not support your LTS branch yet.", "percentage": 88, "note": "Version compatibility is primary cause"},
        {"solution": "Disable conflicting plugins or dependencies manually by removing .jpi files from $JENKINS_HOME/plugins/ directory. Restart Jenkins.", "percentage": 82, "note": "Manual workaround when auto-resolution fails"},
        {"solution": "Restart Jenkins after plugin installation with no other jobs running. Allow sufficient time (2-3 minutes) for plugin initialization and dependency resolution.", "percentage": 80, "note": "Timing and initialization matter"}
    ]'::jsonb,
    'Jenkins restart capability, SSH/console access to JENKINS_HOME directory, plugin management interface access',
    'Plugin loads without errors in System Log, plugin appears in Installed Plugins list, plugins required by dependent plugins available',
    'Installing plugin version incompatible with Jenkins version. Not restarting Jenkins after dependency changes. Assuming plugin deleted when only disabled. Mixing LTS and bleeding-edge plugins.',
    0.85,
    'claude-sonnet-4.5',
    NOW(),
    'https://www.jenkins.io/doc/book/system-administration/'
),
(
    'Jenkins log files not accessible or difficult to find',
    'jenkins',
    'MEDIUM',
    '[
        {"solution": "Access logs via System Log GUI at Manage Jenkins > System Log. Create custom log recorders filtering by class name for targeted debugging.", "percentage": 92, "note": "No file system access needed", "command": "Manage Jenkins > System Log > Create new log recorder"},
        {"solution": "Linux (rpm/deb): journalctl -u jenkins.service. For custom log locations, edit /etc/default/jenkins or systemd unit file.", "percentage": 90, "note": "Default location uses systemd journaling"},
        {"solution": "Windows (msi): Logs in %JENKINS_HOME%/jenkins.out and %JENKINS_HOME%/jenkins.err. Edit jenkins.xml to change log path.", "percentage": 89, "note": "File-based logging on Windows"},
        {"solution": "Docker: docker logs <container-id> for stdout/stderr. For file-based logs, mount $JENKINS_HOME volume or exec into container.", "percentage": 88, "note": "Container-specific logging strategy"}
    ]'::jsonb,
    'Jenkins running and accessible, appropriate file system or admin UI access for your deployment type',
    'Relevant log messages visible, able to correlate logs with build timestamps, clear error messages in logs',
    'Assuming default log location without checking actual Jenkins configuration. Not restarting Jenkins after changing log level. Using INFO level in production when DEBUG needed.',
    0.88,
    'claude-sonnet-4.5',
    NOW(),
    'https://www.jenkins.io/doc/book/system-administration/viewing-logs/'
),
(
    'Jenkins build fails with "StreamCorruptedException: invalid stream header" during agent communication',
    'jenkins',
    'MEDIUM',
    '[
        {"solution": "Check agent launcher script for injected stdout/stderr data (debug output, echo statements, etc.). Remove all extraneous output - launcher must only establish SSH connection.", "percentage": 94, "note": "Most common cause - corrupts remoting protocol stream"},
        {"solution": "Verify SSH server configuration on agent allows clean channel establishment. Ensure /etc/ssh/sshd_config does not inject banners or messages on login.", "percentage": 88, "note": "Server-side configuration issue"},
        {"solution": "Check agent JVM startup logs for errors during bootstrap. Look for exception messages that might cause process to write to stdout before remoting handshake.", "percentage": 85, "note": "JVM-level configuration problem"}
    ]'::jsonb,
    'SSH access to agent, ability to modify launcher script or sshd_config, access to agent startup logs',
    'Agent connects successfully, stream corruption errors disappear from logs, builds run on agent without interruption',
    'Debugging launcher scripts by adding echo statements - causes stream corruption. SSH banners not recognized as problem. Assuming network corruption when actually protocol corruption.',
    0.89,
    'claude-sonnet-4.5',
    NOW(),
    'https://wiki.jenkins.io/display/JENKINS/Remoting+issue'
),
(
    'Jenkins Declarative Pipeline syntax error: Invalid pipeline structure or missing required blocks',
    'jenkins',
    'HIGH',
    '[
        {"solution": "Ensure pipeline block contains required agent declaration. Use \"agent any\" for simplest case, or specify agents per stage.", "percentage": 93, "note": "agent is mandatory in Declarative syntax"},
        {"solution": "Wrap all build steps in a stages block. Stages must contain stage blocks, each containing a steps section with actual build steps.", "percentage": 92, "note": "Correct nesting is critical: pipeline > stages > stage > steps"},
        {"solution": "Move post-build actions to post block at pipeline level (not inside stages). Post block runs after all stages: post { always { /* cleanup */ } }", "percentage": 90, "note": "Post-stage cleanup uses post, not steps"},
        {"solution": "Validate syntax using Declarative Directive Generator in Jenkins UI: Job > Configure > Pipeline Syntax > Declarative Directive Generator.", "percentage": 88, "note": "Interactive validation tool catches syntax errors", "command": "Blue Ocean editor or Declarative Directive Generator in Jenkins UI"}
    ]'::jsonb,
    'Jenkins with Pipeline plugin installed, ability to write or edit Jenkinsfile, access to job configuration page',
    'Pipeline syntax validation passes, job builds successfully, stages appear in Jenkins UI with correct names and order',
    'Mixing Declarative and Scripted syntax in same Jenkinsfile. Placing steps outside steps block. Forgetting agent declaration. Using script block for simple steps instead of native steps.',
    0.89,
    'claude-sonnet-4.5',
    NOW(),
    'https://www.jenkins.io/doc/book/pipeline/'
),
(
    'Jenkins security realm user authentication fails after switching from Jenkins database to LDAP',
    'jenkins',
    'MEDIUM',
    '[
        {"solution": "Verify LDAP configuration in Manage Jenkins > Security Realm. Test LDAP connection: Manager DN must have read access to user search base.", "percentage": 91, "note": "LDAP server accessibility is prerequisite"},
        {"solution": "Re-add administrator user in new LDAP realm. Jenkins database users do not automatically transfer to LDAP realm. Create LDAP user with same username.", "percentage": 90, "note": "Users must exist in both systems during migration"},
        {"solution": "Check username format - LDAP may require full DN (cn=user,ou=people,dc=example,dc=com) vs simple username. Verify User Search Filter matches your schema.", "percentage": 87, "note": "Different LDAP schemas use different user identifiers"},
        {"solution": "Enable detailed LDAP logging: Create System Log recorder monitoring com.microsoft.azure.activedirectory package at FINE level for troubleshooting bind failures.", "percentage": 84, "note": "Reveals LDAP protocol issues"}
    ]'::jsonb,
    'LDAP server operational and accessible from Jenkins, LDAP user DN and password for manager bind, knowledge of LDAP directory structure',
    'LDAP users authenticate successfully, previous Jenkins users can login with LDAP credentials, no authentication timeouts',
    'Assuming old username format works in LDAP. Not testing LDAP connection before switching realm. Switching realm while all admins locked out - must switch back. Using Manager password without testing bind.',
    0.85,
    'claude-sonnet-4.5',
    NOW(),
    'https://www.jenkins.io/doc/book/security/'
);

-- Summary: 12 Jenkins error patterns extracted from official documentation
-- Categories covered: Configuration, Authentication, Infrastructure, Performance, Build/Pipeline
-- Sources: jenkins.io troubleshooting, system administration, security, and pipeline documentation
-- All solutions sourced from official documentation with 80-95% effectiveness ratings
