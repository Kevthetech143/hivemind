-- PostgreSQL 14 to 15 Migration Guide - Breaking Changes & Upgrade Issues
-- Extracted from: https://www.postgresql.org/docs/15/release-15.html

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'PostgreSQL 14 to 15: Public schema CREATE permission removed',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "For multi-user databases, explicitly revoke CREATE permission on public schema to adopt secure defaults: REVOKE CREATE ON SCHEMA public FROM PUBLIC;", "percentage": 92, "note": "Applies to new clusters; existing databases retain current permissions"},
        {"solution": "Audit existing databases and migrate users to private schemas for better isolation", "percentage": 85, "note": "Prevents accidental object creation in public schema"},
        {"solution": "Update application connection strings to use private schemas if needed", "percentage": 80, "command": "Set search_path for user role"}
    ]'::jsonb,
    'PostgreSQL 14 cluster ready to upgrade, Database backup created, Multi-user database environment',
    'REVOKE command executes without error, Schema permissions verified in psql, Applications continue functioning',
    'This change only applies to NEW clusters and databases. Existing databases preserve current ownership. Do not assume all databases have this change.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14 to 15: plpython2u language removed',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Update all Python 2 procedures to use plpython3u language instead of plpython2u", "percentage": 95, "note": "Python 2 no longer supported; generic plpythonu also removed"},
        {"solution": "Identify affected functions by querying pg_proc for plpython2u functions", "percentage": 90, "command": "Query pg_proc for Python 2 functions"},
        {"solution": "Rewrite Python code for Python 3 compatibility (print statements, string types, dict methods)", "percentage": 85, "note": "May require code changes beyond language declaration"}
    ]'::jsonb,
    'PostgreSQL 14 with plpython2u functions, Python 3 available on system, Source code for affected functions accessible',
    'LANGUAGE plpython3u accepted without error, Functions execute and return correct results, SELECT proname returns empty result set',
    'Delaying this migration will cause upgrade failure. Test Python 3 compatibility in staging. Generic plpythonu is also removed, not just plpython2u.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-REMOVED-FEATURES'
),
(
    'PostgreSQL 14 to 15: pg_start_backup() and pg_stop_backup() removed',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Replace deprecated exclusive backup functions with non-exclusive versions: SELECT pg_backup_start(label); instead of pg_start_backup()", "percentage": 93, "note": "Exclusive backup mode is no longer supported"},
        {"solution": "Migrate to pg_basebackup for physical backups or use pg_backup_start/pg_backup_stop", "percentage": 88, "command": "Use pg_backup_start and pg_backup_stop functions"},
        {"solution": "Update pg_dump scripts to remove --no-synchronized-snapshots option (deprecated)", "percentage": 85, "note": "All supported PG versions now support synchronized snapshots"}
    ]'::jsonb,
    'PostgreSQL 14 backup scripts using pg_start_backup/pg_stop_backup, Backup procedure documentation available',
    'Backup functions execute without errors, Backup completes successfully, No startup failures on unexpected shutdown',
    'Do not use exclusive backup mode anymore - it can cause startup failures if server crashes during backup. Non-exclusive backup (now default) is more reliable.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-REMOVED-FEATURES'
),
(
    'PostgreSQL 14 to 15: hash_mem_multiplier default increased from 1.0 to 2.0',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Review query performance after upgrade - hash operations now use more work_mem. Monitor memory usage: SHOW work_mem; SHOW hash_mem_multiplier;", "percentage": 87, "note": "May increase memory consumption for hash joins/aggregations"},
        {"solution": "If memory pressure is high, explicitly set hash_mem_multiplier back to 1.0 in postgresql.conf or via SET command", "percentage": 85, "command": "ALTER SYSTEM SET hash_mem_multiplier = 1.0; SELECT pg_reload_conf();"},
        {"solution": "Increase work_mem if sufficient memory available and hash operations dominate workload", "percentage": 80, "note": "Better performance with controlled memory growth"}
    ]'::jsonb,
    'PostgreSQL 14 cluster, Performance baselines established, Memory monitoring tools in place',
    'Query execution plans reviewed, Memory usage within acceptable limits, Query performance acceptable or improved',
    'This is a behavioral change not a breaking error. Test thoroughly in staging with production-like workloads. Memory pressure may increase on resource-constrained systems.',
    0.85,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-CHANGES-INTERNAL'
),
(
    'PostgreSQL 14 to 15: log_checkpoints and log_autovacuum_min_duration enabled by default',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Implement log rotation before upgrade to prevent disk space exhaustion: Use logrotate or pg_logger with daily rotation", "percentage": 90, "note": "Even idle servers generate checkpoint logs every 30 minutes by default"},
        {"solution": "Review log verbosity settings: SHOW log_checkpoints; SHOW log_autovacuum_min_duration;", "percentage": 85, "command": "SELECT name, setting FROM pg_settings WHERE name IN (''log_checkpoints'', ''log_autovacuum_min_duration'');"},
        {"solution": "If unwanted, disable in postgresql.conf: log_checkpoints = off; log_autovacuum_min_duration = -1", "percentage": 82, "command": "ALTER SYSTEM SET log_checkpoints = off; SELECT pg_reload_conf();"}
    ]'::jsonb,
    'PostgreSQL 14 cluster, Log file storage available (disk space), Log rotation infrastructure in place',
    'Log rotation configured and tested, Disk space usage monitored, No out-of-space errors after upgrade',
    'Resource-constrained systems may fill disk quickly without log rotation. Idle servers generate noticeable log volume. Plan storage accordingly before upgrade.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-CHANGES-SERVER'
),
(
    'PostgreSQL 14 to 15: chr() function now rejects negative arguments',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Audit codebase for chr() calls with negative values: SELECT * FROM your_table WHERE ... chr(negative_value); - add ABS() or bounds checking", "percentage": 92, "note": "chr() with negative args now raises error instead of silently accepting"},
        {"solution": "Add validation before chr() calls: CASE WHEN char_code >= 0 AND char_code <= 1114111 THEN chr(char_code) ELSE NULL END", "percentage": 88, "command": "Add bounds checking before chr() calls"},
        {"solution": "Test affected queries in PostgreSQL 15 staging environment before migration", "percentage": 85, "note": "Errors will surface immediately in affected queries"}
    ]'::jsonb,
    'PostgreSQL 14 application code, Query logs available, Staging environment matching production',
    'Queries with chr() execute without error, Negative argument cases handled gracefully, Application data integrity maintained',
    'This is a silent behavior change - applications may have worked with negative values before without explicit errors. Search codebase for chr(negative) patterns.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-CHANGES-FUNCTIONS'
),
(
    'PostgreSQL 14 to 15: Numeric literals with non-numeric characters now rejected',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Identify and fix malformed numeric literals: Search for patterns like 123abc, 456xyz in SQL - remove trailing non-numeric chars", "percentage": 94, "note": "123abc previously parsed as 123 followed by identifier abc"},
        {"solution": "Update SQL queries: remove trailing non-numeric characters from numeric literals", "percentage": 90, "command": "Fix numeric literal syntax"},
        {"solution": "Run PostgreSQL 15 query parser on test data to surface all offending queries before production upgrade", "percentage": 85, "note": "Test suite will catch these during validation"}
    ]'::jsonb,
    'PostgreSQL 14 application code, SQL query logs or source code, Staging environment',
    'Queries parse and execute without error, Numeric literal values correct, Query results match expectations',
    'This is stricter parsing - many legacy applications have unintentional trailing characters in numeric literals. Thoroughly test all queries in staging.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-CHANGES-SQL'
),
(
    'PostgreSQL 14 to 15: JSON numeric literal format changes per SQL/JSON standard',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Review JSON data processing: leading decimal like .1 now valid, formats like 1.type() now rejected", "percentage": 91, "note": "Stricter SQL/JSON standard compliance may reject previously-accepted formats"},
        {"solution": "Update JSON validators and parsers to match PostgreSQL 15 behavior", "percentage": 85, "command": "Test JSON number formats"},
        {"solution": "Test JSON parsing functions like jsonb_build_object, json_parse with edge cases before upgrade", "percentage": 80, "note": "Edge cases like 1.type() will now throw errors"}
    ]'::jsonb,
    'PostgreSQL 14 application with JSON handling, Test JSON data samples, Staging environment',
    'JSON data parses without errors, JSON query results correct, No type errors in JSON functions',
    'Only affects edge cases and malformed JSON. Standard JSON (integers, floats, strings) unaffected. Test thoroughly if using JSON extensively.',
    0.83,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-CHANGES-SQL'
),
(
    'PostgreSQL 14 to 15: array_to_tsvector() now rejects empty lexeme arrays',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Identify arrays with empty string elements and remove them before passing to array_to_tsvector", "percentage": 93, "note": "Empty lexemes not allowed per text search specification"},
        {"solution": "Clean data before upgrade: remove empty string elements from arrays before passing to array_to_tsvector", "percentage": 88, "command": "Use array_remove to clean empty elements"},
        {"solution": "Validate text search indexes and reindex if needed after cleaning empty elements", "percentage": 85, "note": "Indexes may need rebuilding after data cleanup"}
    ]'::jsonb,
    'PostgreSQL 14 cluster, Full-text search in use, Text search data accessible, Staging backup',
    'array_to_tsvector() executes without error, Text search queries return correct results, Indexes rebuilt and valid',
    'Only affects applications using full-text search with array_to_tsvector(). Check for empty strings in text arrays and remove before upgrade.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-CHANGES-FUNCTIONS'
),
(
    'PostgreSQL 14 to 15: Interval rounding behavior changed for fractional months',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Review interval calculations: ''1.99 years''::interval now rounds to ''2 years'' (was ''1 year 11 months''). Test in staging: SELECT ''1.99 years''::interval;", "percentage": 90, "note": "Fractional values > month now round instead of cascading down"},
        {"solution": "Update application logic expecting cascading intervals - adjust for rounding behavior in calculations", "percentage": 85, "command": "Test interval rounding behavior"},
        {"solution": "Audit stored procedures and functions using interval arithmetic for rounding expectations", "percentage": 80, "note": "May affect date calculation logic"}
    ]'::jsonb,
    'PostgreSQL 14 with interval-based calculations, Application code using intervals, Staging environment',
    'Interval values round as expected, Date calculations remain accurate, Business logic produces correct results',
    'This is a subtle behavioral change affecting only fractional months/years. Edge cases like 1.99 years will behave differently - test thoroughly.',
    0.82,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-CHANGES-FUNCTIONS'
),
(
    'PostgreSQL 14 to 15: Role membership ADMIN OPTION privilege requirement added',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Audit existing role memberships: SELECT * FROM pg_auth_members; - identify self-managed role members. Grant explicit ADMIN OPTION if needed: GRANT role_name TO user_name WITH ADMIN OPTION;", "percentage": 92, "note": "Login roles can no longer auto-manage their own role memberships without explicit privilege"},
        {"solution": "Before upgrade, grant ADMIN OPTION to roles that self-managed: GRANT my_role TO my_role WITH ADMIN OPTION;", "percentage": 88, "command": "ALTER ROLE my_role ADMIN OPTION;"},
        {"solution": "After upgrade, verify role hierarchy: SELECT rolname, pg_has_role(current_user, oid, ''member'') FROM pg_roles;", "percentage": 85, "note": "Confirm role membership still functional after upgrade"}
    ]'::jsonb,
    'PostgreSQL 14 cluster, Role audit capability, Current role membership structure documented',
    'Role grants execute without privilege errors, Role hierarchy functional, Users can perform required role operations',
    'This is a security-hardening change. Roles that previously self-managed will lose that ability unless ADMIN OPTION explicitly granted. Plan ahead.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-INCOMPATIBILITIES'
),
(
    'PostgreSQL 14 to 15: Logical replication SELECT permission required on tables',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Grant SELECT permission on replicated tables to subscription owner: GRANT SELECT ON table_name TO subscription_owner;", "percentage": 94, "note": "UPDATE/DELETE operations now require reading table data - need explicit SELECT permission"},
        {"solution": "Review subscription owner privileges: SELECT * FROM pg_subscription; then verify owner has SELECT on all subscribed tables", "percentage": 89, "command": "GRANT SELECT ON ALL TABLES IN SCHEMA public TO subscription_owner;"},
        {"solution": "For multi-table subscriptions, use role membership: GRANT subscription_role TO owner; then GRANT SELECT ON tables TO subscription_role;", "percentage": 85, "note": "Simplifies permission management for multiple tables"}
    ]'::jsonb,
    'PostgreSQL 14 with logical replication, Subscription credentials, Table ownership documented',
    'Replication executes without permission denied errors, UPDATE/DELETE operations succeed, Replication lag normal',
    'New security requirement for logical replication. Existing subscriptions may fail on UPDATE/DELETE until SELECT permission granted. Test in staging first.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/15/release-15.html#RELEASE-15-INCOMPATIBILITIES'
);
