-- Add Supabase Authentication documentation solutions batch 1
-- Mined from: https://supabase.com/docs/guides/auth/troubleshooting
-- Date: 2025-11-24
-- Category: supabase
-- Coverage: JWT errors, email verification, OAuth, password reset, sessions, SMTP, rate limiting, MFA

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'Supabase Auth error 401: invalid claim: missing sub',
    'supabase',
    'HIGH',
    '[
        {"solution": "Ensure JWT token contains all required claims including sub (subject) claim", "percentage": 90, "note": "The sub claim identifies the user and is mandatory"},
        {"solution": "Validate token structure before sending to Supabase Auth API", "percentage": 85, "note": "Check all required claims: iss, aud, exp, iat, sub, role, session_id"},
        {"solution": "Regenerate access token through session refresh", "percentage": 80, "command": "await supabase.auth.refreshSession()"}
    ]'::jsonb,
    'Valid Supabase project, Active user session, JWT signing keys configured',
    'API returns 200 status, Request includes valid sub claim, User authentication succeeds',
    'JWT tokens must include all required claims. Missing sub claim prevents user identification. Always validate token structure before API calls.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/jwt-fields'
),
(
    'Supabase Auth: email_not_confirmed - Email verification required',
    'supabase',
    'HIGH',
    '[
        {"solution": "User must click verification link sent to email before sign-in", "percentage": 95, "note": "Default behavior when email confirmations enabled"},
        {"solution": "Resend confirmation email using: await supabase.auth.resend({ type: ''signup'', email })", "percentage": 90, "command": "await supabase.auth.resend({ type: ''signup'', email: ''user@example.com'' })"},
        {"solution": "Disable email confirmation in Auth settings for development only", "percentage": 75, "note": "Not recommended for production"}
    ]'::jsonb,
    'Supabase Auth configured, Email confirmation enabled, SMTP configured',
    'User receives verification email, Email link redirects successfully, User can sign in after verification',
    'Email confirmations are required by default. Users cannot sign in until email is verified. Check spam folder if email not received. Default SMTP only sends to project team members - configure custom SMTP for production.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/troubleshooting'
),
(
    'Supabase OAuth error: bad_oauth_state - Provider integration issue',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Verify redirect URL in OAuth provider settings matches exactly what is configured in Supabase Auth", "percentage": 90, "note": "Case-sensitive match required including protocol and path"},
        {"solution": "Check OAuth state parameter is properly passed through flow", "percentage": 85, "note": "State prevents CSRF attacks and must be validated"},
        {"solution": "Clear browser cookies and retry OAuth flow", "percentage": 75, "note": "Stale state tokens can cause this error"}
    ]'::jsonb,
    'OAuth provider configured, Client ID and secret set, Redirect URLs registered',
    'OAuth flow completes successfully, User redirected to application, Access token received',
    'Redirect URLs must match exactly - no trailing slashes or protocol differences. OAuth state expires after short period. Provider credentials must be correct.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/social-login'
),
(
    'Supabase Auth: provider_email_needs_verification',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "OAuth provider did not verify user email - verification email sent by Supabase", "percentage": 95, "note": "User must verify email through Supabase even after OAuth"},
        {"solution": "User clicks verification link in email sent by Supabase Auth", "percentage": 90, "note": "Required before full access granted"},
        {"solution": "Request email scope from OAuth provider to receive pre-verified emails", "percentage": 80, "note": "Provider-specific configuration"}
    ]'::jsonb,
    'OAuth provider configured, Email scope requested, Custom SMTP configured for production',
    'User verifies email via link, OAuth sign-in completes successfully, User profile includes verified email',
    'Some OAuth providers do not verify emails before passing them to Supabase. User must complete email verification even after successful OAuth. This is a security feature, not a bug.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/debugging/error-codes'
),
(
    'Supabase Auth: session_expired - Session exceeded limits',
    'supabase',
    'HIGH',
    '[
        {"solution": "Implement automatic session refresh before JWT expiration", "percentage": 95, "note": "Supabase client libraries handle this automatically if configured"},
        {"solution": "Use default 1-hour JWT expiration to prevent clock skew issues", "percentage": 90, "note": "Avoid setting JWT expiration under 5 minutes"},
        {"solution": "Check session validity: const { data: { session } } = await supabase.auth.getSession()", "percentage": 85, "command": "const { data: { session } } = await supabase.auth.getSession()"}
    ]'::jsonb,
    'Active Supabase session, JWT expiration configured, Auto-refresh enabled in client',
    'Session refreshes automatically, New access token received, API requests succeed',
    'JWT expiration under 5 minutes causes excessive server load and clock skew errors. Sessions expire after inactivity timeout, password changes, or sign-out. Client libraries refresh ahead of expiration automatically.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/sessions'
),
(
    'Supabase Auth: refresh_token_already_used - Token reuse detected',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Wait 10 seconds before retrying - tokens can be reused within this window", "percentage": 90, "note": "Legitimate for SSR serialization delays"},
        {"solution": "Implement proper session storage to prevent duplicate refresh attempts", "percentage": 85, "note": "Common in React strict mode or concurrent requests"},
        {"solution": "Check for unauthorized access - this may indicate token theft", "percentage": 80, "note": "Triggers full session revocation for security"}
    ]'::jsonb,
    'Active session, Refresh token stored securely, Single refresh attempt per expiration',
    'Token refresh succeeds, New refresh token received, No duplicate refresh attempts',
    'Refresh tokens can be reused within 10-second interval for legitimate SSR cases. Outside this window, reuse triggers security revocation. Check app for concurrent refresh attempts or React strict mode issues.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/sessions'
),
(
    'Supabase Auth SMTP: email_address_not_authorized',
    'supabase',
    'VERY_HIGH',
    '[
        {"solution": "Configure custom SMTP provider - default SMTP only sends to project team members", "percentage": 95, "note": "Required for production use"},
        {"solution": "Add SMTP settings in Auth configuration: host, port, username, password, sender email", "percentage": 90, "note": "Supports Resend, AWS SES, Postmark, SendGrid, and others"},
        {"solution": "Increase rate limits after custom SMTP setup via Rate Limits page", "percentage": 85, "note": "Default: 30 emails/hour, can be increased"}
    ]'::jsonb,
    'Custom SMTP provider account, SMTP credentials, DNS records configured (DKIM, SPF, DMARC)',
    'Emails sent to any address successfully, Email rate limit increased, Deliverability improved',
    'Default Supabase SMTP is NOT for production - only sends to team members. Rate limit is 2 emails/hour on default SMTP. Custom SMTP required for sending verification emails to users.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/auth-smtp'
),
(
    'Supabase Auth: over_request_rate_limit - Too many requests by IP',
    'supabase',
    'HIGH',
    '[
        {"solution": "Audit application for unintended repeated API calls - indicates potential bugs", "percentage": 90, "note": "Common in React useEffect without dependencies"},
        {"solution": "Implement exponential backoff for retry logic", "percentage": 85, "note": "Wait 1s, 2s, 4s, 8s before retries"},
        {"solution": "Enable CAPTCHA protection to prevent bot abuse", "percentage": 80, "note": "Reduces automated request spam"}
    ]'::jsonb,
    'Supabase project configured, Client library properly implemented, IP address not blocked',
    'Request rate decreases to normal levels, API returns 200 instead of 429, No repeated unnecessary calls',
    'Rate limit errors (429) often indicate application bugs causing excessive requests. Check React hooks, event listeners, and polling logic. Do not simply increase rate limits without fixing root cause.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/debugging/error-codes'
),
(
    'Supabase Auth: weak_password - Password does not meet requirements',
    'supabase',
    'HIGH',
    '[
        {"solution": "Use AuthWeakPasswordError to access detailed validation messages", "percentage": 95, "note": "Provides specific reasons for rejection"},
        {"solution": "Implement password strength indicator using weak_password error details", "percentage": 90, "note": "Show users requirements before submission"},
        {"solution": "Check password policy in Auth settings: minimum length, special characters", "percentage": 85, "note": "Default requires 6+ characters"}
    ]'::jsonb,
    'Password policy configured in Supabase Auth settings, Client validates before submission',
    'Password meets all requirements, User registration succeeds, AuthWeakPasswordError not thrown',
    'Use error.code === ''weak_password'' to detect. Cast to AuthWeakPasswordError for detailed validation messages. Password requirements configurable per project.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/debugging/error-codes'
),
(
    'Supabase Auth MFA: insufficient_aal - Higher authentication level required',
    'supabase',
    'MEDIUM',
    '[
        {"solution": "Challenge user with MFA verification: await supabase.auth.mfa.challenge({ factorId })", "percentage": 95, "note": "Required when user has MFA enrolled"},
        {"solution": "Verify MFA code: await supabase.auth.mfa.verify({ factorId, challengeId, code })", "percentage": 90, "note": "User enters TOTP code from authenticator app"},
        {"solution": "Check current AAL level: const { data: { session } } = await supabase.auth.getSession(); console.log(session.aal)", "percentage": 85, "command": "console.log(session.aal)"}
    ]'::jsonb,
    'MFA enabled on project, User enrolled in MFA, Factor ID available',
    'AAL level upgrades from aal1 to aal2, User gains access to protected resources, Challenge verification succeeds',
    'AAL1 = single-factor (password), AAL2 = multi-factor. MFA enforcement requires explicit challenge flow. Session AAL does not automatically upgrade.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/debugging/error-codes'
),
(
    'Supabase Auth: otp_expired - One-time password code expired',
    'supabase',
    'HIGH',
    '[
        {"solution": "Request new OTP code: await supabase.auth.signInWithOtp({ email })", "percentage": 95, "note": "OTP codes typically expire after 5-10 minutes"},
        {"solution": "User checks email for most recent OTP code", "percentage": 90, "note": "Previous codes are invalid once new one requested"},
        {"solution": "Implement countdown timer showing OTP expiration time", "percentage": 80, "note": "Improves UX by alerting user before expiration"}
    ]'::jsonb,
    'Email OTP enabled in Auth settings, Custom SMTP configured, User receives emails',
    'New OTP code delivered, User enters code within expiration window, Sign-in succeeds',
    'OTP codes expire quickly for security. Only the most recent code is valid. Requesting new code invalidates previous codes.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/debugging/error-codes'
),
(
    'Supabase Auth: user_already_exists - Duplicate email or phone',
    'supabase',
    'HIGH',
    '[
        {"solution": "Redirect user to sign-in flow instead of sign-up", "percentage": 95, "note": "User likely forgot they have an account"},
        {"solution": "Offer password reset option: await supabase.auth.resetPasswordForEmail(email)", "percentage": 90, "note": "Helps user regain access"},
        {"solution": "Check if user is trying OAuth with different provider - link identities", "percentage": 80, "note": "Use manual linking API if enabled"}
    ]'::jsonb,
    'Supabase Auth configured, Email or phone signup enabled',
    'User successfully signs in with existing account, Password reset email sent if requested, OAuth identity linked',
    'Email and phone must be unique per user. This is not an error condition - user already has account. Provide clear UX directing to sign-in.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://supabase.com/docs/guides/auth/debugging/error-codes'
);
