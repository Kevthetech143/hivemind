-- Add Stack Overflow solutions batch 7: MongoDB, Redis, MySQL, JWT, Express
-- Source: Stack Overflow accepted answers with community verification

-- MongoDB: Couldn't connect to server 127.0.0.1:27017
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'MongoDB couldn''t connect to server 127.0.0.1:27017',
    'mongodb',
    'VERY_HIGH',
    '[
        {"solution": "Start mongod service first: mongod (or sudo systemctl start mongod)", "percentage": 95, "command": "mongod", "note": "Server not running"},
        {"solution": "Remove mongod.lock and run mongod --repair", "percentage": 85, "command": "rm /var/lib/mongodb/mongod.lock && mongod --repair", "note": "Corrupted database"},
        {"solution": "Fix permissions: sudo chown -R mongodb:mongodb /var/lib/mongodb", "percentage": 80, "command": "sudo chown -R mongodb:mongodb /var/lib/mongodb", "note": "Permission issues"}
    ]'::jsonb,
    'MongoDB installed, mongo client',
    'mongo command connects successfully, Database operations work',
    'mongod server must be running before mongo client can connect. Check with: ps aux | grep mongod',
    0.95,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/13312358/'
);

-- MongoDB: E11000 duplicate key error
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'MongoDB E11000 duplicate key error index',
    'mongodb',
    'HIGH',
    '[
        {"solution": "Drop the duplicate index: db.collection.dropIndex(\"field_1\")", "percentage": 90, "note": "Remove conflicting index"},
        {"solution": "Delete conflicting documents before insert: db.collection.deleteMany({field: value})", "percentage": 85, "note": "Clear duplicates first"},
        {"solution": "Use upsert instead: db.collection.updateOne({field: value}, {$set: doc}, {upsert: true})", "percentage": 80, "note": "Update if exists, insert if not"}
    ]'::jsonb,
    'MongoDB connection, Collection with unique index',
    'Insert/update succeeds, No E11000 errors',
    'E11000 means unique index violation. Check existing documents with db.collection.find({field: value}). In non-sparse indexes, null counts as a value.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/24430220/'
);

-- MongoDB: Connection timeout 30000ms
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url, pattern_id
) VALUES (
    'MongoDB MongoTimeoutError: Server selection timed out after 30000 ms',
    'mongodb',
    'HIGH',
    '[
        {"solution": "Change localhost to 127.0.0.1 in connection string", "percentage": 90, "note": "Node 17+ DNS resolution issue"},
        {"solution": "Whitelist IP in MongoDB Atlas: Network Access → Add IP → 0.0.0.0/0 for testing", "percentage": 85, "note": "Atlas firewall blocking"},
        {"solution": "Check mongod service is running: sudo systemctl status mongod", "percentage": 80, "command": "sudo systemctl status mongod"}
    ]'::jsonb,
    'MongoDB connection attempt, Node.js application',
    'Connection succeeds, Database operations work',
    'Node 17+ changed IPv6 precedence. Use 127.0.0.1 instead of localhost. For Atlas, whitelist 0.0.0.0/0 only for testing.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/59162342/',
    (SELECT id FROM patterns WHERE pattern_name = 'VERSION_REGRESSION')
);

-- Redis: Connection refused 127.0.0.1:6379
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Redis connection refused 127.0.0.1:6379',
    'redis',
    'VERY_HIGH',
    '[
        {"solution": "Start Redis server: redis-server --daemonize yes", "percentage": 95, "command": "redis-server --daemonize yes", "note": "Server not running"},
        {"solution": "Check Redis is running: redis-cli ping (should return PONG)", "percentage": 90, "command": "redis-cli ping"},
        {"solution": "Check port 6379 not in use: lsof -i :6379", "percentage": 80, "command": "lsof -i :6379", "note": "Port conflict"}
    ]'::jsonb,
    'Redis installed, redis-cli available',
    'redis-cli ping returns PONG, Client connects successfully',
    'Redis server must be running before client can connect. Start with redis-server. Verify with redis-cli ping.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/42857551/'
);

-- Redis: Client is closed error
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url, pattern_id
) VALUES (
    'Redis NodeJS error: client is closed',
    'redis',
    'HIGH',
    '[
        {"solution": "Call redisClient.connect() before operations (redis v4+)", "percentage": 95, "note": "v4+ requires explicit connect"},
        {"solution": "Use await redisClient.connect() in async function", "percentage": 90, "note": "Must await connection"},
        {"solution": "Check client not already closed: use on(\"error\") handler", "percentage": 80, "note": "Handle connection lifecycle"}
    ]'::jsonb,
    'redis npm package v4+, Node.js application',
    'Redis operations succeed, No closed client errors',
    'redis v4+ requires explicit connect() call before any operations. v3 auto-connected. Migration breaking change.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/70185436/',
    (SELECT id FROM patterns WHERE pattern_name = 'VERSION_REGRESSION')
);

-- MySQL: Error 1045 Access denied
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'MySQL ERROR 1045 (28000): Access denied for user',
    'mysql',
    'VERY_HIGH',
    '[
        {"solution": "Drop anonymous user: DROP USER ''''@''localhost'';", "percentage": 90, "note": "Anonymous user blocks named users"},
        {"solution": "Reset password: ALTER USER ''user''@''localhost'' IDENTIFIED BY ''newpassword'';", "percentage": 85, "note": "Incorrect password"},
        {"solution": "Grant privileges: GRANT ALL PRIVILEGES ON database.* TO ''user''@''localhost'';", "percentage": 80, "note": "User lacks permissions"}
    ]'::jsonb,
    'MySQL installed, Root access',
    'mysql -u user -p connects successfully, User can query database',
    'Anonymous user (''''@''localhost) takes precedence over named users. Drop it. Check with: SELECT user,host FROM mysql.user;',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/10299148/'
);

-- MySQL: Error 2013 Lost connection
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'MySQL Error Code: 2013. Lost connection to MySQL server during query',
    'mysql',
    'HIGH',
    '[
        {"solution": "Increase timeouts in my.cnf: interactive_timeout=300, wait_timeout=300", "percentage": 90, "note": "Query takes too long"},
        {"solution": "Increase MySQL Workbench timeout: Edit → Preferences → SQL Editor → DBMS connection read timeout: 3000", "percentage": 85, "note": "Workbench-specific"},
        {"solution": "Increase max_allowed_packet: SET GLOBAL max_allowed_packet=67108864;", "percentage": 80, "note": "Large query or result"}
    ]'::jsonb,
    'MySQL server, Long-running queries',
    'Queries complete without timeout, Connection stays alive',
    'Default timeout is 30s. Long queries need higher interactive_timeout and wait_timeout in MySQL config.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/10563619/'
);

-- MySQL: Can't connect Error 2003
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'MySQL ERROR 2003: Can''t connect to MySQL server',
    'mysql',
    'HIGH',
    '[
        {"solution": "Start MySQL service: sudo systemctl start mysql (Linux) or net start MySQL (Windows)", "percentage": 95, "command": "sudo systemctl start mysql", "note": "Service not running"},
        {"solution": "Check MySQL is listening: netstat -an | grep 3306", "percentage": 85, "command": "netstat -an | grep 3306"},
        {"solution": "Check firewall not blocking port 3306: sudo ufw allow 3306", "percentage": 80, "command": "sudo ufw allow 3306"}
    ]'::jsonb,
    'MySQL installed, Network access',
    'mysql -u root -p connects, MySQL queries work',
    'Connection refused means MySQL service not running. Start service first, then check port 3306 is open.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/19727432/'
);

-- JWT: JsonWebTokenError invalid token
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'JWT JsonWebTokenError: invalid token',
    'jwt',
    'VERY_HIGH',
    '[
        {"solution": "Don''t stringify token: Use localStorage.setItem(''jwt'', token) not JSON.stringify(token)", "percentage": 90, "note": "JSON.stringify corrupts token"},
        {"solution": "Verify token format: Check Authorization header is \"Bearer <token>\" not \"Bearer {token}\"", "percentage": 85, "note": "Extra characters in token"},
        {"solution": "Check token not empty/null before verify: if (!token) return error", "percentage": 80, "note": "Missing token validation"}
    ]'::jsonb,
    'jsonwebtoken library, Token generation/verification',
    'jwt.verify succeeds, No invalid token errors',
    'Common causes: JSON.stringify wraps token in quotes, extra characters from parsing. Store token as plain string.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/48606341/'
);

-- JWT: TokenExpiredError
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'JWT TokenExpiredError: jwt expired',
    'jwt',
    'VERY_HIGH',
    '[
        {"solution": "Implement refresh token flow: Use short-lived access token + long-lived refresh token", "percentage": 95, "note": "Industry standard solution"},
        {"solution": "Increase expiry time: jwt.sign({data}, secret, {expiresIn: ''24h''})", "percentage": 80, "note": "Simple but less secure"},
        {"solution": "Handle error and redirect to login: catch(err => if(err.name === ''TokenExpiredError'') redirect(''/login'')", "percentage": 85, "note": "User re-authenticates"}
    ]'::jsonb,
    'JWT authentication system, jsonwebtoken library',
    'Expired tokens trigger refresh flow, Users stay logged in',
    'Tokens should expire for security. Implement refresh token pattern instead of very long expiry times.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/73073471/'
);

-- Express: Error Cannot GET /
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Express Error: Cannot GET /',
    'express',
    'VERY_HIGH',
    '[
        {"solution": "Define root route: app.get(''/'', (req, res) => { res.send(''Hello'') })", "percentage": 95, "note": "No route handler for /"},
        {"solution": "Serve static files: app.use(express.static(''public''))", "percentage": 90, "note": "Serve HTML from directory"},
        {"solution": "Check route order: app.use(express.static) before other routes", "percentage": 80, "note": "Middleware order matters"}
    ]'::jsonb,
    'Express.js installed, Node.js server',
    'GET / returns response, No Cannot GET error',
    'Cannot GET means no route handler defined. Define app.get(''/'') or use express.static() for HTML files.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/13339695/'
);

-- Express: Can't set headers after they are sent
INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Express error: Can''t set headers after they are sent',
    'express',
    'HIGH',
    '[
        {"solution": "Ensure only one res.send/json/end per request: Add return before res.send()", "percentage": 95, "note": "Multiple responses sent"},
        {"solution": "Check callback not called twice: Add console.log to find duplicate calls", "percentage": 85, "note": "Callback invoked multiple times"},
        {"solution": "Avoid res.send() after next(): Either send response OR call next(), not both", "percentage": 80, "note": "Response + middleware chain"}
    ]'::jsonb,
    'Express.js application, Route handlers',
    'Single response per request, No headers error',
    'Headers already sent means res.send/json called twice. Add return statement: return res.send(). Common in if/else without return.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/16311137/'
);
