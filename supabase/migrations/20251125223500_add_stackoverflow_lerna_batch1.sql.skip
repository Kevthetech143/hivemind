-- Stack Overflow Lerna Monorepo Solutions - Batch 1
-- Extracted from highest-voted Lerna questions with accepted answers
-- Date: 2025-11-25

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'What is the difference between Nx and Lerna for monorepo management?',
    'stackoverflow-lerna',
    'VERY_HIGH',
    '[
        {"solution": "Use Lerna if you need to focus on linking multiple packages and managing npm publishing. Lerna excels at publishing packages to npm and linking packages within a monorepo", "percentage": 90, "note": "Best for open-source projects with simpler workflows"},
        {"solution": "Use Nx for complex development workflows, scaffolding packages with predefined configurations, running multiple processes (frontend/backend), and task orchestration similar to Webpack", "percentage": 90, "note": "More comprehensive but steeper learning curve"},
        {"solution": "Consider that Lerna is now maintained by the Nx team, making them compatible and allowing for gradual migration or hybrid approaches", "percentage": 85, "note": "Architecture decision impacts long-term maintenance"}
    ]'::jsonb,
    'Understanding of monorepo requirements, Node.js and npm knowledge, Decision framework for publishing vs workflow complexity',
    'Team understands tool selection rationale, Project structure aligns with chosen tool capabilities, CI/CD pipeline works with selected tool',
    'Do not choose based solely on popularity - match tool to actual project needs. NPM/YARN workspaces alone may be sufficient if publishing is not required. Consider that Nx ownership of Lerna may influence long-term support decisions',
    0.88,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/67000436/the-difference-between-nx-and-lerna-monorepos'
),
(
    'Is Lerna still needed with NPM 7+ workspaces?',
    'stackoverflow-lerna',
    'VERY_HIGH',
    '[
        {"solution": "Use NPM workspaces for basic monorepo needs: installation, dependency management, script execution across packages, and automatic symlinking of interdependent packages", "percentage": 85, "note": "Handles 80% of common use cases"},
        {"solution": "Keep Lerna if you need change detection, version management, publishing automation, build ordering based on dependencies, or conventional commits integration", "percentage": 90, "note": "NPM workspaces lack these features"},
        {"solution": "NPM 7+ now installs peer dependencies automatically by default, reducing the primary advantage Lerna had over plain workspaces", "percentage": 88, "note": "Significant shift from earlier npm versions"}
    ]'::jsonb,
    'Node.js 12+, NPM 7+, Understanding of project publishing requirements',
    'Packages correctly installed and linked, Scripts execute across workspaces, No module resolution errors',
    'Do not assume Lerna is unnecessary just because workspaces are available. Lerna provides critical features beyond basic linking. The decision depends on whether you need automated versioning, change detection, or intelligent build ordering',
    0.87,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/64909635/is-lerna-needed-anymore-with-npm-workspaces'
),
(
    'How to set up local project to depend on local Lerna packages?',
    'stackoverflow-lerna',
    'HIGH',
    '[
        {"solution": "Use npm link with lerna bootstrap: cd foo, npx lerna clean, npx lerna bootstrap --hoist, npm run build, cd packages/core, npm link, then from bar: npm link @foo/core", "percentage": 92, "note": "Most reliable approach for development"},
        {"solution": "Add --hoist flag to lerna bootstrap to install shared dependencies at root level, which simplifies peer dependency resolution", "percentage": 88, "note": "Critical flag for local development"},
        {"solution": "Consolidate both repositories under single Lerna instance with shared lerna.json listing packages from both projects", "percentage": 75, "note": "Simplifies dependency management but requires single Git repository"}
    ]'::jsonb,
    'Lerna installed and initialized, Both projects ready for integration, npm or Yarn configured',
    'Dependencies resolve without ENOENT errors, Build completes successfully, Imports from linked packages work at runtime',
    'Do not use file: protocol in package.json - it causes persistent ENOENT errors and fails to resolve transitive dependencies. Do not skip the --hoist flag when bootstrapping. Avoid npm link for external packages - use it only for development-time linking',
    0.91,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/49037987/allow-local-project-to-depend-on-local-lerna-packages'
),
(
    'bash: lerna: command not found error on Windows/Mac',
    'stackoverflow-lerna',
    'HIGH',
    '[
        {"solution": "Add npm bin directory to system PATH environment variable. For Windows: C:\\Users\\yourusername\\AppData\\Roaming\\npm. For Mac: /usr/local/bin", "percentage": 95, "note": "Solves 95% of global command issues"},
        {"solution": "Use npx lerna instead of direct lerna command: npx lerna init, npx lerna bootstrap", "percentage": 90, "note": "Works without PATH configuration"},
        {"solution": "Verify npm installation with npm config get prefix and ensure that directory is in PATH", "percentage": 85, "command": "npm config get prefix"}
    ]'::jsonb,
    'Node.js and npm installed, Global npm permissions configured, Admin/sudo access if needed for PATH modification',
    'lerna --version returns version number, npx lerna command executes without error, Global lerna command works from any directory',
    'Do not reinstall npm globally without fixing PATH - the issue is environment variable configuration, not package installation. On Windows, restart terminal or IDE after PATH changes. Do not skip npm config verification',
    0.94,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/50522215/unable-to-run-lerna-command'
),
(
    'How to build Docker images in a Lerna monorepo without publishing packages?',
    'stackoverflow-lerna',
    'MEDIUM',
    '[
        {"solution": "Use Docker multi-stage builds: Copy root package.json and yarn.lock first, then selectively copy individual package manifests from workspace subdirectories, install dependencies, build, and copy only production artifacts", "percentage": 92, "note": "Avoids publishing to npm registry"},
        {"solution": "Copy root package.json, yarn.lock, then packages/*/package.json, run yarn install --frozen-lockfile --production=true, then copy built artifacts from earlier build stage", "percentage": 90, "command": "COPY [\"package.json\",\"yarn.lock\", \"./\"] && COPY ./packages/*/package.json ./packages/", "note": "Multi-stage approach reduces final image size"},
        {"solution": "Publish packages to local npm registry (Verdaccio) for Docker builds", "percentage": 75, "note": "Alternative for complex monorepos but adds infrastructure overhead"}
    ]'::jsonb,
    'Docker installed, Lerna monorepo with packages directory, package.json and yarn.lock in root, Build artifacts can be generated locally',
    'Docker image builds successfully, All dependencies installed correctly, Application runs in container without missing dependencies',
    'Do not copy entire repository into image - cherry-pick only necessary files. This approach does not scale well with dozens of packages. Do not forget yarn.lock - Docker needs it for reproducible installs. Consider that each layer rebuild can be expensive',
    0.83,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/59320343/how-to-build-docker-images-in-a-lerna-monorepo-without-publishing'
),
(
    'How to configure Rollup to include dependencies from another package in Lerna monorepo?',
    'stackoverflow-lerna',
    'MEDIUM',
    '[
        {"solution": "Extract dependencies from package.json and mark Lerna package dependencies as external in Rollup configuration using the external callback", "percentage": 90, "note": "Prevents Rollup from trying to bundle sibling packages"},
        {"solution": "Add @rollup/plugin-node-resolve with extensions parameter: extensions: [\".js\", \".json\", \".node\", \".ts\", \".tsx\"]", "percentage": 85, "note": "Enables TypeScript dependency resolution"},
        {"solution": "Use TypeScript Rollup plugin with tsconfig.json configuration: typescript({ tsconfig: \"./tsconfig.json\" })", "percentage": 82, "note": "Handles TypeScript transpilation"}
    ]'::jsonb,
    'Rollup configured in Lerna package, Sibling packages in monorepo, @rollup/plugin-node-resolve installed, TypeScript setup optional',
    'Rollup build completes without \"Unexpected token\" errors, Dependencies from sibling packages are correctly resolved, Build output contains proper module format',
    'Do not attempt to inline sibling packages in Rollup output - always mark Lerna packages as external. Do not forget to configure extensions parameter in node-resolve plugin. TypeScript source files must be transpiled before they can be imported in other packages',
    0.80,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/60729218/how-to-get-rollup-to-include-a-dependency-from-another-package-in-a-lerna-monorepo'
),
(
    'Building TypeScript in Lerna: Error: Unexpected token when bundling dependencies',
    'stackoverflow-lerna',
    'MEDIUM',
    '[
        {"solution": "Read the dependent package package.json, extract dependencies list, use Rollup external callback to mark those packages as external: if (dependencies.includes(id)) return true", "percentage": 92, "note": "Prevents Rollup from bundling sibling packages"},
        {"solution": "Ensure each Lerna package exports pre-compiled JavaScript, not TypeScript source files", "percentage": 88, "note": "Rollup cannot parse TypeScript without proper plugins"},
        {"solution": "Build all dependencies before building dependents using lerna run build --include-dependencies", "percentage": 85, "command": "lerna run build --include-dependencies"}
    ]'::jsonb,
    'Lerna monorepo structure with multiple TypeScript packages, Rollup configured, Each package has build script',
    'Rollup build succeeds for all packages, No \"Unexpected token\" errors, Compiled JavaScript output is correct',
    'Do not inline TypeScript from other packages - always mark them as external. Do not build packages in wrong order - use --include-dependencies flag. Do not skip the build step for dependencies',
    0.89,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/58891901/building-typescript-error-unexpected-token'
),
(
    'How to refresh or re-import an already imported repository with Lerna?',
    'stackoverflow-lerna',
    'LOW',
    '[
        {"solution": "Lerna import does not support re-importing once a directory exists. Use Git workaround: in source repo create lerna-export branch with git mv -k * ./packages/original, then merge with --allow-unrelated-histories", "percentage": 70, "note": "Manual but allows incremental updates"},
        {"solution": "For each feature branch, add remote in destination repo: git remote add original [repo-url], create branch, merge with original/lerna-export --allow-unrelated-histories", "percentage": 68, "note": "Requires manual coordination"},
        {"solution": "Delete the imported directory and re-run lerna import from scratch", "percentage": 50, "note": "Loses history and requires rebuilding package structure"}
    ]'::jsonb,
    'Git repositories configured, Lerna initialized, Understanding of Git merge and rebase workflows',
    'Branch imports successfully without conflicts, Package structure matches target, Git history is preserved',
    'Do not re-run lerna import on existing package - it will fail. Do not expect automatic syncing - Lerna import is one-time operation. History from imported packages will differ from source branches. Manual coordination required for complex import scenarios',
    0.65,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/49930314/is-there-a-way-to-refresh-an-imported-repository-with-lerna'
),
(
    'How to handle peer dependencies in a Lerna monorepo?',
    'stackoverflow-lerna',
    'HIGH',
    '[
        {"solution": "Use Yarn workspaces native module resolution which installs most dependencies in root node_modules, relying on Node standard resolution", "percentage": 90, "note": "Works for most cases"},
        {"solution": "List peer dependencies as dev dependencies in individual packages, use rollup plugins to mark them as external during builds", "percentage": 85, "note": "Avoids duplication while allowing tool-specific handling"},
        {"solution": "NPM 7+ now installs peer dependencies automatically, significantly simplifying peer dependency resolution compared to earlier versions", "percentage": 88, "note": "Eliminates need for manual peer dependency installation"}
    ]'::jsonb,
    'Lerna monorepo initialized, Yarn or NPM 7+, Understanding of peer dependency requirements',
    'Packages resolve all dependencies without conflicts, Build tools find peer dependencies correctly, No duplicate installations',
    'Do not assume single solution works for all tools - Jest and webpack may have custom resolution logic. Do not create conflicts between different versions of same peer dependency. Do not forget that NPM 7 behavior differs significantly from earlier versions',
    0.83,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/58027193/peer-dependencies-in-a-monorepo'
),
(
    'LernaJS TypeScript: Cannot find module from linked package',
    'stackoverflow-lerna',
    'HIGH',
    '[
        {"solution": "Define main field in each package package.json pointing to compiled JavaScript: \"main\": \"dist/index.js\" - Node uses this entry point for imports", "percentage": 95, "note": "Solves 95% of module resolution issues"},
        {"solution": "Build all packages before importing from them - TypeScript source files cannot be imported at runtime without compilation", "percentage": 92, "note": "Critical - imports must resolve to .js not .ts"},
        {"solution": "Run lerna bootstrap to create symlinks after defining main entry points", "percentage": 88, "command": "npx lerna bootstrap"}
    ]'::jsonb,
    'Lerna initialized, TypeScript packages with build process, npm or Yarn workspace configured, Each package has main field',
    'Import statements resolve without \"Cannot find module\" error, Runtime executes linked packages correctly, TypeScript compilation succeeds',
    'Do not try to import .ts files directly - only .js files can be required at runtime. Do not forget to set main field - it is required for Node module resolution. Do not import before building - compiled output must exist',
    0.93,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/50780112/lernajs-typescript-cannot-find-module'
),
(
    'How to use unpublished packages in a Lerna monorepo?',
    'stackoverflow-lerna',
    'MEDIUM',
    '[
        {"solution": "Replace \"latest\" dist-tag with wildcard \"*\" in dependency version to force Lerna to match local packages: \"dependencies\": {\"package-name\": \"*\"}", "percentage": 92, "note": "dist-tags do not satisfy semver ranges"},
        {"solution": "Add \"private\": true to packages you do not intend to publish to npm", "percentage": 88, "note": "Prevents accidental publication attempts"},
        {"solution": "Ensure each package has both name and version fields defined in package.json for Lerna to recognize and link them", "percentage": 90, "note": "Minimum requirements for package registration"}
    ]'::jsonb,
    'Lerna monorepo initialized, Packages directory structure created, Each package has package.json with name and version',
    'lerna bootstrap succeeds without registry lookup errors, Packages symlink correctly, Local imports work without npm registry',
    'Do not use \"latest\" as version specifier - Lerna treats it as npm dist-tag and searches registry instead of local. Do not forget to add both name and version fields. Do not publish private packages - set private flag to prevent accidental publication',
    0.91,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/44491525/using-lerna-with-unpublished-packages'
),
(
    'How to set up GitHub Actions to publish a Lerna monorepo to npm?',
    'stackoverflow-lerna',
    'MEDIUM',
    '[
        {"solution": "Use actions/checkout@v2 with fetch-depth: \"0\" to retrieve full history and tags that Lerna needs to detect changes", "percentage": 94, "note": "Essential for change detection"},
        {"solution": "Use actions/setup-node@v2 with registry-url to auto-configure .npmrc using NODE_AUTH_TOKEN environment variable", "percentage": 93, "command": "- uses: actions/setup-node@v2 with: registry-url: \"https://registry.npmjs.org/\"", "note": "Simplifies authentication setup"},
        {"solution": "Configure git user before publishing: git config --global user.email \"[email protected]\", git config --global user.name \"CI Bot\", verify with npm whoami", "percentage": 91, "note": "Required for commit creation during publishing"},
        {"solution": "Use lerna publish --no-verify-access when using NPM Automation Tokens", "percentage": 88, "command": "lerna publish --no-verify-access", "note": "Automation tokens lack full verification privileges"}
    ]'::jsonb,
    'Lerna monorepo with packages, NPM_TOKEN secret configured in GitHub, Git user able to create commits, Repository with tags and history',
    'GitHub Actions workflow executes successfully, Packages publish to npm without errors, New versions appear in npm registry, Git tags created for releases',
    'Do not commit with default GitHub Actions user - configure git user first. Do not use standard npm verify-access with automation tokens. Do not forget fetch-depth: 0 - Lerna needs full history for change detection. Do not store tokens in repository - use GitHub secrets',
    0.89,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/57597367/how-to-set-up-github-actions-to-publish-a-lerna-monorepo'
),
(
    'How to control Lerna package execution order with --sort flag?',
    'stackoverflow-lerna',
    'MEDIUM',
    '[
        {"solution": "Declare Lerna packages as dependencies in dependent packages package.json - Lerna sorts packages topologically (dependencies before dependents) using --sort flag by default", "percentage": 92, "note": "Automatic execution order based on dependency graph"},
        {"solution": "Use lerna run build --include-dependencies --stream to respect full dependency chain during execution", "percentage": 88, "command": "lerna run build --include-dependencies --stream", "note": "Ensures dependencies build before dependents"},
        {"solution": "Pass --no-sort flag to disable topological sorting and execute packages in listed order", "percentage": 75, "note": "Override default behavior only when necessary"}
    ]'::jsonb,
    'Lerna packages with package.json dependencies configured, Lerna 3+, Understanding of topological sorting',
    'Packages execute in correct dependency order, No missing dependency errors, All builds succeed without re-running',
    'Do not specify explicit run order - use dependency declarations instead. Do not disable --sort without understanding consequences. Do not forget that --sort is enabled by default. Build and run operations must respect dependency order to prevent compilation failures',
    0.90,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/50769518/lerna-specify-run-order'
);
