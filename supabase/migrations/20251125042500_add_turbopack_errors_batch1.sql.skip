-- DOC-MINER-42: Turbopack build and HMR errors batch 1
-- Source: Official NextJS Turbopack documentation, GitHub issues, and migration guides
-- Category: turbopack, nextjs
-- Entries: 12

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Turbopack: Module not found - linked dependencies not resolved',
    'turbopack',
    'HIGH',
    '[
        {"solution": "Configure turbopack.root option in next.config.js to point to parent directory containing both project and linked dependencies", "percentage": 92, "note": "Turbopack resolves modules from root directory, unlike webpack which can find linked packages"},
        {"solution": "Use npm link or yarn link to symlink package from parent directory, ensuring turbopack.root is set correctly", "percentage": 90, "command": "npm link ../linked-package", "note": "Symlinks are resolved relative to configured root"},
        {"solution": "Verify the linked package structure and that turbopack.root includes path to containing directory", "percentage": 88, "note": "Example: turbopack: { root: path.resolve(__dirname, \"..\") }"},
        {"solution": "Rebuild linked package after changes and restart development server to refresh module resolution", "percentage": 85, "note": "Changes to linked packages may require restart"}
    ]'::jsonb,
    'Next.js project with Turbopack enabled, npm/yarn link configured, turbopack option accessible in next.config.js',
    'Linked dependencies resolve without errors, Imports from linked packages work, Development server starts successfully',
    'Turbopack uses root directory for module resolution - files outside root are not resolved by default. npm link without turbopack.root configuration will fail. Different behavior than webpack.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/api-reference/turbopack#linked-dependencies'
),
(
    'Turbopack: CSS module import error - tilde syntax not supported',
    'turbopack',
    'HIGH',
    '[
        {"solution": "Remove legacy tilde ~ prefix from SCSS/CSS imports: change @import \"~bootstrap/scss/bootstrap\" to @import \"bootstrap/scss/bootstrap\"", "percentage": 95, "command": "Find and replace @import \"~\" with @import in CSS files"},
        {"solution": "Configure turbopack.resolveAlias to map tilde syntax if unable to update imports: turbopack: { resolveAlias: { \"~\": path.resolve(__dirname, \"node_modules\") } }", "percentage": 88, "note": "Workaround for legacy codebases with many tilde imports"},
        {"solution": "Update sass/scss dependencies to latest versions that support new import syntax", "percentage": 85, "note": "Newer Sass versions handle node_modules imports without tilde prefix"}
    ]'::jsonb,
    'Next.js project with Turbopack, CSS/SCSS files in project, node_modules containing CSS libraries',
    'CSS files import successfully without tilde syntax errors, Styles apply to components correctly, Build completes without CSS module errors',
    'Webpack supports legacy tilde ~ syntax for node_modules imports, but Turbopack does not. Must remove ~ prefix or use resolveAlias configuration. Common with Bootstrap, Material-UI, and other CSS libraries.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/api-reference/turbopack#sass-node_modules-import-syntax'
),
(
    'Turbopack: CSS module ordering differences causing style conflicts',
    'turbopack',
    'MEDIUM',
    '[
        {"solution": "Explicitly order CSS imports using @import statements in base CSS file instead of relying on import order", "percentage": 90, "note": "Turbopack follows JavaScript import order, which may differ from webpack heuristics"},
        {"solution": "Use specific class names and higher CSS specificity to override conflicting rules instead of relying on import order", "percentage": 88, "note": "More maintainable than trying to match Turbopack import ordering"},
        {"solution": "Restructure CSS to use CSS modules with specific class names for component isolation", "percentage": 85, "note": "Prevents style conflicts regardless of import order"},
        {"solution": "Test visual output in browser and adjust CSS rules if rendering differs from webpack builds", "percentage": 80, "note": "Turbopack may concatenate CSS files in different order"}
    ]'::jsonb,
    'Next.js project with Turbopack enabled, CSS files with potential ordering dependencies, Component styles applied via imports',
    'Styles render correctly in browser matching expected output, No visual differences from webpack builds, CSS specificity conflicts resolved',
    'Turbopack concatenates CSS modules following JavaScript import order, which differs from webpack side-effects handling. This can cause subtle rendering changes. Import order matters less than CSS specificity.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/api-reference/turbopack#css-module-ordering'
),
(
    'Turbopack: Custom Sass functions not supported - JavaScript functions fail',
    'turbopack',
    'MEDIUM',
    '[
        {"solution": "Rewrite custom Sass functions as Rust-compatible or native Sass equivalents instead of JavaScript functions", "percentage": 92, "note": "Turbopack uses Rust-based Sass implementation which cannot execute JavaScript"},
        {"solution": "Use sassOptions without custom functions property: sassOptions: { includePaths: [...], outputStyle: \"compressed\" } - omit sassOptions.functions", "percentage": 95, "note": "Remove the functions key entirely if not using Turbopack"},
        {"solution": "Switch to webpack configuration if project requires custom Sass functions: skip turbopack: { sass: {...} } configuration", "percentage": 85, "note": "Fallback to webpack if Sass functions are essential"},
        {"solution": "Use Sass mixins and built-in Sass functions instead of custom JavaScript functions", "percentage": 88, "note": "Sass has many built-in functions covering common use cases"}
    ]'::jsonb,
    'Next.js project with Turbopack enabled, SCSS files with custom Sass functions in sassOptions, Sass compiler configured',
    'Sass compilation succeeds without function errors, Styles apply correctly using native Sass functions, No JavaScript execution errors',
    'Turbopack uses Rust-based Sass implementation that cannot execute JavaScript functions defined in sassOptions.functions. This is fundamental difference from webpack which runs on Node.js and can execute JS functions.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/api-reference/turbopack#custom-sass-functions'
),
(
    'Turbopack: Legacy CSS module features not supported - composes and :global/:local',
    'turbopack',
    'MEDIUM',
    '[
        {"solution": "Convert .css files using legacy features to .module.css format for proper CSS module handling", "percentage": 90, "note": "Unsupported features include :local, :global pseudo-classes, @value, :import, :export ICSS rules"},
        {"solution": "Replace CSS @value declarations with CSS custom properties (CSS variables): --my-color: #ff0000; color: var(--my-color);", "percentage": 92, "note": "CSS variables provide same functionality with modern standard syntax"},
        {"solution": "Remove composes from CSS files and replace with CSS inheritance or composition patterns", "percentage": 85, "note": "CSS modules composition is not supported"},
        {"solution": "Use JavaScript to compose styles instead of CSS composition: import styles1 from \"./a.module.css\"; import styles2 from \"./b.module.css\"; const combined = { ...styles1, ...styles2 };", "percentage": 83, "note": "Workaround for composing multiple CSS module objects"}
    ]'::jsonb,
    'Next.js project with Turbopack enabled, CSS module files using legacy features, next.config.js with turbopack configuration',
    'CSS modules compile without legacy feature errors, Styles apply correctly using supported features, Build completes successfully',
    'Turbopack does not support ICSS-like features (:local, :global, @value, :import, :export) or CSS module composition (composes keyword). These are webpack-specific CSS module extensions.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/api-reference/turbopack#legacy-css-module-features'
),
(
    'Turbopack: Hot Module Replacement (HMR) not working - page reload instead of update',
    'turbopack',
    'HIGH',
    '[
        {"solution": "Verify HMR is enabled in Next.js dev server - ensure no turbopack.disableHmr configuration", "percentage": 90, "note": "HMR enabled by default in dev, check custom next.config.js settings"},
        {"solution": "Check for React components missing hot() export wrapper if using React 18+ - not always required but can affect HMR", "percentage": 75, "note": "React Refresh should handle HMR automatically in Next.js"},
        {"solution": "Restart development server if HMR not working after code changes: kill dev process and run next dev again", "percentage": 85, "note": "Some changes require full restart for HMR to reinitialize"},
        {"solution": "Monitor browser console for HMR client errors - check if turbopack HMR client is connecting properly", "percentage": 80, "note": "Browser DevTools may show HMR connection errors"},
        {"solution": "Verify no middleware or proxies are blocking the HMR WebSocket connection", "percentage": 78, "note": "HMR uses WebSocket for real-time updates"}
    ]'::jsonb,
    'Next.js project with Turbopack enabled (--turbo flag), Development server running, Browser with modern WebSocket support',
    'Code changes trigger HMR updates without full page reload, Component state preserved during updates, Browser DevTools show successful HMR client connection',
    'Turbopack HMR may cause full page reloads instead of true HMR in some cases, making development slower. Different behavior from webpack. Check for console errors related to HMR client.',
    0.82,
    'sonnet-4',
    NOW(),
    'https://github.com/vercel/next.js/issues/50153'
),
(
    'Turbopack: Webpack plugins incompatible - plugin configuration ignored',
    'turbopack',
    'HIGH',
    '[
        {"solution": "Remove or comment out webpack plugin configurations from next.config.js - Turbopack does not support plugins", "percentage": 95, "note": "Turbopack replaces webpack, so webpack() config function is ignored entirely"},
        {"solution": "Use turbopack configuration option instead of webpack() function: turbopack: { /* config */ } instead of webpack: (config) => { /* config */ }", "percentage": 92, "command": "Replace webpack: (config) => {} with turbopack: {} in next.config.js"},
        {"solution": "Find Turbopack-compatible alternatives to webpack plugins (e.g., loaders may work if they return JavaScript code)", "percentage": 85, "note": "Loaders are partially supported if they output JavaScript"},
        {"solution": "If plugin is essential, continue using webpack by disabling Turbopack: set TURBOPACK=false env var or configure to use webpack", "percentage": 80, "note": "Last resort - may not be available in latest Next.js versions"}
    ]'::jsonb,
    'Next.js project with custom webpack() configuration, next.config.js file, Turbopack enabled',
    'Configuration loads without errors, Build uses Turbopack successfully, No warnings about ignored webpack plugins',
    'Turbopack does not support webpack plugins - they are silently ignored. Custom webpack() configurations in next.config.js will not execute. Loaders may work if they return JavaScript code.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/api-reference/turbopack#webpack-plugins-incompatible'
),
(
    'Turbopack: Cannot resolve module with unsupported loader format',
    'turbopack',
    'MEDIUM',
    '[
        {"solution": "Ensure custom loaders return only JavaScript code - loaders transforming stylesheets, images, or binary files are not supported", "percentage": 92, "note": "Turbopack only supports loaders that produce JavaScript output"},
        {"solution": "Use built-in Turbopack support for CSS and images instead of custom loaders: CSS, PNG, JPG, SVG handled natively", "percentage": 90, "note": "Turbopack has native support for common file types"},
        {"solution": "Verify loader options are plain JavaScript primitives (strings, numbers, booleans, objects, arrays) - cannot pass require() modules", "percentage": 88, "note": "Complex objects with require() calls will not work"},
        {"solution": "Check Turbopack documentation for supported loader API features - some webpack loader APIs are not implemented", "percentage": 85, "note": "Example: importModule, loadModule, fs operations, emitFile are unsupported"}
    ]'::jsonb,
    'Next.js project with Turbopack enabled, Custom webpack loaders configured, next.config.js with turbopack.loaders',
    'Loaders execute successfully, JavaScript code is properly transformed, Build completes without loader errors',
    'Turbopack loaders have limitations compared to webpack: only JavaScript output supported, no file system operations except read-only fs, no require() in options, some loader APIs missing.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack'
),
(
    'Turbopack: Automatic root layout creation not supported in App Router',
    'turbopack',
    'MEDIUM',
    '[
        {"solution": "Manually create root layout.tsx file at app/layout.tsx with required structure: export default function Layout({ children }) { return (<html><body>{children}</body></html>) }", "percentage": 95, "command": "Create app/layout.tsx with root HTML and body tags"},
        {"solution": "Ensure root layout is in correct location: app/layout.tsx not app/root/layout.tsx", "percentage": 90, "note": "Root layout must be directly in app/ directory"},
        {"solution": "Include essential metadata and providers in root layout: app metadata, theme providers, authentication context", "percentage": 88, "note": "Root layout is parent to all pages"},
        {"solution": "Verify layout exports default component that accepts children prop", "percentage": 90, "note": "Children prop contains nested routes"}
    ]'::jsonb,
    'Next.js 13+ project with App Router, Turbopack enabled, app/ directory structure',
    'App Router loads without layout errors, Pages render within root layout, No missing layout warnings',
    'Turbopack does not automatically create root layout like older Next.js versions. Must manually create app/layout.tsx file or build will reference non-existent file.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/api-reference/turbopack#root-layout-creation-not-supported'
),
(
    'Turbopack: Unsupported experimental features causing build failures',
    'turbopack',
    'MEDIUM',
    '[
        {"solution": "Remove unsupported experimental configuration options: experimental.urlImports, experimental.esmExternals, experimental.nextScriptWorkers, experimental.sri, experimental.fallbackNodePolyfills", "percentage": 95, "note": "These features are not planned for Turbopack support"},
        {"solution": "Check next.config.js for experimental options and disable Turbopack if features are required: TURBOPACK=false or webpack configuration fallback", "percentage": 90, "command": "Comment out or remove experimental options from next.config.js"},
        {"solution": "Verify Yarn PnP is not enabled if using Turbopack - Yarn PnP is not supported", "percentage": 88, "note": "Use npm, pnpm, or bun instead of Yarn PnP"},
        {"solution": "Use standard Node.js polyfill configuration instead of experimental.fallbackNodePolyfills", "percentage": 85, "note": "Configure resolve.fallback for needed polyfills"}
    ]'::jsonb,
    'Next.js project with Turbopack enabled, next.config.js with experimental options, Node.js 16+',
    'Build completes without unsupported feature errors, All configured features are Turbopack-compatible, No warnings about experimental features',
    'Turbopack has planned feature gaps: Yarn PnP, URL imports, ESM externals, script workers, SRI hashing, and Node.js polyfill fallbacks. These are not supported and should not be configured.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/api-reference/turbopack#unsupported-features'
),
(
    'Turbopack: Module parse error with HMR client runtime',
    'turbopack',
    'MEDIUM',
    '[
        {"solution": "Delete .next/ directory and reinstall node_modules: rm -rf .next node_modules && npm install", "percentage": 90, "command": "rm -rf .next node_modules && npm install"},
        {"solution": "Update Next.js to latest version supporting Turbopack with stable HMR: npm install next@latest", "percentage": 88, "command": "npm install next@latest"},
        {"solution": "Clear npm cache if dependency installation fails: npm cache clean --force", "percentage": 85, "command": "npm cache clean --force"},
        {"solution": "Verify turbopack HMR client module is available in @vercel/turbopack-ecmascript-runtime package", "percentage": 82, "note": "Package must be correctly installed in node_modules"}
    ]'::jsonb,
    'Next.js project with Turbopack, npm/yarn package manager, Valid node_modules',
    'Development server starts without HMR client errors, HMR works correctly, No module parse errors in browser console',
    'HMR client module must be properly installed from @vercel/turbopack-ecmascript-runtime. Missing or corrupted installations cause \"Module not found\" errors. Reinstalling node_modules often resolves this.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://stackoverflow.com/questions/78041028/module-not-found-cant-resolve-vercel-turbopack-ecmascript-runtime'
),
(
    'Turbopack: Bundle size regressions from missing inner graph optimization',
    'turbopack',
    'LOW',
    '[
        {"solution": "Manually split large modules into smaller, focused modules for better tree-shaking potential", "percentage": 88, "note": "Turbopack lacks webpack inner graph optimization for automatic tree-shaking"},
        {"solution": "Use dynamic imports for code-splitting to reduce bundle size: import(\"./module\") instead of static import", "percentage": 90, "note": "Dynamic imports force module boundaries that Turbopack respects"},
        {"solution": "Analyze bundle with next/bundle-analyzer to identify large modules: npm install --save-dev @next/bundle-analyzer", "percentage": 85, "command": "npm install --save-dev @next/bundle-analyzer"},
        {"solution": "Update next.config.js to use bundle analyzer: withBundleAnalyzer in next.config.js", "percentage": 82, "note": "Helps identify which modules cause size regressions"}
    ]'::jsonb,
    'Next.js project with Turbopack, Production build configured, Large dependency bundle, webpack experience for comparison',
    'Bundle size acceptable for deployment, No significant regressions from webpack builds, Core functionality loads efficiently',
    'Turbopack does not have inner graph optimization that webpack provides by default. Large monolithic modules are not automatically tree-shaken. Manual code splitting and module refactoring may be needed.',
    0.78,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/api-reference/turbopack#performance-gap'
),
(
    'Turbopack: Configuration file conflict - custom webpack config breaks build',
    'turbopack',
    'HIGH',
    '[
        {"solution": "Remove or comment out webpack() function from next.config.js when using Turbopack", "percentage": 95, "note": "Turbopack does not recognize webpack() configurations - they are silently ignored causing unexpected behavior"},
        {"solution": "Migrate webpack configuration to Turbopack format: const nextConfig = { turbopack: { /* config here */ } };", "percentage": 92, "command": "Replace webpack: (config) => { ... } with turbopack: { ... } configuration"},
        {"solution": "Run codemod to automatically migrate webpack config: Next.js 16 provides automated migration for experimental.turbo -> turbopack", "percentage": 88, "note": "Only available for versions 15.3.0+"},
        {"solution": "For Next.js 16+, custom webpack configs will cause build to fail with error - remove immediately", "percentage": 95, "note": "Next.js 16 uses Turbopack by default and rejects webpack configurations"}
    ]'::jsonb,
    'Next.js project with custom webpack() configuration, Turbopack enabled, next.config.js file',
    'Build completes successfully without configuration conflicts, Turbopack applies configuration correctly, No errors about invalid webpack config',
    'In Next.js 16+, Turbopack is default build system and custom webpack configurations will cause build failure to prevent misconfiguration. Next.js 14-15 silently ignores webpack() when Turbopack enabled.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://nextjs.org/docs/app/guides/upgrading/version-16'
);
