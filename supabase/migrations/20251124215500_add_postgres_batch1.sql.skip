-- Add PostgreSQL common errors batch 1
-- Documentation source: Official PostgreSQL documentation
-- Extracted: 2025-11-24

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'PostgreSQL error: connection to server at "localhost", port 5432 failed: Connection refused',
    'postgres',
    'VERY_HIGH',
    '[
        {"solution": "Verify PostgreSQL service is running with: systemctl status postgresql (Linux) or pg_ctl status (Windows/Mac)", "percentage": 95, "note": "Most common cause - service not started", "command": "sudo systemctl start postgresql"},
        {"solution": "Check that PostgreSQL is listening on port 5432 in postgresql.conf: listen_addresses = ''*'' or ''localhost''", "percentage": 90, "note": "Verify with: lsof -i :5432", "command": "lsof -i :5432"},
        {"solution": "Ensure firewall allows connections on port 5432", "percentage": 85, "note": "Check firewall rules for PostgreSQL port"},
        {"solution": "Verify correct port number in connection string - default is 5432", "percentage": 80, "note": "Connection refused means kernel rejected, not PostgreSQL"}
    ]'::jsonb,
    'PostgreSQL installed, Sufficient system permissions to start service',
    'Service status shows active/running, lsof shows PostgreSQL listening on port 5432, Connection succeeds',
    'Connection refused at kernel level means no process is listening on that port - NOT that PostgreSQL rejected the connection. Check service is actually running before troubleshooting authentication.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/trouble13828.htm'
),
(
    'PostgreSQL FATAL: no pg_hba.conf entry for host, user, database',
    'postgres',
    'VERY_HIGH',
    '[
        {"solution": "Add appropriate entry to pg_hba.conf file. Example: host all all 0.0.0.0/0 md5 for all hosts, or host all all 192.168.1.0/24 md5 for specific subnet", "percentage": 95, "note": "Most specific match wins - order matters"},
        {"solution": "Reload PostgreSQL configuration after editing pg_hba.conf: pg_ctl reload or SELECT pg_reload_conf();", "percentage": 95, "note": "Changes require reload, not restart", "command": "sudo systemctl reload postgresql"},
        {"solution": "Use trust authentication for local development (NOT production): host all all 127.0.0.1/32 trust", "percentage": 85, "note": "Only for local testing - security risk"},
        {"solution": "Check pg_hba.conf location with: SHOW hba_file; from psql", "percentage": 90, "command": "SHOW hba_file;"}
    ]'::jsonb,
    'Access to PostgreSQL configuration directory, Root/admin privileges to edit pg_hba.conf',
    'Connection succeeds without authentication error, Server log shows successful authentication',
    'pg_hba.conf is processed top-to-bottom - first matching rule wins. After editing, must reload config (pg_ctl reload), NOT restart server. IPv4 vs IPv6 addresses matter (127.0.0.1 vs ::1).',
    0.95,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/client-authentication-problems.html'
),
(
    'PostgreSQL FATAL: password authentication failed for user',
    'postgres',
    'VERY_HIGH',
    '[
        {"solution": "Reset user password with ALTER USER: ALTER USER username WITH PASSWORD ''newpassword'';", "percentage": 90, "note": "Must be run as superuser", "command": "ALTER USER myuser WITH PASSWORD ''mypassword'';"},
        {"solution": "Verify authentication method in pg_hba.conf matches (md5, scram-sha-256, peer, trust)", "percentage": 95, "note": "peer authentication uses OS username, not password"},
        {"solution": "Check for correct username - PostgreSQL usernames are case-sensitive in quotes", "percentage": 85, "note": "user vs User vs USER are different"},
        {"solution": "For peer authentication error, connect as OS user matching database user: sudo -u postgres psql", "percentage": 90, "command": "sudo -u postgres psql"}
    ]'::jsonb,
    'Valid PostgreSQL user account, Access to pg_hba.conf for authentication method verification',
    'Authentication succeeds, psql connects without password prompt (for trust) or with correct password',
    'Password authentication failed means connection was accepted but credentials rejected. Check pg_hba.conf authentication method - peer auth uses OS username (no password), md5/scram-sha-256 use passwords. Server log has more details than client error.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/client-authentication-problems.html'
),
(
    'PostgreSQL FATAL: database does not exist',
    'postgres',
    'HIGH',
    '[
        {"solution": "Create database with: CREATE DATABASE dbname; or createdb dbname from command line", "percentage": 95, "command": "createdb mydatabase"},
        {"solution": "List existing databases to verify name: \\l in psql or SELECT datname FROM pg_database;", "percentage": 90, "command": "psql -l"},
        {"solution": "If no database specified, PostgreSQL tries to connect to database matching username - specify explicitly", "percentage": 85, "note": "psql defaults to username as database name"},
        {"solution": "Check for typos - database names are case-sensitive when quoted", "percentage": 80, "note": "mydb vs MyDB are different"}
    ]'::jsonb,
    'PostgreSQL service running, User with CREATEDB privilege or superuser access',
    'Database appears in \\l listing, Connection succeeds to specified database',
    'If database name is omitted in connection string, PostgreSQL attempts to connect to a database with same name as the user. Database names are case-insensitive unless double-quoted during creation.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/client-authentication-problems.html'
),
(
    'PostgreSQL FATAL: role does not exist',
    'postgres',
    'HIGH',
    '[
        {"solution": "Create user/role with: CREATE USER username WITH PASSWORD ''password''; or createuser from CLI", "percentage": 95, "command": "createuser -P myuser"},
        {"solution": "List existing roles to verify: \\du in psql or SELECT rolname FROM pg_roles;", "percentage": 90, "command": "psql -c \"\\du\""},
        {"solution": "Create role with login privilege: CREATE ROLE username WITH LOGIN PASSWORD ''password'';", "percentage": 90, "note": "ROLE vs USER - USER includes LOGIN by default"},
        {"solution": "Check spelling - role names are case-sensitive when quoted", "percentage": 85, "note": "postgres vs Postgres are different"}
    ]'::jsonb,
    'Superuser or CREATEROLE privilege, PostgreSQL service running',
    'Role appears in \\du listing, Authentication succeeds with role credentials',
    'CREATE USER is equivalent to CREATE ROLE WITH LOGIN. Role names are case-insensitive unless double-quoted. Must have LOGIN privilege to connect.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/client-authentication-problems.html'
),
(
    'PostgreSQL ERROR: relation does not exist',
    'postgres',
    'VERY_HIGH',
    '[
        {"solution": "Use double quotes for mixed-case table names: SELECT * FROM \"MyTable\"; not SELECT * FROM MyTable;", "percentage": 90, "note": "Unquoted identifiers are folded to lowercase"},
        {"solution": "Specify schema explicitly: SELECT * FROM schema_name.table_name; default schema is public", "percentage": 95, "note": "Check search_path with SHOW search_path;", "command": "SHOW search_path;"},
        {"solution": "Verify table exists in correct schema: \\dt schema_name.* in psql or SELECT * FROM information_schema.tables;", "percentage": 90, "command": "\\dt"},
        {"solution": "Set search_path to include schema: SET search_path TO myschema,public;", "percentage": 85, "command": "SET search_path TO myschema,public;"}
    ]'::jsonb,
    'Database connection established, Sufficient privileges to query tables',
    'Query executes without error, Table appears in \\dt listing',
    'PostgreSQL folds unquoted identifiers to lowercase. MyTable becomes mytable unless quoted as "MyTable". Default schema is public - tables in other schemas need explicit schema qualification or search_path configuration.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/ddl-schemas.html'
),
(
    'PostgreSQL ERROR: permission denied for table',
    'postgres',
    'VERY_HIGH',
    '[
        {"solution": "Grant required privileges: GRANT SELECT, INSERT, UPDATE, DELETE ON table_name TO username;", "percentage": 95, "command": "GRANT ALL PRIVILEGES ON TABLE mytable TO myuser;"},
        {"solution": "Grant all privileges on table: GRANT ALL PRIVILEGES ON TABLE table_name TO username;", "percentage": 90, "note": "Includes SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER"},
        {"solution": "Grant privileges on all tables in schema: GRANT ALL ON ALL TABLES IN SCHEMA public TO username;", "percentage": 85, "command": "GRANT ALL ON ALL TABLES IN SCHEMA public TO myuser;"},
        {"solution": "Set default privileges for future tables: ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO username;", "percentage": 90, "note": "Applies to tables created after this command"}
    ]'::jsonb,
    'Superuser access or table owner privileges to grant permissions',
    'User can execute query without permission error, \\dp shows granted privileges',
    'In PostgreSQL 15+, public schema default permissions changed - users no longer have CREATE privilege by default. Must explicitly GRANT privileges. Use \\dp table_name to view current permissions.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/sql-grant.html'
),
(
    'PostgreSQL FATAL: sorry, too many clients already',
    'postgres',
    'HIGH',
    '[
        {"solution": "Increase max_connections in postgresql.conf and restart: max_connections = 200 (default is 100)", "percentage": 85, "note": "Requires server restart, increases memory usage", "command": "ALTER SYSTEM SET max_connections = 200;"},
        {"solution": "Implement connection pooling with PgBouncer or pgpool-II to reuse connections", "percentage": 95, "note": "Recommended for production - more efficient than increasing max_connections"},
        {"solution": "Identify and close idle connections: SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE state = ''idle'';", "percentage": 80, "command": "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE state = ''idle'';"},
        {"solution": "Reserve connections for superuser with superuser_reserved_connections = 3", "percentage": 90, "note": "Ensures superuser can always connect to fix issues"}
    ]'::jsonb,
    'Root/admin access to postgresql.conf, Ability to restart PostgreSQL service',
    'New connections succeed, pg_stat_activity shows connection count below max_connections',
    'max_connections setting requires server restart, not just reload. Each connection consumes memory - increasing beyond 200-300 can cause performance issues. Use connection pooling (PgBouncer) instead of very high max_connections.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/runtime-config-connection.html'
),
(
    'PostgreSQL ERROR: syntax error at or near',
    'postgres',
    'VERY_HIGH',
    '[
        {"solution": "Use single quotes for string literals: WHERE name = ''John'' not WHERE name = \"John\"", "percentage": 90, "note": "Double quotes are for identifiers (table/column names)"},
        {"solution": "Check for missing commas in INSERT/SELECT lists and missing parentheses", "percentage": 85, "note": "Error points to token after the missing punctuation"},
        {"solution": "Use double quotes for reserved keywords as identifiers: SELECT \"grant\" FROM table_name;", "percentage": 80, "note": "Reserved words: SELECT, INSERT, UPDATE, DELETE, GRANT, etc."},
        {"solution": "Verify SQL statement structure - PostgreSQL shows caret (^) pointing to error location in query", "percentage": 95, "note": "Error message shows failing line and column number"}
    ]'::jsonb,
    'Valid SQL syntax knowledge, Access to query text that failed',
    'Query executes without syntax error, Returns expected results or row count',
    'PostgreSQL uses single quotes for strings, double quotes for identifiers. About 18% of SQL bugs are from keyword misspellings. Error caret points to WHERE parser failed, not necessarily WHERE mistake is - check the token BEFORE the caret.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/error-style-guide.html'
),
(
    'PostgreSQL ERROR: deadlock detected',
    'postgres',
    'MEDIUM',
    '[
        {"solution": "Retry the transaction - PostgreSQL automatically aborts one transaction to resolve deadlock", "percentage": 95, "note": "Standard approach - implement automatic retry logic in application"},
        {"solution": "Acquire locks in consistent order across all transactions: always lock tables A, B, C in same sequence", "percentage": 90, "note": "Prevention strategy - eliminates circular wait condition"},
        {"solution": "Use most restrictive lock mode first to minimize lock upgrade deadlocks", "percentage": 85, "note": "FOR UPDATE before FOR SHARE"},
        {"solution": "Adjust deadlock_timeout in postgresql.conf if detection too slow: deadlock_timeout = 1s (default)", "percentage": 75, "note": "Tradeoff between deadlock detection speed and false positives"}
    ]'::jsonb,
    'Transaction isolation level understanding, Access to application code for retry logic',
    'Transaction completes successfully on retry, No deadlock errors in logs',
    'PostgreSQL auto-detects deadlocks after deadlock_timeout (default 1 second) and aborts one transaction. Best defense is acquiring locks in consistent order across ALL transactions. Deadlocks are normal in high-concurrency systems - implement retry logic.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/explicit-locking.html'
),
(
    'PostgreSQL ERROR: could not serialize access due to concurrent update',
    'postgres',
    'MEDIUM',
    '[
        {"solution": "Retry the transaction - error only occurs with REPEATABLE READ or SERIALIZABLE isolation level", "percentage": 95, "note": "Standard approach for serialization failures"},
        {"solution": "Use READ COMMITTED isolation level instead: SET TRANSACTION ISOLATION LEVEL READ COMMITTED;", "percentage": 90, "note": "Default isolation level - prevents this error", "command": "SET TRANSACTION ISOLATION LEVEL READ COMMITTED;"},
        {"solution": "Use SELECT FOR UPDATE to explicitly lock rows before updating", "percentage": 85, "note": "Prevents concurrent updates on same row", "command": "SELECT * FROM table WHERE id = 1 FOR UPDATE;"},
        {"solution": "Implement exponential backoff retry logic in application code", "percentage": 90, "note": "Retry 3-5 times with increasing delays"}
    ]'::jsonb,
    'Understanding of PostgreSQL isolation levels, Transaction retry logic in application',
    'Transaction completes successfully, Retry succeeds with updated row state',
    'This error ONLY occurs with REPEATABLE READ or SERIALIZABLE isolation levels, NOT with default READ COMMITTED. Application must automatically retry transaction when seeing this error. If using FOR UPDATE, lock must be acquired BEFORE the conflicting transaction.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/transaction-iso.html'
),
(
    'PostgreSQL ERROR: could not extend file - No space left on device',
    'postgres',
    'HIGH',
    '[
        {"solution": "Increase disk space on partition containing PostgreSQL data directory (PGDATA)", "percentage": 95, "note": "Primary solution - filesystem full"},
        {"solution": "Clean up PostgreSQL log files in pg_log directory - safe to delete old logs", "percentage": 90, "note": "Do NOT delete pg_xlog (WAL) or pg_clog - critical database files", "command": "rm /var/lib/postgresql/data/pg_log/*.log"},
        {"solution": "Remove old WAL files if safe: check with pg_archivecleanup or pg_wal directory size", "percentage": 75, "note": "Only if WAL archiving configured and archives are backed up"},
        {"solution": "Vacuum database to reclaim space: VACUUM FULL; (locks tables during operation)", "percentage": 80, "command": "VACUUM FULL;"},
        {"solution": "Drop unused indexes or truncate large temporary tables to free immediate space", "percentage": 85, "note": "Emergency measure to restore service"}
    ]'::jsonb,
    'Root/system administrator access, Disk space monitoring tools, PostgreSQL must write WAL before deleting data',
    'Disk usage below 90%, PostgreSQL operations succeed, df -h shows available space',
    'PostgreSQL must write WAL before making changes - needs free space to delete things. NEVER delete pg_xlog (renamed to pg_wal in v10+) or pg_clog - these are critical, not logs. pg_log contains error logs (safe to delete). VACUUM FULL requires 2x table size free space.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/docs/current/diskusage.html'
);
