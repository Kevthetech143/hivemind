-- Add Gradle common errors and solutions batch 1
-- Extracted from official Gradle documentation
-- Source: https://docs.gradle.org/current/userguide/troubleshooting.html

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Gradle build fails with OutOfMemory: Java heap space error',
    'gradle',
    'VERY_HIGH',
    '[
        {"solution": "Increase Gradle JVM heap size by setting org.gradle.jvmargs=-Xmx2048m in gradle.properties file", "percentage": 95, "note": "Add org.gradle.jvmargs=-Xmx2048m to gradle.properties"},
        {"solution": "Set GRADLE_OPTS environment variable before running build", "percentage": 90, "note": "Set GRADLE_OPTS=-Xmx4g for current session"},
        {"solution": "Configure test task memory separately in build.gradle", "percentage": 85, "note": "Add maxHeapSize setting to test task configuration"},
        {"solution": "Disable Kotlin compilation avoidance if using Kotlin plugin v1.8.20: add kotlinAvoidsCompilation=false to gradle.properties", "percentage": 75, "note": "Specific fix for Kotlin OutOfMemory issues with large JAR files"}
    ]'::jsonb,
    'Gradle project initialized, gradle.properties file accessible, Java runtime available',
    'Build completes without OutOfMemory errors, Build log shows no heap space warnings, All tasks execute successfully',
    'Do not set heap size too high relative to available RAM. Ensure gradle.properties is in project root, not in gradle folder. GRADLE_OPTS environment variable is session-specific. Different test and compile JVMs may need separate configuration.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://docs.gradle.org/current/userguide/troubleshooting.html'
),
(
    'Gradle version catalog error: alias is a reserved name',
    'gradle',
    'HIGH',
    '[
        {"solution": "Rename the alias to avoid reserved keywords: versions, bundles, plugins, extensions, class, convention, etc.", "percentage": 95, "note": "Direct solution from official docs"},
        {"solution": "Use dash-separated names instead of reserved keywords: change versions-api to api-versions or dependency-versions", "percentage": 90, "note": "Use different ordering or prefixes"},
        {"solution": "Check for duplicate aliases that normalize to same accessor: someAlias and some-alias normalize to same value, rename one", "percentage": 85, "command": "Verify in libs.versions.toml that no two aliases normalize to same accessor"},
        {"solution": "Update version catalog to use camelCase or other naming conventions instead of reserved names", "percentage": 80, "note": "Preventive approach for future catalogs"}
    ]'::jsonb,
    'Gradle 7.0+, version catalog file (libs.versions.toml) created, Project uses dependency management',
    'Version catalog loads without errors, All aliases resolve correctly in IDE, Build succeeds with catalog aliases available',
    'Remember that both versions and bundles cannot be used as first-level alias names. Do not use extensions, class, or convention as alias names. Dash-separated names like some-alias are normalized to camelCase when generating accessors.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://docs.gradle.org/current/userguide/how_to_fix_version_catalog_problems.html'
),
(
    'Gradle configuration cache: Cannot serialize object of type Configuration',
    'gradle',
    'HIGH',
    '[
        {"solution": "Enable configuration cache integrity checks: -Dorg.gradle.configuration-cache.integrity-check=true to identify exact serialization problems", "percentage": 90, "note": "Provides precise diagnostic information"},
        {"solution": "Turn configuration cache problems into warnings with org.gradle.unsafe.configuration-cache-problems=warn in gradle.properties to bypass failures", "percentage": 85, "note": "Workaround that allows build to proceed"},
        {"solution": "Review HTML report generated during build for problem details, grouped by message and task to identify root cause", "percentage": 90, "note": "Use --configuration-cache flag to generate report"},
        {"solution": "Avoid accessing Configuration objects during configuration phase; defer to task execution phase", "percentage": 80, "note": "Prevents serialization errors by design"}
    ]'::jsonb,
    'Gradle 7.5+, Configuration cache enabled in gradle.properties, Build previously worked without configuration cache',
    'Configuration cache entry created successfully, HTML report generated and reviewed, Build completes with configuration reused from cache',
    'Configuration cache does not support serialization of mutable Configuration objects. Do not access configurations in configuration phase if using configuration cache. External process calls during configuration phase are not supported. Integrity check mode may slow cache operations.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://docs.gradle.org/current/userguide/configuration_cache_debugging.html'
),
(
    'Gradle dependency resolution fails: Could not resolve dependency metadata',
    'gradle',
    'HIGH',
    '[
        {"solution": "Use --refresh-dependencies flag to bypass cache: ./gradlew build --refresh-dependencies", "percentage": 92, "note": "Most effective for stale/corrupt cache"},
        {"solution": "Add artifact() to repository metadataSources in Gradle 6.0+: repositories { maven { url = ... metadataSources { artifact() } } }", "percentage": 90, "note": "Required configuration change in Gradle 6.0+"},
        {"solution": "Run with --offline flag only if dependencies are cached locally: ./gradlew build --offline", "percentage": 75, "note": "Requires dependencies already downloaded"},
        {"solution": "Clear gradle cache: rm -rf ~/.gradle/caches and rerun build", "percentage": 85, "note": "Nuclear option for corrupt cache"}
    ]'::jsonb,
    'Internet connectivity available (unless using --offline), Maven or Ivy repositories configured, Gradle 5.0 or higher',
    'Dependencies resolve successfully, Build completes without resolution errors, Dependency tree shows all artifacts downloaded',
    'Gradle 6.0 changed repository behavior - metadata sources now require explicit configuration. Repository stickiness means artifacts resolved from one repo are not fetched from others. --offline mode requires all dependencies cached locally first. Cache refresh is slower but more reliable.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://docs.gradle.org/current/userguide/dependency_resolution.html'
),
(
    'Gradle task execution fails: Could not create task for plugin',
    'gradle',
    'HIGH',
    '[
        {"solution": "Verify all buildscript classpath dependencies can be resolved by checking build.gradle dependencies block", "percentage": 90, "note": "Ensure plugin JARs are available"},
        {"solution": "Clear Gradle cache with rm -rf ~/.gradle/caches/modules-2 and retry", "percentage": 85, "note": "Often resolves transient resolution failures"},
        {"solution": "Check that repositories() block includes google() and mavenCentral() for Android/Java plugins", "percentage": 88, "command": "Add repositories { google(); mavenCentral() } to buildscript block"},
        {"solution": "Verify Gradle version compatibility with plugin version - update gradle/plugins if versions mismatch", "percentage": 80, "note": "Version compatibility is critical"}
    ]'::jsonb,
    'Gradle project with plugins configured, buildscript section defined, Network access to repositories',
    'Plugin JAR resolves and downloads successfully, Task is created without errors, Build configuration phase completes',
    'Plugin classpath resolution happens before task creation. Missing repositories causes complete failure of plugin resolution. Cache corruption is common cause of transient failures. Always check plugin version compatibility with Gradle version being used.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://docs.gradle.org/current/userguide/troubleshooting.html'
),
(
    'Gradle build cache miss: Task not loaded from cache despite unchanged inputs',
    'gradle',
    'MEDIUM',
    '[
        {"solution": "Enable debug logging to identify cache key differences: ./gradlew :task --build-cache -Dorg.gradle.caching.debug=true", "percentage": 92, "note": "Reveals exact differences causing miss"},
        {"solution": "Check for implementation changes: class names, classloader hashes, or Gradle version differences affect cache key", "percentage": 88, "note": "Most common cause is buildSrc or Gradle update"},
        {"solution": "Verify task inputs are normalized correctly - avoid absolute path normalization if paths differ between CI and local", "percentage": 85, "note": "Normalization issues cause cascade misses"},
        {"solution": "Use Develocity Build Scans (if available) to visualize task input differences between builds", "percentage": 80, "note": "Enterprise feature for deep diagnostics"}
    ]'::jsonb,
    'Build cache enabled in gradle.properties, Multiple builds executed for comparison, Task marked as cacheable',
    'Cache hit occurs for identical builds, Debug output shows matching cache keys, Task execution time reduced on cache hits',
    'Cache key includes task implementation - any Gradle version or buildSrc changes cause miss. Absolute paths cause misses between different machines. Normalization issues cascade to dependent tasks. First cacheable task with miss causes all dependent tasks to execute.',
    0.84,
    'sonnet-4',
    NOW(),
    'https://docs.gradle.org/current/userguide/build_cache_debugging.html'
),
(
    'Gradle Kotlin compilation fails: Cannot use @TaskAction on incremental compile task',
    'gradle',
    'MEDIUM',
    '[
        {"solution": "Update Kotlin Gradle plugin to latest version in build.gradle: ext.kotlin_version = \"1.9.x\" or higher", "percentage": 93, "note": "Fixes version compatibility issues"},
        {"solution": "Ensure Java version 11+ is used - run with JDK 11: JAVA_HOME=/path/to/jdk11", "percentage": 90, "note": "Kotlin 1.8+ requires Java 11 minimum"},
        {"solution": "Clear build artifacts: rm -rf build/ .gradle/ and rebuild to resolve state corruption", "percentage": 85, "note": "Clears incremental compilation state"},
        {"solution": "Check for unresolved Kotlin references - run gradle assembleDebug --scan to get detailed compilation errors", "percentage": 82, "command": "grep -r 'error:' build output for unresolved references"}
    ]'::jsonb,
    'Android/Kotlin project with Gradle build system, Kotlin plugin applied, Java compiler available',
    'compileDebugKotlin task completes without errors, Kotlin classes compile to bytecode, No unresolved reference errors in logs',
    'Kotlin plugin version must match Gradle version. Java version affects Kotlin compilation. Incremental compilation state can become corrupt requiring full rebuild. Error messages may not clearly show actual compilation errors - use --scan for details.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://docs.gradle.org/current/userguide/troubleshooting.html'
),
(
    'Gradle repository authentication fails: Could not resolve due to missing credentials',
    'gradle',
    'MEDIUM',
    '[
        {"solution": "Configure credentials in build.gradle with authentication block: repositories { maven { authentication { basic(BasicAuthentication) } credentials { username = System.getenv(\"REPO_USER\") } } }", "percentage": 92, "note": "Required for authenticated repositories"},
        {"solution": "Set environment variables for credentials: export REPO_USER=username REPO_PASSWORD=password before build", "percentage": 90, "note": "Keeps credentials out of version control"},
        {"solution": "For Azure DevOps, use System.getenv(\"SYSTEM_ACCESSTOKEN\") for authentication token with basic auth", "percentage": 88, "note": "Azure specific solution"},
        {"solution": "For GitHub Packages, configure with token: credentials { username = \"__token__\" password = System.getenv(\"GITHUB_TOKEN\") }", "percentage": 85, "note": "GitHub Packages requires special token setup"}
    ]'::jsonb,
    'Private repository configured with URL, Credentials available via environment variable or gradle.properties, Build system supports BasicAuthentication',
    '401 Unauthorized errors disappear, Artifacts download from authenticated repository successfully, Build completes without credential failures',
    'Credentials must be provided via environment variables, not hardcoded in build.gradle. Authentication scheme must match repository type. Azure DevOps System.AccessToken not automatically available - must be explicitly set. GitHub requires __token__ as username with actual token as password.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://docs.gradle.org/current/userguide/dependency_resolution.html'
),
(
    'Gradle daemon issue: Multiple daemons detected due to Java version mismatch',
    'gradle',
    'MEDIUM',
    '[
        {"solution": "Ensure consistent Java version across environment: set JAVA_HOME and gradle.org.gradle.java.home to same JDK path", "percentage": 93, "note": "Primary cause and solution"},
        {"solution": "Configure toolchain in build.gradle: java { toolchain { languageVersion = JavaLanguageVersion.of(17) } } to enforce JDK version", "percentage": 90, "note": "Project-level Java version enforcement"},
        {"solution": "Stop all running daemons with ./gradlew --stop to force fresh daemon creation", "percentage": 85, "note": "Clears old daemon processes"},
        {"solution": "Check IDE settings for Gradle JDK and update to match JAVA_HOME environment variable", "percentage": 82, "note": "IDE may use different JDK"}
    ]'::jsonb,
    'Gradle project initialized, Java/JDK installed, IDE or build system configured',
    'Only one Gradle daemon running, gradle --status shows single daemon entry, Build uses consistent Java version throughout',
    'Multiple Java versions in PATH cause separate daemons. IDE settings override JAVA_HOME for Gradle execution. Gradle --status only shows daemons with same Gradle version. Stopped daemons may linger in registry requiring manual cleanup of ~/.gradle/daemon/{version}/registry.bin.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://docs.gradle.org/current/userguide/gradle_daemon.html'
),
(
    'Gradle annotation processor error: Incremental processing not supported, falling back to full compilation',
    'gradle',
    'MEDIUM',
    '[
        {"solution": "Disable annotation processor caching entirely: kapt { useBuildCache = false } for Kotlin Annotation Processing", "percentage": 88, "note": "Works around caching incompatibility"},
        {"solution": "Enable incremental annotation processing: kapt.incremental.apt=true in gradle.properties to improve performance", "percentage": 85, "note": "When processors support incremental mode"},
        {"solution": "For Room database processor, enable incremental option: kapt { arguments { arg(\"room.incremental\", \"true\") } }", "percentage": 87, "note": "Room-specific incremental processing"},
        {"solution": "Update annotation processor library versions to ones supporting incremental processing to avoid full recompilation", "percentage": 80, "note": "Long-term solution requires library updates"}
    ]'::jsonb,
    'Android/Kotlin project with annotation processors, kapt or apt configured, Build cache enabled',
    'Annotation processing completes without warnings, Incremental compilation detected in build output, Compile times improve on subsequent builds',
    'Not all annotation processors support incremental compilation - if any are incompatible, Gradle falls back to full compilation. Build cache strips /META-INF/gradle/incremental.annotation.processors metadata. Compile avoidance cannot be used with annotation processors in compile classpath. Configuration annotation processors may invalidate build cache.',
    0.82,
    'sonnet-4',
    NOW(),
    'https://docs.gradle.org/current/userguide/troubleshooting.html'
),
(
    'Gradle starting external process during configuration phase with configuration cache enabled',
    'gradle',
    'LOW',
    '[
        {"solution": "Move external process execution to task action phase instead of configuration phase", "percentage": 95, "note": "Deferred execution supports configuration cache"},
        {"solution": "Disable configuration cache for specific build: ./gradlew --no-configuration-cache if immediate fix needed", "percentage": 85, "note": "Workaround while refactoring"},
        {"solution": "Use Gradle configuration cache incompatibility mode: org.gradle.unsafe.configuration-cache-problems=warn to allow execution", "percentage": 75, "note": "Masks problem without fixing underlying issue"},
        {"solution": "Refactor plugin code to avoid system exec calls during configuration - use ProcessGroovyMethods in task actions", "percentage": 88, "note": "Proper long-term solution"}
    ]'::jsonb,
    'Gradle 7.5+, Configuration cache enabled, Custom plugin or build script with external process calls',
    'Configuration cache creates successfully, External process runs in task execution phase, Build logs show no serialization errors',
    'Configuration cache does not support arbitrary external process execution during configuration phase. Starting external processes requires deferred execution in tasks. This pattern is incompatible with configuration caching and cannot be easily worked around. Requires refactoring build logic.',
    0.79,
    'sonnet-4',
    NOW(),
    'https://docs.gradle.org/current/userguide/configuration_cache_debugging.html'
);
