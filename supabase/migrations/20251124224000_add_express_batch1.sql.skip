-- Add Express.js security vulnerabilities and common errors - Batch 1
-- Source: Express.js docs, CVE databases, security advisories
-- Extracted: 2025-11-24
-- DOC-MINER-57: Express.js CVEs and common errors

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'CVE-2024-45590: body-parser denial of service when URL encoding enabled',
    'security',
    'HIGH',
    '[
        {"solution": "Upgrade body-parser to version 1.20.3 or later", "percentage": 95, "note": "Patches the denial of service vulnerability", "command": "npm install body-parser@latest"},
        {"solution": "Upgrade Express.js to latest version which includes patched body-parser", "percentage": 93, "note": "Express 4.21.1+ includes fixed body-parser", "command": "npm install express@latest"},
        {"solution": "Implement rate limiting on endpoints using body-parser", "percentage": 85, "note": "Mitigates impact of DoS attacks", "command": "npm install express-rate-limit"},
        {"solution": "Monitor for specially crafted payloads with excessive URL encoding", "percentage": 80, "note": "Early detection helps prevent exploitation"}
    ]'::jsonb,
    'Express.js application using body-parser middleware, npm or package manager access',
    'body-parser version 1.20.3+, Security scan shows no CVE-2024-45590, Application handles URL-encoded payloads without DoS',
    'Versions prior to 1.20.3 are vulnerable. A malicious actor using a specially crafted payload could flood the server. This is an asymmetric resource consumption vulnerability (CWE-405).',
    0.95,
    'sonnet-4',
    NOW(),
    'https://expressjs.com/2024/09/29/security-releases.html'
),
(
    'Express.js error: Cannot GET / or Cannot POST /endpoint',
    'express',
    'VERY_HIGH',
    '[
        {"solution": "Define route handler for the specific path being accessed", "percentage": 92, "note": "Most common cause - no route matches the request", "command": "app.get(\"/\", (req, res) => { res.send(\"Hello\"); });"},
        {"solution": "Check that HTTP method matches route definition (GET vs POST vs PUT)", "percentage": 90, "note": "Method mismatch is frequent beginner mistake"},
        {"solution": "Verify route is registered before app.listen() is called", "percentage": 88, "note": "Order matters - routes must be defined before server starts"},
        {"solution": "Add catch-all route to handle undefined paths", "percentage": 85, "note": "Improves user experience", "command": "app.use((req, res) => { res.status(404).send(\"Not Found\"); });"}
    ]'::jsonb,
    'Express.js application running, Routes defined in code',
    'Request returns expected response, No Cannot GET/POST errors in browser or logs',
    'Routes are case-sensitive and must match exactly. Catch-all routes should be defined LAST. Middleware order affects route matching.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://expressjs.com/en/starter/basic-routing.html'
),
(
    'Express.js TypeError: next is not a function',
    'express',
    'HIGH',
    '[
        {"solution": "Add return statement before next() to prevent double execution", "percentage": 92, "note": "Most common cause - calling next() twice", "command": "if (condition) { return next(); }"},
        {"solution": "Check router.param() parameter order - value comes before next", "percentage": 88, "note": "Signature is (req, res, value, next) for router.param()", "command": "router.param(\"id\", (req, res, id, next) => {...});"},
        {"solution": "Verify middleware function signature has (req, res, next) parameters", "percentage": 90, "note": "Missing next parameter causes this error"},
        {"solution": "Ensure next is not being overwritten in middleware code", "percentage": 85, "note": "Variable name collision can cause this"}
    ]'::jsonb,
    'Express.js middleware or route handlers defined, Application code accessible',
    'Middleware executes without TypeError, next() properly chains to subsequent handlers',
    'Never call next() twice in same middleware. Always return after calling next() to stop execution. The next parameter must be included in function signature.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://expressjs.com/en/guide/using-middleware.html'
),
(
    'Express.js error: listen EADDRINUSE address already in use',
    'express',
    'VERY_HIGH',
    '[
        {"solution": "Find and kill process using the port", "percentage": 93, "note": "Most direct solution", "command": "lsof -ti:3000 | xargs kill -9 (macOS/Linux) or taskkill /F /IM node.exe (Windows)"},
        {"solution": "Change port number to an available port", "percentage": 90, "note": "Quick workaround", "command": "app.listen(process.env.PORT || 3001)"},
        {"solution": "Use kill-port npm package to automate port cleanup", "percentage": 88, "note": "Cross-platform solution", "command": "npx kill-port 3000"},
        {"solution": "Exit terminal with Ctrl+C if server is running in background", "percentage": 85, "note": "Simple fix for accidental multiple instances"}
    ]'::jsonb,
    'Express.js server attempting to start, Port number known, Terminal or command line access',
    'Server starts successfully, No EADDRINUSE error, Application accessible on specified port',
    'Port already being used by another application or zombie Express process. Avoid hardcoding port numbers - use environment variables. Check for hidden terminal windows with running servers.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://expressjs.com/en/starter/basic-routing.html'
),
(
    'Express.js Helmet COEP error: ERR_BLOCKED_BY_RESPONSE.NotSameOrigin',
    'security',
    'HIGH',
    '[
        {"solution": "Disable Cross-Origin-Embedder-Policy header in Helmet", "percentage": 93, "note": "Quick fix for cross-origin resource loading", "command": "app.use(helmet({ crossOriginEmbedderPolicy: false }));"},
        {"solution": "Configure COEP to allow credentials for specific origins", "percentage": 88, "note": "More secure than disabling entirely", "command": "helmet({ crossOriginEmbedderPolicy: { policy: \"credentialless\" } })"},
        {"solution": "Set CORP headers on external resources you control", "percentage": 85, "note": "Proper long-term solution for owned resources"},
        {"solution": "Serve cross-origin resources from same domain using proxy", "percentage": 80, "note": "Eliminates cross-origin issues"}
    ]'::jsonb,
    'Express.js application using Helmet middleware, Loading cross-origin resources',
    'Cross-origin resources load successfully, No ERR_BLOCKED_BY_RESPONSE errors in console',
    'COEP require-corp makes loading cross-origin resources restrictive by default. Helmet sets COEP header automatically. Images from external domains need CORP headers.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://helmetjs.github.io/'
),
(
    'Express.js Content Security Policy blocking inline scripts',
    'security',
    'HIGH',
    '[
        {"solution": "Configure Helmet CSP to allow specific script sources", "percentage": 90, "note": "Maintain security while allowing needed scripts", "command": "helmet.contentSecurityPolicy({ directives: { scriptSrc: [\"''self''\", \"cdn.example.com\"] } })"},
        {"solution": "Use nonces for inline scripts", "percentage": 92, "note": "Best practice for inline script security", "command": "<script nonce=\"${req.nonce}\">"},
        {"solution": "Move inline scripts to external files", "percentage": 88, "note": "Cleanest solution for CSP compliance"},
        {"solution": "Disable CSP in development only", "percentage": 75, "note": "Temporary workaround - DO NOT use in production", "command": "if (process.env.NODE_ENV === \"development\") helmet({ contentSecurityPolicy: false })"}
    ]'::jsonb,
    'Express.js application with Helmet middleware, Inline scripts or external script sources',
    'Scripts execute without CSP violations, No console errors about blocked scripts',
    'Helmet sets strict CSP by default. Inline scripts are blocked by default CSP. Never use unsafe-inline in production - use nonces instead. Helmet performs minimal CSP validation.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://helmetjs.github.io/'
),
(
    'Express.js CORS error: No Access-Control-Allow-Origin header',
    'express',
    'VERY_HIGH',
    '[
        {"solution": "Install and configure cors middleware", "percentage": 95, "note": "Standard solution for CORS", "command": "npm install cors && app.use(cors())"},
        {"solution": "Configure cors for specific origins", "percentage": 92, "note": "More secure than allowing all origins", "command": "app.use(cors({ origin: \"https://yourdomain.com\" }))"},
        {"solution": "Enable credentials for authenticated requests", "percentage": 88, "note": "Required for cookies/auth headers", "command": "cors({ origin: true, credentials: true })"},
        {"solution": "Set CORS headers manually if not using middleware", "percentage": 80, "note": "More control but more code", "command": "res.header(\"Access-Control-Allow-Origin\", \"*\")"}
    ]'::jsonb,
    'Express.js API accessed from browser on different origin, npm access to install cors package',
    'Cross-origin requests succeed, CORS headers present in response, No console errors in browser',
    'CORS errors only occur in browsers, not server-to-server. Wildcard origin (*) cannot be used with credentials:true. Helmet and CORS serve different purposes - use both.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://expressjs.com/en/resources/middleware/cors.html'
),
(
    'Express.js error: Headers already sent, cannot set headers',
    'express',
    'HIGH',
    '[
        {"solution": "Add return statement after sending response to stop execution", "percentage": 93, "note": "Prevents code after res.send() from running", "command": "return res.json(data);"},
        {"solution": "Check res.headersSent before sending second response", "percentage": 90, "note": "Defensive programming pattern", "command": "if (!res.headersSent) { res.send(data); }"},
        {"solution": "Fix asynchronous code that tries to send multiple responses", "percentage": 88, "note": "Common in callbacks and promises"},
        {"solution": "Use next(err) instead of res.send() in error cases", "percentage": 85, "note": "Let error handler send response", "command": "if (error) return next(error);"}
    ]'::jsonb,
    'Express.js route handlers with response logic, Error stack trace available',
    'Single response sent per request, No header-already-sent errors in logs',
    'Once headers are sent, cannot send another response. Calling res.send(), res.json(), res.redirect() sends headers. Always return after sending response. Common in if/else without return statements.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://expressjs.com/en/guide/error-handling.html'
),
(
    'Express.js error: unhandled promise rejection in async route handler',
    'express',
    'HIGH',
    '[
        {"solution": "Wrap async route handlers with try-catch and pass errors to next()", "percentage": 93, "note": "Standard error handling pattern", "command": "try { await asyncOp(); } catch(err) { next(err); }"},
        {"solution": "Use express-async-errors package to auto-handle rejections", "percentage": 90, "note": "Eliminates need for try-catch everywhere", "command": "npm install express-async-errors && require(\"express-async-errors\")"},
        {"solution": "Attach .catch(next) to promise chains", "percentage": 88, "note": "Works for promise-based code", "command": "asyncOp().then(data => res.json(data)).catch(next)"},
        {"solution": "Upgrade to Express 5 which handles promise rejections automatically", "percentage": 85, "note": "Express 5+ auto-calls next() on rejection"}
    ]'::jsonb,
    'Express.js application with async route handlers, Error logs showing unhandled rejections',
    'Errors caught and passed to error handler, No unhandled rejection warnings, Error responses sent to client',
    'Express 4 does not catch async errors automatically. Unhandled rejections crash the server in production. Always handle promise rejections in middleware. Express 5 fixes this behavior.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://expressjs.com/en/guide/error-handling.html'
),
(
    'Express.js security: weak express-session secret key detected',
    'security',
    'HIGH',
    '[
        {"solution": "Generate strong random secret key using crypto module", "percentage": 95, "note": "Use cryptographically secure random string", "command": "secret: require(\"crypto\").randomBytes(64).toString(\"hex\")"},
        {"solution": "Store secret in environment variable, never hardcode", "percentage": 93, "note": "Keep secrets out of version control", "command": "secret: process.env.SESSION_SECRET"},
        {"solution": "Use secret key of at least 32 characters from secure source", "percentage": 90, "note": "Longer keys are more secure"},
        {"solution": "Rotate session secret periodically and support key array for graceful rotation", "percentage": 85, "note": "Best practice for production", "command": "secret: [newSecret, oldSecret]"}
    ]'::jsonb,
    'Express.js application using express-session middleware, Access to environment configuration',
    'Session cookies properly signed and validated, Strong secret configured, No security warnings',
    'Weak/known secret keys can be guessed by attackers enabling session tampering. Secret key is used to sign session cookie for integrity. Default or simple secrets (like "secret" or "keyboard cat") are insecure.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://www.npmjs.com/package/express-session'
),
(
    'Express.js rate limiting: 429 Too Many Requests',
    'security',
    'HIGH',
    '[
        {"solution": "Implement express-rate-limit middleware with appropriate limits", "percentage": 93, "note": "Standard solution for rate limiting", "command": "const limiter = rateLimit({ windowMs: 15*60*1000, max: 100 }); app.use(limiter);"},
        {"solution": "Configure different limits for different endpoint sensitivity", "percentage": 90, "note": "Auth endpoints need stricter limits", "command": "app.use(\"/api/auth\", rateLimit({ windowMs: 15*60*1000, max: 5 }))"},
        {"solution": "Use Redis store for distributed rate limiting across servers", "percentage": 88, "note": "Required for multi-server deployments", "command": "store: new RedisStore({ client: redisClient })"},
        {"solution": "Return Retry-After header to inform clients when to retry", "percentage": 85, "note": "Better client experience", "command": "standardHeaders: true, legacyHeaders: false"}
    ]'::jsonb,
    'Express.js application exposed to public internet, Redis available for distributed systems',
    'Rate limits enforced, 429 responses sent when limits exceeded, Retry-After headers present, Brute-force attacks mitigated',
    'Rate limiting is critical for production APIs. Limits should be based on usage patterns. IP-based limiting can be bypassed by attackers using proxies. Combine with authentication-based limiting for better security.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://www.npmjs.com/package/express-rate-limit'
),
(
    'Express.js security: X-Powered-By header exposes Express version',
    'security',
    'MEDIUM',
    '[
        {"solution": "Disable X-Powered-By header using app.disable()", "percentage": 95, "note": "Simple one-line fix", "command": "app.disable(\"x-powered-by\")"},
        {"solution": "Use Helmet middleware which disables it automatically", "percentage": 93, "note": "Helmet provides comprehensive security headers", "command": "app.use(helmet())"},
        {"solution": "Set custom X-Powered-By header to obscure real framework", "percentage": 80, "note": "Security through obscurity - not recommended as primary defense", "command": "app.use((req, res, next) => { res.setHeader(\"X-Powered-By\", \"Custom\"); next(); })"}
    ]'::jsonb,
    'Express.js application in production, Ability to modify application code',
    'X-Powered-By header absent or customized in HTTP responses, Server fingerprinting reduced',
    'Express sends X-Powered-By: Express by default. This helps attackers fingerprint the server and target known vulnerabilities. Removing this header is security best practice. Use Helmet for comprehensive header security.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://expressjs.com/en/advanced/best-practice-security.html'
);
