-- Add PostgreSQL CVE security advisories batch 1
-- DOC-MINER-CVE-01: SQL injection, privilege escalation, extension vulnerabilities
-- Source: Official PostgreSQL security advisories (https://www.postgresql.org/support/security/)
-- Mined: 2025-11-24

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'CVE-2023-39417: PostgreSQL extension script SQL injection via @substitutions@',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade PostgreSQL to version 15.4, 14.9, 13.12, 12.16, or 11.21 which contain patches for this vulnerability", "percentage": 95, "note": "Official fix from PostgreSQL security team"},
        {"solution": "Audit all extension scripts for @substitution@ usage in CREATE/ALTER statements within quoted strings", "percentage": 90, "note": "Review custom extensions before upgrade"},
        {"solution": "Restrict extension installation privileges to trusted superusers only until patched", "percentage": 85, "note": "Temporary mitigation for unpatched systems"},
        {"solution": "Review extension code for improper handling of substitution parameters that could allow SQL injection", "percentage": 80, "note": "Look for @extschema@, @extowner@, etc. within quoted contexts"}
    ]'::jsonb,
    'PostgreSQL versions 15.0-15.3, 14.0-14.8, 13.0-13.11, 12.0-12.15, or 11.0-11.20, Ability to upgrade database',
    'PostgreSQL version shows patched release number, Extension scripts execute without SQL injection risk, Security audit passes',
    'Malicious extensions can inject SQL through improperly handled @substitution@ parameters. Affects CREATE EXTENSION and ALTER EXTENSION UPDATE. Custom extensions need manual review.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2023-39417/'
),
(
    'CVE-2025-1094: PostgreSQL SQL injection via encoding validation bypass in quoting APIs',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade to PostgreSQL 17.3, 16.7, 15.11, or 14.16 immediately to patch critical SQL injection vulnerability", "percentage": 95, "note": "CVSS 8.1 - Critical severity"},
        {"solution": "Review all client code using PQescapeStringConn, PQescapeLiteral, PQescapeIdentifier for handling of invalid encoding sequences", "percentage": 90, "note": "APIs affected by encoding bypass"},
        {"solution": "Validate input encoding before passing to PostgreSQL quoting functions in client applications", "percentage": 85, "note": "Additional layer of defense"},
        {"solution": "Use parameterized queries instead of manual string quoting to avoid SQL injection entirely", "percentage": 95, "note": "Best practice - eliminates quoting vulnerabilities"}
    ]'::jsonb,
    'PostgreSQL versions 17.0-17.2, 16.0-16.6, 15.0-15.10, or 14.0-14.15, Client applications using libpq quoting APIs',
    'PostgreSQL upgraded to patched version, Parameterized queries implemented, No encoding validation failures in logs',
    'Text failing encoding validation can bypass quoting protections. Affects PQescapeStringConn, PQescapeLiteral, PQescapeIdentifier. Invalid UTF-8 sequences particularly dangerous. Use parameterized queries.',
    0.95,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2025-1094/'
),
(
    'CVE-2024-10979: PostgreSQL PL/Perl privilege escalation via environment variable manipulation',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade PostgreSQL to 17.1, 16.5, 15.9, or 14.14 to fix PL/Perl environment variable security flaw", "percentage": 95, "note": "CVSS 8.8 - Critical severity"},
        {"solution": "Audit all PL/Perl functions for environment variable usage and restrict to trusted users only", "percentage": 90, "note": "Review %ENV access in Perl code"},
        {"solution": "Remove untrusted PL/Perl language (plperlu) if not required for database operations", "percentage": 85, "command": "DROP EXTENSION plperlu CASCADE;", "note": "Reduces attack surface"},
        {"solution": "Implement row-level security policies on functions using PL/Perl to restrict execution", "percentage": 80, "note": "Additional access control layer"}
    ]'::jsonb,
    'PostgreSQL with PL/Perl extension installed, Versions 17.0, 16.0-16.4, 15.0-15.8, or 14.0-14.13',
    'PostgreSQL upgraded to patched version, PL/Perl functions execute without privilege escalation, Environment variables properly isolated',
    'Authenticated users can execute arbitrary code by manipulating environment variables within PL/Perl functions. Affects both trusted (plperl) and untrusted (plperlu) variants. Environment changes persist across function calls.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2024-10979/'
),
(
    'CVE-2024-0985: PostgreSQL privilege escalation via REFRESH MATERIALIZED VIEW CONCURRENTLY',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade PostgreSQL to 16.2, 15.6, 14.11, 13.14, or 12.18 to patch materialized view vulnerability", "percentage": 95, "note": "CVSS 8.0 - Critical severity"},
        {"solution": "Audit materialized views for SECURITY DEFINER functions and restrict REFRESH privileges", "percentage": 90, "note": "Review view definitions for privilege escalation risk"},
        {"solution": "Grant REFRESH privilege on materialized views only to trusted users until patched", "percentage": 85, "note": "Temporary mitigation"},
        {"solution": "Replace REFRESH MATERIALIZED VIEW CONCURRENTLY with non-concurrent refresh where possible", "percentage": 75, "note": "Reduces attack surface but impacts availability"}
    ]'::jsonb,
    'PostgreSQL versions 16.0-16.1, 15.0-15.5, 14.0-14.10, 13.0-13.13, or 12.0-12.17, Materialized views with CONCURRENT refresh',
    'PostgreSQL version patched, Non-owner users cannot execute arbitrary SQL via REFRESH, Security audit passes',
    'Non-owner users can execute arbitrary SQL through REFRESH MATERIALIZED VIEW CONCURRENTLY. Vulnerability allows privilege escalation via SECURITY DEFINER functions. Only affects CONCURRENT refresh mode.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2024-0985/'
),
(
    'CVE-2023-5869: PostgreSQL arbitrary code execution via array modification integer overflow',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade to PostgreSQL 16.1, 15.5, 14.10, 13.13, or 12.17 to fix buffer overrun vulnerability", "percentage": 95, "note": "CVSS 8.8 - Critical severity"},
        {"solution": "Review application code for array modification operations with user-controlled dimensions", "percentage": 90, "note": "Identify potential attack vectors"},
        {"solution": "Implement input validation on array size and dimension parameters before database operations", "percentage": 85, "note": "Additional protection layer"},
        {"solution": "Restrict array manipulation functions to trusted users via database permissions", "percentage": 80, "note": "Limit exposure until patched"}
    ]'::jsonb,
    'PostgreSQL versions 16.0, 15.0-15.4, 14.0-14.9, 13.0-13.12, or 12.0-12.16, Applications using array modification',
    'PostgreSQL upgraded to fixed version, No buffer overrun errors in logs, Array operations execute safely',
    'Integer overflow in array modification enables buffer overrun and code execution. Malicious array operations can overflow internal buffers. Affects array_set, array_cat, and related functions.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2023-5869/'
),
(
    'CVE-2023-2454: PostgreSQL privilege escalation via CREATE SCHEMA search_path bypass',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade PostgreSQL to 15.3, 14.8, 13.11, 12.15, or 11.20 to fix search_path security bypass", "percentage": 95, "note": "CVSS 7.2 - High severity"},
        {"solution": "Set search_path explicitly at session or role level to prevent search_path manipulation attacks", "percentage": 90, "command": "ALTER ROLE username SET search_path = schema1, schema2;", "note": "Hardens configuration"},
        {"solution": "Audit CREATE SCHEMA statements for schema_element clauses that could bypass protective search_path", "percentage": 85, "note": "Review schema creation patterns"},
        {"solution": "Use schema-qualified object references instead of relying on search_path resolution", "percentage": 80, "note": "Eliminates search_path dependency"}
    ]'::jsonb,
    'PostgreSQL versions 15.0-15.2, 14.0-14.7, 13.0-13.10, 12.0-12.14, or 11.0-11.19, CREATE SCHEMA privilege',
    'PostgreSQL patched, search_path configurations enforced, Schema creation no longer bypasses security settings',
    'CREATE SCHEMA ... schema_element defeats protective search_path changes. Attackers can execute privileged operations by manipulating schema search order. Set explicit search_path at role level.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2023-2454/'
),
(
    'CVE-2024-10976: PostgreSQL row-level security bypass with user ID changes in subqueries',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade to PostgreSQL 17.1, 16.5, 15.9, or 14.14 to fix RLS bypass vulnerability", "percentage": 95, "note": "CVSS 4.2 - Medium severity"},
        {"solution": "Review RLS policies on tables accessed via subqueries with SET ROLE or security definer functions", "percentage": 90, "note": "Audit policy effectiveness"},
        {"solution": "Avoid user ID changes within queries that access RLS-protected tables", "percentage": 85, "note": "Design pattern change"},
        {"solution": "Test RLS policies with nested queries and user context switches to verify enforcement", "percentage": 80, "note": "Validation testing"}
    ]'::jsonb,
    'PostgreSQL versions 17.0, 16.0-16.4, 15.0-15.8, or 14.0-14.13, Tables with row-level security enabled, Subqueries with user context changes',
    'PostgreSQL upgraded, RLS policies enforce correctly in nested contexts, Security tests pass',
    'RLS policies disregard user ID changes in subquery contexts. SET ROLE or SECURITY DEFINER functions can bypass row security. Query optimization may inline subqueries, breaking RLS enforcement.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2024-10976/'
),
(
    'CVE-2023-2455: PostgreSQL row-level security bypass after query inlining',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade to PostgreSQL 15.3, 14.8, 13.11, 12.15, or 11.20 to fix RLS inlining vulnerability", "percentage": 95, "note": "CVSS 4.2 - Medium severity"},
        {"solution": "Review and test all RLS policies on tables accessed via views or functions that may be inlined", "percentage": 90, "note": "Verify policy enforcement after optimization"},
        {"solution": "Use SECURITY BARRIER views for RLS-protected tables to prevent unsafe optimization", "percentage": 85, "command": "CREATE VIEW view_name WITH (security_barrier) AS SELECT ...", "note": "Prevents problematic inlining"},
        {"solution": "Disable query optimization for specific functions using VOLATILE or STABLE keywords strategically", "percentage": 75, "note": "Limits optimizer changes to query plan"}
    ]'::jsonb,
    'PostgreSQL versions 15.0-15.2, 14.0-14.7, 13.0-13.10, 12.0-12.14, or 11.0-11.19, Row-level security policies, Views or functions',
    'PostgreSQL patched, RLS policies enforce correctly after optimization, SECURITY BARRIER views deployed where needed',
    'Query optimizer inlining can bypass RLS policies when user ID changes. Planner may execute checks under wrong user context. Use security_barrier views to prevent unsafe optimizations.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2023-2455/'
),
(
    'CVE-2023-39418: PostgreSQL MERGE statement fails to enforce row-level security policies',
    'cve',
    'LOW',
    '[
        {"solution": "Upgrade PostgreSQL to 16.1, 15.5 to fix MERGE statement RLS enforcement", "percentage": 95, "note": "CVSS 3.1 - Low severity"},
        {"solution": "Avoid using MERGE on RLS-protected tables until upgraded to patched version", "percentage": 90, "note": "Use separate INSERT/UPDATE/DELETE instead"},
        {"solution": "Review audit logs for MERGE operations on tables with RLS policies to detect potential bypasses", "percentage": 85, "note": "Forensic analysis"},
        {"solution": "Grant MERGE privilege only to trusted users on RLS-protected tables", "percentage": 80, "note": "Access control mitigation"}
    ]'::jsonb,
    'PostgreSQL versions 16.0, 15.0-15.4 with MERGE statement support, Tables with row-level security enabled',
    'PostgreSQL upgraded to 16.1 or 15.5+, MERGE statements enforce RLS correctly, Security audit passes',
    'MERGE statement does not apply UPDATE or SELECT row security policies. Affects PostgreSQL 15+ where MERGE was introduced. Use separate DML statements if RLS enforcement critical.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2023-39418/'
),
(
    'CVE-2022-2625: PostgreSQL extension scripts replace objects not belonging to extension',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade PostgreSQL to 14.5, 13.8, 12.12, 11.17, or 10.22 to fix extension object replacement vulnerability", "percentage": 95, "note": "CVSS 7.1 - High severity"},
        {"solution": "Audit extension installation scripts for object creation that could replace system or user objects", "percentage": 90, "note": "Review CREATE OR REPLACE patterns in extensions"},
        {"solution": "Install extensions only from trusted sources (official PostgreSQL repository or verified vendors)", "percentage": 85, "note": "Supply chain security"},
        {"solution": "Use dedicated schemas for extensions to isolate objects and prevent replacement attacks", "percentage": 80, "command": "CREATE EXTENSION extension_name SCHEMA extension_schema;", "note": "Namespace isolation"}
    ]'::jsonb,
    'PostgreSQL versions 14.0-14.4, 13.0-13.7, 12.0-12.11, 11.0-11.16, or 10.0-10.21, Extension installation capability',
    'PostgreSQL upgraded to patched version, Extension scripts no longer modify unrelated objects, Installation logs clean',
    'Extension scripts can modify or replace database objects outside extension scope during installation. Malicious extensions could hijack system functions or user tables. Always review extension code before installation.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2022-2625/'
),
(
    'CVE-2024-7348: PostgreSQL arbitrary SQL execution via relation replacement during pg_dump',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade PostgreSQL to 17.0, 16.4, 15.8, 14.13, 13.16, or 12.20 to fix pg_dump vulnerability", "percentage": 95, "note": "CVSS 8.8 - Critical severity"},
        {"solution": "Restrict concurrent DDL operations during pg_dump execution on production databases", "percentage": 90, "note": "Prevent table replacement attacks"},
        {"solution": "Use snapshot isolation for pg_dump by taking application-level backup locks", "percentage": 85, "note": "Ensures consistent dump state"},
        {"solution": "Monitor for suspicious CREATE OR REPLACE TABLE operations during backup windows", "percentage": 80, "note": "Detect attack attempts"}
    ]'::jsonb,
    'PostgreSQL versions 17.0 RC1, 16.0-16.3, 15.0-15.7, 14.0-14.12, 13.0-13.15, or 12.0-12.19, pg_dump usage',
    'PostgreSQL upgraded to patched version, pg_dump executes without SQL injection risk, Backups verified as secure',
    'Concurrent table replacement during pg_dump allows SQL injection. Attacker can replace relation during dump to inject arbitrary SQL. Use transaction snapshots to prevent concurrent modifications.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2024-7348/'
),
(
    'CVE-2022-1552: PostgreSQL privilege escalation via autovacuum and REINDEX security sandbox bypass',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Upgrade to PostgreSQL 14.3, 13.7, 12.11, 11.16, or 10.21 to fix maintenance operation sandbox bypass", "percentage": 95, "note": "CVSS 8.8 - Critical severity"},
        {"solution": "Review and restrict CREATE INDEX, CREATE STATISTICS, and autovacuum configurations to trusted users", "percentage": 90, "note": "Limit attack surface"},
        {"solution": "Audit index expressions and statistics for functions that could execute with escalated privileges", "percentage": 85, "note": "Review expression indexes and extended statistics"},
        {"solution": "Disable autovacuum on untrusted tables until patched", "percentage": 75, "command": "ALTER TABLE table_name SET (autovacuum_enabled = false);", "note": "Temporary mitigation with performance impact"}
    ]'::jsonb,
    'PostgreSQL versions 14.0-14.2, 13.0-13.6, 12.0-12.10, 11.0-11.15, or 10.0-10.20, Autovacuum enabled, Expression indexes or extended statistics',
    'PostgreSQL upgraded to patched version, Maintenance operations enforce security restrictions, No privilege escalation in logs',
    'Autovacuum, REINDEX, and similar maintenance operations bypass security restricted operation sandbox. Expression indexes and extended statistics with malicious functions can escalate privileges. Functions execute as superuser during maintenance.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://www.postgresql.org/support/security/CVE-2022-1552/'
);
