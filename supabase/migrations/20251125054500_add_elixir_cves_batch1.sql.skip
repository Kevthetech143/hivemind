-- Mining CVE entries from Elixir/Phoenix/Hex ecosystem
-- Source: GitHub Advisory Database, NVD, Snyk Security
-- Category: cve
-- Date: 2025-11-25

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES
(
    'CVE-2017-1000163: Phoenix Arbitrary URL Redirect vulnerability',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade Phoenix to version 1.0.6, 1.1.8, or 1.2.3 or higher", "percentage": 95, "note": "Official patch that blocks malicious redirect payloads"},
        {"solution": "Review code using Phoenix.Controller.redirect/2 with user-controlled input", "percentage": 85, "note": "Audit existing redirect implementations before patching"},
        {"solution": "Validate redirect URLs against whitelist before passing to redirect/2", "percentage": 90, "command": "Use URI.parse and check host against trusted list", "note": "Defense in depth approach"}
    ]'::jsonb,
    'Phoenix 1.0.0-1.2.2 deployed, Git repo access, Ability to rebuild',
    'Application starts without errors after upgrade, Malicious redirects blocked, Tests pass',
    'Do not assume redirect/2 validates external URLs - it only prevents basic external redirects. Browser interpretation varies (Chrome/Firefox handle \\n differently). Manual validation is still necessary.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://github.com/advisories/GHSA-cmfh-8f8r-fj96'
),
(
    'CVE-2022-42975: Phoenix WebSocket check_origin wildcard mishandling',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade Phoenix to version 1.6.14 or later", "percentage": 95, "note": "Fixes improper wildcard origin validation in socket transport"},
        {"solution": "Review check_origin configuration in UserSocket endpoint", "percentage": 85, "note": "Audit wildcard patterns used in socket connection security"},
        {"solution": "Test WebSocket connections from different origins after patching", "percentage": 90, "command": "Run integration tests with cross-origin requests", "note": "Verify origin validation is working as expected"}
    ]'::jsonb,
    'Phoenix < 1.6.14 deployed, Mix/Hex available, WebSocket endpoints configured',
    'WebSocket connections from unauthorized origins rejected, CSRF validation works, No errors in logs',
    'LiveView applications are unaffected due to built-in CSRF token protection. The vulnerability only affects raw WebSocket connections using check_origin. Do not rely on wildcard patterns with explicit origins.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2022-42975'
),
(
    'CVE-2024-25718: Samly SAML session expiration bypass in access control',
    'cve',
    'VERY_HIGH',
    '[
        {"solution": "Update Samly package to version 1.4.0 or later", "percentage": 95, "note": "Implements session expiration validation in get_assertion/3"},
        {"solution": "Review SAML assertion caching strategy in application code", "percentage": 85, "note": "Ensure cached sessions are invalidated on expiry"},
        {"solution": "Implement additional server-side session validation middleware", "percentage": 90, "command": "Check session expiry timestamp on every authenticated request", "note": "Defense in depth prevents expired credentials from granting access"}
    ]'::jsonb,
    'Samly < 1.4.0 in use, SAML 2.0 authentication active, Mix dependency management',
    'Expired sessions rejected immediately, AuthHandler validates session timestamps, No unauthorized access with stale tokens',
    'Do not rely solely on cached credentials - always validate expiry before granting access. Session cache is vulnerable to replay attacks if expiration is not enforced. Enable server-side session tracking.',
    0.94,
    'sonnet-4',
    NOW(),
    'https://github.com/advisories/GHSA-h3rw-77w7-92gf'
),
(
    'CVE-2018-1000883: Plug header injection via malicious cookie values',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade Plug to version 1.0.6, 1.1.9, 1.2.5, or 1.3.5+", "percentage": 95, "note": "Adds input validation to cookie handling in Connection module"},
        {"solution": "Sanitize and validate all cookie input before processing", "percentage": 85, "note": "Even with patch, validate untrusted cookie sources"},
        {"solution": "Review HTTP response headers being set from user input", "percentage": 80, "command": "Audit cookie generation and response header construction", "note": "Prevent injection of arbitrary headers through cookies"}
    ]'::jsonb,
    'Plug < 1.3.5 deployed, Cookie-based authentication in use, Mix/Hex available',
    'No extra headers in HTTP responses from cookies, Application starts after upgrade, Security tests pass',
    'Cookie validation happens at Connection layer - do not assume safety from trusting cookies. Validate cookies before using in response headers. User interaction required for exploitation but still critical for web apps.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://github.com/advisories/GHSA-9h73-w7ch-rh73'
),
(
    'CVE-2017-1000052: Plug.Static null byte injection bypasses file type restrictions',
    'cve',
    'HIGH',
    '[
        {"solution": "Upgrade Plug to patched versions: 1.0.4, 1.1.7, 1.2.3, or 1.3.2+", "percentage": 95, "note": "Adds null byte filtering to static file path handling"},
        {"solution": "Serve uploaded files from cloud storage (S3, etc) instead of local filesystem", "percentage": 90, "note": "Cloud storage is not affected by this vulnerability"},
        {"solution": "Implement file type validation independent of filename extension", "percentage": 85, "command": "Use file magic bytes/MIME detection instead of extension checking", "note": "Defense in depth prevents bypass even if null bytes are crafted"}
    ]'::jsonb,
    'Plug < 1.3.2 with local file serving enabled, File upload functionality active, Mix dependency management',
    'Null byte payloads rejected, Files with wrong extensions blocked, Upload tests pass',
    'Only affects local filesystem serving - cloud storage unaffected. Attackers can bypass filetype restrictions by appending null bytes (e.g., malicious.exe%00.txt). Do not rely on filename extensions for validation.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://github.com/advisories/GHSA-2q6v-32mr-8p8x'
),
(
    'CVE-2021-32851: Mind-elixir XSS in menu field name handling',
    'cve',
    'MEDIUM',
    '[
        {"solution": "Upgrade mind-elixir to version 0.18.1 or 0.19.2+", "percentage": 95, "note": "Fixes DOM insertion of unsanitized menu names"},
        {"solution": "Sanitize menu field names before passing to MindElixir constructor", "percentage": 90, "note": "Escape HTML special characters in field values"},
        {"solution": "Use Content Security Policy (CSP) headers to prevent inline script execution", "percentage": 80, "command": "Set-Content-Security-Policy: script-src ''self''", "note": "Mitigates XSS impact even if payload bypasses sanitization"}
    ]'::jsonb,
    'Mind-elixir < 0.18.1 in use, Untrusted user input for menu names, Browser environment with DOM manipulation',
    'Menu names rendered without HTML interpretation, No JavaScript execution from menu text, CSP violations logged if attempted',
    'Vulnerability in contextMenu.js where innerHTML is used with user input. Always sanitize before DOM insertion. User interaction not required if attacker controls menu field name during initialization.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://securitylab.github.com/advisories/GHSL-2021-1047_Mind-elixir/'
),
(
    'CVE-2017-1000163 Exploit Pattern: Newline injection in Phoenix redirects',
    'cve',
    'HIGH',
    '[
        {"solution": "Block newline characters (\\r\\n) in redirect URL parameters", "percentage": 90, "note": "Prevent carriage return line feed injection"},
        {"solution": "Use URI.parse and validate the scheme matches (http/https)", "percentage": 85, "command": "URI.parse(url) |> validate_local_origin()", "note": "Ensure redirect target is same-origin"},
        {"solution": "Implement redirect URL whitelist with regex or exact matching", "percentage": 95, "note": "Only allow redirects to pre-approved paths"}
    ]'::jsonb,
    'Phoenix application with user-controlled redirects, URI module available, Test environment',
    'Newline injection attempts blocked, Only whitelisted URLs accepted, No external redirects possible',
    'The vulnerability relies on browser interpretation differences. Chrome/Firefox handle %0A differently. Always validate at HTTP level, not just in code. Path-relative URLs like /path are safe.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2017-1000163'
),
(
    'CVE-2024-25718 Exploit Pattern: SAML assertion cache abuse for privilege escalation',
    'cve',
    'CRITICAL',
    '[
        {"solution": "Validate session timestamps on every authenticated request", "percentage": 95, "note": "Call Samly.State.Store.get_assertion before granting access"},
        {"solution": "Implement session TTL enforcement at middleware layer", "percentage": 90, "command": "Check exp claim and reject if expired before AuthHandler caching", "note": "Prevent cache population with expired assertions"},
        {"solution": "Clear session cache on logout and periodically expire old entries", "percentage": 85, "note": "Use ETS time-to-live or explicit deletion on session termination"}
    ]'::jsonb,
    'Samly 1.3.x or earlier in production, SAML 2.0 deployed, Access to application logs',
    'Expired sessions rejected at handler layer, Cache no longer valid after token expiry, Logout clears assertions',
    'Attacker reuses expired session token from browser cache. The cached assertion is used even after expiration because Samly.AuthHandler does not check timestamps. This is critical for any SAML 2.0 app.',
    0.96,
    'sonnet-4',
    NOW(),
    'https://nvd.nist.gov/vuln/detail/CVE-2024-25718'
),
(
    'Elixir CVE Prevention Pattern: Input validation for URL and redirect handling',
    'cve',
    'HIGH',
    '[
        {"solution": "Create reusable redirect validation function accepting whitelist", "percentage": 90, "note": "validate_redirect_url(url, allowed_hosts) centralizes logic"},
        {"solution": "Use Plug.Router''s match pattern to restrict redirect destinations", "percentage": 85, "command": "Only allow path-relative URLs like /dashboard, /profile", "note": "Prevents any external redirect possibility"},
        {"solution": "Log all redirect attempts including source and destination", "percentage": 80, "note": "Enables security monitoring and incident response"}
    ]'::jsonb,
    'Phoenix router configured, URI validation library available, Logging system active',
    'Redirects only to whitelisted destinations, External redirects logged and blocked, All tests pass',
    'Do not trust user input for redirect URLs. Browser URL parsing is complex - use server-side validation exclusively. Never use string concatenation for redirect URL construction.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://github.com/phoenixframework/phoenix/releases/tag/v1.2.3'
),
(
    'Elixir CVE Prevention Pattern: Static file serving security with cloud storage',
    'cve',
    'HIGH',
    '[
        {"solution": "Configure file uploads to use S3/cloud storage instead of local filesystem", "percentage": 95, "note": "Cloud storage not affected by null byte or path traversal attacks"},
        {"solution": "If local serving required: validate file extension against MIME type", "percentage": 85, "command": "File.mime_type(path) should match declared extension", "note": "Double validation prevents extension spoofing"},
        {"solution": "Implement file access control separate from storage location", "percentage": 80, "note": "Use database or filesystem permissions to control downloads"}
    ]'::jsonb,
    'File upload feature implemented, Cloud provider account (S3/GCS), Or strict MIME validation possible',
    'Uploaded files served safely, No path traversal possible, MIME type verification prevents execution',
    'Local filesystem serving introduces multiple attack vectors. Cloud storage is simpler and safer. If local serving required, filename handling must be extremely careful.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://hex.pm/packages/plug'
),
(
    'Elixir CVE Prevention Pattern: Authentication token and session management',
    'cve',
    'CRITICAL',
    '[
        {"solution": "Always validate token expiration timestamp on authenticated requests", "percentage": 95, "note": "Never trust cached credentials without server validation"},
        {"solution": "Implement session store with explicit TTL and invalidation", "percentage": 90, "command": "Use ETS with timeout or Redis with EXPIRE for cache", "note": "Ensures expired sessions cannot be reused"},
        {"solution": "Log authentication events and token usage for audit trail", "percentage": 85, "note": "Enables detection of token replay or cache abuse attacks"}
    ]'::jsonb,
    'Authentication system using tokens or sessions, Database or cache system (ETS/Redis), Logging infrastructure',
    'Expired tokens rejected, Sessions expire after configured TTL, Audit logs show all auth events',
    'Token/session caching must include expiry validation. Server-side session store preferred over client-side caching. SAML assertion caching especially dangerous without expiry checks.',
    0.93,
    'sonnet-4',
    NOW(),
    'https://github.com/dropbox/samly/releases/tag/v1.4.0'
);
