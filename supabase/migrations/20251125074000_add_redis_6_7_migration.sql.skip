-- Add Redis 6â†’7 migration guide - Breaking changes and upgrade issues
-- Extracted from official Redis documentation: https://redis.io/docs/latest/embeds/r7-breaking-changes/

INSERT INTO knowledge_entries (
    query, category, hit_frequency, solutions, prerequisites, success_indicators,
    common_pitfalls, success_rate, claude_version, last_verified, source_url
) VALUES (
    'Redis 7: Lua print() function removed - scripts fail with stdout error',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Replace all print() calls with redis.log(redis.LOG_WARNING, message) in Lua scripts", "percentage": 95, "note": "Official Redis recommendation to prevent process hangs"},
        {"solution": "Override print function in scripts: local print = function(msg) redis.log(redis.LOG_NOTICE, msg) end", "percentage": 85, "note": "Wrapper approach for backward compatibility"},
        {"solution": "Remove all print() statements - use EVAL return values instead to communicate from script", "percentage": 80, "command": "Use EVAL return values for output"}
    ]'::jsonb,
    'Redis 7.0+, Existing Lua scripts using print()',
    'EVAL scripts execute without errors, Log messages appear in redis-server logs via redis.log()',
    'print() was removed to prevent Redis processes from hanging if stdout buffer fills up. Must migrate ALL scripts before upgrade.',
    0.92,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7-breaking-changes/'
),
(
    'Redis 7: ZPOPMIN/ZPOPMAX with count=0 returns WRONGTYPE instead of empty array',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Update client code to handle WRONGTYPE error response instead of empty array when count=0 on non-sorted-set keys", "percentage": 90, "note": "Check key type before calling with count parameter"},
        {"solution": "Validate count parameter is positive (>0) before calling ZPOPMIN/ZPOPMAX", "percentage": 88, "command": "Check: if count <= 0 return error before ZPOPMIN call"},
        {"solution": "For zero-count edge case, return empty array client-side: if count == 0 then return {}", "percentage": 82, "note": "Wrapper function pattern"}
    ]'::jsonb,
    'Redis 7.0+, Code using ZPOPMIN/ZPOPMAX with count parameter',
    'Commands return proper error response, Client handles WRONGTYPE gracefully without crashing',
    'Negative count values produce "value is out of range, must be positive" errors. Always validate count >= 0 before calling these commands. Test edge cases with count=0.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7-breaking-changes/'
),
(
    'Redis 7: LPOP/RPOP with count returns null array instead of (nil) for nonexistent keys',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Update client code to check for null array response instead of nil when count parameter is used with LPOP/RPOP", "percentage": 92, "note": "Applies to both nonexistent lists and count=0 case"},
        {"solution": "Use LPOP/RPOP without count parameter for single-element retrieval to maintain (nil) behavior", "percentage": 85, "command": "LPOP key (without count) returns (nil) for nonexistent keys"},
        {"solution": "Add type check before using count variant: check if key exists and is a list", "percentage": 80, "note": "Defensive programming pattern"}
    ]'::jsonb,
    'Redis 7.0+, Client code expecting (nil) from LPOP/RPOP count variant',
    'Commands return null array for nonexistent keys, Client properly deserializes null array response',
    'This is a subtle breaking change - code checking for nil will fail silently if it does not handle null arrays. Null array is different from (nil). Test with nonexistent keys.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7-breaking-changes/'
),
(
    'Redis 7: XCLAIM/XAUTOCLAIM skip deleted entries instead of returning nil',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Update stream consumer code to handle automatic deletion of claimed deleted entries from pending entry list (PEL)", "percentage": 91, "note": "Entries no longer returned as nil in response"},
        {"solution": "Verify PEL behavior: deleted entries removed automatically, consumer only sees valid entries in XCLAIM response", "percentage": 86, "command": "XAUTOCLAIM mystream mygroup consumer 0 0-0 to verify entry cleanup"},
        {"solution": "Remove any nil-checking logic in XCLAIM result processing since deleted entries no longer appear", "percentage": 82, "note": "Simplifies result handling but requires code review"}
    ]'::jsonb,
    'Redis 7.0+, Code using XCLAIM/XAUTOCLAIM with consumer groups',
    'XCLAIM returns only valid entries, Deleted entries silently removed from PEL, Consumer group tracking works correctly',
    'The automatic cleanup of deleted entries from PEL is a behavioral change. If code relies on seeing nil for deleted entries, it will silently fail. Audit all consumer group code.',
    0.87,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7-breaking-changes/'
),
(
    'Redis 7: SORT/SORT_RO reject key patterns in GET/BY unless full keyspace ACL access granted',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Grant ACL users full keyspace access for SORT: ACL SETUSER username +@all ~* (allows all commands on all keys)", "percentage": 93, "note": "Required if using SORT with external key patterns in GET/BY"},
        {"solution": "Refactor SORT commands to avoid external key patterns - use local key references only", "percentage": 85, "command": "Replace SORT key BY weight_* GET object_* with direct key access"},
        {"solution": "Update ACL to allow SORT: ACL SETUSER username +sort (gives basic access, but with key pattern restrictions)", "percentage": 78, "note": "User can use SORT but only on keys they have access to"}
    ]'::jsonb,
    'Redis 7.0+, ACL-protected Redis with SORT/SORT_RO commands using GET/BY with external keys',
    'SORT command executes with proper ACL permissions, Key patterns in GET/BY clauses work without permission errors',
    'Redis 7 strictly enforces ACL for SORT external key access. Old code with partial key restrictions will fail with permission denied. Either grant full access or refactor SORT logic.',
    0.90,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7-breaking-changes/'
),
(
    'Redis 7: ACL GETUSER response format changed - keys/channels now use ACL DSL syntax',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Update ACL parsing code to handle new DSL format: keys appear as \"~pattern\" and channels as \"&pattern\" in ACL GETUSER response", "percentage": 91, "note": "Previous: empty array, New: empty string \"\", Channels now in DSL format"},
        {"solution": "Use redis-cli: ACL GETUSER username and review new format with ~ and & prefixes for patterns", "percentage": 86, "command": "ACL GETUSER default to see new response format"},
        {"solution": "Implement parsing wrapper for ACL DSL format in client code to maintain backward compatibility", "percentage": 80, "note": "Enables gradual migration from old to new format"}
    ]'::jsonb,
    'Redis 7.0+, Code parsing ACL GETUSER responses programmatically',
    'ACL GETUSER returns valid DSL format, Client code successfully parses key patterns (~) and channel patterns (&)',
    'The response format is fundamentally different. Code that looks for empty arrays will break. Review all ACL introspection code. Empty key patterns now return \"\" string instead of empty array.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7-breaking-changes/'
),
(
    'Redis 7: PFCOUNT and PUBLISH now treated as write commands in Lua scripts',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Wrap PFCOUNT/PUBLISH calls in EVAL (not EVAL_RO) since they are now write commands", "percentage": 93, "note": "EVAL_RO scripts cannot contain write operations. Use EVAL instead."},
        {"solution": "Ensure scripts using PFCOUNT/PUBLISH have proper numkeys argument: EVAL \"redis.call(''PFCOUNT'', KEYS[1])\" 1 myhll", "percentage": 88, "command": "EVAL script_content numkeys key1 [key2...]"},
        {"solution": "Review all read-only script requirements: EVAL_RO now rejects PFCOUNT/PUBLISH - migrate to EVAL if needed", "percentage": 82, "note": "Breaking change for scripts expecting read-only semantics"}
    ]'::jsonb,
    'Redis 7.0+, Lua scripts using PFCOUNT or PUBLISH commands',
    'Scripts using PFCOUNT/PUBLISH execute via EVAL without errors, Commands properly replicated to replicas',
    'PFCOUNT and PUBLISH have \"may_replicate\" flag removed. They are now classified as write commands. Code expecting these to be read-only will fail. Migration requires moving to EVAL.',
    0.89,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7-breaking-changes/'
),
(
    'Redis 7: Unknown command error messages changed case from "Unknown" to "unknown"',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Update error message parsing to match new lowercase format: check for \"ERR unknown command\" instead of \"ERR Unknown command\"", "percentage": 94, "note": "Case-sensitive string matching in error handlers will fail"},
        {"solution": "Use case-insensitive error matching: convert error message to lowercase before pattern matching", "percentage": 87, "command": "if error.toLowerCase().includes(''unknown command'')"},
        {"solution": "Implement error code checking instead of message text: check for ERR prefix and extract error code", "percentage": 80, "note": "More robust than text matching"}
    ]'::jsonb,
    'Redis 7.0+, Client code checking error messages for unknown commands',
    'Error messages matched correctly with lowercase format, Error handling code processes all unknown command errors',
    'This is a minor but widespread change. Any code doing string comparison on error messages will break. Search for ''Unknown'' (capital U) in error handling code and update to ''unknown''.',
    0.91,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7-breaking-changes/'
),
(
    'Redis 7: INFO commandstats now shows per-subcommand statistics instead of aggregated',
    'migration-guide',
    'MEDIUM',
    '[
        {"solution": "Update monitoring/stats collection to parse new format: cmdstat_acl|list, cmdstat_acl|setuser instead of single cmdstat_acl entry", "percentage": 92, "note": "Subcommand stats now separated with pipe delimiter"},
        {"solution": "Aggregate subcommand stats in application layer if total command usage needed: sum all cmdstat_acl|* entries", "percentage": 85, "command": "Extract pattern cmdstat_COMMAND|SUBCOMMAND from INFO output"},
        {"solution": "Review Prometheus/monitoring exporters and update regex patterns to capture new subcommand format", "percentage": 81, "note": "Affects all metrics collection pipelines"}
    ]'::jsonb,
    'Redis 7.0+, Monitoring systems parsing INFO commandstats',
    'Stats parsing correctly extracts subcommand statistics, Monitoring dashboards show accurate per-subcommand metrics',
    'Monitoring systems expecting single entries per command will miss subcommand data. This affects Prometheus, Datadog, and other monitoring tools. Update regex patterns and aggregation logic.',
    0.86,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7-breaking-changes/'
),
(
    'Redis 7.2: Lua time sampling frozen during command/script execution - keys will not expire',
    'migration-guide',
    'HIGH',
    '[
        {"solution": "Refactor any scripts expecting TTL expiration during execution: move key expiration checks outside the script", "percentage": 91, "note": "Keys do not expire while script is running - can cause infinite loops"},
        {"solution": "Implement external expiration check: run PTTL in loop outside script instead of relying on in-script key expiration", "percentage": 87, "command": "while redis.call(''pttl'', mykey) > 0 do wait_logic() end"},
        {"solution": "Use Redis streams or pub/sub for timeout notification instead of waiting for key expiration in script", "percentage": 79, "note": "Distributed timeout pattern instead of in-script waiting"}
    ]'::jsonb,
    'Redis 7.2+, Lua scripts that wait for key expiration in loops',
    'Scripts complete without hanging, Timeout mechanisms work correctly, No infinite loops from expired keys',
    'Time sampling frozen is a subtle breaking change. Scripts with while loops waiting for PTTL > 0 will hang indefinitely. This is especially dangerous in production. Audit all long-running scripts.',
    0.88,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7.2-breaking-changes/'
),
(
    'Redis 7: Module command errors now include subcommands with updated syntax and case',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Update error handling for module commands to expect new error format with subcommand notation", "percentage": 88, "note": "Module errors now formatted consistently with native Redis subcommands"},
        {"solution": "Review third-party module documentation and update error parsing if modules updated error messages", "percentage": 82, "command": "Check module docs for new error format specification"},
        {"solution": "Add generic module error handler that extracts error code independent of message format", "percentage": 75, "note": "Defensive approach for future module changes"}
    ]'::jsonb,
    'Redis 7.0+, Code using third-party Redis modules with error handling',
    'Module command errors parsed correctly, Error codes extracted from module responses',
    'Module error format changes are implementation-specific. Impact depends on which modules you use. Review module changelogs for Redis 7 compatibility.',
    0.79,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7-breaking-changes/'
),
(
    'Redis 7: CONFIG REWRITE/RESETSTAT now allowed during loading phase',
    'migration-guide',
    'LOW',
    '[
        {"solution": "Update startup scripts to call CONFIG REWRITE during initial load phase if configuration changes needed", "percentage": 85, "note": "Previously blocked during loading, now allowed for flexible initialization"},
        {"solution": "No code changes required - old CONFIG REWRITE commands that were blocked will now execute", "percentage": 80, "note": "Change is backward compatible and allows more flexibility"},
        {"solution": "Review initialization order in Docker/Kubernetes startup scripts - can now use CONFIG commands earlier", "percentage": 75, "note": "Optimization opportunity for deployment automation"}
    ]'::jsonb,
    'Redis 7.0+, Deployment scripts using CONFIG REWRITE',
    'CONFIG REWRITE executes during loading phase, Configuration persists correctly, No errors from CONFIG commands during startup',
    'This is a compatibility improvement, not a breaking change. Old code continues to work. Can now be called earlier in initialization sequence if needed.',
    0.82,
    'sonnet-4',
    NOW(),
    'https://redis.io/docs/latest/embeds/r7-breaking-changes/'
);
